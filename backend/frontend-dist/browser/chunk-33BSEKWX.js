import{d as h,e as m}from"./chunk-RFXIYJE6.js";import{O as g,S as n,a as l,h as u}from"./chunk-EGMLUSXW.js";function b(i){return{name:i,characterIds:[],partyIds:[],itemLibrary:[],runeLibrary:[],spellLibrary:[],skillLibrary:[],lootBundles:[],battleLoot:[],battleParticipants:[],currentTurnIndex:0,trash:[],battleMaps:[]}}var y=class i{constructor(e,t){this.api=e;this.socket=t;this.socket.patches$.subscribe(r=>{let a=this.worldSubject.value;if(a){if(this.pendingPatchPaths.has(r.path)){console.log("[WORLD STORE] Skipping echo of own patch:",r.path),this.pendingPatchPaths.delete(r.path);return}this.applyJsonPatch(a,r),this.worldSubject.next(l({},a))}})}worldSubject=new u(null);world$=this.worldSubject.asObservable();worldName;pendingPatchPaths=new Set;get worldValue(){return this.worldSubject.value}async save(){let e=this.worldSubject.value;if(!e){console.warn("[WORLD STORE] No world loaded, cannot save.");return}if(!this.worldName){console.error("[WORLD STORE] No worldName set, cannot save.");return}try{await this.api.saveWorld(this.worldName,e),console.log("[WORLD STORE] World saved successfully")}catch(t){console.error("[WORLD STORE] Failed to save world:",t)}}async load(e){this.worldName=e,console.log("[WORLD STORE] Loading world:",e);let t=await this.api.loadWorld(e);if(console.log("[WORLD STORE] Loaded world from API:",t),!t)console.log("[WORLD STORE] No world found, creating new"),t=b(e),this.worldSubject.next(t),this.save();else{let r=!1;t.characters&&!t.characterIds&&(console.log("[WORLD STORE] Migrating: characters -> characterIds"),t.characterIds=t.characters,delete t.characters,r=!0),t.party&&!t.partyIds&&(console.log("[WORLD STORE] Migrating: party -> partyIds"),t.partyIds=t.party,delete t.party,r=!0),t.library&&(console.log("[WORLD STORE] Migrating: library object -> separate libraries"),t.itemLibrary=t.library.items||[],t.runeLibrary=t.library.runes||[],t.spellLibrary=t.library.spells||[],t.skillLibrary=t.library.skills||[],delete t.library,r=!0),t.name||(t.name=e,r=!0),t.battleParticipants||(console.log("[WORLD STORE] Migrating: adding battleParticipants"),t.battleParticipants=[],r=!0),t.currentTurnIndex===void 0&&(console.log("[WORLD STORE] Migrating: adding currentTurnIndex"),t.currentTurnIndex=0,r=!0),t.lootBundles||(console.log("[WORLD STORE] Migrating: adding lootBundles"),t.lootBundles=[],r=!0),t.skillLibrary||(console.log("[WORLD STORE] Migrating: adding skillLibrary"),t.skillLibrary=[],r=!0),t.trash||(console.log("[WORLD STORE] Migrating: adding trash"),t.trash=[],r=!0),console.log("[WORLD STORE] Setting loaded world with",t.battleParticipants?.length||0,"battle participants"),this.worldSubject.next(t),r&&(console.log("[WORLD STORE] Saving migrated world to backend"),await this.save())}this.socket.connect(),this.socket.joinWorld(e)}applyPatch(e){let t=this.worldSubject.value;t&&(this.applyJsonPatch(t,e),this.worldSubject.next(l({},t))),this.pendingPatchPaths.add(e.path),setTimeout(()=>this.pendingPatchPaths.delete(e.path),5e3),this.socket.sendPatch(this.worldName,e)}revealBattleLoot(){this.socket.revealBattleLoot(this.worldName)}applyJsonPatch(e,t){let r=t.path.split("."),a=e;for(let o=0;o<r.length-1;o++){let d=r[o],p=parseInt(d,10);!isNaN(p)&&Array.isArray(a)?a=a[p]:a=a[d]??={}}let s=r[r.length-1],c=parseInt(s,10);!isNaN(c)&&Array.isArray(a)?a[c]=t.value:a[s]=t.value}static \u0275fac=function(t){return new(t||i)(n(m),n(h))};static \u0275prov=g({token:i,factory:i.\u0275fac,providedIn:"root"})};export{y as a};
