import{a as Ce}from"./chunk-33BSEKWX.js";import{a as Z,b as Re,c as Ve}from"./chunk-RFXIYJE6.js";import{c as We}from"./chunk-U2QMYJWS.js";import{p as Le}from"./chunk-CRXYTJXZ.js";import{j as He,k as j,p as Ie}from"./chunk-QU66LBKX.js";import{$b as fe,Bb as ge,Cb as oe,Db as ie,Fa as Y,Fb as W,Ga as De,Gb as H,Ha as te,Ia as p,Ib as u,Jb as L,Kb as ce,O as le,T as D,Tb as Oe,Ua as F,Ub as K,Vb as Q,Wb as ze,Y as f,Z as C,Zb as be,a as U,b as X,da as E,eb as ye,fb as k,g as ue,gb as T,h as Ee,ia as _,ib as he,jb as N,kb as $,la as Se,lb as ne,mb as R,na as Be,nb as q,ob as re,p as se,pb as l,qb as d,rb as A,sb as O,tb as I,wb as G,xb as y,yb as m}from"./chunk-EGMLUSXW.js";var xe=class i{http=D(Ie);async loadBattleMap(e,t){let n=`/api/worlds/${e}/battlemaps/${t}`;try{return await se(this.http.get(n))}catch(r){return console.error(`[BATTLEMAP API] Failed to load battle map ${t}:`,r),null}}async saveBattleMap(e,t){let n=`/api/worlds/${e}/battlemaps/${t.id}`;try{await se(this.http.post(n,t))}catch(r){throw console.error("[BATTLEMAP API] Failed to save battle map:",r),r}}async createBattleMap(e,t){let n=`/api/worlds/${e}/battlemaps`;try{return await se(this.http.post(n,t))}catch(r){return console.error(`[BATTLEMAP API] Failed to create battle map in world ${e}:`,r),null}}async listBattleMaps(e){let t=`/api/worlds/${e}/battlemaps`;try{return await se(this.http.get(t))||[]}catch(n){return console.error("[BATTLEMAP API] Failed to list battlemaps:",n),[]}}async deleteBattleMap(e,t){let n=`/api/worlds/${e}/battlemaps/${t}`;try{await se(this.http.delete(n))}catch(r){throw console.error("[BATTLEMAP API] Failed to delete battlemap:",r),r}}static \u0275fac=function(t){return new(t||i)};static \u0275prov=le({token:i,factory:i.\u0275fac,providedIn:"root"})};var _e=class i{socket;patchSubject=new ue;measurementSubject=new ue;connectionReadySubject=new ue;isConnected=!1;patches$=this.patchSubject.asObservable();measurements$=this.measurementSubject.asObservable();connectionReady$=this.connectionReadySubject.asObservable();connect(){if(this.socket){this.isConnected&&this.connectionReadySubject.next();return}console.log("[BATTLEMAP SOCKET] Connecting to:",window.location.origin),this.socket=Ve(window.location.origin,{path:"/socket.io",transports:["websocket"]}),this.socket.on("connect",()=>{console.log("[BATTLEMAP SOCKET] Connected! Socket ID:",this.socket?.id),this.isConnected=!0,this.connectionReadySubject.next()}),this.socket.on("disconnect",e=>{console.log("[BATTLEMAP SOCKET] Disconnected. Reason:",e),this.isConnected=!1}),this.socket.on("battleMapPatched",e=>{console.log("[BATTLEMAP SOCKET] Received patch:",e.path),this.patchSubject.next(e)}),this.socket.on("measurementUpdate",e=>{this.measurementSubject.next(e)})}async joinBattleMap(e,t){this.isConnected||(console.log("[BATTLEMAP SOCKET] Waiting for connection..."),await new Promise(n=>{let r=this.connectionReady$.subscribe(()=>{r.unsubscribe(),n()})})),console.log("[BATTLEMAP SOCKET] Joining battle map:",t),this.socket?.emit("joinBattleMap",{worldName:e,battleMapId:t})}sendPatch(e,t,n){console.log("[BATTLEMAP SOCKET] Sending patch:",n.path),this.socket?.emit("patchBattleMap",{worldName:e,battleMapId:t,patch:n})}sendMeasurement(e,t,n){this.socket?.emit("updateMeasurement",{worldName:e,battleMapId:t,measurement:n})}leaveBattleMap(e){this.socket?.emit("leaveBattleMap",{battleMapId:e})}static \u0275fac=function(t){return new(t||i)};static \u0275prov=le({token:i,factory:i.\u0275fac,providedIn:"root"})};function qe(i,e,t){return{id:i,name:e,worldName:t,tokens:[],strokes:[],walls:[],measurementLines:[],createdAt:Date.now(),updatedAt:Date.now()}}var b=class i{static SIZE=40;static WIDTH=i.SIZE*2;static HEIGHT=Math.sqrt(3)*i.SIZE;static HORIZ=i.SIZE*1.5;static VERT=i.HEIGHT;static hexToPixel(e){let t=i.HORIZ*e.q,n=i.HEIGHT*(e.r+e.q*.5);return{x:t,y:n}}static pixelToHex(e,t){let n=e/i.HORIZ,r=t/i.HEIGHT-n*.5;return i.hexRound({q:n,r})}static hexRound(e){let t=-e.q-e.r,n=Math.round(e.q),r=Math.round(e.r),o=Math.round(t),a=Math.abs(n-e.q),s=Math.abs(r-e.r),c=Math.abs(o-t);return a>s&&a>c?n=-r-o:s>c&&(r=-n-o),{q:n,r}}static hexDistance(e,t){let n=e.q,r=e.r,o=-e.q-e.r,a=t.q,s=t.r,c=-t.q-t.r;return Math.max(Math.abs(n-a),Math.abs(r-s),Math.abs(o-c))}static getHexCorners(e){let t=[];for(let n=0;n<6;n++){let r=60*n,o=Math.PI/180*r;t.push({x:e.x+i.SIZE*Math.cos(o),y:e.y+i.SIZE*Math.sin(o)})}return t}static getNeighbors(e){return[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}].map(n=>({q:e.q+n.q,r:e.r+n.r}))}static getVisibleHexBounds(e,t,n,r){let o=i.pixelToHex(e,n),a=i.pixelToHex(t,n),s=i.pixelToHex(e,r),c=i.pixelToHex(t,r);return{minQ:Math.min(o.q,a.q,s.q,c.q)-1,maxQ:Math.max(o.q,a.q,s.q,c.q)+1,minR:Math.min(o.r,a.r,s.r,c.r)-1,maxR:Math.max(o.r,a.r,s.r,c.r)+1}}static hexLineDraw(e,t){let n=i.hexDistance(e,t);if(n===0)return[e];let r=[];for(let o=0;o<=n;o++){let a=o/n,s=e.q+(t.q-e.q)*a,c=e.r+(t.r-e.r)*a;r.push(i.hexRound({q:s,r:c}))}return r}static isWall(e,t){return t.some(n=>n.q===e.q&&n.r===e.r)}static hexKey(e){return`${e.q},${e.r}`}static parseHexKey(e){let[t,n]=e.split(",").map(Number);return{q:t,r:n}}static findPath(e,t,n,r){let o=i.hexDistance(e,t);if(o>r)return null;let a=new Set(n.map(z=>i.hexKey(z))),s=i.hexKey(e),c=i.hexKey(t);if(a.has(c))return null;if(s===c)return[e];let x=[{hex:e,g:0,f:o}],v=new Map([[s,0]]),w=new Map,S=new Set;for(;x.length>0;){let z=0;for(let P=1;P<x.length;P++)x[P].f<x[z].f&&(z=P);let h=x.splice(z,1)[0],M=i.hexKey(h.hex);if(M===c){let P=[],g=h.hex;for(;g;)P.unshift(g),g=w.get(i.hexKey(g));return P}if(!(h.g>=r)){S.add(M);for(let P of i.getNeighbors(h.hex)){let g=i.hexKey(P);if(S.has(g)||a.has(g))continue;let B=h.g+1,V=v.get(g);if(V!==void 0&&B>=V)continue;v.set(g,B),w.set(g,h.hex);let ae=i.hexDistance(P,t),Pe=B+ae,Me=x.findIndex(Fe=>i.hexKey(Fe.hex)===g);Me>=0?(x[Me].g=B,x[Me].f=Pe):x.push({hex:P,g:B,f:Pe})}}}return null}};function de(){return Date.now().toString(36)+Math.random().toString(36).substr(2,9)}var ee=class i{battleMapSubject=new Ee(null);battleMap$=this.battleMapSubject.asObservable();worldName;battleMapId;pendingPatchPaths=new Set;strokeUndoHistory=[];maxUndoHistory=50;api=D(xe);socket=D(_e);get battleMapValue(){return this.battleMapSubject.value}constructor(){this.socket.patches$.subscribe(e=>{let t=this.battleMapSubject.value;if(t){if(this.pendingPatchPaths.has(e.path)){this.pendingPatchPaths.delete(e.path);return}this.applyJsonPatch(t,e),this.battleMapSubject.next(U({},t))}})}async load(e,t){this.worldName=e,this.battleMapId=t,console.log("[BATTLEMAP STORE] Loading battle map:",t,"from world:",e);let n=await this.api.loadBattleMap(e,t);n?(console.log("[BATTLEMAP STORE] Loaded existing battle map"),n=this.migrateBattleMap(n),this.battleMapSubject.next(n)):(console.log("[BATTLEMAP STORE] Creating empty battle map"),n=qe(t,t,e),this.battleMapSubject.next(n),await this.api.createBattleMap(e,n)),this.socket.connect(),await this.socket.joinBattleMap(e,t)}migrateBattleMap(e){return e.strokes||(e.strokes=e.drawings||[]),e.tokens||(e.tokens=[]),e.measurementLines||(e.measurementLines=[]),e.walls||(e.walls=[]),e}applyPatch(e){let t=this.battleMapSubject.value;t&&(this.pendingPatchPaths.add(e.path),this.applyJsonPatch(t,e),t.updatedAt=Date.now(),this.battleMapSubject.next(U({},t))),this.socket.sendPatch(this.worldName,this.battleMapId,e)}addToken(e){let t=this.battleMapValue;if(!t)return;let n=X(U({},e),{id:de()}),r=[...t.tokens,n];this.applyPatch({path:"tokens",value:r})}moveToken(e,t){let n=this.battleMapValue;if(!n)return;let r=n.tokens.findIndex(a=>a.id===e);if(r===-1)return;let o=[...n.tokens];o[r]=X(U({},o[r]),{position:t}),this.applyPatch({path:"tokens",value:o})}removeToken(e){let t=this.battleMapValue;if(!t)return;let n=t.tokens.filter(r=>r.id!==e);this.applyPatch({path:"tokens",value:n})}addStroke(e){let t=this.battleMapValue;if(!t)return;this.strokeUndoHistory.push([...t.strokes]),this.strokeUndoHistory.length>this.maxUndoHistory&&this.strokeUndoHistory.shift();let n=X(U({},e),{id:de()}),r=[...t.strokes,n];this.applyPatch({path:"strokes",value:r})}undoStroke(){if(!this.battleMapValue||this.strokeUndoHistory.length===0)return!1;let t=this.strokeUndoHistory.pop();return this.applyPatch({path:"strokes",value:t}),!0}clearStrokes(){let e=this.battleMapValue;e&&(this.strokeUndoHistory.push([...e.strokes]),this.strokeUndoHistory.length>this.maxUndoHistory&&this.strokeUndoHistory.shift(),this.applyPatch({path:"strokes",value:[]}))}addWall(e){let t=this.battleMapValue;if(!t||t.walls.some(o=>o.q===e.q&&o.r===e.r))return;let r=[...t.walls,{q:e.q,r:e.r}];this.applyPatch({path:"walls",value:r})}removeWall(e){let t=this.battleMapValue;if(!t)return;let n=t.walls.filter(r=>!(r.q===e.q&&r.r===e.r));this.applyPatch({path:"walls",value:n})}toggleWall(e){let t=this.battleMapValue;if(!t)return;t.walls.some(r=>r.q===e.q&&r.r===e.r)?this.removeWall(e):this.addWall(e)}clearWalls(){this.applyPatch({path:"walls",value:[]})}applyJsonPatch(e,t){let n=t.path.split(".");if(n.length===1&&Array.isArray(t.value)){e[n[0]]=t.value;return}if(n.length===1){e[n[0]]=t.value;return}let r=e;for(let s=0;s<n.length-1;s++){let c=n[s],x=parseInt(c,10);!isNaN(x)&&Array.isArray(r)?r=r[x]:r=r[c]??={}}let o=n[n.length-1],a=parseInt(o,10);!isNaN(a)&&Array.isArray(r)?r[a]=t.value:r[o]=t.value}static \u0275fac=function(t){return new(t||i)};static \u0275prov=le({token:i,factory:i.\u0275fac,providedIn:"root"})};function Ne(i,e){if(i&1&&(A(0,"img",2),K(1,"imageUrl")),i&2){let t=m();I("src",Q(1,2,t.token.portrait),Y)("alt",t.token.characterName)}}function $e(i,e){if(i&1&&(l(0,"div",3),u(1),d()),i&2){let t=m();p(),L(t.initials)}}function Ge(i,e){i&1&&A(0,"div",5)}function je(i,e){if(i&1){let t=O();l(0,"div",7),y("click",function(r){return f(t),C(r.stopPropagation())}),l(1,"button",8),y("click",function(){f(t);let r=m();return C(r.onRemove())}),l(2,"span"),u(3,"\u{1F5D1}\uFE0F"),d(),u(4," Remove "),d()()}}var ve=class i{elementRef=D(Be);token;isCurrentTurn=!1;position={x:0,y:0};scale=1;currentTool="cursor";isDragEnabled=!1;syncedTeam;dragStart=new E;dragMove=new E;dragEnd=new E;remove=new E;showContextMenu=!1;isDragging=!1;get worldPosition(){return b.hexToPixel(this.token.position)}get tokenWidth(){return b.WIDTH*.9}get tokenHeight(){return b.HEIGHT*.9}get canDrag(){return this.currentTool==="cursor"}onPointerDown(e){this.onMouseDown(e)}onMouseDown(e){!this.canDrag||e.button!==0||(e.preventDefault(),e.stopPropagation(),this.isDragging=!0,this.dragStart.emit({event:e}))}onDocumentPointerMove(e){this.onDocumentMouseMove(e)}onDocumentPointerUp(e){this.onDocumentMouseUp(e)}onDocumentMouseMove(e){this.isDragging&&(e.preventDefault(),this.dragMove.emit({event:e}))}onDocumentMouseUp(e){this.isDragging&&e.button===0&&(this.isDragging=!1,this.dragEnd.emit({event:e}))}onContextMenu(e){e.preventDefault(),e.stopPropagation(),this.showContextMenu=!this.showContextMenu}onRemove(){this.showContextMenu=!1,this.remove.emit()}closeContextMenu(){this.showContextMenu=!1}get initials(){return(this.token.characterName||"Unknown").split(" ").map(t=>t[0]).join("").substring(0,2).toUpperCase()}get teamColor(){switch(this.syncedTeam||this.token.team){case"red":return"#ef4444";case"blue":return"#3b82f6";case"green":return"#22c55e";case"yellow":return"#eab308";case"purple":return"#a855f7";default:return"#60a5fa"}}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=F({type:i,selectors:[["app-battlemap-token"]],hostBindings:function(t,n){t&1&&G("pointermove",function(o){return n.onDocumentPointerMove(o)},te)("pointerup",function(o){return n.onDocumentPointerUp(o)},te)("mousemove",function(o){return n.onDocumentMouseMove(o)},te)("mouseup",function(o){return n.onDocumentMouseUp(o)},te)},inputs:{token:"token",isCurrentTurn:"isCurrentTurn",position:"position",scale:"scale",currentTool:"currentTool",isDragEnabled:"isDragEnabled",syncedTeam:"syncedTeam"},outputs:{dragStart:"dragStart",dragMove:"dragMove",dragEnd:"dragEnd",remove:"remove"},decls:8,vars:20,consts:[[1,"token",3,"pointerdown","contextmenu","click"],[1,"token-hexagon"],["draggable","false",1,"portrait",3,"src","alt"],[1,"initials"],[1,"token-name"],[1,"turn-glow"],[1,"context-menu"],[1,"context-menu",3,"click"],[1,"menu-item","danger",3,"click"]],template:function(t,n){t&1&&(l(0,"div",0),y("pointerdown",function(o){return n.onPointerDown(o)})("contextmenu",function(o){return n.onContextMenu(o)})("click",function(){return n.closeContextMenu()}),l(1,"div",1),k(2,Ne,2,4,"img",2)(3,$e,2,1,"div",3),d(),l(4,"div",4),u(5),d(),k(6,Ge,1,0,"div",5),k(7,je,5,0,"div",6),d()),t&2&&(W("left",n.worldPosition.x,"px")("top",n.worldPosition.y,"px")("width",n.tokenWidth,"px")("height",n.tokenHeight,"px")("--team-color",n.teamColor),H("current-turn",n.isCurrentTurn)("dragging",n.isDragging)("can-drag",n.canDrag),p(2),T(n.token.portrait?2:3),p(3),L(n.token.characterName),p(),T(n.isCurrentTurn?6:-1),p(),T(n.showContextMenu?7:-1))},dependencies:[j,Z],styles:['.token[_ngcontent-%COMP%]{position:absolute;transform:translate(-50%,-50%);-webkit-user-select:none;user-select:none;z-index:10;transition:filter .15s ease,box-shadow .15s ease;cursor:default;touch-action:none}.token.can-drag[_ngcontent-%COMP%]{cursor:grab}.token.can-drag[_ngcontent-%COMP%]:hover{filter:brightness(1.1);z-index:20}.token.can-drag[_ngcontent-%COMP%]:active{cursor:grabbing}.token.dragging[_ngcontent-%COMP%]{opacity:.4;cursor:grabbing;z-index:5}.token-hexagon[_ngcontent-%COMP%]{width:100%;height:100%;position:relative;clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%);background:var(--card);border-radius:0;overflow:hidden;display:flex;align-items:center;justify-content:center}.portrait[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.initials[_ngcontent-%COMP%]{font-size:1.5rem;font-weight:700;color:var(--text);text-transform:uppercase}.token-name[_ngcontent-%COMP%]{position:absolute;bottom:-20px;left:50%;transform:translate(-50%);font-size:.65rem;font-weight:600;color:var(--text);background:#000000bf;padding:2px 6px;border-radius:4px;white-space:nowrap;max-width:100px;overflow:hidden;text-overflow:ellipsis}.token[_ngcontent-%COMP%]:before{content:"";position:absolute;inset:-3px;clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%);background:var(--team-color, #60a5fa);z-index:-1}.token.current-turn[_ngcontent-%COMP%]:before{animation:_ngcontent-%COMP%_token-pulse 1.5s ease-in-out infinite}.turn-glow[_ngcontent-%COMP%]{position:absolute;inset:-10px;clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%);background:radial-gradient(circle,rgba(251,191,36,.4) 0%,transparent 70%);pointer-events:none;animation:_ngcontent-%COMP%_glow-pulse 1.5s ease-in-out infinite}@keyframes _ngcontent-%COMP%_token-pulse{0%,to{box-shadow:0 0 15px #fbbf2499;filter:brightness(1)}50%{box-shadow:0 0 30px #fbbf24e6;filter:brightness(1.2)}}@keyframes _ngcontent-%COMP%_glow-pulse{0%,to{opacity:.5;transform:scale(1)}50%{opacity:1;transform:scale(1.1)}}.context-menu[_ngcontent-%COMP%]{position:absolute;top:calc(100% + 5px);left:50%;transform:translate(-50%);background:var(--card);border:1px solid var(--border);border-radius:8px;padding:.25rem;min-width:100px;box-shadow:0 4px 20px #00000080;z-index:100}.menu-item[_ngcontent-%COMP%]{width:100%;padding:.5rem .75rem;background:transparent;border:none;color:var(--text);font-size:.85rem;cursor:pointer;display:flex;align-items:center;gap:.5rem;border-radius:4px;transition:background .2s}.menu-item[_ngcontent-%COMP%]:hover{background:var(--border)}.menu-item.danger[_ngcontent-%COMP%]{color:#ef4444}.menu-item.danger[_ngcontent-%COMP%]:hover{background:#ef444433}'],changeDetection:0})};var Ue=["gridCanvas"],Ye=["drawCanvas"],Xe=["overlayCanvas"],Ke=["container"],Qe=(i,e)=>e.id;function Ze(i,e){if(i&1){let t=O();R(0,"app-battlemap-token",13),G("dragStart",function(r){let o=f(t).$implicit,a=m(2);return C(a.onTokenDragStart(o,r.event))})("dragEnd",function(r){let o=f(t).$implicit,a=m(2);return C(a.onTokenDragEnd(r.event,o.id))})("remove",function(){let r=f(t).$implicit,o=m(2);return C(o.tokenRemove.emit(r.id))}),q()}if(i&2){let t=e.$implicit,n=m(2);ne("token",t)("isCurrentTurn",n.isTokenCurrentTurn(t))("position",n.getTokenScreenPosition(t))("scale",n.scale)("currentTool",n.currentTool)("syncedTeam",n.getSyncedTeam(t))}}function Je(i,e){if(i&1&&N(0,Ze,1,6,"app-battlemap-token",12,Qe),i&2){let t=m();$(t.battleMap.tokens)}}function et(i,e){if(i&1&&(re(0,"img",16),K(1,"imageUrl")),i&2){let t=m(2);ne("src",Q(1,2,t.draggingToken.portrait),Y)("alt",t.draggingToken.characterName)}}function tt(i,e){if(i&1&&(R(0,"div",17),u(1),q()),i&2){let t=m(2);p(),L(t.getInitials(t.draggingToken.characterName))}}function nt(i,e){if(i&1&&(R(0,"div",14)(1,"div",15),k(2,et,2,4,"img",16)(3,tt,2,1,"div",17),q()()),i&2){let t=m();W("left",t.dragGhostPosition().x,"px")("top",t.dragGhostPosition().y,"px")("width",t.ghostWidth,"px")("height",t.ghostHeight,"px")("--team-color",t.getTeamColor(t.draggingToken.team)),p(2),T(t.draggingToken.portrait?2:3)}}function rt(i,e){if(i&1){let t=O();R(0,"div",18),G("click",function(r){return f(t),C(r.stopPropagation())}),R(1,"button",19),G("click",function(){f(t);let r=m();return C(r.onCreateQuickToken())}),R(2,"span"),u(3,"\u2795"),q(),u(4," Create Token "),q()()}if(i&2){let t=m();W("left",t.contextMenuPosition().x,"px")("top",t.contextMenuPosition().y,"px")}}function ot(i,e){if(i&1&&(R(0,"div",20)(1,"span",21),u(2),K(3,"number"),q()()),i&2){let t=m();W("left",t.brushResizePreview().x,"px")("top",t.brushResizePreview().y,"px")("width",t.brushResizePreview().size,"px")("height",t.brushResizePreview().size,"px"),p(2),L(ze(3,9,t.brushResizePreview().size,"1.0-0"))}}var me=class i{gridCanvas;drawCanvas;overlayCanvas;container;battleMap=null;currentTool="cursor";brushColor="#000000";penBrushSize=4;eraserBrushSize=12;onKeyDown(e){e.ctrlKey&&e.key==="z"&&(e.preventDefault(),this.store.undoStroke())}drawWithWalls=!1;dragMode="free";currentTurnCharacterId=null;battleParticipants=[];drawLayerVisible=!0;tokenDrop=new E;tokenMove=new E;tokenRemove=new E;quickTokenDrop=new E;brushSizeChange=new E;store=D(ee);cdr=D(fe);gridCtx=null;drawCtx=null;overlayCtx=null;renderPending=!1;resizeObserver=null;panX=0;panY=0;scale=1;isPanning=!1;isZooming=!1;zoomStartY=0;zoomStartScale=1;isDrawing=!1;isWallDrawing=!1;wallPaintMode="add";wallPaintedHexes=new Set;lastMouseX=0;lastMouseY=0;currentStrokePoints=[];currentStrokeHexes=new Set;lastDrawTime=0;drawThrottle=16;isResizingBrush=!1;brushResizeStartX=0;brushResizeStartSize=0;brushResizePreview=_(null);measureStart=_(null);measureEnd=_(null);measureDistance=_(0);draggingToken=null;dragGhostPosition=_(null);dragHoverHex=_(null);dragPath=_([]);dragFullPath=_([]);dragWaypoints=_([]);dragStartHex=_(null);dragPathInvalid=_(!1);dragOverHex=null;isExternalDragActive=!1;showContextMenu=_(!1);contextMenuPosition=_({x:0,y:0});contextMenuHex=_(null);ngAfterViewInit(){this.initCanvases(),this.centerView(),this.scheduleRender(),this.setupResizeObserver()}ngOnDestroy(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null)}ngOnChanges(e){e.battleMap&&this.gridCtx&&this.scheduleRender(),e.drawLayerVisible&&this.updateLayerVisibility()}updateLayerVisibility(){this.drawCanvas?.nativeElement&&(this.drawCanvas.nativeElement.style.opacity=this.drawLayerVisible?"1":"0")}initCanvases(){let e=this.gridCanvas?.nativeElement,t=this.drawCanvas?.nativeElement,n=this.overlayCanvas?.nativeElement;e&&(this.gridCtx=e.getContext("2d"),this.resizeCanvas(e)),t&&(this.drawCtx=t.getContext("2d"),this.resizeCanvas(t)),n&&(this.overlayCtx=n.getContext("2d"),this.resizeCanvas(n))}resizeCanvas(e){let t=this.container?.nativeElement;if(!t)return;let n=t.getBoundingClientRect(),r=window.devicePixelRatio||1;e.width=n.width*r,e.height=n.height*r,e.style.width=n.width+"px",e.style.height=n.height+"px";let o=e.getContext("2d");o&&o.scale(r,r)}setupResizeObserver(){let e=this.container?.nativeElement;e&&(this.resizeObserver=new ResizeObserver(()=>{let t=this.gridCanvas?.nativeElement,n=this.drawCanvas?.nativeElement,r=this.overlayCanvas?.nativeElement;t&&this.resizeCanvas(t),n&&this.resizeCanvas(n),r&&this.resizeCanvas(r),this.scheduleRender()}),this.resizeObserver.observe(e))}centerView(){let e=this.container?.nativeElement;if(!e)return;let t=e.getBoundingClientRect();this.panX=t.width/2,this.panY=t.height/2}screenToWorld(e,t){return{x:(e-this.panX)/this.scale,y:(t-this.panY)/this.scale}}worldToScreen(e,t){return{x:e*this.scale+this.panX,y:t*this.scale+this.panY}}scheduleRender(){this.renderPending||(this.renderPending=!0,requestAnimationFrame(()=>{this.renderPending=!1,this.render()}))}render(){this.renderGrid(),this.renderStrokes(),this.renderOverlay()}renderGrid(){if(!this.gridCtx||!this.battleMap)return;let e=this.gridCanvas.nativeElement,t=this.gridCtx,n=window.devicePixelRatio||1;t.clearRect(0,0,e.width/n,e.height/n),t.save(),t.translate(this.panX,this.panY),t.scale(this.scale,this.scale);let r=this.screenToWorld(0,0),o=this.screenToWorld(e.width/n,e.height/n),a=b.getVisibleHexBounds(r.x,o.x,r.y,o.y),s=this.dragHoverHex()||this.dragOverHex,c=new Set(this.battleMap.walls?.map(w=>`${w.q},${w.r}`)||[]),x=this.dragFullPath(),v=new Set(x.map(w=>`${w.q},${w.r}`));for(let w=a.minQ;w<=a.maxQ;w++)for(let S=a.minR;S<=a.maxR;S++){let z={q:w,r:S},h=s&&s.q===w&&s.r===S,M=`${w},${S}`,P=c.has(M),g=v.has(M);this.drawHexagon(t,z,h||!1,P,g)}t.restore()}drawHexagon(e,t,n,r,o){let a=b.hexToPixel(t),s=b.getHexCorners(a);e.beginPath(),e.moveTo(s[0].x,s[0].y);for(let c=1;c<s.length;c++)e.lineTo(s[c].x,s[c].y);e.closePath(),n?(e.fillStyle="rgba(96, 165, 250, 0.4)",e.fill(),e.strokeStyle="rgba(96, 165, 250, 1)",e.lineWidth=3):o?(e.fillStyle="rgba(34, 197, 94, 0.3)",e.fill(),e.strokeStyle="rgba(34, 197, 94, 0.8)",e.lineWidth=2):r?(e.fillStyle="rgba(60, 60, 60, 0.3)",e.fill(),e.strokeStyle="rgba(80, 80, 80, 0.6)",e.lineWidth=2,e.setLineDash([4,2])):(e.fillStyle="rgba(30, 41, 59, 0.5)",e.fill(),e.strokeStyle="rgba(71, 85, 105, 0.6)",e.lineWidth=1),e.stroke(),e.setLineDash([])}renderStrokes(){if(!this.drawCtx||!this.battleMap)return;let e=this.drawCanvas.nativeElement,t=this.drawCtx,n=window.devicePixelRatio||1;t.clearRect(0,0,e.width/n,e.height/n),t.save(),t.translate(this.panX,this.panY),t.scale(this.scale,this.scale);for(let r of this.battleMap.strokes)if(!(r.points.length<2)){t.globalCompositeOperation=r.isEraser?"destination-out":"source-over",t.beginPath(),t.moveTo(r.points[0].x,r.points[0].y);for(let o=1;o<r.points.length;o++)t.lineTo(r.points[o].x,r.points[o].y);t.strokeStyle=r.isEraser?"rgba(0,0,0,1)":r.color,t.lineWidth=r.lineWidth,t.lineCap="round",t.lineJoin="round",t.stroke()}t.globalCompositeOperation="source-over",t.restore()}renderOverlay(){if(!this.overlayCtx)return;let e=this.overlayCtx,t=this.overlayCanvas?.nativeElement;if(!t)return;let n=window.devicePixelRatio||1;e.clearRect(0,0,t.width,t.height),e.save(),e.scale(n,n),this.renderMeasurementOnOverlay(e),this.renderMovementPathOnOverlay(e),e.restore()}renderMeasurementOnOverlay(e){let t=this.measureStart(),n=this.measureEnd();if(!t||!n)return;e.save();let r=this.worldToScreen(t.x,t.y),o=this.worldToScreen(n.x,n.y);e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(o.x,o.y),e.strokeStyle="#fbbf24",e.lineWidth=3,e.setLineDash([10,5]),e.stroke(),e.setLineDash([]),e.fillStyle="#fbbf24",e.beginPath(),e.arc(r.x,r.y,6,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(o.x,o.y,6,0,Math.PI*2),e.fill();let a=(r.x+o.x)/2,s=(r.y+o.y)/2,c=b.pixelToHex(t.x,t.y),x=b.pixelToHex(n.x,n.y),w=b.hexDistance(c,x)*1.5;this.measureDistance.set(w),e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(a-30,s-15,60,24),e.fillStyle="#fbbf24",e.font="bold 14px system-ui",e.textAlign="center",e.textBaseline="middle",e.fillText(`${w.toFixed(1)} m`,a,s),e.restore()}renderMovementPathOnOverlay(e){let t=this.dragPath(),n=this.dragWaypoints(),r=this.dragStartHex(),o=this.dragPathInvalid(),a=this.draggingToken;if(!r||t.length===0)return;e.save();let s=o?"#ef4444":"#22c55e",c=[],x=b.hexToPixel(r);c.push(this.worldToScreen(x.x,x.y));for(let g of n){let B=b.hexToPixel(g);c.push(this.worldToScreen(B.x,B.y))}if(t.length>0){let g=t[t.length-1],B=b.hexToPixel(g);c.push(this.worldToScreen(B.x,B.y))}if(c.length<2){e.restore();return}e.beginPath(),e.moveTo(c[0].x,c[0].y);for(let g=1;g<c.length;g++)e.lineTo(c[g].x,c[g].y);e.strokeStyle=s,e.lineWidth=4,e.lineCap="round",e.lineJoin="round",e.stroke(),e.beginPath(),e.moveTo(c[0].x,c[0].y);for(let g=1;g<c.length;g++)e.lineTo(c[g].x,c[g].y);e.strokeStyle="rgba(255, 255, 255, 0.5)",e.lineWidth=6,e.setLineDash([8,4]),e.stroke(),e.setLineDash([]);for(let g=0;g<n.length;g++){let B=n[g],V=b.hexToPixel(B),ae=this.worldToScreen(V.x,V.y);e.beginPath(),e.arc(ae.x,ae.y,8,0,Math.PI*2),e.fillStyle=o?"#f87171":"#f59e0b",e.fill(),e.strokeStyle="#ffffff",e.lineWidth=2,e.stroke(),e.fillStyle="#000000",e.font="bold 10px system-ui",e.textAlign="center",e.textBaseline="middle",e.fillText(`${g+1}`,ae.x,ae.y)}e.beginPath(),e.arc(c[0].x,c[0].y,6,0,Math.PI*2),e.fillStyle="#3b82f6",e.fill(),e.strokeStyle="#ffffff",e.lineWidth=2,e.stroke();let v=c[c.length-1];e.beginPath(),e.arc(v.x,v.y,6,0,Math.PI*2),e.fillStyle=s,e.fill(),e.strokeStyle="#ffffff",e.lineWidth=2,e.stroke();let w=0,S=r;for(let g of n)w+=b.hexDistance(S,g),S=g;if(t.length>1)w+=t.length-1;else if(t.length===1){let g=t[t.length-1];w+=b.hexDistance(S,g)}let z=w*1.5,M=(a?.movementSpeed||100)*1.5;e.fillStyle="rgba(0, 0, 0, 0.85)";let P=80;e.fillRect(v.x+10,v.y-14,P,28),e.fillStyle=s,e.font="bold 14px system-ui",e.textAlign="center",e.textBaseline="middle",e.fillText(`${z.toFixed(1)}/${M}m`,v.x+10+P/2,v.y),e.restore()}renderMeasurement(){}onMouseDown(e){if(this.closeContextMenu(),this.draggingToken)return;let t=this.container.nativeElement.getBoundingClientRect(),n=e.clientX-t.left,r=e.clientY-t.top,o=this.screenToWorld(n,r);if(e.button===1){e.ctrlKey?(this.isZooming=!0,this.zoomStartY=e.clientY,this.zoomStartScale=this.scale):(this.isPanning=!0,this.lastMouseX=e.clientX,this.lastMouseY=e.clientY),e.preventDefault();return}switch(this.currentTool){case"cursor":e.button===0&&(this.isPanning=!0,this.lastMouseX=e.clientX,this.lastMouseY=e.clientY);break;case"draw":{if(this.isDrawing=!0,this.currentStrokePoints=[o],this.currentStrokeHexes.clear(),this.drawWithWalls){let a=b.pixelToHex(o.x,o.y),s=`${a.q},${a.r}`;this.currentStrokeHexes.add(s),this.store.addWall(a)}break}case"erase":{if(this.isDrawing=!0,this.currentStrokePoints=[o],this.currentStrokeHexes.clear(),this.drawWithWalls){let a=b.pixelToHex(o.x,o.y),s=`${a.q},${a.r}`;this.currentStrokeHexes.add(s),this.store.removeWall(a)}break}case"walls":{let a=b.pixelToHex(o.x,o.y),s=`${a.q},${a.r}`,c=this.battleMap?.walls?.some(x=>x.q===a.q&&x.r===a.r)??!1;this.wallPaintMode=c?"remove":"add",this.wallPaintedHexes.clear(),this.wallPaintedHexes.add(s),this.isWallDrawing=!0,this.wallPaintMode==="add"?this.store.addWall(a):this.store.removeWall(a);break}case"measure":{let a=b.pixelToHex(o.x,o.y),s=b.hexToPixel(a);this.measureStart.set(s),this.measureEnd.set(s);break}}}onMouseMove(e){let t=this.container.nativeElement.getBoundingClientRect(),n=e.clientX-t.left,r=e.clientY-t.top,o=this.screenToWorld(n,r);if(this.isZooming){let s=1+(this.zoomStartY-e.clientY)*.01,c=Math.max(.1,Math.min(5,this.zoomStartScale*s));this.scale=c,this.scheduleRender();return}if(this.draggingToken){this.dragGhostPosition.set({x:e.clientX-t.left,y:e.clientY-t.top});let a=b.pixelToHex(o.x,o.y);if(this.dragHoverHex.set(a),this.dragMode==="enforced"&&!this.draggingToken.isOnTheFly){let s=this.battleMap?.walls||[],c=this.draggingToken.movementSpeed||100,x=this.dragWaypoints(),v=[],w=0,S=this.draggingToken.position,z=!0;v.push(S);for(let g of x){let B=b.findPath(S,g,s,c);if(B&&B.length>1){for(let V=1;V<B.length;V++)v.push(B[V]);w+=B.length-1}else w+=b.hexDistance(S,g),v.push(g),z=!1;S=g}let h=x.length>0?x[x.length-1]:this.draggingToken.position,M=c-w,P=M>0?b.findPath(h,a,s,M):null;if(P&&P.length>0){let B=w+P.length-1>c;for(let V=1;V<P.length;V++)v.push(P[V]);this.dragPathInvalid.set(B),this.dragPath.set(P),this.dragFullPath.set(v)}else this.dragPathInvalid.set(!0),this.dragPath.set([h,a]),v.push(a),this.dragFullPath.set(v)}else this.dragPathInvalid.set(!1),this.dragPath.set([]),this.dragFullPath.set([]);this.scheduleRender();return}if(this.isPanning){let a=e.clientX-this.lastMouseX,s=e.clientY-this.lastMouseY;this.panX+=a,this.panY+=s,this.lastMouseX=e.clientX,this.lastMouseY=e.clientY,this.scheduleRender();return}if(this.isDrawing){let a=performance.now();if(a-this.lastDrawTime<this.drawThrottle)return;if(this.lastDrawTime=a,this.currentStrokePoints.push(o),this.drawWithWalls){let s=b.pixelToHex(o.x,o.y),c=`${s.q},${s.r}`;this.currentStrokeHexes.has(c)||(this.currentStrokeHexes.add(c),this.currentTool==="draw"?this.store.addWall(s):this.currentTool==="erase"&&this.store.removeWall(s))}this.renderLiveStroke();return}if(this.isWallDrawing&&this.currentTool==="walls"){let a=b.pixelToHex(o.x,o.y),s=`${a.q},${a.r}`;this.wallPaintedHexes.has(s)||(this.wallPaintedHexes.add(s),this.wallPaintMode==="add"?this.store.addWall(a):this.store.removeWall(a),this.scheduleRender());return}if(this.isZooming&&e.button===1){this.isZooming=!1;return}if(this.currentTool==="measure"&&this.measureStart()){let a=b.pixelToHex(o.x,o.y),s=b.hexToPixel(a);this.measureEnd.set(s),this.scheduleRender()}}onMouseUp(e){if(this.draggingToken&&e.button===0){let t=this.container.nativeElement.getBoundingClientRect(),n=e.clientX-t.left,r=e.clientY-t.top,o=this.screenToWorld(n,r),a=b.pixelToHex(o.x,o.y);if(this.dragMode==="enforced"&&!this.draggingToken.isOnTheFly)if(this.dragPathInvalid())a=this.draggingToken.position;else{let s=this.dragPath();if(s.length>0){let c=this.draggingToken.movementSpeed||1/0,x=Math.min(s.length-1,c);a=s[x]}else a=this.draggingToken.position}this.tokenMove.emit({tokenId:this.draggingToken.id,position:a}),this.draggingToken=null,this.dragGhostPosition.set(null),this.dragHoverHex.set(null),this.dragPath.set([]),this.dragFullPath.set([]),this.dragWaypoints.set([]),this.dragStartHex.set(null),this.scheduleRender();return}if(this.isWallDrawing&&(this.isWallDrawing=!1,this.wallPaintedHexes.clear(),this.scheduleRender()),this.isDrawing&&this.currentStrokePoints.length>1){let t=this.currentTool==="erase"?this.eraserBrushSize:this.penBrushSize;this.store.addStroke({points:this.currentStrokePoints,color:this.brushColor,lineWidth:t,isEraser:this.currentTool==="erase"})}this.isPanning=!1,this.isDrawing=!1,this.currentStrokePoints=[],this.currentTool==="measure"&&(this.measureStart.set(null),this.measureEnd.set(null),this.measureDistance.set(0),this.scheduleRender())}onMouseLeave(){if(this.draggingToken&&(this.draggingToken=null,this.dragGhostPosition.set(null),this.dragHoverHex.set(null),this.dragPath.set([]),this.dragFullPath.set([]),this.dragWaypoints.set([]),this.dragStartHex.set(null),this.scheduleRender()),this.isWallDrawing&&(this.isWallDrawing=!1,this.wallPaintedHexes.clear()),this.isDrawing&&this.currentStrokePoints.length>1){let e=this.currentTool==="erase"?this.eraserBrushSize:this.penBrushSize;this.store.addStroke({points:this.currentStrokePoints,color:this.brushColor,lineWidth:e,isEraser:this.currentTool==="erase"})}this.isPanning=!1,this.isDrawing=!1,this.currentStrokePoints=[],this.scheduleRender()}onPointerDown(e){if(e.target.setPointerCapture(e.pointerId),e.pointerType==="pen"&&e.altKey&&e.button===0){e.ctrlKey?(this.isZooming=!0,this.zoomStartY=e.clientY,this.zoomStartScale=this.scale):(this.isPanning=!0,this.lastMouseX=e.clientX,this.lastMouseY=e.clientY),e.preventDefault();return}if(e.shiftKey&&(this.currentTool==="draw"||this.currentTool==="erase")){this.isResizingBrush=!0,this.brushResizeStartX=e.clientX,this.brushResizeStartSize=this.currentTool==="erase"?this.eraserBrushSize:this.penBrushSize;let t=this.container.nativeElement.getBoundingClientRect();this.brushResizePreview.set({x:e.clientX-t.left,y:e.clientY-t.top,size:this.brushResizeStartSize}),e.preventDefault();return}if(e.pointerType==="pen"&&e.buttons&4){e.ctrlKey?(this.isZooming=!0,this.zoomStartY=e.clientY,this.zoomStartScale=this.scale):this.isPanning=!0,e.preventDefault();return}this.onMouseDown(e)}onPointerMove(e){if(this.isZooming){let n=1+(this.zoomStartY-e.clientY)*.01,r=Math.max(.1,Math.min(5,this.zoomStartScale*n));this.scale=r,this.scheduleRender();return}if(this.isResizingBrush){let t=e.clientX-this.brushResizeStartX,n=Math.max(1,Math.min(100,Math.round(this.brushResizeStartSize+t*.5))),r=this.container.nativeElement.getBoundingClientRect();this.brushResizePreview.set({x:e.clientX-r.left,y:e.clientY-r.top,size:n});return}this.onMouseMove(e)}onPointerUp(e){if(e.target.releasePointerCapture(e.pointerId),this.isZooming){this.isZooming=!1;return}if(this.isResizingBrush){let t=this.brushResizePreview();t&&this.brushSizeChange.emit(t.size),this.isResizingBrush=!1,this.brushResizePreview.set(null);return}this.onMouseUp(e)}onPointerLeave(e){e.target.hasPointerCapture(e.pointerId)||(this.isResizingBrush&&(this.isResizingBrush=!1,this.brushResizePreview.set(null)),this.onMouseLeave())}onContextMenu(e){if(e.preventDefault(),e.stopPropagation(),this.draggingToken&&this.dragMode==="enforced"&&!this.draggingToken.isOnTheFly){let t=this.container.nativeElement.getBoundingClientRect(),n=e.clientX-t.left,r=e.clientY-t.top,o=this.screenToWorld(n,r),a=b.pixelToHex(o.x,o.y),s=this.dragWaypoints();s.some(x=>x.q===a.q&&x.r===a.r)||(this.dragWaypoints.set([...s,a]),this.scheduleRender());return}if(this.currentTool==="cursor"&&!this.draggingToken){let t=this.container.nativeElement.getBoundingClientRect(),n=e.clientX-t.left,r=e.clientY-t.top,o=this.screenToWorld(n,r),a=b.pixelToHex(o.x,o.y);this.battleMap?.tokens.some(c=>c.position.q===a.q&&c.position.r===a.r)||(this.contextMenuPosition.set({x:e.clientX-t.left,y:e.clientY-t.top}),this.contextMenuHex.set(a),this.showContextMenu.set(!0))}}closeContextMenu(){this.showContextMenu.set(!1),this.contextMenuHex.set(null)}onCreateQuickToken(){let e=this.contextMenuHex();if(e){let t=prompt("Enter token name:","Enemy");t&&this.store.addToken({characterId:de(),characterName:t,position:e,team:"red",isOnTheFly:!0})}this.closeContextMenu()}onWheel(e){e.preventDefault();let t=this.container.nativeElement.getBoundingClientRect(),n=e.clientX-t.left,r=e.clientY-t.top,o=e.deltaY>0?.9:1.1,a=Math.max(.2,Math.min(3,this.scale*o));this.panX=n-(n-this.panX)*(a/this.scale),this.panY=r-(r-this.panY)*(a/this.scale),this.scale=a,this.scheduleRender()}onDragEnter(e){e.preventDefault(),e.stopPropagation(),this.isExternalDragActive=!0}onDragOver(e){e.preventDefault(),e.stopPropagation(),this.isExternalDragActive||(this.isExternalDragActive=!0),e.dataTransfer&&(e.dataTransfer.dropEffect="copy");let t=this.container.nativeElement.getBoundingClientRect(),n=e.clientX-t.left,r=e.clientY-t.top,o=this.screenToWorld(n,r),a=b.pixelToHex(o.x,o.y);(!this.dragOverHex||this.dragOverHex.q!==a.q||this.dragOverHex.r!==a.r)&&(this.dragOverHex=a,this.scheduleRender())}onDragLeave(e){let t=this.container.nativeElement.getBoundingClientRect(),n=e.clientX,r=e.clientY;(n<t.left||n>t.right||r<t.top||r>t.bottom)&&(this.isExternalDragActive=!1,this.dragOverHex=null,this.scheduleRender())}onDrop(e){e.preventDefault(),e.stopPropagation(),this.isExternalDragActive=!1;let t=e.dataTransfer?.getData("text/plain");if(!t){console.log("[BATTLEMAP GRID] Drop event has no characterId");return}let n=this.container.nativeElement.getBoundingClientRect(),r=e.clientX-n.left,o=e.clientY-n.top,a=this.screenToWorld(r,o),s=b.pixelToHex(a.x,a.y);console.log("[BATTLEMAP GRID] Dropping character",t,"at hex",s),this.dragOverHex=null,this.tokenDrop.emit({characterId:t,position:s}),this.scheduleRender()}onTokenDragStart(e,t){this.draggingToken=e;let n=this.container.nativeElement.getBoundingClientRect();this.dragGhostPosition.set({x:t.clientX-n.left,y:t.clientY-n.top});let r=this.screenToWorld(t.clientX-n.left,t.clientY-n.top);this.dragHoverHex.set(b.pixelToHex(r.x,r.y)),this.dragWaypoints.set([]),this.dragStartHex.set(e.position)}onTokenDragMove(e){}onTokenDragEnd(e,t){}renderLiveStroke(){if(!this.drawCtx||this.currentStrokePoints.length<2)return;let e=this.drawCtx,t=this.currentStrokePoints;this.renderStrokes(),e.save(),e.translate(this.panX,this.panY),e.scale(this.scale,this.scale);let n=this.currentTool==="erase",r=n?this.eraserBrushSize:this.penBrushSize;e.globalCompositeOperation=n?"destination-out":"source-over",e.beginPath(),e.moveTo(t[0].x,t[0].y);for(let o=1;o<t.length;o++)e.lineTo(t[o].x,t[o].y);e.strokeStyle=n?"rgba(0,0,0,1)":this.brushColor,e.lineWidth=r,e.lineCap="round",e.lineJoin="round",e.stroke(),e.globalCompositeOperation="source-over",e.restore()}getTokenScreenPosition(e){return b.hexToPixel(e.position)}isTokenCurrentTurn(e){return e.characterId===this.currentTurnCharacterId}get ghostWidth(){return b.WIDTH*.9*this.scale}get ghostHeight(){return b.HEIGHT*.9*this.scale}getInitials(e){return e?e.split(" ").filter(t=>t.length>0).map(t=>t[0]).join("").substring(0,2).toUpperCase():"??"}getSyncedTeam(e){return e.isOnTheFly?e.team:this.battleParticipants.find(n=>n.characterId===e.characterId)?.team||e.team}getTeamColor(e){switch(e){case"red":return"#ef4444";case"blue":return"#3b82f6";case"green":return"#22c55e";case"yellow":return"#eab308";case"purple":return"#a855f7";default:return"#60a5fa"}}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=F({type:i,selectors:[["app-battlemap-grid"]],viewQuery:function(t,n){if(t&1&&ge(Ue,5)(Ye,5)(Xe,5)(Ke,5),t&2){let r;oe(r=ie())&&(n.gridCanvas=r.first),oe(r=ie())&&(n.drawCanvas=r.first),oe(r=ie())&&(n.overlayCanvas=r.first),oe(r=ie())&&(n.container=r.first)}},hostBindings:function(t,n){t&1&&G("keydown",function(o){return n.onKeyDown(o)},te)},inputs:{battleMap:"battleMap",currentTool:"currentTool",brushColor:"brushColor",penBrushSize:"penBrushSize",eraserBrushSize:"eraserBrushSize",drawWithWalls:"drawWithWalls",dragMode:"dragMode",currentTurnCharacterId:"currentTurnCharacterId",battleParticipants:"battleParticipants",drawLayerVisible:"drawLayerVisible"},outputs:{tokenDrop:"tokenDrop",tokenMove:"tokenMove",tokenRemove:"tokenRemove",quickTokenDrop:"quickTokenDrop",brushSizeChange:"brushSizeChange"},features:[Se],decls:13,vars:18,consts:[["container",""],["gridCanvas",""],["drawCanvas",""],["overlayCanvas",""],[1,"grid-container",3,"pointerdown","pointermove","pointerup","pointerleave","pointercancel","wheel","contextmenu","dragenter","dragover","dragleave","drop"],[1,"grid-canvas"],[1,"draw-canvas"],[1,"tokens-layer"],[1,"overlay-canvas"],[1,"drag-ghost",3,"left","top","width","height","--team-color"],[1,"grid-context-menu",3,"left","top"],[1,"brush-resize-preview",3,"left","top","width","height"],[3,"token","isCurrentTurn","position","scale","currentTool","syncedTeam"],[3,"dragStart","dragEnd","remove","token","isCurrentTurn","position","scale","currentTool","syncedTeam"],[1,"drag-ghost"],[1,"ghost-hexagon"],["draggable","false",1,"ghost-portrait",3,"src","alt"],[1,"ghost-initials"],[1,"grid-context-menu",3,"click"],[1,"context-menu-item",3,"click"],[1,"brush-resize-preview"],[1,"brush-size-label"]],template:function(t,n){if(t&1){let r=O();R(0,"div",4,0),G("pointerdown",function(a){return f(r),C(n.onPointerDown(a))})("pointermove",function(a){return f(r),C(n.onPointerMove(a))})("pointerup",function(a){return f(r),C(n.onPointerUp(a))})("pointerleave",function(a){return f(r),C(n.onPointerLeave(a))})("pointercancel",function(a){return f(r),C(n.onPointerLeave(a))})("wheel",function(a){return f(r),C(n.onWheel(a))})("contextmenu",function(a){return f(r),C(n.onContextMenu(a))})("dragenter",function(a){return f(r),C(n.onDragEnter(a))})("dragover",function(a){return f(r),C(n.onDragOver(a))})("dragleave",function(a){return f(r),C(n.onDragLeave(a))})("drop",function(a){return f(r),C(n.onDrop(a))}),re(2,"canvas",5,1)(4,"canvas",6,2),R(6,"div",7),k(7,Je,2,0),q(),re(8,"canvas",8,3),k(10,nt,4,11,"div",9),k(11,rt,5,4,"div",10),k(12,ot,4,12,"div",11),q()}t&2&&(H("tool-cursor",n.currentTool==="cursor")("tool-draw",n.currentTool==="draw")("tool-erase",n.currentTool==="erase")("tool-walls",n.currentTool==="walls")("tool-measure",n.currentTool==="measure")("external-drag-active",n.isExternalDragActive),p(6),W("transform","translate("+n.panX+"px, "+n.panY+"px) scale("+n.scale+")"),p(),T(n.battleMap?7:-1),p(3),T(n.draggingToken&&n.dragGhostPosition()?10:-1),p(),T(n.showContextMenu()?11:-1),p(),T(n.brushResizePreview()?12:-1))},dependencies:[j,ve,He,Z],styles:[".grid-container[_ngcontent-%COMP%]{position:relative;width:100%;height:100%;overflow:hidden;background:#e8e8e8;background-image:radial-gradient(circle at 50% 50%,rgba(200,200,200,.3) 0%,transparent 50%);touch-action:none}.grid-canvas[_ngcontent-%COMP%], .draw-canvas[_ngcontent-%COMP%], .overlay-canvas[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}.draw-canvas[_ngcontent-%COMP%]{z-index:1;transition:opacity .2s ease}.overlay-canvas[_ngcontent-%COMP%]{z-index:100}.tokens-layer[_ngcontent-%COMP%]{position:absolute;top:0;left:0;transform-origin:0 0;pointer-events:none;z-index:10}.tokens-layer[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{pointer-events:auto}.grid-container.external-drag-active[_ngcontent-%COMP%]   .tokens-layer[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{pointer-events:none}.drag-ghost[_ngcontent-%COMP%]{position:absolute;transform:translate(-50%,-50%);pointer-events:none;z-index:50;opacity:.9;filter:drop-shadow(0 4px 12px rgba(0,0,0,.4))}.ghost-hexagon[_ngcontent-%COMP%]{width:100%;height:100%;clip-path:polygon(25% 0%,75% 0%,100% 50%,75% 100%,25% 100%,0% 50%);background:var(--team-color, #60a5fa);display:flex;align-items:center;justify-content:center;overflow:hidden}.ghost-portrait[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.ghost-initials[_ngcontent-%COMP%]{font-size:1.2rem;font-weight:700;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.5)}.grid-container.tool-cursor[_ngcontent-%COMP%]{cursor:default}.grid-container.tool-draw[_ngcontent-%COMP%]{cursor:crosshair}.grid-container.tool-erase[_ngcontent-%COMP%]{cursor:cell}.grid-container.tool-walls[_ngcontent-%COMP%]{cursor:pointer}.grid-container.tool-measure[_ngcontent-%COMP%]{cursor:crosshair}.grid-context-menu[_ngcontent-%COMP%]{position:absolute;z-index:2000;background:var(--card);border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 16px #0000004d;min-width:150px;padding:4px}.context-menu-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;width:100%;padding:10px 12px;border:none;background:transparent;color:var(--text);cursor:pointer;font-size:.9rem;border-radius:4px;transition:background .15s}.context-menu-item[_ngcontent-%COMP%]:hover{background:var(--accent);color:#fff}.brush-resize-preview[_ngcontent-%COMP%]{position:absolute;transform:translate(-50%,-50%);pointer-events:none;z-index:200;border:2px dashed #fff;border-radius:50%;box-shadow:0 0 0 2px #00000080,inset 0 0 0 1px #ffffff4d;display:flex;align-items:center;justify-content:center}.brush-size-label[_ngcontent-%COMP%]{background:#000000b3;color:#fff;padding:2px 6px;border-radius:4px;font-size:12px;font-weight:700}"],changeDetection:0})};var it=(i,e)=>e.id;function at(i,e){if(i&1){let t=O();l(0,"button",13),y("click",function(){let r=f(t).$implicit,o=m();return C(o.selectTool(r.id))}),l(1,"span",3),u(2),d()()}if(i&2){let t=e.$implicit,n=m();H("active",n.currentTool===t.id),I("title",t.label),p(2),L(t.icon)}}function st(i,e){if(i&1){let t=O();l(0,"button",25),y("click",function(){let r=f(t).$implicit,o=m(2);return C(o.selectColor(r))}),d()}if(i&2){let t=e.$implicit,n=m(2);W("background",t)("border-color",t==="#ffffff"?"#666":t),H("active",n.brushColor===t)}}function lt(i,e){if(i&1){let t=O();l(0,"button",26),y("click",function(){let r=f(t).$implicit,o=m(2);return C(o.selectPenSize(r))}),A(1,"span",27),d()}if(i&2){let t=e.$implicit,n=m(2);H("active",n.penBrushSize===t),I("title",t+"px"),p(),W("width",t,"px")("height",t,"px")}}function ct(i,e){if(i&1){let t=O();l(0,"div",7)(1,"label",14)(2,"input",15),y("change",function(){f(t);let r=m();return C(r.toggleDrawWithWalls())}),d(),l(3,"span",16),u(4,"+\u{1F9F1}"),d()(),l(5,"div",17),N(6,st,1,6,"button",18,he),l(8,"label",19)(9,"input",20),y("input",function(r){f(t);let o=m();return C(o.onColorInput(r))}),d(),A(10,"span",21),d()(),l(11,"div",22)(12,"span",23),u(13,"Size:"),d(),N(14,lt,2,7,"button",24,he),d()()}if(i&2){let t=m();p(2),I("checked",t.drawWithWalls),p(4),$(t.presetColors),p(3),I("value",t.brushColor),p(),W("background",t.brushColor),p(4),$(t.penBrushSizes)}}function dt(i,e){if(i&1){let t=O();l(0,"button",26),y("click",function(){let r=f(t).$implicit,o=m(2);return C(o.selectEraserSize(r))}),A(1,"span",27),d()}if(i&2){let t=e.$implicit,n=m(2);H("active",n.eraserBrushSize===t),I("title",t+"px"),p(),W("width",n.clampSize(t),"px")("height",n.clampSize(t),"px")}}function pt(i,e){if(i&1){let t=O();l(0,"div",7)(1,"label",28)(2,"input",15),y("change",function(){f(t);let r=m();return C(r.toggleDrawWithWalls())}),d(),l(3,"span",16),u(4,"-\u{1F9F1}"),d()(),l(5,"div",22)(6,"span",23),u(7,"Size:"),d(),N(8,dt,2,7,"button",24,he),d()()}if(i&2){let t=m();p(2),I("checked",t.drawWithWalls),p(6),$(t.eraserBrushSizes)}}function mt(i,e){if(i&1){let t=O();l(0,"div",7)(1,"button",29),y("click",function(){f(t);let r=m();return C(r.clearWalls.emit())}),u(2," \u{1F5D1}\uFE0F Clear Walls "),d()()}}function ut(i,e){if(i&1){let t=O();l(0,"div",8)(1,"span",30),u(2,"Mode:"),d(),l(3,"button",31),y("click",function(){f(t);let r=m();return C(r.setDragMode("free"))}),u(4," Free "),d(),l(5,"button",32),y("click",function(){f(t);let r=m();return C(r.setDragMode("enforced"))}),u(6," Enforced "),d()()}if(i&2){let t=m();p(3),H("active",t.dragMode==="free"),p(2),H("active",t.dragMode==="enforced")}}function ht(i,e){if(i&1){let t=O();l(0,"div",42)(1,"label"),u(2,"Preview:"),d(),l(3,"img",46),y("error",function(r){f(t);let o=m(2);return C(o.onImageError(r))}),d()()}if(i&2){let t=m(2);p(3),I("src",t.getProxiedUrl(t.quickTokenImageUrl()),Y)}}function gt(i,e){if(i&1){let t=O();l(0,"div",33),y("click",function(){f(t);let r=m();return C(r.closeQuickTokenModal())}),l(1,"div",34),y("click",function(r){return f(t),C(r.stopPropagation())}),l(2,"div",35)(3,"h3"),u(4,"Create Quick Token"),d(),l(5,"button",36),y("click",function(){f(t);let r=m();return C(r.closeQuickTokenModal())}),u(6,"\u2715"),d()(),l(7,"div",37)(8,"div",38)(9,"label"),u(10,"Token Name"),d(),l(11,"input",39),y("input",function(r){f(t);let o=m();return C(o.quickTokenName.set(r.target.value))}),d()(),l(12,"div",38)(13,"label"),u(14,"Image URL (optional)"),d(),l(15,"input",40),y("input",function(r){f(t);let o=m();return C(o.quickTokenImageUrl.set(r.target.value))}),d(),l(16,"p",41),u(17,"Paste a direct link to a token image, or leave empty for initials only."),d()(),k(18,ht,4,1,"div",42),d(),l(19,"div",43)(20,"button",44),y("click",function(){f(t);let r=m();return C(r.closeQuickTokenModal())}),u(21,"Cancel"),d(),l(22,"button",45),y("click",function(){f(t);let r=m();return C(r.createQuickToken())}),u(23,"Create Token"),d()()()()}if(i&2){let t=m();p(11),I("value",t.quickTokenName()),p(4),I("value",t.quickTokenImageUrl()),p(3),T(t.quickTokenImageUrl()?18:-1)}}var we=class i{currentTool="cursor";brushColor="#000000";penBrushSize=4;eraserBrushSize=12;drawWithWalls=!1;dragMode="free";drawLayerVisible=!0;toolChange=new E;brushColorChange=new E;penBrushSizeChange=new E;eraserBrushSizeChange=new E;drawWithWallsChange=new E;dragModeChange=new E;drawLayerVisibleChange=new E;toggleCharacterList=new E;toggleBattleTracker=new E;clearDrawings=new E;clearWalls=new E;quickTokenCreate=new E;tools=[{id:"cursor",icon:"\u2196\uFE0F",label:"Move Tokens (Middle-click to pan)"},{id:"draw",icon:"\u270F\uFE0F",label:"Draw"},{id:"erase",icon:"\u{1F9F9}",label:"Erase"},{id:"walls",icon:"\u{1F9F1}",label:"Walls"},{id:"measure",icon:"\u{1F4CF}",label:"Measure Distance"}];penBrushSizes=[2,4,8,12,20];eraserBrushSizes=[8,12,20,32,48];clampSize(e){return Math.min(e,24)}presetColors=["#ef4444","#f97316","#eab308","#22c55e","#3b82f6","#8b5cf6","#ec4899","#ffffff","#000000"];showQuickTokenModal=_(!1);quickTokenName=_("");quickTokenImageUrl=_("");selectTool(e){this.toolChange.emit(e)}selectColor(e){this.brushColorChange.emit(e)}selectPenSize(e){this.penBrushSizeChange.emit(e)}selectEraserSize(e){this.eraserBrushSizeChange.emit(e)}toggleDrawWithWalls(){this.drawWithWallsChange.emit(!this.drawWithWalls)}setDragMode(e){this.dragModeChange.emit(e)}onColorInput(e){let t=e.target;this.brushColorChange.emit(t.value)}openQuickTokenModal(){this.showQuickTokenModal.set(!0),this.quickTokenName.set(""),this.quickTokenImageUrl.set("")}closeQuickTokenModal(){this.showQuickTokenModal.set(!1)}getProxiedUrl(e){return e?e.startsWith("/api/")||e.startsWith("data:")?e:`/api/images/proxy?url=${encodeURIComponent(e)}`:""}onImageError(e){let t=e.target;t.style.display="none"}async createQuickToken(){let e=this.quickTokenName(),t=this.quickTokenImageUrl();if(!e.trim()){alert("Please enter a token name");return}let n="";if(t&&t.trim())try{let r=await fetch("/api/images/download",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t,name:e})});if(r.ok){let o=await r.json();o.success&&o.imageId&&(n=o.imageId)}}catch(r){console.error("Failed to download image:",r)}this.quickTokenCreate.emit({name:e,portrait:n,position:{q:0,r:0}}),this.closeQuickTokenModal()}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=F({type:i,selectors:[["app-battlemap-toolbar"]],inputs:{currentTool:"currentTool",brushColor:"brushColor",penBrushSize:"penBrushSize",eraserBrushSize:"eraserBrushSize",drawWithWalls:"drawWithWalls",dragMode:"dragMode",drawLayerVisible:"drawLayerVisible"},outputs:{toolChange:"toolChange",brushColorChange:"brushColorChange",penBrushSizeChange:"penBrushSizeChange",eraserBrushSizeChange:"eraserBrushSizeChange",drawWithWallsChange:"drawWithWallsChange",dragModeChange:"dragModeChange",drawLayerVisibleChange:"drawLayerVisibleChange",toggleCharacterList:"toggleCharacterList",toggleBattleTracker:"toggleBattleTracker",clearDrawings:"clearDrawings",clearWalls:"clearWalls",quickTokenCreate:"quickTokenCreate"},decls:24,vars:7,consts:[[1,"toolbar"],[1,"toolbar-section"],["title","Toggle Character List",1,"toolbar-btn",3,"click"],[1,"btn-icon"],["title","Quick Token",1,"toolbar-btn",3,"click"],[1,"toolbar-section","tools"],[1,"toolbar-btn",3,"active","title"],[1,"toolbar-section","brush-settings"],[1,"toolbar-section","drag-mode-settings"],[1,"layer-toggles"],["title","Toggle Drawing Layer visibility",1,"layer-toggle-btn",3,"click"],["title","Toggle Battle Tracker",1,"toolbar-btn",3,"click"],[1,"modal-overlay"],[1,"toolbar-btn",3,"click","title"],["title","Also place walls while drawing",1,"wall-mode-toggle"],["type","checkbox",3,"change","checked"],[1,"toggle-label"],[1,"color-picker"],[1,"color-swatch",3,"active","background","border-color"],[1,"custom-color"],["type","color",3,"input","value"],[1,"custom-color-preview"],[1,"size-picker"],[1,"size-label"],[1,"size-btn",3,"active","title"],[1,"color-swatch",3,"click"],[1,"size-btn",3,"click","title"],[1,"size-dot"],["title","Also remove walls while erasing",1,"wall-mode-toggle"],["title","Clear all walls",1,"action-btn","danger",3,"click"],[1,"mode-label"],["title","Free movement - no restrictions",1,"mode-btn",3,"click"],["title","Enforced - respects movement speed and walls",1,"mode-btn",3,"click"],[1,"modal-overlay",3,"click"],[1,"modal-content",3,"click"],[1,"modal-header"],[1,"modal-close",3,"click"],[1,"modal-body"],[1,"form-group"],["type","text","placeholder","e.g., Goblin, Dragon...",3,"input","value"],["type","text","placeholder","https://example.com/image.png",3,"input","value"],[1,"form-hint"],[1,"selected-preview"],[1,"modal-footer"],[1,"btn-secondary",3,"click"],[1,"btn-primary",3,"click"],["alt","Token preview",3,"error","src"]],template:function(t,n){t&1&&(l(0,"div",0)(1,"div",1)(2,"button",2),y("click",function(){return n.toggleCharacterList.emit()}),l(3,"span",3),u(4,"\u{1F465}"),d()(),l(5,"button",4),y("click",function(){return n.openQuickTokenModal()}),l(6,"span",3),u(7,"\u2795"),d()()(),l(8,"div",5),N(9,at,3,4,"button",6,it),d(),k(11,ct,16,4,"div",7),k(12,pt,10,1,"div",7),k(13,mt,3,0,"div",7),k(14,ut,7,4,"div",8),l(15,"div",1)(16,"div",9)(17,"button",10),y("click",function(){return n.drawLayerVisibleChange.emit(!n.drawLayerVisible)}),l(18,"span",3),u(19,"\u270F\uFE0F"),d()()(),l(20,"button",11),y("click",function(){return n.toggleBattleTracker.emit()}),l(21,"span",3),u(22,"\u2694\uFE0F"),d()()()(),k(23,gt,24,3,"div",12)),t&2&&(p(9),$(n.tools),p(2),T(n.currentTool==="draw"?11:-1),p(),T(n.currentTool==="erase"?12:-1),p(),T(n.currentTool==="walls"?13:-1),p(),T(n.currentTool==="cursor"?14:-1),p(3),H("active",n.drawLayerVisible),p(6),T(n.showQuickTokenModal()?23:-1))},dependencies:[j,Le],styles:[".toolbar[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;padding:.5rem 1rem;background:var(--card);border-bottom:1px solid var(--border);gap:1rem;min-height:60px}.toolbar-section[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.toolbar-section.tools[_ngcontent-%COMP%]{background:var(--bg);padding:.25rem;border-radius:8px}.toolbar-btn[_ngcontent-%COMP%]{width:44px;height:44px;border-radius:8px;background:transparent;border:1px solid transparent;color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}.toolbar-btn[_ngcontent-%COMP%]:hover{background:var(--border)}.toolbar-btn.active[_ngcontent-%COMP%]{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 0 10px #8b5cf666}.btn-icon[_ngcontent-%COMP%]{font-size:1.4rem}.brush-settings[_ngcontent-%COMP%]{background:var(--bg);padding:.5rem;border-radius:8px;gap:1rem}.color-picker[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.25rem}.color-swatch[_ngcontent-%COMP%]{width:28px;height:28px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:all .2s}.color-swatch[_ngcontent-%COMP%]:hover{transform:scale(1.15)}.color-swatch.active[_ngcontent-%COMP%]{border-color:#fff;box-shadow:0 0 0 2px var(--accent);transform:scale(1.1)}.custom-color[_ngcontent-%COMP%]{position:relative;width:28px;height:28px;cursor:pointer}.custom-color[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{position:absolute;opacity:0;width:100%;height:100%;cursor:pointer}.custom-color-preview[_ngcontent-%COMP%]{display:block;width:100%;height:100%;border-radius:50%;border:2px dashed var(--border);background:conic-gradient(red,#ff0,#0f0,#0ff,#00f,#f0f,red)}.size-picker[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.25rem}.size-btn[_ngcontent-%COMP%]{width:32px;height:32px;border-radius:6px;background:transparent;border:1px solid transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}.size-btn[_ngcontent-%COMP%]:hover{background:var(--border)}.size-btn.active[_ngcontent-%COMP%]{background:var(--accent);border-color:var(--accent)}.size-dot[_ngcontent-%COMP%]{border-radius:50%;background:var(--text);max-width:24px;max-height:24px}.size-btn.active[_ngcontent-%COMP%]   .size-dot[_ngcontent-%COMP%]{background:#fff}.size-label[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-muted);margin-right:.25rem}.wall-mode-toggle[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;cursor:pointer;padding:.25rem .5rem;border-radius:6px;background:var(--border);transition:all .2s}.wall-mode-toggle[_ngcontent-%COMP%]:has(input:checked){background:#dc2626;color:#fff}.wall-mode-toggle[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{display:none}.toggle-label[_ngcontent-%COMP%]{font-size:.85rem;font-weight:500}.drag-mode-settings[_ngcontent-%COMP%]{background:var(--bg);padding:.5rem;border-radius:8px;gap:.5rem}.mode-label[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-muted)}.mode-btn[_ngcontent-%COMP%]{padding:.35rem .75rem;border-radius:6px;background:transparent;border:1px solid var(--border);color:var(--text);font-size:.8rem;cursor:pointer;transition:all .2s}.mode-btn[_ngcontent-%COMP%]:hover{background:var(--border)}.mode-btn.active[_ngcontent-%COMP%]{background:var(--accent);border-color:var(--accent);color:#fff}.modal-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background:#000000b3;display:flex;align-items:center;justify-content:center;z-index:1000}.modal-content[_ngcontent-%COMP%]{background:var(--card);border-radius:12px;width:90%;max-width:500px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column}.modal-header[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;padding:1rem;border-bottom:1px solid var(--border)}.modal-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:1.1rem}.modal-close[_ngcontent-%COMP%]{background:transparent;border:none;color:var(--text-muted);font-size:1.2rem;cursor:pointer;padding:.25rem;line-height:1}.modal-close[_ngcontent-%COMP%]:hover{color:var(--text)}.modal-body[_ngcontent-%COMP%]{padding:1rem;overflow-y:auto;flex:1}.form-group[_ngcontent-%COMP%]{margin-bottom:1rem}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;font-size:.85rem;color:var(--text-muted);margin-bottom:.5rem}.form-group[_ngcontent-%COMP%]   input[type=text][_ngcontent-%COMP%]{width:100%;padding:.5rem .75rem;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:.9rem}.form-group[_ngcontent-%COMP%]   input[type=text][_ngcontent-%COMP%]:focus{outline:none;border-color:var(--accent)}.form-group[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{width:100%;padding:.75rem;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:.9rem;font-family:inherit;resize:vertical;min-height:100px}.form-group[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]:focus{outline:none;border-color:var(--accent)}.modal-wide[_ngcontent-%COMP%]{max-width:600px}.search-row[_ngcontent-%COMP%]{display:flex;gap:.5rem}.search-row[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{flex:1}.search-btn[_ngcontent-%COMP%]{padding:.5rem 1rem;border:1px solid var(--border);border-radius:6px;background:var(--accent);color:#fff;cursor:pointer}.search-btn[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.image-results[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;margin-top:1rem}.image-result[_ngcontent-%COMP%]{aspect-ratio:1;border:2px solid transparent;border-radius:8px;overflow:hidden;cursor:pointer;background:var(--bg);padding:0}.image-result[_ngcontent-%COMP%]:hover{border-color:var(--accent)}.image-result.selected[_ngcontent-%COMP%]{border-color:var(--accent);box-shadow:0 0 10px #8b5cf680}.image-result[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.selected-preview[_ngcontent-%COMP%]{margin-top:1rem;text-align:center}.selected-preview[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{font-size:.85rem;color:var(--text-muted)}.selected-preview[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:80px;height:80px;border-radius:8px;object-fit:cover;margin-top:.5rem}.modal-footer[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:.75rem;padding:1rem;border-top:1px solid var(--border)}.btn-secondary[_ngcontent-%COMP%]{padding:.5rem 1rem;border:1px solid var(--border);border-radius:6px;background:transparent;color:var(--text);cursor:pointer}.btn-secondary[_ngcontent-%COMP%]:hover{background:var(--border)}.btn-primary[_ngcontent-%COMP%]{padding:.5rem 1rem;border:none;border-radius:6px;background:var(--accent);color:#fff;cursor:pointer}.btn-primary[_ngcontent-%COMP%]:hover{opacity:.9}.toolbar-separator[_ngcontent-%COMP%]{width:1px;height:30px;background:var(--border);margin:0 .5rem}.toolbar-btn.ai-toggle[_ngcontent-%COMP%]{position:relative}.toolbar-btn.ai-toggle[_ngcontent-%COMP%]:disabled{opacity:.4;cursor:not-allowed}.toolbar-btn.ai-toggle.available[_ngcontent-%COMP%]:not(.active){border-color:#22c55e}.toolbar-btn.ai-toggle.active[_ngcontent-%COMP%]{background:linear-gradient(135deg,#8b5cf6,#ec4899);border-color:transparent;animation:_ngcontent-%COMP%_ai-pulse 2s infinite}.toolbar-btn.ai-toggle.generating[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_ai-generating .5s infinite alternate}.generating-indicator[_ngcontent-%COMP%]{position:absolute;bottom:2px;right:2px;width:8px;height:8px;background:#fbbf24;border-radius:50%;animation:_ngcontent-%COMP%_blink .5s infinite alternate}@keyframes _ngcontent-%COMP%_ai-pulse{0%,to{box-shadow:0 0 10px #8b5cf666}50%{box-shadow:0 0 20px #ec489999}}@keyframes _ngcontent-%COMP%_ai-generating{0%{transform:scale(1)}to{transform:scale(1.05)}}@keyframes _ngcontent-%COMP%_blink{0%{opacity:.4}to{opacity:1}}.layer-toggles[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.25rem;background:var(--bg);padding:.25rem;border-radius:8px;margin-right:.5rem}.layer-toggle-btn[_ngcontent-%COMP%]{width:36px;height:36px;border-radius:6px;background:transparent;border:1px solid transparent;color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;opacity:.4}.layer-toggle-btn[_ngcontent-%COMP%]:hover{background:var(--border);opacity:.7}.layer-toggle-btn.active[_ngcontent-%COMP%]{opacity:1;background:var(--card);border-color:var(--border)}.layer-toggle-btn[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{font-size:1.1rem}.settings-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem}.input-with-button[_ngcontent-%COMP%]{display:flex;gap:.5rem}.input-with-button[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{flex:1}.btn-small[_ngcontent-%COMP%]{padding:.5rem;border:1px solid var(--border);border-radius:6px;background:var(--bg);cursor:pointer;font-size:1rem;transition:all .2s}.btn-small[_ngcontent-%COMP%]:hover{background:var(--border)}input[type=range][_ngcontent-%COMP%]{width:100%;height:6px;border-radius:3px;background:var(--border);outline:none;-webkit-appearance:none;appearance:none}input[type=range][_ngcontent-%COMP%]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;background:var(--accent);cursor:pointer;transition:all .2s}input[type=range][_ngcontent-%COMP%]::-webkit-slider-thumb:hover{transform:scale(1.15)}input[type=number][_ngcontent-%COMP%]{width:100%;padding:.5rem;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);font-size:.9rem}@media(max-width:600px){.settings-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}}.color-prompts-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1rem;margin-bottom:1rem}.color-prompt-row[_ngcontent-%COMP%]{display:grid;grid-template-columns:40px 100px 150px 1fr 40px;gap:.75rem;align-items:end;padding:.75rem;background:var(--bg);border-radius:8px;border:1px solid var(--border)}.color-preview[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:6px;border:2px solid var(--border)}.color-input[_ngcontent-%COMP%], .name-input[_ngcontent-%COMP%], .prompt-input[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.color-input[_ngcontent-%COMP%]   label[_ngcontent-%COMP%], .name-input[_ngcontent-%COMP%]   label[_ngcontent-%COMP%], .prompt-input[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{font-size:.75rem;font-weight:500;color:var(--text-muted)}.color-input[_ngcontent-%COMP%]   input[type=color][_ngcontent-%COMP%]{width:100%;height:40px;border:1px solid var(--border);border-radius:6px;cursor:pointer}.name-input[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], .prompt-input[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{padding:.5rem;border:1px solid var(--border);border-radius:6px;background:var(--card);color:var(--text);font-size:.9rem}.btn-danger-small[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:6px;background:#dc2626;color:#fff;border:none;cursor:pointer;font-size:1.1rem;transition:all .2s}.btn-danger-small[_ngcontent-%COMP%]:hover{background:#b91c1c;transform:scale(1.05)}.modal-description[_ngcontent-%COMP%]{margin-bottom:1.5rem;color:var(--text-muted);font-size:.95rem;line-height:1.5}"],changeDetection:0})};var bt=(i,e)=>e.id;function ft(i,e){i&1&&(l(0,"div",4)(1,"span",7),u(2,"\u{1F464}"),d(),l(3,"p"),u(4,"No characters in this world"),d()())}function Ct(i,e){if(i&1&&(A(0,"img",11),K(1,"imageUrl")),i&2){let t=m().$implicit;I("src",Q(1,2,t.sheet.portrait),Y)("alt",t.sheet.name)}}function xt(i,e){if(i&1&&(l(0,"div",12),u(1),d()),i&2){let t=m().$implicit,n=m(2);p(),L(n.getInitials(t.sheet.name||"Unknown"))}}function _t(i,e){if(i&1&&u(0),i&2){let t=m(2).$implicit;ce(" / ",t.sheet.secondary_class," ")}}function vt(i,e){if(i&1&&(u(0),k(1,_t,1,1)),i&2){let t=m().$implicit;ce(" ",t.sheet.primary_class," "),p(),T(t.sheet.secondary_class?1:-1)}}function wt(i,e){i&1&&(l(0,"span",16),u(1,"No class"),d())}function kt(i,e){i&1&&(l(0,"div",17),u(1,"\u2713"),d())}function Tt(i,e){if(i&1){let t=O();l(0,"div",9),y("dragstart",function(r){let o=f(t).$implicit,a=m(2);return C(a.onDragStart(r,o.id))}),l(1,"div",10),k(2,Ct,2,4,"img",11)(3,xt,2,1,"div",12),d(),l(4,"div",13)(5,"div",14),u(6),d(),l(7,"div",15),k(8,vt,2,2)(9,wt,2,0,"span",16),d()(),k(10,kt,2,0,"div",17),d()}if(i&2){let t=e.$implicit,n=m(2);H("on-map",n.isOnMap(t.id)),p(2),T(t.sheet.portrait?2:3),p(4),L(t.sheet.name||t.id),p(2),T(t.sheet.primary_class?8:9),p(2),T(n.isOnMap(t.id)?10:-1)}}function Mt(i,e){if(i&1&&N(0,Tt,11,6,"div",8,bt),i&2){let t=m();$(t.characters)}}var ke=class i{characters=[];tokensOnMap=[];isOnMap(e){return this.tokensOnMap.some(t=>t.characterId===e)}onDragStart(e,t){if(e.dataTransfer){e.dataTransfer.setData("text/plain",t),e.dataTransfer.effectAllowed="copy";let n=this.characters.find(s=>s.id===t),r=Math.round(b.HEIGHT*.9),o=document.createElement("canvas");o.width=r,o.height=r;let a=o.getContext("2d");if(a){a.save(),a.translate(r/2,r/2),a.beginPath();let s=r/2-2;for(let v=0;v<6;v++){let w=Math.PI/180*(60*v),S=s*Math.cos(w),z=s*Math.sin(w);v===0?a.moveTo(S,z):a.lineTo(S,z)}a.closePath(),a.fillStyle="#60a5fa",a.fill(),a.strokeStyle="#3b82f6",a.lineWidth=2,a.stroke(),a.fillStyle="white",a.font=`bold ${Math.round(r*.25)}px system-ui`,a.textAlign="center",a.textBaseline="middle";let x=(n?.sheet.name||"Token").split(" ").map(v=>v[0]).join("").substring(0,2).toUpperCase();a.fillText(x,0,0),a.restore()}o.style.position="absolute",o.style.left="-9999px",o.style.top="-9999px",document.body.appendChild(o),e.dataTransfer.setDragImage(o,r/2,r/2),requestAnimationFrame(()=>{document.body.removeChild(o)}),console.log("[CHARACTER LIST] Drag started for character",t)}}getInitials(e){return e.split(" ").map(t=>t[0]).join("").substring(0,2).toUpperCase()}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=F({type:i,selectors:[["app-battlemap-character-list"]],inputs:{characters:"characters",tokensOnMap:"tokensOnMap"},decls:12,vars:2,consts:[[1,"character-list"],[1,"list-header"],[1,"char-count"],[1,"list-content"],[1,"empty-state"],[1,"list-footer"],[1,"hint"],[1,"empty-icon"],["draggable","true",1,"character-card",3,"on-map"],["draggable","true",1,"character-card",3,"dragstart"],[1,"char-portrait"],[3,"src","alt"],[1,"char-initials"],[1,"char-info"],[1,"char-name"],[1,"char-class"],[1,"no-class"],["title","On map",1,"on-map-badge"]],template:function(t,n){t&1&&(l(0,"div",0)(1,"div",1)(2,"h3"),u(3,"Characters"),d(),l(4,"span",2),u(5),d()(),l(6,"div",3),k(7,ft,5,0,"div",4)(8,Mt,2,0),d(),l(9,"div",5)(10,"p",6),u(11,"Drag characters onto the map"),d()()()),t&2&&(p(5),L(n.characters.length),p(2),T(n.characters.length===0?7:8))},dependencies:[j,Z],styles:[".character-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:100%;background:var(--card)}.list-header[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;padding:1rem;border-bottom:1px solid var(--border)}.list-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:1rem;color:var(--text)}.char-count[_ngcontent-%COMP%]{background:var(--accent);color:#fff;font-size:.75rem;font-weight:600;padding:2px 8px;border-radius:12px}.list-content[_ngcontent-%COMP%]{flex:1;overflow-y:auto;padding:.5rem}.empty-state[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem;color:var(--text-muted)}.empty-icon[_ngcontent-%COMP%]{font-size:3rem;margin-bottom:.5rem;opacity:.5}.empty-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;text-align:center}.character-card[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem;padding:.75rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;margin-bottom:.5rem;cursor:grab;transition:all .2s}.character-card[_ngcontent-%COMP%]:hover{border-color:var(--accent);box-shadow:0 0 10px #8b5cf633}.character-card[_ngcontent-%COMP%]:active{cursor:grabbing;transform:scale(.98)}.character-card.on-map[_ngcontent-%COMP%]{opacity:.6;border-style:dashed}.character-card.on-map[_ngcontent-%COMP%]:hover{opacity:.8}.char-portrait[_ngcontent-%COMP%]{width:45px;height:45px;border-radius:50%;overflow:hidden;background:var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0}.char-portrait[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.char-initials[_ngcontent-%COMP%]{font-size:1rem;font-weight:700;color:var(--text)}.char-info[_ngcontent-%COMP%]{flex:1;min-width:0}.char-name[_ngcontent-%COMP%]{font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.char-class[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-muted)}.no-class[_ngcontent-%COMP%]{font-style:italic}.on-map-badge[_ngcontent-%COMP%]{width:24px;height:24px;background:#22c55e;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700}.list-footer[_ngcontent-%COMP%]{padding:.75rem 1rem;border-top:1px solid var(--border)}.hint[_ngcontent-%COMP%]{margin:0;font-size:.75rem;color:var(--text-muted);text-align:center}"],changeDetection:0})};function yt(i,e){i&1&&(l(0,"div",4)(1,"span",5),u(2,"\u2694\uFE0F"),d(),l(3,"p"),u(4,"No battle in progress"),d(),l(5,"p",6),u(6,"The GM can start a battle from the World view"),d()())}function Pt(i,e){if(i&1&&(l(0,"div",7)(1,"span",10),u(2,"Current Turn:"),d(),l(3,"span",11),u(4),d()()),i&2){let t=m(2);p(4),L(t.currentTurnDisplay)}}function Et(i,e){if(i&1&&(A(0,"img",16),K(1,"imageUrl")),i&2){let t=m().$implicit;I("src",Q(1,2,t.portrait),Y)("alt",t.name)}}function St(i,e){if(i&1&&(l(0,"div",17),u(1),d()),i&2){let t=m().$implicit;p(),L(t.name.substring(0,2).toUpperCase())}}function Bt(i,e){if(i&1&&(l(0,"div",15),k(1,Et,2,4,"img",16)(2,St,2,1,"div",17),l(3,"span",18),u(4),d(),l(5,"span",19),u(6),d(),A(7,"div",20),d()),i&2){let t=e.$implicit,n=m(3);W("--team-color",n.getTeamColor(t.team)),H("scripted",t.isScripted)("calculated",!t.isScripted),p(),T(t.portrait?1:2),p(3),L(t.name),p(2),ce("T",t.turnNumber),p(),W("background",n.getTeamColor(t.team))}}function Dt(i,e){if(i&1&&A(0,"div",21),i&2){let t=m().$implicit,n=m(2);W("background",n.getTeamColor(t.team))}}function Ot(i,e){if(i&1&&(l(0,"div",12),N(1,Bt,8,11,"div",13,ye().trackTile,!0),k(3,Dt,1,2,"div",14),d()),i&2){let t=e.$implicit,n=e.$index;H("scripted",t.isScripted)("calculated",!t.isScripted)("first-group",n===0),p(),$(t.tiles),p(2),T(t.tiles.length>1?3:-1)}}function zt(i,e){if(i&1&&(k(0,Pt,5,1,"div",7),l(1,"div",8),N(2,Ot,4,7,"div",9,ye().trackGroup,!0),d()),i&2){let t=m();T(t.currentTurnDisplay?0:-1),p(2),$(t.groups)}}var Te=class i{worldStore=D(Ce);battlemapStore=D(ee);cdr=D(fe);subscriptions=[];groups=[];currentTurnDisplay=null;portraitMap=new Map;TIMELINE_LENGTH=12;ngOnInit(){this.subscriptions.push(this.worldStore.world$.subscribe(e=>{e&&(this.rebuildTimeline(e),this.cdr.markForCheck())})),this.subscriptions.push(this.battlemapStore.battleMap$.subscribe(()=>{this.updatePortraitMap();let e=this.worldStore.worldValue;e&&this.rebuildTimeline(e),this.cdr.markForCheck()}))}updatePortraitMap(){let e=this.battlemapStore.battleMapValue;if(e?.tokens){this.portraitMap.clear();for(let t of e.tokens)t.portrait&&!this.portraitMap.has(t.characterId)&&this.portraitMap.set(t.characterId,t.portrait)}}ngOnDestroy(){this.subscriptions.forEach(e=>e.unsubscribe())}rebuildTimeline(e){let t=e.battleParticipants||[];if(console.log("[BATTLEMAP TRACKER] Rebuilding timeline, participants:",t.length),t.length>0&&console.log("[BATTLEMAP TRACKER] First participant:",t[0]),t.length===0){this.groups=[],this.currentTurnDisplay=null;return}let n=t[0],r=n.turnFrequency>=1e4?n.turnFrequency-1e4:0,o=[...t].sort((h,M)=>h.nextTurnAt-M.nextTurnAt),a=new Map;for(let h of o)a.set(h.characterId,{characterId:h.characterId,name:h.name,portrait:this.portraitMap.get(h.characterId)||h.portrait,speed:h.speed,team:h.team||"blue",currentTurn:h.currentTurn||1});let s=[];for(let h of o){let M=a.get(h.characterId);M&&(s.push({id:`${M.characterId}_t1`,characterId:M.characterId,name:M.name,portrait:M.portrait,team:M.team,turnNumber:1,isScripted:s.length<r}),M.currentTurn=2)}let c=this.TIMELINE_LENGTH*2,x=0;for(;s.length<this.TIMELINE_LENGTH&&a.size>0&&x<c;){x++;let h=null;for(let M of a.values()){let P=M.currentTurn*1e3/Math.max(M.speed,1);(!h||P<h.timing)&&(h={p:M,timing:P})}if(!h)break;s.push({id:`${h.p.characterId}_t${h.p.currentTurn}`,characterId:h.p.characterId,name:h.p.name,portrait:h.p.portrait,team:h.p.team,turnNumber:h.p.currentTurn,isScripted:s.length<r}),h.p.currentTurn++}let v=s.slice(0,r),S=s.slice(r).map(h=>{let M=a.get(h.characterId);return X(U({},h),{timing:M?h.turnNumber*1e3/Math.max(M.speed,1):0})});S.sort((h,M)=>h.timing-M.timing);let z=[...v,...S];for(let h=0;h<z.length;h++)z[h].isScripted=h<r;this.groups=this.groupTiles(z,r),this.groups.length>0?this.currentTurnDisplay=this.groups[0].tiles.map(h=>h.name).join(" & "):this.currentTurnDisplay=null}groupTiles(e,t){if(e.length===0)return[];let n=[],r=[],o=null,a=new Set,s=0;for(let c of e){let x=o===null||c.team!==o||a.has(c.characterId);if(x&&r.length>0){let v=s-r.length;n.push({id:`group_${n.length}`,tiles:r,team:o,isScripted:v<t}),r=[],a.clear()}x&&(o=c.team),r.push(c),a.add(c.characterId),s++}if(r.length>0){let c=e.length-r.length;n.push({id:`group_${n.length}`,tiles:r,team:o,isScripted:c<t})}return n}getTeamColor(e){switch(e){case"red":return"#ef4444";case"blue":return"#3b82f6";case"green":return"#10b981";case"yellow":return"#eab308";case"purple":return"#a855f7";case"orange":return"#f97316";default:return"#60a5fa"}}trackGroup(e,t){return t.id}trackTile(e,t){return t.id}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=F({type:i,selectors:[["app-battlemap-battle-tracker"]],decls:9,vars:1,consts:[[1,"battle-tracker"],[1,"tracker-header"],[1,"view-only-badge"],[1,"tracker-content"],[1,"empty-state"],[1,"empty-icon"],[1,"sub-text"],[1,"current-turn-display"],[1,"timeline"],[1,"turn-group",3,"scripted","calculated","first-group"],[1,"label"],[1,"names"],[1,"turn-group"],[1,"tile",3,"scripted","calculated","--team-color"],[1,"group-line",3,"background"],[1,"tile"],[1,"tile-portrait",3,"src","alt"],[1,"tile-initials"],[1,"tile-name"],[1,"turn-number"],[1,"team-indicator"],[1,"group-line"]],template:function(t,n){t&1&&(l(0,"div",0)(1,"div",1)(2,"h3"),u(3,"\u2694\uFE0F Battle Tracker"),d(),l(4,"span",2),u(5,"View Only"),d()(),l(6,"div",3),k(7,yt,7,0,"div",4)(8,zt,4,1),d()()),t&2&&(p(7),T(n.groups.length===0?7:8))},dependencies:[j,Z],styles:[".battle-tracker[_ngcontent-%COMP%]{display:flex;flex-direction:row;height:100%;background:var(--card);overflow:hidden}.tracker-header[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:.5rem;border-right:1px solid var(--border);min-width:90px;gap:4px}.tracker-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:.8rem;color:var(--text);white-space:nowrap}.view-only-badge[_ngcontent-%COMP%]{font-size:.55rem;text-transform:uppercase;letter-spacing:.5px;padding:2px 6px;border-radius:3px;background:#60a5fa33;color:#60a5fa;font-weight:600}.tracker-content[_ngcontent-%COMP%]{flex:1;overflow-x:auto;overflow-y:hidden;padding:.5rem;display:flex;align-items:center}.empty-state[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;padding:.5rem 1rem;color:var(--text-muted)}.empty-icon[_ngcontent-%COMP%]{font-size:1.5rem;opacity:.5}.empty-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0}.sub-text[_ngcontent-%COMP%], .current-turn-display[_ngcontent-%COMP%]{display:none}.timeline[_ngcontent-%COMP%]{display:flex;gap:4px;padding:4px;align-items:center;height:100%}.timeline[_ngcontent-%COMP%]::-webkit-scrollbar{height:4px}.timeline[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:#0000001a;border-radius:2px}.timeline[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:var(--accent);border-radius:2px}.turn-group[_ngcontent-%COMP%]{display:flex;gap:2px;padding:4px 4px 8px;border-radius:6px;background:#0000001a;position:relative;flex-shrink:0;height:fit-content}.turn-group.first-group[_ngcontent-%COMP%]{background:#fbbf241a;box-shadow:0 0 0 1px #fbbf244d}.turn-group.scripted[_ngcontent-%COMP%]:not(.first-group){background:rgba(var(--accent-rgb, 96, 165, 250),.1)}.turn-group.calculated[_ngcontent-%COMP%]{background:#0000000d}.group-line[_ngcontent-%COMP%]{position:absolute;bottom:2px;left:4px;right:4px;height:2px;border-radius:1px}.tile[_ngcontent-%COMP%]{position:relative;width:40px;height:56px;background:var(--card-bg, #2a2a2a);border:1px solid var(--border);border-radius:4px;display:flex;flex-direction:column;align-items:center;overflow:hidden;flex-shrink:0}.tile.scripted[_ngcontent-%COMP%]{border-top:2px solid var(--accent, #60a5fa)}.tile.calculated[_ngcontent-%COMP%]{border-top:2px dashed rgba(255,255,255,.2);opacity:.8}.tile-portrait[_ngcontent-%COMP%]{width:100%;height:34px;object-fit:cover}.tile-initials[_ngcontent-%COMP%]{width:100%;height:34px;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;color:var(--text);background:var(--border)}.tile-name[_ngcontent-%COMP%]{position:absolute;bottom:10px;left:0;right:0;background:#000000bf;color:#fff;text-align:center;padding:1px 2px;font-size:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.turn-number[_ngcontent-%COMP%]{position:absolute;bottom:0;left:0;right:0;background:#00000080;color:var(--text-muted);text-align:center;font-size:6px;padding:1px}.team-indicator[_ngcontent-%COMP%]{position:absolute;bottom:0;left:0;right:0;height:2px}"],changeDetection:0})};var Ht=()=>[];function It(i,e){if(i&1&&re(0,"app-battlemap-character-list",4),i&2){let t,n=m();ne("characters",n.worldCharacters())("tokensOnMap",((t=n.battleMap())==null?null:t.tokens)||Oe(2,Ht))}}function Wt(i,e){i&1&&re(0,"app-battlemap-battle-tracker")}var Ae=class i{gridComponent;route=D(We);store=D(ee);worldStore=D(Ce);characterApi=D(Re);subscriptions=[];worldName=_("");battleMapId=_("");battleMap=_(null);world=_(null);worldCharacters=_([]);currentTool=_("cursor");brushColor=_("#000000");penBrushSize=_(4);eraserBrushSize=_(12);drawWithWalls=_(!1);dragMode=_("free");drawLayerVisible=_(!0);currentTurnCharacterId=be(()=>{let e=this.world();if(!e||!e.battleParticipants||e.battleParticipants.length===0)return null;let t=e.currentTurnIndex||0;return t>=e.battleParticipants.length?null:e.battleParticipants[t]?.characterId||null});battleParticipants=be(()=>this.world()?.battleParticipants||[]);enrichedBattleMap=be(()=>{let e=this.battleMap();if(!e)return null;let t=this.worldCharacters(),n=new Map;t.forEach(o=>{o.sheet.portrait&&n.set(o.id,o.sheet.portrait)});let r=e.tokens.map(o=>X(U({},o),{portrait:o.isOnTheFly?o.portrait:n.get(o.characterId)||o.portrait}));return X(U({},e),{tokens:r})});showCharacterList=_(!0);showBattleTracker=_(!0);ngOnInit(){this.subscriptions.push(this.route.paramMap.subscribe(async e=>{let t=e.get("worldName")||"default",n=e.get("mapId")||"default";this.worldName.set(t),this.battleMapId.set(n),await this.store.load(t,n),await this.worldStore.load(t),await this.loadWorldCharacters()})),this.subscriptions.push(this.store.battleMap$.subscribe(e=>{this.battleMap.set(e)})),this.subscriptions.push(this.worldStore.world$.subscribe(e=>{this.world.set(e)}))}ngOnDestroy(){this.subscriptions.forEach(e=>e.unsubscribe())}handleKeyDown(e){let t=e.target;if(t.tagName==="INPUT"||t.tagName==="TEXTAREA")return;switch(e.key.toLowerCase()){case"e":this.currentTool()==="draw"?this.currentTool.set("erase"):this.currentTool()==="erase"?this.currentTool.set("draw"):this.currentTool.set("erase"),e.preventDefault();break;case"b":this.currentTool.set("draw"),e.preventDefault();break;case"f":this.currentTool.set("cursor"),e.preventDefault();break;case"r":this.currentTool.set("measure"),e.preventDefault();break;case"w":this.currentTool.set("walls"),e.preventDefault();break;case"control":this.currentTool()==="cursor"&&(this.dragMode.set(this.dragMode()==="free"?"enforced":"free"),e.preventDefault());break}}async loadWorldCharacters(){let e=this.worldStore.worldValue;if(!e)return;let t=[];for(let n of e.characterIds||[])try{let r=await this.characterApi.loadCharacter(n);r&&t.push({id:n,sheet:r})}catch(r){console.error(`Failed to load character ${n}:`,r)}this.worldCharacters.set(t)}onToolChange(e){this.currentTool.set(e)}onBrushColorChange(e){this.brushColor.set(e)}onPenBrushSizeChange(e){this.penBrushSize.set(e)}onEraserBrushSizeChange(e){this.eraserBrushSize.set(e)}onBrushSizeChange(e){this.currentTool()==="erase"?this.eraserBrushSize.set(e):this.penBrushSize.set(e)}onDrawWithWallsChange(e){this.drawWithWalls.set(e)}onClearWalls(){this.store.clearWalls()}onDragModeChange(e){this.dragMode.set(e)}onTokenDrop(e){console.log("[BATTLEMAP] Token drop event received:",e);let t=this.worldCharacters().find(o=>o.id===e.characterId);if(!t){console.log("[BATTLEMAP] Character not found:",e.characterId);return}console.log("[BATTLEMAP] Adding new token at",e.position);let n=t.sheet.speed,r=n?n.base+(n.bonus||0):6;this.store.addToken({characterId:e.characterId,characterName:t.sheet.name||e.characterId,position:e.position,team:"blue",isOnTheFly:!1,movementSpeed:r})}onQuickTokenDrop(e){console.log("[BATTLEMAP] Quick token drop:",e),this.store.addToken({characterId:"quick-"+Date.now(),characterName:e.name,portrait:e.portrait,position:e.position,team:"red",isOnTheFly:!0})}onTokenMove(e){this.store.moveToken(e.tokenId,e.position)}onTokenRemove(e){this.store.removeToken(e)}toggleCharacterList(){this.showCharacterList.set(!this.showCharacterList())}toggleBattleTracker(){this.showBattleTracker.set(!this.showBattleTracker())}onDrawLayerVisibleChange(e){this.drawLayerVisible.set(e)}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=F({type:i,selectors:[["app-battlemap"]],viewQuery:function(t,n){if(t&1&&ge(me,5),t&2){let r;oe(r=ie())&&(n.gridComponent=r.first)}},hostBindings:function(t,n){t&1&&G("keydown",function(o){return n.handleKeyDown(o)},De)},decls:7,vars:19,consts:[[1,"battlemap-container"],[3,"toolChange","brushColorChange","penBrushSizeChange","eraserBrushSizeChange","drawWithWallsChange","dragModeChange","drawLayerVisibleChange","toggleCharacterList","toggleBattleTracker","clearWalls","quickTokenCreate","currentTool","brushColor","penBrushSize","eraserBrushSize","drawWithWalls","dragMode","drawLayerVisible"],[1,"battlemap-main"],[1,"battlemap-content"],[3,"characters","tokensOnMap"],[3,"tokenDrop","tokenMove","tokenRemove","quickTokenDrop","brushSizeChange","battleMap","currentTool","brushColor","penBrushSize","eraserBrushSize","drawWithWalls","dragMode","currentTurnCharacterId","battleParticipants","drawLayerVisible"]],template:function(t,n){t&1&&(R(0,"div",0)(1,"app-battlemap-toolbar",1),G("toolChange",function(o){return n.onToolChange(o)})("brushColorChange",function(o){return n.onBrushColorChange(o)})("penBrushSizeChange",function(o){return n.onPenBrushSizeChange(o)})("eraserBrushSizeChange",function(o){return n.onEraserBrushSizeChange(o)})("drawWithWallsChange",function(o){return n.onDrawWithWallsChange(o)})("dragModeChange",function(o){return n.onDragModeChange(o)})("drawLayerVisibleChange",function(o){return n.onDrawLayerVisibleChange(o)})("toggleCharacterList",function(){return n.toggleCharacterList()})("toggleBattleTracker",function(){return n.toggleBattleTracker()})("clearWalls",function(){return n.onClearWalls()})("quickTokenCreate",function(o){return n.onQuickTokenDrop(o)}),q(),R(2,"div",2)(3,"div",3),k(4,It,1,3,"app-battlemap-character-list",4),R(5,"app-battlemap-grid",5),G("tokenDrop",function(o){return n.onTokenDrop(o)})("tokenMove",function(o){return n.onTokenMove(o)})("tokenRemove",function(o){return n.onTokenRemove(o)})("quickTokenDrop",function(o){return n.onQuickTokenDrop(o)})("brushSizeChange",function(o){return n.onBrushSizeChange(o)}),q()(),k(6,Wt,1,0,"app-battlemap-battle-tracker"),q()()),t&2&&(p(),ne("currentTool",n.currentTool())("brushColor",n.brushColor())("penBrushSize",n.penBrushSize())("eraserBrushSize",n.eraserBrushSize())("drawWithWalls",n.drawWithWalls())("dragMode",n.dragMode())("drawLayerVisible",n.drawLayerVisible()),p(3),T(n.showCharacterList()?4:-1),p(),ne("battleMap",n.enrichedBattleMap())("currentTool",n.currentTool())("brushColor",n.brushColor())("penBrushSize",n.penBrushSize())("eraserBrushSize",n.eraserBrushSize())("drawWithWalls",n.drawWithWalls())("dragMode",n.dragMode())("currentTurnCharacterId",n.currentTurnCharacterId())("battleParticipants",n.battleParticipants())("drawLayerVisible",n.drawLayerVisible()),p(),T(n.showBattleTracker()?6:-1))},dependencies:[j,me,we,ke,Te],styles:[".battlemap-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:100vh;width:100vw;background:var(--bg);overflow:hidden;position:fixed;inset:0}.battlemap-main[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0}.battlemap-content[_ngcontent-%COMP%]{flex:1;display:flex;overflow:hidden;min-height:0}app-battlemap-grid[_ngcontent-%COMP%]{flex:1;min-width:0;overflow:hidden}app-battlemap-character-list[_ngcontent-%COMP%]{width:280px;min-width:280px;border-right:1px solid var(--border);background:var(--card);overflow-y:auto}app-battlemap-battle-tracker[_ngcontent-%COMP%]{width:100%;height:100px;min-height:100px;border-top:1px solid var(--border);background:var(--card);overflow-x:auto;overflow-y:hidden}@media(max-width:900px){app-battlemap-character-list[_ngcontent-%COMP%]{position:fixed;top:60px;bottom:100px;left:0;z-index:100;box-shadow:0 0 20px #00000080}app-battlemap-battle-tracker[_ngcontent-%COMP%]{position:fixed;bottom:0;left:0;right:0;z-index:100}}"],changeDetection:0})};export{Ae as BattlemapComponent};
