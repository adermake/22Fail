import{a as Ee,b as De,c as Oe}from"./chunk-MF233SY5.js";import{a as de,b as Le,c as Pe}from"./chunk-RFXIYJE6.js";import{c as Ie}from"./chunk-U2QMYJWS.js";import{p as ce,q as Z}from"./chunk-CRXYTJXZ.js";import{k as F,p as Te}from"./chunk-QU66LBKX.js";import{$b as le,Bb as Se,Cb as Q,Db as J,Fa as te,Fb as R,Ga as ke,Gb as P,Ha as Me,Ia as l,Ib as b,Jb as H,Kb as B,O as X,T as L,Ua as W,Ub as ae,Vb as se,Y as p,Z as h,Zb as K,a as k,b as N,da as y,fb as f,g as oe,gb as _,h as xe,ia as u,ib as re,jb as D,kb as O,la as we,lb as j,mb as C,nb as x,ob as Y,p as ie,pb as d,qb as m,rb as z,sb as v,tb as E,wb as M,xb as w,yb as s}from"./chunk-EGMLUSXW.js";function q(){return Date.now().toString(36)+Math.random().toString(36).substring(2,9)}function me(r,e){return{id:r,name:e,tokens:[],strokes:[],walls:[],measurementLines:[],images:[],createdAt:Date.now(),updatedAt:Date.now()}}function ze(r){let e=me("default","Main Map");return{id:r,worldName:r,maps:{default:e},activeMapId:"default",imageLibrary:[],createdAt:Date.now(),updatedAt:Date.now()}}var A=32,S={hexToPixel(r){let e=A*(1.5*r.q),t=A*(Math.sqrt(3)/2*r.q+Math.sqrt(3)*r.r);return{x:e,y:t}},pixelToHex(r){let e=.6666666666666666*r.x/A,t=(-1/3*r.x+Math.sqrt(3)/3*r.y)/A;return this.roundHex({q:e,r:t})},roundHex(r){let e=-r.q-r.r,t=Math.round(r.q),n=Math.round(r.r),o=Math.round(e),i=Math.abs(t-r.q),a=Math.abs(n-r.r),c=Math.abs(o-e);return i>a&&i>c?t=-n-o:a>c&&(n=-t-o),{q:t,r:n}},hexDistance(r,e){return(Math.abs(r.q-e.q)+Math.abs(r.q+r.r-e.q-e.r)+Math.abs(r.r-e.r))/2},getHexCorners(r){let e=[];for(let t=0;t<6;t++){let n=Math.PI/180*(60*t);e.push({x:r.x+A*Math.cos(n),y:r.y+A*Math.sin(n)})}return e},get hexWidth(){return A*2},get hexHeight(){return A*Math.sqrt(3)}};var pe=class r{http=L(Te);async loadLobby(e){try{return await ie(this.http.get(`/api/worlds/${e}/lobby`))}catch(t){return t.status===404||console.error("[LobbyAPI] Failed to load lobby:",t),null}}async saveLobby(e,t){try{await ie(this.http.post(`/api/worlds/${e}/lobby`,t))}catch(n){throw console.error("[LobbyAPI] Failed to save lobby:",n),n}}async createLobby(e){let t=ze(e);try{return await ie(this.http.post(`/api/worlds/${e}/lobby`,t))||t}catch(n){throw console.error("[LobbyAPI] Failed to create lobby:",n),n}}static \u0275fac=function(t){return new(t||r)};static \u0275prov=X({token:r,factory:r.\u0275fac,providedIn:"root"})};var he=class r{socket;isConnected=!1;patchSubject=new oe;measurementSubject=new oe;connectionReadySubject=new oe;patches$=this.patchSubject.asObservable();measurements$=this.measurementSubject.asObservable();connectionReady$=this.connectionReadySubject.asObservable();connect(){if(this.socket?.connected&&this.isConnected){console.log("[LobbySocket] Already connected, skipping");return}this.socket&&(console.log("[LobbySocket] Cleaning up existing socket"),this.socket.disconnect(),this.socket=void 0),console.log("[LobbySocket] Creating new socket connection...");try{this.socket=Pe(window.location.origin,{path:"/socket.io",transports:["polling","websocket"],reconnection:!0,reconnectionAttempts:10,reconnectionDelay:1e3,timeout:1e4,forceNew:!0}),console.log("[LobbySocket] Socket instance created:",!!this.socket)}catch(e){console.error("[LobbySocket] Error creating socket:",e),this.socket=void 0,this.isConnected=!1;return}this.socket.on("connect",()=>{console.log("[LobbySocket] \u2705 Connected successfully:",this.socket?.id),this.isConnected=!0,this.connectionReadySubject.next()}),this.socket.on("disconnect",e=>{console.log("[LobbySocket] \u274C Disconnected:",e),this.isConnected=!1,(e==="io server disconnect"||e==="transport close")&&(console.log("[LobbySocket] Scheduling reconnection..."),setTimeout(()=>{this.socket?.connected||(console.log("[LobbySocket] Attempting reconnection..."),this.connect())},2e3))}),this.socket.on("connect_error",e=>{console.error("[LobbySocket] \u274C Connection error:",e),this.isConnected=!1}),this.socket.on("reconnect",()=>{console.log("[LobbySocket] \u2705 Reconnected successfully"),this.isConnected=!0,this.connectionReadySubject.next()}),setInterval(()=>{this.socket&&this.socket.connected!==this.isConnected&&(console.log("[LobbySocket] \u{1F504} Syncing connection state - socket.connected:",this.socket.connected,"isConnected:",this.isConnected),this.isConnected=this.socket.connected,this.isConnected&&this.connectionReadySubject.next())},1e3),this.socket.on("lobbyPatched",e=>{console.log("[LobbySocket] Received lobby patch:",e.path),this.patchSubject.next(e)}),this.socket.on("battleMapPatched",e=>{console.log("[LobbySocket] Received battleMap patch (using as lobby):",e.path),this.patchSubject.next(e)}),this.socket.on("measurementUpdate",e=>{this.measurementSubject.next(e)})}get connected(){return!!(this.socket?.connected&&this.isConnected)}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=void 0,this.isConnected=!1)}async ensureConnected(){if(!this.isConnected)return new Promise(e=>{let t=this.connectionReady$.subscribe(()=>{t.unsubscribe(),e()})})}async joinLobby(e){await this.ensureConnected(),console.log("[LobbySocket] Joining lobby:",e),this.socket?.emit("joinLobby",{worldName:e})}async joinMap(e,t){await this.ensureConnected(),console.log("[LobbySocket] Joining map:",t),this.socket?.emit("joinMap",{worldName:e,mapId:t})}sendPatch(e,t,n){if(!this.socket){console.warn("[LobbySocket] \u274C No socket instance, patch not sent:",n.path),console.log("[LobbySocket] Attempting to reconnect..."),this.connect();return}if(!this.socket.connected){console.warn("[LobbySocket] \u274C Socket not connected, patch not sent:",n.path),console.log("[LobbySocket] Socket state - connected:",this.socket.connected,"id:",this.socket.id),console.log("[LobbySocket] Attempting to reconnect..."),this.connect();return}if(!this.isConnected&&(console.warn("[LobbySocket] \u274C Internal state shows not connected, syncing with socket state"),this.isConnected=this.socket.connected,!this.isConnected)){console.log("[LobbySocket] Still not connected, patch not sent:",n.path);return}console.log("[LobbySocket] \u2705 Sending patch:",n.path);try{this.socket.emit("patchBattleMap",{worldName:e,battleMapId:t,patch:n})}catch(o){console.error("[LobbySocket] Error sending patch:",o),this.isConnected=!1}}sendMeasurement(e,t,n){this.socket?.emit("updateMeasurement",{worldName:e,battleMapId:t,measurement:n})}leaveLobby(e){this.socket?.emit("leaveLobby",{worldName:e})}static \u0275fac=function(t){return new(t||r)};static \u0275prov=X({token:r,factory:r.\u0275fac,providedIn:"root"})};var ee=class r{api=L(pe);socket=L(he);imageService=L(Z);lobbySubject=new xe(null);lobby$=this.lobbySubject.asObservable();worldName="";currentMapId="";strokeUndoHistory=[];MAX_UNDO=50;pendingPatchPaths=new Set;get lobby(){return this.lobbySubject.value}get currentMap(){let e=this.lobby;return!e||!this.currentMapId?null:e.maps[this.currentMapId]||null}get tokens(){return this.currentMap?.tokens||[]}get strokes(){return this.currentMap?.strokes||[]}get images(){return this.currentMap?.images||[]}get walls(){return this.currentMap?.walls||[]}get imageLibrary(){return this.lobby?.imageLibrary||[]}constructor(){this.socket.patches$.subscribe(e=>{if(this.pendingPatchPaths.has(e.path)){this.pendingPatchPaths.delete(e.path);return}this.applyRemotePatch(e)})}async loadLobby(e){this.worldName=e,console.log("[LobbyStore] Loading lobby for:",e);let t=await this.api.loadLobby(e);t||(console.log("[LobbyStore] Creating new lobby"),t=await this.api.createLobby(e)),t=this.migrateLobby(t),this.lobbySubject.next(t);let n=t.activeMapId||Object.keys(t.maps)[0]||"default";await this.switchMap(n),console.log("[LobbyStore] Connecting to socket..."),this.socket.connect();let o=0,i=10;for(;o<i&&(await new Promise(a=>setTimeout(a,200)),!this.socket.connected);)o++,console.log(`[LobbyStore] Waiting for socket connection... attempt ${o}/${i}`);return o>=i?console.warn("[LobbyStore] Socket connection timeout, continuing without real-time sync"):console.log("[LobbyStore] \u2705 Socket connected successfully"),await this.socket.joinLobby(e),console.log("[LobbyStore] \u2705 Socket connection and room join complete"),t}migrateLobby(e){e.maps||(e.maps={default:me("default","Main Map")}),e.imageLibrary||(e.imageLibrary=[]),e.activeMapId||(e.activeMapId=Object.keys(e.maps)[0]||"default");for(let t of Object.keys(e.maps)){let n=e.maps[t];n.tokens||(n.tokens=[]),n.strokes||(n.strokes=[]),n.walls||(n.walls=[]),n.images||(n.images=[]),n.measurementLines||(n.measurementLines=[]),n.images=n.images.filter(o=>o.imageId),e.imageLibrary=e.imageLibrary.filter(o=>o.imageId)}return e}async switchMap(e){let t=this.lobby;if(t){if(!t.maps[e]){console.error("[LobbyStore] Map not found:",e);return}this.currentMapId=e,t.activeMapId=e,t.updatedAt=Date.now(),this.lobbySubject.next(k({},t)),await this.socket.joinMap(this.worldName,e)}}async createMap(e){let t=this.lobby;if(!t)throw new Error("No lobby loaded");let n=me(q(),e);return t.maps[n.id]=n,t.updatedAt=Date.now(),this.lobbySubject.next(k({},t)),await this.api.saveLobby(this.worldName,t),n.id}async deleteMap(e){let t=this.lobby;if(!t)return;if(Object.keys(t.maps).length<=1){console.warn("[LobbyStore] Cannot delete the only map");return}if(delete t.maps[e],t.activeMapId===e){let o=Object.keys(t.maps)[0];await this.switchMap(o)}t.updatedAt=Date.now(),this.lobbySubject.next(k({},t)),await this.api.saveLobby(this.worldName,t)}async renameMap(e,t){let n=this.lobby;!n||!n.maps[e]||(n.maps[e].name=t,n.maps[e].updatedAt=Date.now(),n.updatedAt=Date.now(),this.lobbySubject.next(k({},n)),await this.api.saveLobby(this.worldName,n))}addToken(e){let t=N(k({},e),{id:q()}),n=[...this.tokens,t];this.applyPatch({path:"tokens",value:n})}moveToken(e,t){let n=[...this.tokens],o=n.findIndex(i=>i.id===e);o!==-1&&(n[o]=N(k({},n[o]),{position:t}),this.applyPatch({path:"tokens",value:n}))}updateToken(e,t){let n=[...this.tokens],o=n.findIndex(i=>i.id===e);o!==-1&&(n[o]=k(k({},n[o]),t),this.applyPatch({path:"tokens",value:n}))}removeToken(e){let t=this.tokens.filter(n=>n.id!==e);this.applyPatch({path:"tokens",value:t})}addStroke(e){this.strokeUndoHistory.push([...this.strokes]),this.strokeUndoHistory.length>this.MAX_UNDO&&this.strokeUndoHistory.shift();let t=N(k({},e),{id:q()}),n=[...this.strokes,t];this.applyPatch({path:"strokes",value:n})}undoStroke(){if(this.strokeUndoHistory.length===0)return!1;let e=this.strokeUndoHistory.pop();return this.applyPatch({path:"strokes",value:e}),!0}deleteImage(e){let t=this.images.filter(n=>n.id!==e);this.applyPatch({path:"images",value:t})}clearStrokes(){this.strokes.length!==0&&(this.strokeUndoHistory.push([...this.strokes]),this.strokeUndoHistory.length>this.MAX_UNDO&&this.strokeUndoHistory.shift(),this.applyPatch({path:"strokes",value:[]}))}addImage(e,t,n,o,i){let a={id:q(),imageId:e,x:t,y:n,width:o,height:i,rotation:0,zIndex:Math.max(0,...this.images.map(g=>g.zIndex))+1},c=[...this.images,a];this.applyPatch({path:"images",value:c})}updateImage(e,t){let n=[...this.images],o=n.findIndex(i=>i.id===e);o!==-1&&(n[o]=k(k({},n[o]),t),this.applyPatch({path:"images",value:n}))}removeImage(e){let t=this.images.filter(n=>n.id!==e);this.applyPatch({path:"images",value:t})}moveImageForward(e){let t=[...this.images],n=t.find(a=>a.id===e);if(!n)return;let o=t.filter(a=>a.zIndex>n.zIndex);if(o.length===0)return;let i=Math.min(...o.map(a=>a.zIndex));n.zIndex=i+.5,this.normalizeZIndices(t),this.applyPatch({path:"images",value:t})}moveImageBackward(e){let t=[...this.images],n=t.find(a=>a.id===e);if(!n)return;let o=t.filter(a=>a.zIndex<n.zIndex);if(o.length===0)return;let i=Math.max(...o.map(a=>a.zIndex));n.zIndex=i-.5,this.normalizeZIndices(t),this.applyPatch({path:"images",value:t})}moveImageToFront(e){let t=[...this.images],n=t.findIndex(i=>i.id===e);if(n===-1)return;let o=Math.max(0,...t.map(i=>i.zIndex));t[n]=N(k({},t[n]),{zIndex:o+1}),this.applyPatch({path:"images",value:t})}moveImageToBack(e){let t=[...this.images],n=t.findIndex(i=>i.id===e);if(n===-1)return;let o=Math.min(0,...t.map(i=>i.zIndex));t[n]=N(k({},t[n]),{zIndex:o-1}),this.applyPatch({path:"images",value:t})}normalizeZIndices(e){[...e].sort((n,o)=>n.zIndex-o.zIndex).forEach((n,o)=>{let i=e.find(a=>a.id===n.id);i&&(i.zIndex=o)})}async addLibraryImage(e,t){let n=await this.imageService.uploadImage(e),o={id:q(),name:t,imageId:n,width:200,height:200,createdAt:Date.now()},i=this.lobby;if(!i)throw new Error("No lobby loaded");return i.imageLibrary=[...i.imageLibrary,o],i.updatedAt=Date.now(),this.lobbySubject.next(k({},i)),await this.api.saveLobby(this.worldName,i),o}async updateLibraryImage(e,t){let n=this.lobby;if(!n)return;let o=n.imageLibrary.findIndex(i=>i.id===e);o!==-1&&(n.imageLibrary=[...n.imageLibrary],n.imageLibrary[o]=N(k({},n.imageLibrary[o]),{name:t}),n.updatedAt=Date.now(),this.lobbySubject.next(k({},n)),await this.api.saveLobby(this.worldName,n))}async removeLibraryImage(e){let t=this.lobby;t&&(t.imageLibrary=t.imageLibrary.filter(n=>n.id!==e),t.updatedAt=Date.now(),this.lobbySubject.next(k({},t)),await this.api.saveLobby(this.worldName,t))}addWall(e){if(this.walls.some(o=>o.q===e.q&&o.r===e.r))return;let n=[...this.walls,{q:e.q,r:e.r}];this.applyPatch({path:"walls",value:n})}removeWall(e){let t=this.walls.filter(n=>!(n.q===e.q&&n.r===e.r));this.applyPatch({path:"walls",value:t})}toggleWall(e){this.walls.some(n=>n.q===e.q&&n.r===e.r)?this.removeWall(e):this.addWall(e)}clearWalls(){this.applyPatch({path:"walls",value:[]})}async cleanupOrphanedImages(){try{console.log("[LobbyStore] Starting image cleanup...");let e=await fetch("http://localhost:3000/api/images/cleanup",{method:"POST",headers:{"Content-Type":"application/json"}});if(e.ok){let t=await e.json();console.log("[LobbyStore] Cleanup result:",t),this.worldName&&await this.loadLobby(this.worldName)}else console.error("[LobbyStore] Cleanup failed:",e.statusText)}catch(e){console.error("[LobbyStore] Error during cleanup:",e)}}applyPatch(e){let t=this.currentMap;if(!t)return;this.pendingPatchPaths.add(e.path),this.applyJsonPatch(t,e),t.updatedAt=Date.now();let n=this.lobby;n&&(n.maps[this.currentMapId]=k({},t),n.updatedAt=Date.now(),this.lobbySubject.next(k({},n)),this.api.saveLobby(this.worldName,n).catch(o=>{console.error("[LobbyStore] Failed to save:",o)})),this.socket.sendPatch(this.worldName,this.currentMapId,e)}applyRemotePatch(e){let t=this.currentMap;if(!t)return;this.applyJsonPatch(t,e),t.updatedAt=Date.now();let n=this.lobby;n&&(n.maps[this.currentMapId]=k({},t),this.lobbySubject.next(k({},n)))}applyJsonPatch(e,t){let n=t.path.split(".");if(n.length===1){e[n[0]]=t.value;return}let o=e;for(let c=0;c<n.length-1;c++){let g=n[c],I=parseInt(g,10);!isNaN(I)&&Array.isArray(o)?o=o[I]:o=o[g]??={}}let i=n[n.length-1],a=parseInt(i,10);!isNaN(a)&&Array.isArray(o)?o[a]=t.value:o[i]=t.value}static \u0275fac=function(t){return new(t||r)};static \u0275prov=X({token:r,factory:r.\u0275fac,providedIn:"root"})};function Fe(r,e){if(r&1){let t=v();d(0,"img",5),ae(1,"imageUrl"),w("error",function(o){p(t);let i=s();return h(i.onImageError(o))}),m()}if(r&2){let t=s();E("src",se(1,1,t.token.portrait),te)}}function Ne(r,e){if(r&1&&(d(0,"div",2),b(1),m()),r&2){let t=s();l(),B(" ",t.token.name.charAt(0).toUpperCase()," ")}}function Ae(r,e){if(r&1&&z(0,"div",6),r&2){let t=s();R("background",t.getTeamColor(t.token.team))}}var be=class r{token;position={x:0,y:0};scale=1;isCurrentTurn=!1;dragStart=new y;contextMenu=new y;isDragging=!1;teamColors={blue:"#3b82f6",red:"#ef4444",green:"#22c55e",yellow:"#eab308",purple:"#8b5cf6",orange:"#f97316"};getTeamColor(e){return this.teamColors[e]||"#6b7280"}getTokenBorder(){return this.token.team?`3px solid ${this.getTeamColor(this.token.team)}`:"3px solid #475569"}onMouseDown(e){e.button===0&&(e.preventDefault(),e.stopPropagation(),this.isDragging=!0,this.dragStart.emit(e))}onContextMenu(e){e.preventDefault(),e.stopPropagation(),this.contextMenu.emit(e)}onImageError(e){let t=e.target;t.style.display="none"}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=W({type:r,selectors:[["app-lobby-token"]],inputs:{token:"token",position:"position",scale:"scale",isCurrentTurn:"isCurrentTurn"},outputs:{dragStart:"dragStart",contextMenu:"contextMenu"},decls:6,vars:15,consts:[[1,"token",3,"mousedown","contextmenu"],["alt","",1,"token-portrait",3,"src"],[1,"token-placeholder"],[1,"team-indicator",3,"background"],[1,"token-name"],["alt","",1,"token-portrait",3,"error","src"],[1,"team-indicator"]],template:function(t,n){t&1&&(d(0,"div",0),w("mousedown",function(i){return n.onMouseDown(i)})("contextmenu",function(i){return n.onContextMenu(i)}),f(1,Fe,2,3,"img",1)(2,Ne,2,1,"div",2),f(3,Ae,1,2,"div",3),d(4,"div",4),b(5),m()()),t&2&&(R("left",n.position.x,"px")("top",n.position.y,"px")("transform","scale("+n.scale+")")("border",n.getTokenBorder()),P("current-turn",n.isCurrentTurn)("dragging",n.isDragging),l(),_(n.token.portrait?1:2),l(2),_(n.token.team?3:-1),l(2),H(n.token.name))},dependencies:[F,de],styles:[".token[_ngcontent-%COMP%]{position:absolute;width:48px;height:48px;margin-left:-24px;margin-top:-24px;cursor:grab;pointer-events:auto;transition:transform .1s,box-shadow .1s;z-index:1;background:#1e293b;-webkit-clip-path:polygon(50% 0%,93.3% 25%,93.3% 75%,50% 100%,6.7% 75%,6.7% 25%);clip-path:polygon(50% 0%,93.3% 25%,93.3% 75%,50% 100%,6.7% 75%,6.7% 25%)}.token[_ngcontent-%COMP%]:hover{box-shadow:0 0 12px #3b82f699;z-index:2}.token[_ngcontent-%COMP%]:active, .token.dragging[_ngcontent-%COMP%]{cursor:grabbing;z-index:10}.token.current-turn[_ngcontent-%COMP%]{box-shadow:0 0 16px #22c55e99}.token-portrait[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover;-webkit-clip-path:polygon(50% 0%,93.3% 25%,93.3% 75%,50% 100%,6.7% 75%,6.7% 25%);clip-path:polygon(50% 0%,93.3% 25%,93.3% 75%,50% 100%,6.7% 75%,6.7% 25%)}.token-placeholder[_ngcontent-%COMP%]{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:600;color:#94a3b8;background:transparent}.team-indicator[_ngcontent-%COMP%]{position:absolute;bottom:-2px;right:-2px;width:14px;height:14px;border-radius:50%;border:2px solid #1e293b;z-index:2}.token-name[_ngcontent-%COMP%]{position:absolute;bottom:-20px;left:50%;transform:translate(-50%);white-space:nowrap;font-size:10px;color:#1f2937;background:#ffffffe6;padding:2px 6px;border-radius:4px;pointer-events:none}"],changeDetection:0})};var qe=["gridCanvas"],Ge=["imageCanvas"],je=["drawCanvas"],$e=["overlayCanvas"],Ue=["container"],Xe=(r,e)=>e.id;function Ye(r,e){if(r&1){let t=v();C(0,"app-lobby-token",14),M("dragStart",function(o){let i=p(t).$implicit,a=s();return h(a.onTokenDragStart(i,o))})("contextMenu",function(o){let i=p(t).$implicit,a=s();return h(a.onTokenContextMenu(i,o))}),x()}if(r&2){let t=e.$implicit,n=s();j("token",t)("position",n.getTokenScreenPosition(t))("scale",n.scale)("isCurrentTurn",!1)}}function Qe(r,e){if(r&1&&Y(0,"div",15),r&2){let t=s();R("left",t.worldToScreen(t.dragGhostPosition().x,t.dragGhostPosition().y).x,"px")("top",t.worldToScreen(t.dragGhostPosition().x,t.dragGhostPosition().y).y,"px")}}function Je(r,e){if(r&1){let t=v();C(0,"button",17),M("click",function(){p(t);let o=s(2);return h(o.onMoveImageToFront())}),b(1,"Bring to Front"),x(),C(2,"button",17),M("click",function(){p(t);let o=s(2);return h(o.onMoveImageForward())}),b(3,"Bring Forward"),x(),C(4,"button",17),M("click",function(){p(t);let o=s(2);return h(o.onMoveImageBackward())}),b(5,"Send Backward"),x(),C(6,"button",17),M("click",function(){p(t);let o=s(2);return h(o.onMoveImageToBack())}),b(7,"Send to Back"),x(),Y(8,"div",18),C(9,"button",19),M("click",function(){p(t);let o=s(2);return h(o.onDeleteSelectedImage())}),b(10,"Delete Image"),x()}}function Ke(r,e){if(r&1){let t=v();C(0,"button",17),M("click",function(){p(t);let o=s(2);return h(o.onCreateQuickToken())}),b(1,"\u2795 Create Quick Token"),x()}}function Ze(r,e){if(r&1){let t=v();C(0,"div",16),M("click",function(o){return p(t),h(o.stopPropagation())}),f(1,Je,11,0)(2,Ke,2,0,"button"),x()}if(r&2){let t=s();R("left",t.contextMenuPosition().x,"px")("top",t.contextMenuPosition().y,"px"),l(),_(t.contextMenuImageId()?1:t.contextMenuHex()?2:-1)}}var ue=class r{gridCanvas;imageCanvas;drawCanvas;overlayCanvas;container;map=null;tokens=[];currentTool="cursor";brushColor="#000000";penBrushSize=4;eraserBrushSize=12;drawWithWalls=!1;dragMode="free";drawLayerVisible=!0;imageLayerVisible=!0;selectedImageId=null;isGM=!1;tokenDrop=new y;tokenMove=new y;tokenRemove=new y;quickTokenDrop=new y;imageSelect=new y;imageTransform=new y;imageDelete=new y;placeImage=new y;toolAutoSelect=new y;store=L(ee);imageService=L(Z);cdr=L(le);gridCtx=null;imageCtx=null;drawCtx=null;overlayCtx=null;imageCache=new Map;renderPending=!1;resizeObserver=null;panX=0;panY=0;scale=1;isPanning=!1;isDrawing=!1;isWallDrawing=!1;wallPaintMode="add";currentStrokePoints=[];lastMousePos={x:0,y:0};measureStart=u(null);measureEnd=u(null);measureDistance=u(0);draggingToken=null;dragGhostPosition=u(null);dragHoverHex=u(null);dragStartHex=u(null);dragPath=u([]);transformingImageId=null;transformMode="move";transformHandle=null;transformAnchor=null;initialImageTransform=null;showContextMenu=u(!1);contextMenuPosition=u({x:0,y:0});contextMenuImageId=u(null);contextMenuHex=u(null);onKeyDown(e){e.ctrlKey&&e.key==="z"&&(e.preventDefault(),this.store.undoStroke())}ngAfterViewInit(){this.initCanvases(),this.centerView(),this.scheduleRender(),this.setupResizeObserver()}ngOnChanges(e){(e.map||e.tokens)&&this.scheduleRender(),e.drawLayerVisible&&this.updateLayerVisibility(),e.imageLayerVisible&&this.updateLayerVisibility()}ngOnDestroy(){this.resizeObserver&&this.resizeObserver.disconnect()}initCanvases(){let e=[{el:this.gridCanvas?.nativeElement,name:"grid"},{el:this.imageCanvas?.nativeElement,name:"image"},{el:this.drawCanvas?.nativeElement,name:"draw"},{el:this.overlayCanvas?.nativeElement,name:"overlay"}];for(let{el:t,name:n}of e)if(t){let o=t.getContext("2d");n==="grid"&&(this.gridCtx=o),n==="image"&&(this.imageCtx=o),n==="draw"&&(this.drawCtx=o),n==="overlay"&&(this.overlayCtx=o),this.resizeCanvas(t)}}resizeCanvas(e){let t=this.container?.nativeElement;if(!t)return;let n=t.getBoundingClientRect(),o=window.devicePixelRatio||1;e.width=n.width*o,e.height=n.height*o,e.style.width=`${n.width}px`,e.style.height=`${n.height}px`;let i=e.getContext("2d");i&&i.scale(o,o)}setupResizeObserver(){let e=this.container?.nativeElement;e&&(this.resizeObserver=new ResizeObserver(()=>{[this.gridCanvas,this.imageCanvas,this.drawCanvas,this.overlayCanvas].forEach(t=>{t?.nativeElement&&this.resizeCanvas(t.nativeElement)}),this.scheduleRender()}),this.resizeObserver.observe(e))}centerView(){let e=this.container?.nativeElement;if(!e)return;let t=e.getBoundingClientRect();this.panX=t.width/2,this.panY=t.height/2}updateLayerVisibility(){this.drawCanvas?.nativeElement&&(this.drawCanvas.nativeElement.style.opacity=this.drawLayerVisible?"1":"0"),this.imageCanvas?.nativeElement&&(this.imageCanvas.nativeElement.style.opacity=this.imageLayerVisible?"1":"0")}screenToWorld(e,t){return{x:(e-this.panX)/this.scale,y:(t-this.panY)/this.scale}}worldToScreen(e,t){return{x:e*this.scale+this.panX,y:t*this.scale+this.panY}}scheduleRender(){this.renderPending||(this.renderPending=!0,requestAnimationFrame(()=>{this.renderPending=!1,this.render()}))}render(){this.renderGrid(),this.renderImages(),this.renderStrokes(),this.renderOverlay()}renderGrid(){if(!this.gridCtx)return;let e=this.gridCanvas.nativeElement,t=this.gridCtx,n=window.devicePixelRatio||1;t.fillStyle="#f8fafc",t.fillRect(0,0,e.width/n,e.height/n),t.save(),t.translate(this.panX,this.panY),t.scale(this.scale,this.scale);let o=this.screenToWorld(-50,-50),i=this.screenToWorld(e.width/n+50,e.height/n+50),a=Math.max(5,Math.ceil(10/this.scale)),c=Math.floor(o.x/(S.hexWidth*.75))-a,g=Math.ceil(i.x/(S.hexWidth*.75))+a,I=Math.floor(o.y/S.hexHeight)-a,U=Math.ceil(i.y/S.hexHeight)+a,ne=this.map?.walls||[],ye=new Set(ne.map(T=>`${T.q},${T.r}`)),ve=new Set(this.dragPath().map(T=>`${T.q},${T.r}`)),G=this.dragHoverHex();if((g-c+1)*(U-I+1)>2500||this.scale<.2){t.strokeStyle="rgba(148, 163, 184, 0.1)",t.lineWidth=1;for(let T=c;T<=g;T+=4){let V=T*S.hexWidth*.75;t.beginPath(),t.moveTo(V,o.y),t.lineTo(V,i.y),t.stroke()}for(let T=I;T<=U;T+=4){let V=T*S.hexHeight;t.beginPath(),t.moveTo(o.x,V),t.lineTo(i.x,V),t.stroke()}}else for(let T=c;T<=g;T++)for(let V=I;V<=U;V++){let Ce=`${T},${V}`,We=G&&G.q===T&&G.r===V,Re=ye.has(Ce),Be=ve.has(Ce);this.drawHexagon(t,{q:T,r:V},We||!1,Re,Be)}t.restore()}drawHexagon(e,t,n,o,i){let a=S.hexToPixel(t),c=S.getHexCorners(a);e.beginPath(),e.moveTo(c[0].x,c[0].y);for(let g=1;g<c.length;g++)e.lineTo(c[g].x,c[g].y);e.closePath(),n?(e.fillStyle="rgba(96, 165, 250, 0.3)",e.fill(),e.strokeStyle="rgba(96, 165, 250, 1)",e.lineWidth=3):i?(e.fillStyle="rgba(34, 197, 94, 0.2)",e.fill(),e.strokeStyle="rgba(34, 197, 94, 0.8)",e.lineWidth=2):o?(e.fillStyle="rgba(239, 68, 68, 0.15)",e.fill(),e.strokeStyle="rgba(239, 68, 68, 0.4)",e.lineWidth=1):(e.strokeStyle="rgba(148, 163, 184, 0.12)",e.lineWidth=.5),e.stroke()}renderImages(){if(!this.imageCtx||!this.map)return;let e=this.imageCanvas.nativeElement,t=this.imageCtx,n=window.devicePixelRatio||1;t.clearRect(0,0,e.width/n,e.height/n),t.save(),t.translate(this.panX,this.panY),t.scale(this.scale,this.scale);let o=[...this.map.images||[]].sort((i,a)=>i.zIndex-a.zIndex);for(let i of o)this.renderImage(t,i);t.restore()}renderImage(e,t){if(!t.imageId)return;let n=`/api/images/${t.imageId}`,o=this.imageCache.get(n);if(!(!o&&(o=new Image,o.crossOrigin="anonymous",o.src=n,this.imageCache.set(n,o),o.onload=()=>{this.scheduleRender()},o.onerror=()=>{this.store.deleteImage(t.id)},!o.complete))){if(!o.naturalWidth||!o.naturalHeight){this.store.deleteImage(t.id);return}e.save(),e.translate(t.x,t.y),e.rotate(t.rotation*Math.PI/180),e.drawImage(o,-t.width/2,-t.height/2,t.width,t.height),e.restore(),this.selectedImageId===t.id&&this.renderImageHandles(e,t)}}renderImageHandles(e,t){e.save(),e.translate(t.x,t.y),e.rotate(t.rotation*Math.PI/180);let n=t.width/2,o=t.height/2,i=10/this.scale;e.strokeStyle="#3b82f6",e.lineWidth=2/this.scale,e.setLineDash([8/this.scale,4/this.scale]),e.strokeRect(-n,-o,t.width,t.height),e.setLineDash([]),e.fillStyle="#ffffff",e.strokeStyle="#3b82f6",e.lineWidth=2/this.scale;let a=[{x:-n,y:-o},{x:n,y:-o},{x:n,y:o},{x:-n,y:o}];for(let I of a)e.fillRect(I.x-i/2,I.y-i/2,i,i),e.strokeRect(I.x-i/2,I.y-i/2,i,i);let c=-o-25/this.scale,g=6/this.scale;e.beginPath(),e.moveTo(0,-o),e.lineTo(0,c),e.strokeStyle="#3b82f6",e.stroke(),e.beginPath(),e.arc(0,c,g,0,Math.PI*2),e.fillStyle="#22c55e",e.fill(),e.strokeStyle="#ffffff",e.stroke(),e.restore()}renderStrokes(){if(!this.drawCtx||!this.map)return;let e=this.drawCanvas.nativeElement,t=this.drawCtx,n=window.devicePixelRatio||1;t.clearRect(0,0,e.width/n,e.height/n),t.save(),t.translate(this.panX,this.panY),t.scale(this.scale,this.scale);for(let o of this.map.strokes||[])if(!(o.points.length<2)){t.globalCompositeOperation=o.isEraser?"destination-out":"source-over",t.beginPath(),t.moveTo(o.points[0].x,o.points[0].y);for(let i=1;i<o.points.length;i++)t.lineTo(o.points[i].x,o.points[i].y);t.strokeStyle=o.isEraser?"rgba(0,0,0,1)":o.color,t.lineWidth=o.lineWidth,t.lineCap="round",t.lineJoin="round",t.stroke()}t.globalCompositeOperation="source-over",t.restore()}renderOverlay(){if(!this.overlayCtx)return;let e=this.overlayCanvas?.nativeElement;if(!e)return;let t=this.overlayCtx,n=window.devicePixelRatio||1;t.clearRect(0,0,e.width/n,e.height/n),this.renderMeasurement(t),this.renderDragPath(t)}renderMeasurement(e){let t=this.measureStart(),n=this.measureEnd();if(!t||!n)return;let o=this.worldToScreen(t.x,t.y),i=this.worldToScreen(n.x,n.y);e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(i.x,i.y),e.strokeStyle="#fbbf24",e.lineWidth=3,e.setLineDash([10,5]),e.stroke(),e.setLineDash([]),e.fillStyle="#fbbf24",e.beginPath(),e.arc(o.x,o.y,6,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(i.x,i.y,6,0,Math.PI*2),e.fill();let a=(o.x+i.x)/2,c=(o.y+i.y)/2,g=this.measureDistance();e.font="bold 14px sans-serif",e.fillStyle="#fbbf24",e.textAlign="center",e.textBaseline="bottom",e.fillText(`${g.toFixed(1)} ft`,a,c-5)}renderDragPath(e){let t=this.dragPath();if(!(t.length<2)){e.strokeStyle="#22c55e",e.lineWidth=3,e.setLineDash([5,5]);for(let n=0;n<t.length-1;n++){let o=S.hexToPixel(t[n]),i=S.hexToPixel(t[n+1]),a=this.worldToScreen(o.x,o.y),c=this.worldToScreen(i.x,i.y);e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(c.x,c.y),e.stroke()}e.setLineDash([])}}onMouseDown(e){if(e.button===1){e.preventDefault(),this.isPanning=!0,this.lastMousePos={x:e.clientX,y:e.clientY};return}let t=this.container.nativeElement.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top,i=this.screenToWorld(n,o),a=S.pixelToHex(i);switch(this.currentTool){case"cursor":this.handleCursorDown(e,i,a);break;case"draw":case"erase":this.handleDrawDown(e,i);break;case"walls":this.handleWallDown(e,a);break;case"measure":this.handleMeasureDown(e,i,a);break;case"image":this.handleImageDown(e,i);break}}onMouseMove(e){let t=this.container.nativeElement.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top,i=this.screenToWorld(n,o),a=S.pixelToHex(i);if(this.isPanning){let c=e.clientX-this.lastMousePos.x,g=e.clientY-this.lastMousePos.y;this.panX+=c,this.panY+=g,this.lastMousePos={x:e.clientX,y:e.clientY},this.scheduleRender();return}switch(this.currentTool){case"cursor":this.handleCursorMove(e,i,a);break;case"draw":case"erase":this.handleDrawMove(e,i);break;case"walls":this.handleWallMove(e,a);break;case"measure":this.handleMeasureMove(e,i,a);break;case"image":this.handleImageMove(e,i);break}}onMouseUp(e){if(this.isPanning){this.isPanning=!1;return}let t=this.container.nativeElement.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top,i=this.screenToWorld(n,o),a=S.pixelToHex(i);switch(this.currentTool){case"cursor":this.handleCursorUp(e,i,a);break;case"draw":case"erase":this.handleDrawUp(e,i);break;case"walls":this.handleWallUp(e,a);break;case"measure":this.handleMeasureUp(e,i,a);break;case"image":this.handleImageUp(e,i);break}}onWheel(e){e.preventDefault();let t=this.container.nativeElement.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top,i=e.deltaY>0?.9:1.1,a=Math.max(.1,Math.min(5,this.scale*i)),c=this.screenToWorld(n,o);this.scale=a;let g=this.screenToWorld(n,o);this.panX+=(g.x-c.x)*this.scale,this.panY+=(g.y-c.y)*this.scale,this.scheduleRender()}onContextMenu(e){e.preventDefault();let t=this.container.nativeElement.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top,i=this.screenToWorld(n,o),a=S.pixelToHex(i),c=this.findImageAtPoint(i);this.showContextMenu.set(!0),this.contextMenuPosition.set({x:e.clientX,y:e.clientY}),this.contextMenuImageId.set(c?.id||null),this.contextMenuHex.set(a)}handleCursorDown(e,t,n){if(e.button!==0)return;if(this.selectedImageId){let a=this.map?.images?.find(c=>c.id===this.selectedImageId);if(a){let c=this.getTransformHandle(t,a);if(c){this.startImageTransform(a,c,t);return}}}let o=this.findImageAtPoint(t);if(o){this.imageSelect.emit(o.id);return}let i=this.findTokenAtHex(n);if(i){this.startTokenDrag(i,n);return}this.imageSelect.emit(null)}handleCursorMove(e,t,n){if(this.updateCursor(t),this.transformingImageId&&this.transformHandle){this.updateImageTransform(t);return}if(this.draggingToken){this.updateTokenDrag(n);return}}handleCursorUp(e,t,n){if(this.transformingImageId){this.finishImageTransform();return}if(this.draggingToken){this.finishTokenDrag(n);return}}handleDrawDown(e,t){e.button===0&&(this.isDrawing=!0,this.currentStrokePoints=[t])}handleDrawMove(e,t){this.isDrawing&&(this.currentStrokePoints.push(t),this.renderCurrentStroke(t))}handleDrawUp(e,t){if(this.isDrawing){if(this.isDrawing=!1,this.currentStrokePoints.length>1){let n={id:q(),points:[...this.currentStrokePoints],color:this.brushColor,lineWidth:this.currentTool==="erase"?this.eraserBrushSize:this.penBrushSize,isEraser:this.currentTool==="erase"};this.store.addStroke(n)}this.currentStrokePoints=[],this.scheduleRender()}}handleWallDown(e,t){if(e.button!==0)return;this.isWallDrawing=!0;let n=this.map?.walls||[],o=`${t.q},${t.r}`,i=n.some(a=>a.q===t.q&&a.r===t.r);this.wallPaintMode=i?"remove":"add",this.paintWall(t)}handleWallMove(e,t){this.isWallDrawing&&this.paintWall(t)}handleWallUp(e,t){this.isWallDrawing=!1}handleMeasureDown(e,t,n){e.button===0&&(this.measureStart.set(t),this.measureEnd.set(t),this.measureDistance.set(0))}handleMeasureMove(e,t,n){if(!this.measureStart())return;this.measureEnd.set(t);let o=this.measureStart(),i=Math.sqrt(Math.pow(t.x-o.x,2)+Math.pow(t.y-o.y,2));this.measureDistance.set(i),this.scheduleRender()}handleMeasureUp(e,t,n){}handleImageDown(e,t){if(e.button!==0)return;let n=this.getPendingImageId();n&&(this.placeImage.emit({imageId:n,x:t.x,y:t.y,width:100,height:100}),this.toolAutoSelect.emit("cursor"))}handleImageMove(e,t){}handleImageUp(e,t){}findImageAtPoint(e){if(!this.map?.images)return null;let t=[...this.map.images].sort((n,o)=>o.zIndex-n.zIndex);for(let n of t)if(this.isPointInImage(e,n))return n;return null}isPointInImage(e,t){let n=e.x-t.x,o=e.y-t.y,i=Math.cos(-t.rotation*Math.PI/180),a=Math.sin(-t.rotation*Math.PI/180),c=n*i-o*a,g=n*a+o*i;return Math.abs(c)<=t.width/2&&Math.abs(g)<=t.height/2}findTokenAtHex(e){return this.tokens.find(t=>t.position.q===e.q&&t.position.r===e.r)||null}getTransformHandle(e,t){let n=10/this.scale,o=t.width/2,i=t.height/2,a=e.x-t.x,c=e.y-t.y,g=Math.cos(-t.rotation*Math.PI/180),I=Math.sin(-t.rotation*Math.PI/180),U=a*g-c*I,ne=a*I+c*g,ye=-i-25/this.scale;if(Math.abs(U)<6/this.scale&&Math.abs(ne-ye)<6/this.scale)return"rotate";let ve=[{x:-o,y:-i,handle:"tl"},{x:o,y:-i,handle:"tr"},{x:o,y:i,handle:"br"},{x:-o,y:i,handle:"bl"}];for(let G of ve)if(Math.abs(U-G.x)<n/2&&Math.abs(ne-G.y)<n/2)return G.handle;return null}updateCursor(e){let t=this.container?.nativeElement;if(!t)return;let n="default";if(this.selectedImageId){let o=this.map?.images?.find(i=>i.id===this.selectedImageId);if(o){let i=this.getTransformHandle(e,o);i==="rotate"?n="crosshair":i==="tl"||i==="br"?n="nw-resize":i==="tr"||i==="bl"?n="ne-resize":this.isPointInImage(e,o)&&(n="move")}}this.selectedImageId||this.findImageAtPoint(e)&&(n="pointer"),t.style.cursor=n}startTokenDrag(e,t){this.draggingToken=e,this.dragStartHex.set(t),this.dragHoverHex.set(t),this.dragPath.set([t])}updateTokenDrag(e){if(!this.draggingToken)return;this.dragHoverHex.set(e);let t=this.dragStartHex();if(t){let n=this.findPath(t,e);this.dragPath.set(n)}this.scheduleRender()}finishTokenDrag(e){if(!this.draggingToken)return;let t=this.dragStartHex();t&&(t.q!==e.q||t.r!==e.r)&&this.tokenMove.emit({tokenId:this.draggingToken.id,position:e}),this.draggingToken=null,this.dragStartHex.set(null),this.dragHoverHex.set(null),this.dragPath.set([]),this.scheduleRender()}startImageTransform(e,t,n){this.transformingImageId=e.id,this.transformHandle=t,this.transformAnchor=n,this.initialImageTransform={x:e.x,y:e.y,width:e.width,height:e.height,rotation:e.rotation}}updateImageTransform(e){if(!this.transformingImageId||!this.transformHandle||!this.transformAnchor||!this.initialImageTransform||!this.map?.images?.find(a=>a.id===this.transformingImageId))return;let n=e.x-this.transformAnchor.x,o=e.y-this.transformAnchor.y,i={};switch(this.transformHandle){case"rotate":let a=Math.atan2(o,n)*180/Math.PI;i.rotation=this.initialImageTransform.rotation+a;break;case"tl":case"tr":case"bl":case"br":let c=Math.max(.1,1+(Math.abs(n)+Math.abs(o))/100);i.width=this.initialImageTransform.width*c,i.height=this.initialImageTransform.height*c;break}this.imageTransform.emit({id:this.transformingImageId,transform:i})}finishImageTransform(){this.transformingImageId=null,this.transformHandle=null,this.transformAnchor=null,this.initialImageTransform=null}paintWall(e){let n=(this.map?.walls||[]).some(o=>o.q===e.q&&o.r===e.r);this.wallPaintMode==="add"&&!n?this.store.addWall(e):this.wallPaintMode==="remove"&&n&&this.store.removeWall(e),this.scheduleRender()}renderCurrentStroke(e){if(!this.overlayCtx||this.currentStrokePoints.length===0)return;let t=this.overlayCanvas.nativeElement,n=this.overlayCtx,o=window.devicePixelRatio||1;if(n.clearRect(0,0,t.width/o,t.height/o),n.save(),n.translate(this.panX,this.panY),n.scale(this.scale,this.scale),this.currentStrokePoints.length>0){n.beginPath(),n.moveTo(this.currentStrokePoints[0].x,this.currentStrokePoints[0].y);for(let i=1;i<this.currentStrokePoints.length;i++)n.lineTo(this.currentStrokePoints[i].x,this.currentStrokePoints[i].y);n.lineTo(e.x,e.y),n.strokeStyle=this.currentTool==="erase"?"rgba(255, 0, 0, 0.5)":this.brushColor,n.lineWidth=this.currentTool==="erase"?this.eraserBrushSize:this.penBrushSize,n.lineCap="round",n.lineJoin="round",n.stroke()}n.restore()}findPath(e,t){let n=[e],o=e;for(;o.q!==t.q||o.r!==t.r;){let i=this.getHexNeighbors(o),a=i[0],c=S.hexDistance(a,t);for(let g of i){let I=S.hexDistance(g,t);I<c&&(a=g,c=I)}if(o=a,n.push(o),n.length>50)break}return n}getPendingImageId(){return null}onTokenDrop(e){e.preventDefault();let t=this.container.nativeElement.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top,i=this.screenToWorld(n,o),a=S.pixelToHex(i),c=e.dataTransfer?.getData("application/json");if(c){let g=JSON.parse(c);g.type==="character"?this.tokenDrop.emit({characterId:g.characterId,position:a}):g.type==="quickToken"&&this.quickTokenDrop.emit({name:g.name,portrait:g.portrait,position:a})}}onDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="copy"}onDragLeave(e){}onDrop(e){e.preventDefault();let t=e.dataTransfer?.files;t&&t.length>0&&t[0].type.startsWith("image/")&&this.toolAutoSelect.emit()}getTokenScreenPosition(e){let t=S.hexToPixel(e.position);return this.worldToScreen(t.x,t.y)}onTokenDragStart(e,t){this.draggingToken=e,this.dragStartHex.set(e.position);let n=this.container.nativeElement.getBoundingClientRect(),o=this.screenToWorld(t.clientX-n.left,t.clientY-n.top);this.dragGhostPosition.set(o)}onTokenContextMenu(e,t){t.preventDefault(),confirm(`Remove ${e.name} from the map?`)&&this.tokenRemove.emit(e.id)}onMoveImageForward(){let e=this.contextMenuImageId();e&&this.store.moveImageForward(e),this.closeContextMenu()}onMoveImageBackward(){let e=this.contextMenuImageId();e&&this.store.moveImageBackward(e),this.closeContextMenu()}onMoveImageToFront(){let e=this.contextMenuImageId();e&&this.store.moveImageToFront(e),this.closeContextMenu()}onMoveImageToBack(){let e=this.contextMenuImageId();e&&this.store.moveImageToBack(e),this.closeContextMenu()}onDeleteSelectedImage(){let e=this.contextMenuImageId();e&&this.imageDelete.emit(e),this.closeContextMenu()}onCreateQuickToken(){let e=this.contextMenuPos();if(e){let t=this.screenToWorld(e.x,e.y),n=S.pixelToHex(t)}this.closeContextMenu()}getHexNeighbors(e){return[{q:1,r:0},{q:1,r:-1},{q:0,r:-1},{q:-1,r:0},{q:-1,r:1},{q:0,r:1}].map(n=>({q:e.q+n.q,r:e.r+n.r}))}closeContextMenu(){this.contextMenuPosition.set({x:0,y:0}),this.contextMenuImageId.set(null)}contextMenuPos(){let e=this.contextMenuPosition();return e.x===0&&e.y===0?null:e}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=W({type:r,selectors:[["app-lobby-grid"]],viewQuery:function(t,n){if(t&1&&Se(qe,5)(Ge,5)(je,5)($e,5)(Ue,5),t&2){let o;Q(o=J())&&(n.gridCanvas=o.first),Q(o=J())&&(n.imageCanvas=o.first),Q(o=J())&&(n.drawCanvas=o.first),Q(o=J())&&(n.overlayCanvas=o.first),Q(o=J())&&(n.container=o.first)}},hostBindings:function(t,n){t&1&&M("keydown",function(i){return n.onKeyDown(i)},Me)},inputs:{map:"map",tokens:"tokens",currentTool:"currentTool",brushColor:"brushColor",penBrushSize:"penBrushSize",eraserBrushSize:"eraserBrushSize",drawWithWalls:"drawWithWalls",dragMode:"dragMode",drawLayerVisible:"drawLayerVisible",imageLayerVisible:"imageLayerVisible",selectedImageId:"selectedImageId",isGM:"isGM"},outputs:{tokenDrop:"tokenDrop",tokenMove:"tokenMove",tokenRemove:"tokenRemove",quickTokenDrop:"quickTokenDrop",imageSelect:"imageSelect",imageTransform:"imageTransform",imageDelete:"imageDelete",placeImage:"placeImage",toolAutoSelect:"toolAutoSelect"},features:[we],decls:15,vars:2,consts:[["container",""],["imageCanvas",""],["gridCanvas",""],["drawCanvas",""],["overlayCanvas",""],[1,"grid-container",3,"mousedown","mousemove","mouseup","mouseleave","wheel","contextmenu","dragover","dragleave","drop"],[1,"canvas-layer","image-layer"],[1,"canvas-layer","grid-layer"],[1,"canvas-layer","draw-layer"],[1,"canvas-layer","overlay-layer"],[1,"token-layer"],[3,"token","position","scale","isCurrentTurn"],[1,"drag-ghost",3,"left","top"],[1,"context-menu",3,"left","top"],[3,"dragStart","contextMenu","token","position","scale","isCurrentTurn"],[1,"drag-ghost"],[1,"context-menu",3,"click"],[3,"click"],[1,"menu-divider"],[1,"danger",3,"click"]],template:function(t,n){if(t&1){let o=v();C(0,"div",5,0),M("mousedown",function(a){return p(o),h(n.onMouseDown(a))})("mousemove",function(a){return p(o),h(n.onMouseMove(a))})("mouseup",function(a){return p(o),h(n.onMouseUp(a))})("mouseleave",function(a){return p(o),h(n.onMouseUp(a))})("wheel",function(a){return p(o),h(n.onWheel(a))})("contextmenu",function(a){return p(o),h(n.onContextMenu(a))})("dragover",function(a){return p(o),h(n.onDragOver(a))})("dragleave",function(a){return p(o),h(n.onDragLeave(a))})("drop",function(a){return p(o),h(n.onDrop(a))}),Y(2,"canvas",6,1)(4,"canvas",7,2)(6,"canvas",8,3)(8,"canvas",9,4),C(10,"div",10),D(11,Ye,1,4,"app-lobby-token",11,Xe),x(),f(13,Qe,1,4,"div",12),f(14,Ze,3,5,"div",13),x()}t&2&&(l(11),O(n.tokens),l(2),_(n.dragGhostPosition()?13:-1),l(),_(n.showContextMenu()?14:-1))},dependencies:[F,be],styles:[".grid-container[_ngcontent-%COMP%]{position:relative;width:100%;height:100%;overflow:hidden;cursor:crosshair;background:#f8fafc}.canvas-layer[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}.image-layer[_ngcontent-%COMP%]{z-index:1}.grid-layer[_ngcontent-%COMP%]{z-index:2}.draw-layer[_ngcontent-%COMP%]{z-index:3}.overlay-layer[_ngcontent-%COMP%]{z-index:4}.token-layer[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;z-index:10;pointer-events:none}.drag-ghost[_ngcontent-%COMP%]{position:absolute;width:40px;height:40px;margin-left:-20px;margin-top:-20px;border-radius:50%;background:#3b82f680;border:2px solid #3b82f6;pointer-events:none;z-index:20}.context-menu[_ngcontent-%COMP%]{position:fixed;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:4px 0;min-width:160px;z-index:1000;box-shadow:0 4px 12px #0000004d}.context-menu[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{display:block;width:100%;padding:8px 16px;background:none;border:none;color:var(--text);text-align:left;font-size:13px;cursor:pointer;transition:background .15s}.context-menu[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{background:var(--border)}.context-menu[_ngcontent-%COMP%]   button.danger[_ngcontent-%COMP%]{color:#ef4444}.context-menu[_ngcontent-%COMP%]   button.danger[_ngcontent-%COMP%]:hover{background:#ef444426}.menu-divider[_ngcontent-%COMP%]{height:1px;background:#334155;margin:4px 0}"],changeDetection:0})};var et=(r,e)=>e.id;function tt(r,e){if(r&1){let t=v();d(0,"button",10),w("click",function(){let o=p(t).$implicit,i=s();return h(i.selectTool(o.id))}),b(1),m()}if(r&2){let t=e.$implicit,n=s();P("active",n.currentTool===t.id),E("title",t.label+" ("+t.shortcut+")"),l(),B(" ",t.icon," ")}}function nt(r,e){if(r&1){let t=v();d(0,"button",19),w("click",function(){let o=p(t).$implicit,i=s(3);return h(i.selectColor(o))}),m()}if(r&2){let t=e.$implicit,n=s(3);R("background",t),P("active",n.brushColor===t)}}function ot(r,e){if(r&1){let t=v();d(0,"button",20),w("click",function(){let o=p(t).$implicit,i=s(3);return h(i.selectPenSize(o))}),z(1,"span",21),m()}if(r&2){let t=e.$implicit,n=s(3);P("active",n.penBrushSize===t),E("title",t+"px"),l(),R("width",n.clampSize(t),"px")("height",n.clampSize(t),"px")("background",n.brushColor)}}function it(r,e){if(r&1){let t=v();d(0,"div",15)(1,"input",16),w("input",function(o){p(t);let i=s(2);return h(i.onColorInput(o))}),m(),D(2,nt,1,4,"button",17,re),m(),d(4,"div",12),D(5,ot,2,9,"button",18,re),m()}if(r&2){let t=s(2);l(),E("value",t.brushColor),l(),O(t.presetColors),l(3),O(t.penBrushSizes)}}function rt(r,e){if(r&1){let t=v();d(0,"button",20),w("click",function(){let o=p(t).$implicit,i=s(3);return h(i.selectEraserSize(o))}),z(1,"span",22),m()}if(r&2){let t=e.$implicit,n=s(3);P("active",n.eraserBrushSize===t),E("title",t+"px"),l(),R("width",n.clampSize(t),"px")("height",n.clampSize(t),"px")}}function at(r,e){if(r&1&&(d(0,"div",12),D(1,rt,2,7,"button",18,re),m()),r&2){let t=s(2);l(),O(t.eraserBrushSizes)}}function st(r,e){if(r&1){let t=v();d(0,"label",13)(1,"input",23),w("change",function(){p(t);let o=s(2);return h(o.toggleDrawWithWalls())}),m(),d(2,"span"),b(3,"+ Walls"),m()()}if(r&2){let t=s(2);l(),E("checked",t.drawWithWalls)}}function lt(r,e){if(r&1){let t=v();d(0,"div",11),f(1,it,7,1),f(2,at,3,0,"div",12),f(3,st,4,1,"label",13),m(),z(4,"div",2),d(5,"div",3)(6,"button",14),w("click",function(){p(t);let o=s();return h(o.clearDrawings.emit())}),b(7," \u{1F5D1}\uFE0F "),m()()}if(r&2){let t=s();l(),_(t.currentTool==="draw"?1:-1),l(),_(t.currentTool==="erase"?2:-1),l(),_(t.isGM?3:-1)}}function ct(r,e){if(r&1){let t=v();d(0,"div",3)(1,"button",24),w("click",function(){p(t);let o=s();return h(o.setDragMode("free"))}),b(2," \u{1F193} "),m(),d(3,"button",25),w("click",function(){p(t);let o=s();return h(o.setDragMode("snap"))}),b(4," \u{1F9F2} "),m()()}if(r&2){let t=s();l(),P("active",t.dragMode==="free"),l(2),P("active",t.dragMode==="snap")}}function dt(r,e){if(r&1){let t=v();d(0,"div",3)(1,"button",26),w("click",function(){p(t);let o=s();return h(o.clearWalls.emit())}),b(2," \u{1F5D1}\uFE0F Walls "),m()()}}var fe=class r{currentTool="cursor";brushColor="#000000";penBrushSize=4;eraserBrushSize=12;drawWithWalls=!1;dragMode="free";drawLayerVisible=!0;isGM=!1;toolChange=new y;brushColorChange=new y;penBrushSizeChange=new y;eraserBrushSizeChange=new y;drawWithWallsChange=new y;dragModeChange=new y;drawLayerVisibleChange=new y;clearDrawings=new y;clearWalls=new y;toggleSidebar=new y;tools=[{id:"cursor",icon:"\u2196\uFE0F",label:"Select/Move",shortcut:"F"},{id:"draw",icon:"\u270F\uFE0F",label:"Draw",shortcut:"B"},{id:"erase",icon:"\u{1F9F9}",label:"Erase",shortcut:"E"},{id:"walls",icon:"\u{1F9F1}",label:"Walls",shortcut:"W"},{id:"measure",icon:"\u{1F4CF}",label:"Measure",shortcut:"R"},{id:"image",icon:"\u{1F5BC}\uFE0F",label:"Images",shortcut:"I"}];penBrushSizes=[2,4,8,12,20];eraserBrushSizes=[8,12,20,32,48];presetColors=["#ef4444","#f97316","#eab308","#22c55e","#3b82f6","#8b5cf6","#ec4899","#ffffff","#000000"];selectTool(e){this.toolChange.emit(e)}selectColor(e){this.brushColorChange.emit(e)}onColorInput(e){let t=e.target;this.brushColorChange.emit(t.value)}selectPenSize(e){this.penBrushSizeChange.emit(e)}selectEraserSize(e){this.eraserBrushSizeChange.emit(e)}toggleDrawWithWalls(){this.drawWithWallsChange.emit(!this.drawWithWalls)}setDragMode(e){this.dragModeChange.emit(e)}clampSize(e){return Math.min(e,24)}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=W({type:r,selectors:[["app-lobby-toolbar"]],inputs:{currentTool:"currentTool",brushColor:"brushColor",penBrushSize:"penBrushSize",eraserBrushSize:"eraserBrushSize",drawWithWalls:"drawWithWalls",dragMode:"dragMode",drawLayerVisible:"drawLayerVisible",isGM:"isGM"},outputs:{toolChange:"toolChange",brushColorChange:"brushColorChange",penBrushSizeChange:"penBrushSizeChange",eraserBrushSizeChange:"eraserBrushSizeChange",drawWithWallsChange:"drawWithWallsChange",dragModeChange:"dragModeChange",drawLayerVisibleChange:"drawLayerVisibleChange",clearDrawings:"clearDrawings",clearWalls:"clearWalls",toggleSidebar:"toggleSidebar"},decls:18,vars:7,consts:[[1,"toolbar"],["title","Toggle Sidebar",1,"tool-btn","sidebar-toggle",3,"click"],[1,"toolbar-divider"],[1,"tool-group"],[1,"tool-btn",3,"active","title"],[1,"spacer"],[1,"tool-group","layer-toggles"],[1,"tool-btn","layer-toggle",3,"click","title"],[1,"layer-icon"],[1,"layer-label"],[1,"tool-btn",3,"click","title"],[1,"tool-group","drawing-options"],[1,"brush-sizes"],[1,"checkbox-label"],["title","Clear All Drawings",1,"tool-btn","danger",3,"click"],[1,"color-picker"],["type","color",1,"color-input",3,"input","value"],[1,"color-btn",3,"background","active"],[1,"size-btn",3,"active","title"],[1,"color-btn",3,"click"],[1,"size-btn",3,"click","title"],[1,"size-dot"],[1,"size-dot","eraser-dot"],["type","checkbox",3,"change","checked"],["title","Free Movement",1,"tool-btn",3,"click"],["title","Snap to Grid",1,"tool-btn",3,"click"],["title","Clear All Walls",1,"tool-btn","danger",3,"click"]],template:function(t,n){t&1&&(d(0,"div",0)(1,"button",1),w("click",function(){return n.toggleSidebar.emit()}),b(2," \u2630 "),m(),z(3,"div",2),d(4,"div",3),D(5,tt,2,4,"button",4,et),m(),z(7,"div",2),f(8,lt,8,3),f(9,ct,5,4,"div",3),f(10,dt,3,0,"div",3),z(11,"div",5),d(12,"div",6)(13,"button",7),w("click",function(){return n.drawLayerVisibleChange.emit(!n.drawLayerVisible)}),d(14,"span",8),b(15),m(),d(16,"span",9),b(17,"Draw"),m()()()()),t&2&&(l(5),O(n.tools),l(3),_(n.currentTool==="draw"||n.currentTool==="erase"?8:-1),l(),_(n.currentTool==="cursor"?9:-1),l(),_(n.currentTool==="walls"&&n.isGM?10:-1),l(3),P("layer-hidden",!n.drawLayerVisible),E("title",n.drawLayerVisible?"Hide Drawing Layer":"Show Drawing Layer"),l(2),H(n.drawLayerVisible?"\u{1F441}\uFE0F":"\u{1F6AB}"))},dependencies:[F,ce],styles:[".toolbar[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--card, #1f2937);border-bottom:1px solid var(--border, #374151);min-height:52px}.tool-group[_ngcontent-%COMP%]{display:flex;align-items:center;gap:4px}.toolbar-divider[_ngcontent-%COMP%]{width:1px;height:32px;background:var(--border, #374151);margin:0 8px}.spacer[_ngcontent-%COMP%]{flex:1}.tool-btn[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;width:40px;height:40px;border:1px solid var(--border, #374151);border-radius:8px;background:var(--bg, #111827);color:var(--text, #e5e7eb);font-size:18px;cursor:pointer;transition:all .2s}.tool-btn[_ngcontent-%COMP%]:hover{background:var(--card, #1f2937);border-color:var(--accent, #3b82f6)}.tool-btn.active[_ngcontent-%COMP%]{background:var(--accent, #3b82f6);border-color:var(--accent, #3b82f6)}.tool-btn.inactive[_ngcontent-%COMP%]{opacity:.5}.tool-btn.danger[_ngcontent-%COMP%]:hover{background:#ef4444;border-color:#ef4444}.sidebar-toggle[_ngcontent-%COMP%]{font-size:20px}.color-picker[_ngcontent-%COMP%]{display:flex;align-items:center;gap:4px}.color-input[_ngcontent-%COMP%]{width:32px;height:32px;border:none;border-radius:6px;cursor:pointer;padding:0}.color-btn[_ngcontent-%COMP%]{width:24px;height:24px;border:2px solid #0f3460;border-radius:4px;cursor:pointer;transition:transform .2s,border-color .2s}.color-btn[_ngcontent-%COMP%]:hover{transform:scale(1.1)}.color-btn.active[_ngcontent-%COMP%]{border-color:#3b82f6;transform:scale(1.1)}.brush-sizes[_ngcontent-%COMP%]{display:flex;align-items:center;gap:4px;margin-left:8px}.size-btn[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;width:32px;height:32px;border:1px solid #0f3460;border-radius:6px;background:#1a1a2e;cursor:pointer;transition:all .2s}.size-btn[_ngcontent-%COMP%]:hover{border-color:#3b82f6}.size-btn.active[_ngcontent-%COMP%]{background:#0f3460;border-color:#3b82f6}.size-dot[_ngcontent-%COMP%]{border-radius:50%;background:#e0e0e0}.size-dot.eraser-dot[_ngcontent-%COMP%]{background:#94a3b8;border:1px dashed #64748b}.checkbox-label[_ngcontent-%COMP%]{display:flex;align-items:center;gap:6px;color:#a0a0a0;font-size:12px;cursor:pointer;margin-left:12px}.checkbox-label[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{cursor:pointer}.drawing-options[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px}.layer-toggles[_ngcontent-%COMP%]{gap:8px}.layer-toggle[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;width:auto;padding:4px 12px;gap:2px}.layer-toggle[_ngcontent-%COMP%]   .layer-icon[_ngcontent-%COMP%]{font-size:16px}.layer-toggle[_ngcontent-%COMP%]   .layer-label[_ngcontent-%COMP%]{font-size:10px;opacity:.8}.layer-toggle.layer-hidden[_ngcontent-%COMP%]{opacity:.4;background:#0f0f1a}.layer-toggle.layer-hidden[_ngcontent-%COMP%]:hover{opacity:.6}"],changeDetection:0})};var Ve=(r,e)=>e.id;function mt(r,e){if(r&1&&(z(0,"img",12),ae(1,"imageUrl")),r&2){let t=s().$implicit;E("src",se(1,1,t.sheet.portrait),te)}}function pt(r,e){if(r&1&&(d(0,"div",13),b(1),m()),r&2){let t=s().$implicit;l(),H((t.sheet.name||t.id).charAt(0))}}function ht(r,e){if(r&1&&(d(0,"span"),b(1),m()),r&2){let t=s().$implicit;l(),H(t.sheet.race)}}function bt(r,e){r&1&&(d(0,"span",17),b(1,"\u{1F3AF}"),m())}function gt(r,e){if(r&1){let t=v();d(0,"div",10),w("dragstart",function(o){let i=p(t).$implicit,a=s(2);return h(a.onCharacterDragStart(o,i.id))}),d(1,"div",11),f(2,mt,2,3,"img",12)(3,pt,2,1,"div",13),m(),d(4,"div",14)(5,"div",15),b(6),m(),d(7,"div",16),f(8,ht,2,1,"span"),m()(),f(9,bt,2,0,"span",17),m()}if(r&2){let t=e.$implicit,n=s(2);P("on-map",n.isTokenOnMap(t.id)),l(2),_(t.sheet.portrait?2:3),l(4),H(t.sheet.name||t.id),l(2),_(t.sheet.race?8:-1),l(),_(n.isTokenOnMap(t.id)?9:-1)}}function ut(r,e){if(r&1&&(d(0,"p"),b(1),m()),r&2){let t=s(3);l(),B('No characters match "',t.searchQuery(),'"')}}function ft(r,e){r&1&&(d(0,"p"),b(1,"No characters in this world"),m(),d(2,"p",18),b(3,"Add characters in the World view"),m())}function _t(r,e){if(r&1&&(d(0,"div",9),f(1,ut,2,1,"p")(2,ft,4,0),m()),r&2){let t=s(2);l(),_(t.searchQuery()?1:2)}}function yt(r,e){if(r&1&&(d(0,"div",6),D(1,gt,10,6,"div",8,Ve),f(3,_t,3,1,"div",9),m()),r&2){let t=s();l(),O(t.filteredCharacters),l(2),_(t.filteredCharacters.length===0?3:-1)}}function vt(r,e){if(r&1){let t=v();d(0,"label",19)(1,"input",22),w("change",function(o){p(t);let i=s(2);return h(i.onFileSelect(o))}),m(),d(2,"span"),b(3,"\u{1F4C1} Upload Images"),m()()}}function Ct(r,e){if(r&1){let t=v();d(0,"input",28),w("input",function(o){p(t);let i=s(3);return h(i.editingName.set(o.target.value))})("keydown",function(o){p(t);let i=s(3);return h(i.onRenameKeydown(o))})("blur",function(){p(t);let o=s(3);return h(o.saveRename())}),m()}if(r&2){let t=s(3);E("value",t.editingName())}}function xt(r,e){if(r&1){let t=v();d(0,"div",29),w("dblclick",function(o){p(t);let i=s().$implicit,a=s(2);return h(a.startRename(i,o))}),b(1),m()}if(r&2){let t=s().$implicit;l(),B(" ",t.name," ")}}function wt(r,e){if(r&1){let t=v();d(0,"div",27)(1,"button",30),w("click",function(o){p(t);let i=s().$implicit,a=s(2);return h(a.startRename(i,o))}),b(2," \u270F\uFE0F "),m(),d(3,"button",31),w("click",function(){p(t);let o=s().$implicit,i=s(2);return h(i.confirmDelete(o.id,o.name))}),b(4," \u{1F5D1}\uFE0F "),m()()}}function kt(r,e){if(r&1){let t=v();d(0,"div",23),w("dragstart",function(o){let i=p(t).$implicit,a=s(2);return h(a.onImageDragStart(o,i))}),d(1,"div",24),z(2,"img",12),m(),f(3,Ct,1,1,"input",25)(4,xt,2,1,"div",26),f(5,wt,5,0,"div",27),m()}if(r&2){let t=e.$implicit,n=s(2);l(2),E("src","/api/images/"+t.imageId,te),l(),_(n.editingImageId()===t.id?3:4),l(2),_(n.isGM?5:-1)}}function Mt(r,e){if(r&1&&(d(0,"p"),b(1),m()),r&2){let t=s(3);l(),B('No images match "',t.searchQuery(),'"')}}function St(r,e){r&1&&(d(0,"p",18),b(1,"Upload images to use as backgrounds"),m())}function Tt(r,e){if(r&1&&(d(0,"p"),b(1,"No images in library"),m(),f(2,St,2,0,"p",18)),r&2){let t=s(3);l(2),_(t.isGM?2:-1)}}function It(r,e){if(r&1&&(d(0,"div",9),f(1,Mt,2,1,"p")(2,Tt,3,1),m()),r&2){let t=s(2);l(),_(t.searchQuery()?1:2)}}function Lt(r,e){if(r&1&&(d(0,"div",7),f(1,vt,4,0,"label",19),d(2,"div",20),D(3,kt,6,3,"div",21,Ve),m(),f(5,It,3,1,"div",9),m()),r&2){let t=s();l(),_(t.isGM?1:-1),l(2),O(t.filteredImages),l(2),_(t.filteredImages.length===0?5:-1)}}var _e=class r{characters=[];tokensOnMap=[];images=[];isGM=!1;loadImages=new y;deleteImage=new y;renameImage=new y;dragStart=new y;activeTab=u("characters");editingImageId=u(null);editingName=u("");searchQuery=u("");switchTab(e){this.activeTab.set(e)}onCharacterDragStart(e,t){e.dataTransfer?.setData("text/plain",JSON.stringify({type:"character",characterId:t}))}isTokenOnMap(e){return this.tokensOnMap.some(t=>t.characterId===e)}get filteredCharacters(){let e=this.searchQuery().toLowerCase();return e?this.characters.filter(t=>t.sheet.name?.toLowerCase().includes(e)||t.id.toLowerCase().includes(e)):this.characters}onFileSelect(e){let t=e.target;t.files&&t.files.length>0&&(this.loadImages.emit(t.files),t.value="")}onImageDragStart(e,t){e.dataTransfer?.setData("text/plain",JSON.stringify({type:"library-image",imageId:t.imageId,width:t.width,height:t.height})),this.dragStart.emit(t)}startRename(e,t){t.stopPropagation(),this.editingImageId.set(e.id),this.editingName.set(e.name)}saveRename(){let e=this.editingImageId(),t=this.editingName().trim();e&&t&&this.renameImage.emit({id:e,name:t}),this.cancelRename()}cancelRename(){this.editingImageId.set(null),this.editingName.set("")}onRenameKeydown(e){e.key==="Enter"?this.saveRename():e.key==="Escape"&&this.cancelRename()}confirmDelete(e,t){confirm(`Delete "${t}"?`)&&this.deleteImage.emit(e)}get filteredImages(){let e=this.searchQuery().toLowerCase();return e?this.images.filter(t=>t.name.toLowerCase().includes(e)):this.images}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=W({type:r,selectors:[["app-lobby-sidebar"]],inputs:{characters:"characters",tokensOnMap:"tokensOnMap",images:"images",isGM:"isGM"},outputs:{loadImages:"loadImages",deleteImage:"deleteImage",renameImage:"renameImage",dragStart:"dragStart"},decls:11,vars:7,consts:[[1,"sidebar"],[1,"tab-header"],[1,"tab-btn",3,"click"],[1,"search-bar"],["type","text","placeholder","Search...",3,"input","value"],[1,"tab-content"],[1,"character-list"],[1,"image-library"],["draggable","true",1,"character-item",3,"on-map"],[1,"empty-state"],["draggable","true",1,"character-item",3,"dragstart"],[1,"char-portrait"],["alt","",3,"src"],[1,"char-placeholder"],[1,"char-info"],[1,"char-name"],[1,"char-meta"],["title","Token on map",1,"on-map-badge"],[1,"hint"],[1,"upload-btn"],[1,"image-grid"],["draggable","true",1,"image-item"],["type","file","accept","image/*","multiple","","hidden","",3,"change"],["draggable","true",1,"image-item",3,"dragstart"],[1,"image-preview"],["type","text","autofocus","",1,"rename-input",3,"value"],[1,"image-name"],[1,"image-actions"],["type","text","autofocus","",1,"rename-input",3,"input","keydown","blur","value"],[1,"image-name",3,"dblclick"],["title","Rename",1,"action-btn",3,"click"],["title","Delete",1,"action-btn","danger",3,"click"]],template:function(t,n){t&1&&(d(0,"div",0)(1,"div",1)(2,"button",2),w("click",function(){return n.switchTab("characters")}),b(3," \u{1F464} Characters "),m(),d(4,"button",2),w("click",function(){return n.switchTab("images")}),b(5," \u{1F5BC}\uFE0F Images "),m()(),d(6,"div",3)(7,"input",4),w("input",function(i){return n.searchQuery.set(i.target.value)}),m()(),d(8,"div",5),f(9,yt,4,1,"div",6),f(10,Lt,6,2,"div",7),m()()),t&2&&(l(2),P("active",n.activeTab()==="characters"),l(2),P("active",n.activeTab()==="images"),l(3),E("value",n.searchQuery()),l(2),_(n.activeTab()==="characters"?9:-1),l(),_(n.activeTab()==="images"?10:-1))},dependencies:[F,ce,de],styles:[".sidebar[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:100%}.tab-header[_ngcontent-%COMP%]{display:flex;border-bottom:1px solid var(--border, #374151)}.tab-btn[_ngcontent-%COMP%]{flex:1;padding:12px;background:none;border:none;color:var(--text, #e5e7eb);opacity:.6;font-size:13px;cursor:pointer;transition:all .2s}.tab-btn[_ngcontent-%COMP%]:hover{background:#ffffff0d;opacity:.9}.tab-btn.active[_ngcontent-%COMP%]{color:var(--accent, #3b82f6);opacity:1;border-bottom:2px solid var(--accent, #3b82f6);background:#3b82f61a}.search-bar[_ngcontent-%COMP%]{padding:8px;border-bottom:1px solid var(--border, #374151)}.search-bar[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:100%;padding:8px 12px;background:var(--bg, #111827);border:1px solid var(--border, #374151);border-radius:6px;color:var(--text, #e5e7eb);font-size:13px}.search-bar[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:focus{outline:none;border-color:var(--accent, #3b82f6)}.tab-content[_ngcontent-%COMP%]{flex:1;overflow-y:auto;padding:8px}.character-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:4px}.character-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg, #111827);border:1px solid var(--border, #374151);border-radius:8px;cursor:grab;transition:all .2s}.character-item[_ngcontent-%COMP%]:hover{border-color:var(--accent, #3b82f6);background:#3b82f61a}.character-item.on-map[_ngcontent-%COMP%]{border-color:#22c55e;background:#22c55e1a}.character-item[_ngcontent-%COMP%]:active{cursor:grabbing}.char-portrait[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:50%;overflow:hidden;flex-shrink:0}.char-portrait[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.char-placeholder[_ngcontent-%COMP%]{width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--border, #374151);color:var(--text, #e5e7eb);opacity:.6;font-size:18px;font-weight:600}.char-info[_ngcontent-%COMP%]{flex:1;min-width:0}.char-name[_ngcontent-%COMP%]{color:var(--text, #e5e7eb);font-size:14px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.char-meta[_ngcontent-%COMP%]{display:flex;gap:6px;color:#6b7280;font-size:11px}.on-map-badge[_ngcontent-%COMP%]{font-size:12px}.image-library[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:8px}.upload-btn[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;padding:12px;background:var(--bg, #111827);border:1px dashed var(--accent, #3b82f6);border-radius:8px;color:var(--accent, #3b82f6);font-size:13px;cursor:pointer;transition:all .2s}.upload-btn[_ngcontent-%COMP%]:hover{background:#3b82f633}.image-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}.image-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;background:var(--bg, #111827);border:1px solid var(--border, #374151);border-radius:8px;overflow:hidden;cursor:grab;transition:all .2s}.image-item[_ngcontent-%COMP%]:hover{border-color:var(--accent, #3b82f6)}.image-item[_ngcontent-%COMP%]:active{cursor:grabbing}.image-preview[_ngcontent-%COMP%]{width:100%;height:80px;overflow:hidden;background:var(--border, #374151)}.image-preview[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.image-name[_ngcontent-%COMP%]{padding:6px 8px;color:var(--text, #e5e7eb);opacity:.6;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.rename-input[_ngcontent-%COMP%]{width:100%;padding:6px 8px;background:var(--bg, #111827);border:1px solid var(--accent, #3b82f6);border-radius:0;color:var(--text, #e5e7eb);font-size:11px}.image-actions[_ngcontent-%COMP%]{display:none;padding:4px;gap:4px;justify-content:flex-end}.image-item[_ngcontent-%COMP%]:hover   .image-actions[_ngcontent-%COMP%]{display:flex}.action-btn[_ngcontent-%COMP%]{width:24px;height:24px;display:flex;align-items:center;justify-content:center;background:none;border:none;border-radius:4px;font-size:12px;cursor:pointer;transition:background .2s}.action-btn[_ngcontent-%COMP%]:hover{background:#ffffff1a}.action-btn.danger[_ngcontent-%COMP%]:hover{background:#ef444433}.empty-state[_ngcontent-%COMP%]{text-align:center;padding:32px 16px;color:#6b7280}.empty-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0}.empty-state[_ngcontent-%COMP%]   .hint[_ngcontent-%COMP%]{font-size:12px;margin-top:4px;color:#4b5563}"],changeDetection:0})};var Pt=(r,e)=>e.id;function Et(r,e){if(r&1){let t=v();C(0,"app-lobby-sidebar",13),M("loadImages",function(o){p(t);let i=s();return h(i.onLoadImages(o))})("deleteImage",function(o){p(t);let i=s();return h(i.onDeleteLibraryImage(o))})("renameImage",function(o){p(t);let i=s();return h(i.onRenameLibraryImage(o))}),x()}if(r&2){let t=s();j("characters",t.worldCharacters())("tokensOnMap",t.enrichedTokens())("images",t.imageLibrary())("isGM",t.isGM())}}function Dt(r,e){if(r&1&&(C(0,"div",8),Y(1,"app-battle-tracker",14),x()),r&2){let t=s();l(),j("engine",t.battleTrackerEngine())}}function Ot(r,e){if(r&1){let t=v();C(0,"button",15),M("click",function(){p(t);let o=s();return h(o.showMapSettings())}),b(1," \u2699\uFE0F "),x()}}function zt(r,e){r&1&&(C(0,"span",24),b(1,"Current"),x())}function Vt(r,e){if(r&1&&(C(0,"div",23)(1,"span",10),b(2),x(),f(3,zt,2,0,"span",24),x()),r&2){let t=e.$implicit,n=s(2);P("active",n.currentMapId()===t.id),l(2),H(t.name),l(),_(n.currentMapId()===t.id?3:-1)}}function Ht(r,e){if(r&1){let t=v();C(0,"div",16),M("click",function(){p(t);let o=s();return h(o.showMapSettingsModal.set(!1))}),C(1,"div",17),M("click",function(o){return p(t),h(o.stopPropagation())}),C(2,"div",18)(3,"h3"),b(4,"Map Settings"),x(),C(5,"button",19),M("click",function(){p(t);let o=s();return h(o.showMapSettingsModal.set(!1))}),b(6,"\xD7"),x()(),C(7,"div",20)(8,"p"),b(9),x(),C(10,"div",21),D(11,Vt,4,4,"div",22,Pt),x()()()()}if(r&2){let t=s();l(9),B("Maps: ",t.mapList().length),l(2),O(t.mapList())}}var He=class r{route=L(Ie);store=L(ee);worldStore=L(Ee);characterApi=L(Le);imageService=L(Z);cdr=L(le);subscriptions=[];worldName=u("");isGM=u(!1);lobby=u(null);currentMapId=u("default");worldCharacters=u([]);currentTool=u("cursor");brushColor=u("#000000");penBrushSize=u(4);eraserBrushSize=u(12);drawWithWalls=u(!1);dragMode=u("free");drawLayerVisible=u(!0);imageLayerVisible=u(!0);selectedImageId=u(null);showSidebar=u(!0);sidebarTab=u("characters");showMapSettingsModal=u(!1);currentMap=K(()=>{let e=this.lobby(),t=this.currentMapId();return e?.maps[t]||null});enrichedTokens=K(()=>{let e=this.currentMap();if(!e)return[];let t=this.worldCharacters(),n=new Map;return t.forEach(o=>{o.sheet.portrait&&n.set(o.id,o.sheet.portrait)}),e.tokens.map(o=>N(k({},o),{portrait:o.isQuickToken?o.portrait:n.get(o.characterId)||o.portrait}))});imageLibrary=K(()=>this.lobby()?.imageLibrary||[]);mapList=K(()=>{let e=this.lobby();return e?Object.entries(e.maps).map(([t,n])=>({id:t,name:n.name})):[]});battleTrackerEngine=K(()=>{let e=new Oe,t=this.worldCharacters();return e});ngOnInit(){this.subscriptions.push(this.route.paramMap.subscribe(async e=>{let t=e.get("worldName")||"default";this.worldName.set(t),this.route.queryParamMap.subscribe(n=>{this.isGM.set(n.get("gm")==="true")}),await this.loadLobby(t),await this.worldStore.load(t),console.log("[Lobby] World loaded, characterIds:",this.worldStore.worldValue?.characterIds),await this.loadWorldCharacters()})),this.subscriptions.push(this.store.lobby$.subscribe(e=>{this.lobby.set(e),e?.activeMapId&&this.currentMapId.set(e.activeMapId),this.cdr.markForCheck()}))}async loadLobby(e){console.log("[Lobby] Loading lobby for:",e);try{await this.store.loadLobby(e),console.log("[Lobby] Lobby loaded successfully")}catch(t){console.error("[Lobby] Failed to load lobby:",t)}}async loadWorldCharacters(){let e=this.worldStore.worldValue;if(!e){console.warn("[Lobby] No world loaded");return}console.log("[Lobby] World data:",{name:e.name,characterIds:e.characterIds,hasCharacters:!!e.characterIds?.length});let t=[];for(let n of e.characterIds||[])try{console.log("[Lobby] Loading character:",n);let o=await this.characterApi.loadCharacter(n);o?(console.log("[Lobby] Character loaded:",n,o.name),t.push({id:n,sheet:o})):console.warn("[Lobby] Character sheet is null for:",n)}catch(o){console.error("[Lobby] Failed to load character:",n,o)}console.log("[Lobby] Loaded characters:",t.length,t.map(n=>n.sheet.name)),this.worldCharacters.set(t),this.cdr.markForCheck()}ngOnDestroy(){this.subscriptions.forEach(e=>e.unsubscribe())}handleKeyDown(e){let t=e.target;if(t.tagName==="INPUT"||t.tagName==="TEXTAREA")return;switch(e.key.toLowerCase()){case"e":this.currentTool.set(this.currentTool()==="erase"?"draw":"erase"),e.preventDefault();break;case"b":this.currentTool.set("draw"),e.preventDefault();break;case"f":this.currentTool.set("cursor"),e.preventDefault();break;case"r":this.currentTool.set("measure"),e.preventDefault();break;case"w":this.currentTool.set("walls"),e.preventDefault();break;case"i":this.currentTool.set("image"),e.preventDefault();break;case"z":e.ctrlKey&&(this.store.undoStroke(),e.preventDefault());break}}onToolChange(e){this.currentTool.set(e)}onBrushColorChange(e){this.brushColor.set(e)}onPenBrushSizeChange(e){this.penBrushSize.set(e)}onEraserBrushSizeChange(e){this.eraserBrushSize.set(e)}onDragModeChange(e){this.dragMode.set(e)}onDrawWithWallsChange(e){this.drawWithWalls.set(e)}onTokenDrop(e){console.log("[Lobby] Token drop:",e);let t=this.worldCharacters().find(i=>i.id===e.characterId);if(!t)return;let n=t.sheet.speed,o=n?n.base+(n.bonus||0):6;this.store.addToken({characterId:e.characterId,name:t.sheet.name||e.characterId,position:e.position,team:"blue",isQuickToken:!1,movementSpeed:o})}onQuickTokenDrop(e){console.log("[Lobby] Quick token drop:",e),this.store.addToken({characterId:"quick-"+Date.now(),name:e.name,portrait:e.portrait,position:e.position,team:"red",isQuickToken:!0})}onTokenMove(e){this.store.moveToken(e.tokenId,e.position)}onTokenRemove(e){this.store.removeToken(e)}async onLoadImages(e){if(this.isGM())for(let t=0;t<e.length;t++){let n=e[t];if(!n.type.startsWith("image/"))continue;let o=new FileReader;o.onload=async i=>{let a=i.target?.result;if(a)try{let c=n.name.replace(/\.[^/.]+$/,"");await this.store.addLibraryImage(a,c),this.cdr.markForCheck()}catch(c){console.error("[Lobby] Failed to upload image:",c)}},o.readAsDataURL(n)}}onRenameLibraryImage(e){this.store.updateLibraryImage(e.id,e.name)}onDeleteLibraryImage(e){this.store.removeLibraryImage(e)}onPlaceImage(e){this.store.addImage(e.imageId,e.x,e.y,e.width,e.height)}onSelectImage(e){this.selectedImageId.set(e)}onTransformImage(e){this.store.updateImage(e.id,e.transform)}onDeleteImage(e){this.store.removeImage(e),this.selectedImageId()===e&&this.selectedImageId.set(null)}async onCreateMap(e){await this.store.createMap(e)}async onDeleteMap(e){await this.store.deleteMap(e)}async onSwitchMap(e){await this.store.switchMap(e),this.currentMapId.set(e)}onDrawLayerVisibleChange(e){this.drawLayerVisible.set(e)}onImageLayerVisibleChange(e){this.imageLayerVisible.set(e)}toggleSidebar(){this.showSidebar.set(!this.showSidebar())}showMapSettings(){console.log("[Lobby] Opening map settings..."),this.showMapSettingsModal.set(!0)}async cleanupImages(){console.log("[Lobby] Starting image cleanup..."),await this.store.cleanupOrphanedImages()}onToolAutoSelect(e){e==="image"&&this.currentTool.set("image")}static \u0275fac=function(t){return new(t||r)};static \u0275cmp=W({type:r,selectors:[["app-lobby"]],hostBindings:function(t,n){t&1&&M("keydown",function(i){return n.handleKeyDown(i)},ke)},decls:15,vars:25,consts:[[1,"lobby-container"],[3,"toolChange","brushColorChange","penBrushSizeChange","eraserBrushSizeChange","drawWithWallsChange","dragModeChange","drawLayerVisibleChange","clearDrawings","clearWalls","toggleSidebar","currentTool","brushColor","penBrushSize","eraserBrushSize","drawWithWalls","dragMode","drawLayerVisible","isGM"],[2,"position","fixed","top","10px","right","10px","z-index","1000"],[2,"background","red","color","white","border","none","padding","8px 12px","border-radius","4px","cursor","pointer",3,"click"],[1,"lobby-main"],[1,"lobby-sidebar",3,"characters","tokensOnMap","images","isGM"],[1,"lobby-grid-wrapper"],[3,"tokenDrop","tokenMove","tokenRemove","quickTokenDrop","imageSelect","imageTransform","imageDelete","placeImage","toolAutoSelect","map","tokens","currentTool","brushColor","penBrushSize","eraserBrushSize","drawWithWalls","dragMode","drawLayerVisible","imageLayerVisible","selectedImageId","isGM"],[1,"battle-tracker-panel"],[1,"map-badge"],[1,"map-name"],["title","Switch Map",1,"map-switch-btn"],[1,"modal-backdrop"],[1,"lobby-sidebar",3,"loadImages","deleteImage","renameImage","characters","tokensOnMap","images","isGM"],[1,"read-only",3,"engine"],["title","Switch Map",1,"map-switch-btn",3,"click"],[1,"modal-backdrop",3,"click"],[1,"modal-dialog",3,"click"],[1,"modal-header"],[1,"modal-close",3,"click"],[1,"modal-content"],[1,"map-list"],[1,"map-item",3,"active"],[1,"map-item"],[1,"current-badge"]],template:function(t,n){if(t&1&&(C(0,"div",0)(1,"app-lobby-toolbar",1),M("toolChange",function(i){return n.onToolChange(i)})("brushColorChange",function(i){return n.onBrushColorChange(i)})("penBrushSizeChange",function(i){return n.onPenBrushSizeChange(i)})("eraserBrushSizeChange",function(i){return n.onEraserBrushSizeChange(i)})("drawWithWallsChange",function(i){return n.onDrawWithWallsChange(i)})("dragModeChange",function(i){return n.onDragModeChange(i)})("drawLayerVisibleChange",function(i){return n.onDrawLayerVisibleChange(i)})("clearDrawings",function(){return n.store.clearStrokes()})("clearWalls",function(){return n.store.clearWalls()})("toggleSidebar",function(){return n.toggleSidebar()}),x(),C(2,"div",2)(3,"button",3),M("click",function(){return n.cleanupImages()}),b(4," \u{1F9F9} Cleanup Broken Images "),x()(),C(5,"div",4),f(6,Et,1,4,"app-lobby-sidebar",5),C(7,"div",6)(8,"app-lobby-grid",7),M("tokenDrop",function(i){return n.onTokenDrop(i)})("tokenMove",function(i){return n.onTokenMove(i)})("tokenRemove",function(i){return n.onTokenRemove(i)})("quickTokenDrop",function(i){return n.onQuickTokenDrop(i)})("imageSelect",function(i){return n.onSelectImage(i)})("imageTransform",function(i){return n.onTransformImage(i)})("imageDelete",function(i){return n.onDeleteImage(i)})("placeImage",function(i){return n.onPlaceImage(i)})("toolAutoSelect",function(i){return n.onToolAutoSelect(i)}),x()(),f(9,Dt,2,1,"div",8),x(),C(10,"div",9)(11,"span",10),b(12),x(),f(13,Ot,2,0,"button",11),x()(),f(14,Ht,13,1,"div",12)),t&2){let o;l(),j("currentTool",n.currentTool())("brushColor",n.brushColor())("penBrushSize",n.penBrushSize())("eraserBrushSize",n.eraserBrushSize())("drawWithWalls",n.drawWithWalls())("dragMode",n.dragMode())("drawLayerVisible",n.drawLayerVisible())("isGM",n.isGM()),l(5),_(n.showSidebar()?6:-1),l(2),j("map",n.currentMap())("tokens",n.enrichedTokens())("currentTool",n.currentTool())("brushColor",n.brushColor())("penBrushSize",n.penBrushSize())("eraserBrushSize",n.eraserBrushSize())("drawWithWalls",n.drawWithWalls())("dragMode",n.dragMode())("drawLayerVisible",n.drawLayerVisible())("imageLayerVisible",n.imageLayerVisible())("selectedImageId",n.selectedImageId())("isGM",n.isGM()),l(),_(n.isGM()?9:-1),l(3),H(((o=n.currentMap())==null?null:o.name)||"No Map"),l(),_(n.isGM()?13:-1),l(),_(n.showMapSettingsModal()?14:-1)}},dependencies:[F,ue,fe,_e,De],styles:[".lobby-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:100vh;width:100vw;overflow:hidden;background:var(--bg)}.lobby-main[_ngcontent-%COMP%]{display:flex;flex:1;overflow:hidden}.lobby-sidebar[_ngcontent-%COMP%]{width:280px;min-width:280px;background:var(--card);border-right:1px solid var(--border);overflow-y:auto}.lobby-grid-wrapper[_ngcontent-%COMP%]{flex:1;position:relative;overflow:hidden}.battle-tracker-panel[_ngcontent-%COMP%]{position:absolute;top:20px;right:20px;width:300px;max-height:60vh;background:#fffffff2;border-radius:8px;border:1px solid #e5e7eb;box-shadow:0 4px 12px #00000026;-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);z-index:50;overflow:hidden}.battle-tracker-panel[_ngcontent-%COMP%]   .read-only[_ngcontent-%COMP%]{pointer-events:none;opacity:.8}.map-badge[_ngcontent-%COMP%]{position:absolute;bottom:16px;left:50%;transform:translate(-50%);display:flex;align-items:center;gap:8px;background:#1f2937f2;padding:8px 16px;border-radius:8px;border:1px solid var(--border);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);z-index:100}.map-name[_ngcontent-%COMP%]{color:var(--text);font-size:14px;font-weight:500}.map-switch-btn[_ngcontent-%COMP%]{background:none;border:none;cursor:pointer;font-size:16px;padding:4px;border-radius:4px;transition:background .2s}.map-switch-btn[_ngcontent-%COMP%]:hover{background:#ffffff1a}@media(max-width:768px){.lobby-sidebar[_ngcontent-%COMP%]{width:240px;min-width:240px}}.modal-backdrop[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:1000}.modal-dialog[_ngcontent-%COMP%]{background:var(--card);border:1px solid var(--border);border-radius:12px;width:90%;max-width:500px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column}.modal-header[_ngcontent-%COMP%]{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}.modal-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;color:var(--text);font-size:18px}.modal-close[_ngcontent-%COMP%]{background:none;border:none;color:var(--text);font-size:24px;cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:background .2s}.modal-close[_ngcontent-%COMP%]:hover{background:#ffffff1a}.modal-content[_ngcontent-%COMP%]{padding:20px;overflow-y:auto}.map-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:8px;margin-top:12px}.map-item[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;transition:all .2s}.map-item.active[_ngcontent-%COMP%]{border-color:var(--accent);background:#3b82f61a}.map-name[_ngcontent-%COMP%]{color:var(--text);font-size:14px}.current-badge[_ngcontent-%COMP%]{background:var(--accent);color:#fff;padding:2px 8px;border-radius:4px;font-size:12px;font-weight:500}"],changeDetection:0})};export{He as LobbyComponent};
