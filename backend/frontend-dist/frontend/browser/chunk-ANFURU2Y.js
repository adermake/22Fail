import{a as Ie,b as Le,g as Ve,h as Re,j as We,l as Be,m as Ae}from"./chunk-TLJHWCTZ.js";import{a as R,b as De,c as Fe}from"./chunk-MF233SY5.js";import{a as Pe,b as Ee,d as Oe}from"./chunk-RFXIYJE6.js";import{c as ve}from"./chunk-U2QMYJWS.js";import{a as we}from"./chunk-YL74CBNY.js";import{b as $,c as H,f as N,h as Se,j as Te,k as Me,l as ke,p as z}from"./chunk-CRXYTJXZ.js";import{g as Ce,i as xe,k as F}from"./chunk-QU66LBKX.js";import{$b as ye,Fa as ge,Fb as Z,Gb as W,Ia as d,Ib as p,Jb as I,Kb as f,Lb as Q,Nb as L,O as B,Ob as O,Pb as V,Qa as he,Qb as _e,T as w,Tb as be,Ua as A,Ub as Y,Vb as pe,Wb as fe,Y as m,Z as u,a as S,b as E,da as y,db as K,fb as C,gb as x,hb as J,ib as q,jb as T,kb as M,la as ue,lb as k,mb as l,nb as s,ob as D,sb as v,wb as h,yb as c}from"./chunk-EGMLUSXW.js";var X=class a{store=w(R);partyCharacters=new Map;setPartyCharacters(t){this.partyCharacters=t}calculateSpeed(t){let e=t.speed;if(!e)return 10;let r=e.base+e.bonus+e.gain*t.level;return Math.floor(r)||10}getHealth(t){let e=t.statuses?.find(r=>r.statusName==="Leben");return e?{current:e.statusCurrent||0,max:(e.statusBase||0)+(e.statusBonus||0)}:{current:0,max:0}}getAvailableCharactersForBattle(t){return t.map(e=>({id:e.id,name:e.sheet.name||e.id,speed:this.calculateSpeed(e.sheet)}))}addToBattle(t){let e=this.store.worldValue;if(!e)return;let r=this.partyCharacters.get(t);if(!r)return;let i=this.calculateSpeed(r),n=this.getHealth(r),o=e.battleParticipants.length>0?Math.max(...e.battleParticipants.map(_=>_.nextTurnAt)):0,b={characterId:t,name:r.name||t,speed:i,turnFrequency:i,nextTurnAt:o+10,team:"blue",portrait:r.portrait,currentHealth:n.current,maxHealth:n.max},g=[...e.battleParticipants,b];this.store.applyPatch({path:"battleParticipants",value:g})}removeFromBattle(t){let e=this.store.worldValue;if(!e)return;let r=e.battleParticipants.filter(i=>i.characterId!==t);this.store.applyPatch({path:"battleParticipants",value:r})}advanceTurn(){let t=this.store.worldValue;if(!t||t.battleParticipants.length===0)return;let e=this.getBattleQueue();if(e.length===0)return;let r=e[0],i=new Set(r.turns.map(o=>o.characterId)),n=t.battleParticipants.map(o=>{let b=this.partyCharacters.get(o.characterId),g=b?this.calculateSpeed(b):o.speed;if(i.has(o.characterId)){let _=o.nextTurnAt+1e3/g;return E(S({},o),{speed:g,nextTurnAt:_})}return E(S({},o),{speed:g})});this.store.applyPatch({path:"battleParticipants",value:n})}resetBattle(){let t=this.store.worldValue;if(!t)return;let e=t.battleParticipants.map(r=>{let i=this.partyCharacters.get(r.characterId),n=i?this.calculateSpeed(i):r.speed;return E(S({},r),{speed:n,nextTurnAt:0})});this.store.applyPatch({path:"battleParticipants",value:e})}refreshBattleSpeeds(){let t=this.store.worldValue;if(!t)return;let e=t.battleParticipants.map(r=>{let i=this.partyCharacters.get(r.characterId),n=i?this.calculateSpeed(i):r.speed;return E(S({},r),{speed:n})});this.store.applyPatch({path:"battleParticipants",value:e})}syncTurns(t,e){let r=this.store.worldValue;if(!r)return;let i=r.battleParticipants.find(o=>o.characterId===e);if(!i)return;let n=r.battleParticipants.map(o=>o.characterId===t?E(S({},o),{nextTurnAt:i.nextTurnAt}):o);this.store.applyPatch({path:"battleParticipants",value:n})}setTurnOrder(t,e){let r=this.store.worldValue;if(!r||r.battleParticipants.length===0)return;let i=[],n=r.battleParticipants.map(g=>S({},g));for(let g=0;g<10;g++){n.sort((P,ce)=>P.nextTurnAt-ce.nextTurnAt);let _=n[0];i.push(S({},_)),_.nextTurnAt=_.nextTurnAt+1e3/_.speed}let o=i[e]?.nextTurnAt;if(o===void 0)return;let b=r.battleParticipants.map(g=>g.characterId===t?E(S({},g),{nextTurnAt:o}):g);this.store.applyPatch({path:"battleParticipants",value:b})}changeParticipantTeam(t,e){let r=this.store.worldValue;if(!r)return;let i=r.battleParticipants.map(n=>n.characterId===t?E(S({},n),{team:e}):n);this.store.applyPatch({path:"battleParticipants",value:i})}reorderParticipants(t,e){let r=this.store.worldValue;if(!r)return;let i=this.getBattleQueue();if(i.length===0)return;let n;if(e<=0)n=i[0].startTime-10;else if(e>=i.length)n=i[i.length-1].startTime+10;else{let b=i[e-1],g=i[e];n=(b.startTime+g.startTime)/2}let o=r.battleParticipants.map(b=>b.characterId===t?E(S({},b),{nextTurnAt:n}):b);this.store.applyPatch({path:"battleParticipants",value:o})}getBattleQueue(){let t=this.store.worldValue;if(!t||t.battleParticipants.length===0)return[];let e=[],r=t.battleParticipants.map(g=>E(S({},g),{currentTurnAt:g.nextTurnAt,speed:this.partyCharacters.get(g.characterId)?this.calculateSpeed(this.partyCharacters.get(g.characterId)):g.speed}));for(let g=0;g<50;g++){r.sort((de,Ge)=>de.currentTurnAt-Ge.currentTurnAt);let _=r[0],P=t.battleParticipants.find(de=>de.characterId===_.characterId),ce=P?Math.abs(P.nextTurnAt-_.currentTurnAt)<.001:!1;e.push({characterId:_.characterId,name:_.name,team:_.team||"blue",time:_.currentTurnAt,isAnchor:ce,speed:_.speed}),_.currentTurnAt+=1e3/_.speed}let i=[];if(e.length===0)return[];let n=1,o={turns:[e[0]],team:e[0].team,startTime:e[0].time},b=new Set([e[0].characterId]);for(let g=1;g<e.length;g++){let _=e[g],P=Math.abs(_.time-o.startTime);_.team===o.team&&!b.has(_.characterId)&&P<n?(o.turns.push(_),b.add(_.characterId)):(i.push(o),o={turns:[_],team:_.team,startTime:_.time},b=new Set([_.characterId]))}return i.push(o),i}static \u0275fac=function(e){return new(e||a)};static \u0275prov=B({token:a,factory:a.\u0275fac,providedIn:"root"})};var G=class a{store=w(R);getTrash(){return this.store.worldValue?.trash||[]}addToTrash(t,e){let r=this.store.worldValue;if(!r)return;let i=[...r.trash||[],{type:t,data:e,deletedAt:Date.now()}];this.store.applyPatch({path:"trash",value:i})}restoreFromTrash(t){let e=this.store.worldValue;if(!e||!e.trash)return;let r=e.trash[t],i=[...e.trash];switch(i.splice(t,1),r.type){case"item":this.store.applyPatch({path:"itemLibrary",value:[...e.itemLibrary,r.data]});break;case"rune":this.store.applyPatch({path:"runeLibrary",value:[...e.runeLibrary,r.data]});break;case"spell":this.store.applyPatch({path:"spellLibrary",value:[...e.spellLibrary,r.data]});break;case"skill":this.store.applyPatch({path:"skillLibrary",value:[...e.skillLibrary,r.data]});break}this.store.applyPatch({path:"trash",value:i})}permanentlyDelete(t){let e=this.store.worldValue;if(!e||!e.trash)return;let r=[...e.trash];r.splice(t,1),this.store.applyPatch({path:"trash",value:r})}emptyTrash(){this.store.applyPatch({path:"trash",value:[]})}static \u0275fac=function(e){return new(e||a)};static \u0275prov=B({token:a,factory:a.\u0275fac,providedIn:"root"})};var ee=class{name;class;description;type;enlightened;level;skillId;statModifiers};var j=class{name;description;weight;lost;requirements;armorDebuff;statModifiers};var te=class extends j{durability;efficiency;range;weaponType;damageType;primaryMaterial;secondaryMaterial;additiveMaterial;craftingPointsUsed;bonuses=[];generatedName};var me=(n=>(n.HELMET="Helm",n.CHEST="Brustpanzer",n.LEGGINGS="Beinschutz",n.BOOTS="Stiefel",n.GAUNTLETS="Handschuhe",n))(me||{}),re=class extends j{durability;stability;armorType;primaryMaterial;secondaryMaterial;additiveMaterial;craftingPointsUsed;generatedName};var ie=[{name:"Eisen",type:"schwer",rarity:"h\xE4ufig",locations:["\xFCberall"],durability:80,efficiency:7,durabilityModifier:3,efficiencyModifier:3,specialEffect:"Mit jeder Reparatur wird die Haltbarkeit der Waffe dauerhaft um 10 erh\xF6ht."},{name:"Holz",type:"leicht",rarity:"sehr h\xE4ufig",locations:["\xFCberall"],durability:50,efficiency:4,durabilityModifier:5,efficiencyModifier:3,specialEffect:"Vorraussetzung-1(\u221E) reduziert Vorraussetzung um 2 statt 1."},{name:"Ahnenholz",type:"sehr leicht",rarity:"selten",locations:["in magischen W\xE4ldern"],durability:70,efficiency:5,durabilityModifier:4,efficiencyModifier:3,specialEffect:"+2 beim W\xFCrfeln f\xFCr Zaubercasts"},{name:"Stein",type:"sehr schwer",rarity:"sehr h\xE4ufig",locations:["\xFCberall"],durability:60,efficiency:5,durabilityModifier:3,efficiencyModifier:4},{name:"Silber",type:"mittel",rarity:"selten",locations:["\xFCberall"],durability:70,efficiency:10,durabilityModifier:3,efficiencyModifier:2,specialEffect:"+2 im Kampf gegen Monster/Untote"},{name:"Gold",type:"schwer",rarity:"selten",locations:["\xFCberall"],durability:50,efficiency:6,durabilityModifier:5,efficiencyModifier:3,specialEffect:"+1 Charismamodifikator"},{name:"Platin",type:"sehr schwer",rarity:"sehr selten",locations:["\xFCberall"],durability:100,efficiency:12,durabilityModifier:4,efficiencyModifier:4},{name:"Adamantit",type:"sehr schwer",rarity:"selten",locations:["tief unter der Erde"],durability:150,efficiency:9,durabilityModifier:6,efficiencyModifier:6,specialEffect:"+5 W\xFCrfelbonus, wenn die Waffe zerst\xF6rt wird"},{name:"Meteoritenerz",type:"?",rarity:"???",locations:["???"],durability:120,efficiency:12,durabilityModifier:2,efficiencyModifier:2,specialEffect:"Effekt variiert"},{name:"Asremit",type:"sehr leicht",rarity:"h\xE4ufig",locations:["in der \xDCberwelt"],durability:40,efficiency:15,durabilityModifier:5,efficiencyModifier:2,specialEffect:"Werfen+1, unabh\xE4ngig vom Waffenbonus"},{name:"Blutrubin",type:"leicht",rarity:"selten",locations:["Vulkangebiet"],durability:80,efficiency:8,durabilityModifier:4,efficiencyModifier:2,specialEffect:"Kann bis zu 50 Leben speichern, die ihm freiwillig vom Tr\xE4ger oder vom Gegner durch Kontakt mit tiefen Wunden gegeben werden kann. Diese Leben k\xF6nnen dem Tr\xE4ger zur\xFCckgegeben werden, um ihn um diesen Betrag zu heilen."},{name:"\xC4thersaphir",type:"leicht",rarity:"selten",locations:["im Meer"],durability:80,efficiency:8,durabilityModifier:4,efficiencyModifier:2,specialEffect:"Kann bis zu 50 Mana speichern, die ihm vom Tr\xE4ger gegeben wird. Diese Mana kann dem Tr\xE4ger zur\xFCckgegeben werden, um die Mana um diesen Betrag wiederherzustellen."},{name:"Natursmaragd",type:"leicht",rarity:"selten",locations:["in Urw\xE4ldern"],durability:80,efficiency:8,durabilityModifier:4,efficiencyModifier:2,specialEffect:"Kann bis zu 50 Ausdauer speichern, die ihm vom Tr\xE4ger gegeben wird. Diese Ausdauer kann dem Tr\xE4ger zur\xFCckgegeben werden, um die Ausdauer um diesen Betrag wiederherzustellen."},{name:"Elementarkristall",type:"leicht",rarity:"sehr selten",locations:["an Orten mit hoher Manakonzentration"],durability:60,efficiency:7,durabilityModifier:3,efficiencyModifier:3,specialEffect:"Kann Spells speichern und sp\xE4ter ausf\xFChren. Komplexit\xE4t der gespeicherten Spells kann nicht Eff./2 \xFCberschreiten."},{name:"Seraphit",type:"schwer",rarity:"selten",locations:["in der \xDCberwelt"],durability:80,efficiency:6,durabilityModifier:3,efficiencyModifier:4,specialEffect:"Verst\xE4rkt Heilzauber um 50%"},{name:"Vulkanit",type:"leicht",rarity:"h\xE4ufig",locations:["in Lava"],durability:90,efficiency:8,durabilityModifier:4,efficiencyModifier:5,specialEffect:"Leuchtet im Dunkeln"}];var ne=[{name:"Stoff",type:"sehr leicht",rarity:"sehr h\xE4ufig",locations:["\xFCberall"],durability:50,durabilityModifier:5,efficiency:0,efficiencyModifier:0,stability:5,stabilityModifier:5},{name:"Mondseide",type:"sehr leicht",rarity:"sehr selten",locations:["\xFCberall"],durability:80,durabilityModifier:3,efficiency:0,efficiencyModifier:0,stability:5,stabilityModifier:4,specialEffect:"10% des erlittenen Schadens werden zu Mana konvertiert"},{name:"Leder",type:"leicht",rarity:"sehr h\xE4ufig",locations:["\xFCberall"],durability:70,durabilityModifier:3,efficiency:0,efficiencyModifier:0,stability:6,stabilityModifier:4},{name:"Eisen",type:"schwer",rarity:"h\xE4ufig",locations:["\xFCberall"],durability:80,durabilityModifier:3,efficiency:0,efficiencyModifier:0,stability:8,stabilityModifier:2,specialEffect:"Mit jeder Reparatur wird die Haltbarkeit der R\xFCstung dauerhaft um 10 erh\xF6ht."},{name:"Silber",type:"schwer",rarity:"selten",locations:["\xFCberall"],durability:80,durabilityModifier:2,efficiency:0,efficiencyModifier:0,stability:11,stabilityModifier:2},{name:"Gold",type:"schwer",rarity:"selten",locations:["\xFCberall"],durability:50,durabilityModifier:5,efficiency:0,efficiencyModifier:0,stability:9,stabilityModifier:3,specialEffect:"+1 Charismamodifikator"},{name:"Platin",type:"schwer",rarity:"sehr selten",locations:["\xFCberall"],durability:100,durabilityModifier:4,efficiency:0,efficiencyModifier:0,stability:12,stabilityModifier:4},{name:"Adamantit",type:"sehr schwer",rarity:"selten",locations:["tief unter der Erde"],durability:150,durabilityModifier:6,efficiency:0,efficiencyModifier:0,stability:12,stabilityModifier:6,specialEffect:"+5 beim Wurf, wenn die R\xFCstung zerst\xF6rt wird"},{name:"Meteoritenerz",type:"?",rarity:"???",locations:["???"],durability:150,durabilityModifier:2,efficiency:0,efficiencyModifier:0,stability:10,stabilityModifier:2,specialEffect:"Effekt variiert"},{name:"Asremit",type:"sehr leicht",rarity:"h\xE4ufig",locations:["in der \xDCberwelt"],durability:40,durabilityModifier:5,efficiency:0,efficiencyModifier:0,stability:7,stabilityModifier:3,specialEffect:"-2 R\xFCstungsmalus, unabh\xE4ngig vom R\xFCstungsbonus"},{name:"Elementarkristall",type:"leicht",rarity:"sehr selten",locations:["an der Oberfl\xE4che an Orten mit hoher Manakonzentration"],durability:50,durabilityModifier:4,efficiency:0,efficiencyModifier:0,stability:6,stabilityModifier:4,specialEffect:"Kann Spells speichern und sp\xE4ter ausf\xFChren. Komplexit\xE4t der gespeicherten Spells darf nicht Eff./4 \xFCberschreiten."},{name:"Seraphit",type:"schwer",rarity:"selten",locations:["in der \xDCberwelt"],durability:80,durabilityModifier:3,efficiency:0,efficiencyModifier:0,stability:12,stabilityModifier:2,specialEffect:"Verst\xE4rkt Heilung auf Tr\xE4ger um 50%"},{name:"Vulkanit",type:"leicht",rarity:"h\xE4ufig",locations:["in Lava"],durability:70,durabilityModifier:4,efficiency:0,efficiencyModifier:0,stability:8,stabilityModifier:3,specialEffect:"Leuchtet im Dunkeln"}];var $e=[{name:"Messer",damageType:"Schnitt",range:.5,type:"Leicht"},{name:"Sichel",damageType:"Schnitt",range:.5,type:"Leicht"},{name:"Kurzschwert",damageType:"Schnitt",range:1,type:"Leicht"},{name:"Peitsche",damageType:"Schnitt",range:3,type:"Leicht"},{name:"Dolch",damageType:"Stich",range:.5,type:"Leicht"},{name:"Rapier",damageType:"Stich",range:1.5,type:"Leicht"},{name:"Handschuhe",damageType:"Wucht",range:.5,type:"Leicht"},{name:"Nunchaku",damageType:"Wucht",range:.5,type:"Leicht"},{name:"Stab",damageType:"Wucht",range:1,type:"Leicht"},{name:"Wurfbeil",damageType:"Schnitt",range:10,type:"Fernkampf"},{name:"Wurfmesser",damageType:"Schnitt",range:20,type:"Fernkampf"},{name:"Wurfspeer",damageType:"Stich",range:50,type:"Fernkampf"},{name:"Kurzbogen",damageType:"Stich",range:50,type:"Fernkampf"},{name:"Armbrust",damageType:"Stich",range:100,type:"Fernkampf"},{name:"Langbogen",damageType:"Stich",range:100,type:"Fernkampf"},{name:"Bola",damageType:"Wucht",range:20,type:"Fernkampf"},{name:"Bumerang",damageType:"Wucht",range:30,type:"Fernkampf"},{name:"Schleuder",damageType:"Wucht",range:50,type:"Fernkampf"},{name:"Axt",damageType:"Schnitt",range:1.5,type:"Schwer"},{name:"S\xE4bel",damageType:"Schnitt",range:1.5,type:"Schwer"},{name:"Sense",damageType:"Schnitt",range:1.5,type:"Schwer"},{name:"Kriegsaxt",damageType:"Schnitt",range:2,type:"Schwer"},{name:"Langschwert",damageType:"Schnitt",range:2,type:"Schwer"},{name:"Gleve",damageType:"Schnitt",range:2.5,type:"Schwer"},{name:"Gro\xDFschwert",damageType:"Schnitt",range:2.5,type:"Schwer"},{name:"Hellebarde",damageType:"Schnitt",range:3,type:"Schwer"},{name:"Hacke",damageType:"Stich",range:1,type:"Schwer"},{name:"Dreizack",damageType:"Stich",range:2,type:"Schwer"},{name:"Langspeer",damageType:"Stich",range:3,type:"Schwer"},{name:"Lanze",damageType:"Stich",range:3,type:"Schwer"},{name:"Schild",damageType:"Wucht",range:.5,type:"Schwer"},{name:"Hammer",damageType:"Wucht",range:1,type:"Schwer"},{name:"Keule",damageType:"Wucht",range:2,type:"Schwer"},{name:"Kriegshammer",damageType:"Wucht",range:2,type:"Schwer"},{name:"Morgenstern",damageType:"Wucht",range:2.5,type:"Schwer"}];var ae=class a{namePrefixes=["M\xE4chtige(r)","Verfluchte(r)","Gesegnete(r)","Alte(r)","Meisterlich gefertigte(r)","Brutale(r)","Elegante(r)","T\xF6dliche(r)","Rostige(r)","Leuchtende(r)","D\xE4monische(r)","Himmlische(r)"];nameSuffixes=["der Verdammnis","des Lichts","der Zerst\xF6rung","des Schutzes","aus der Tiefe","des K\xF6nigs","der alten G\xF6tter","des Chaos","der Ordnung","des Blutes"];constructor(){}generateWeapon(t,e){let r=new te,i=$e;e&&(i=i.filter(P=>P.type===e));let n=this.getRandomElement(i);r.weaponType=n.type,r.damageType=n.damageType,r.range=n.range,r.weight=this.getWeightFromType(n.type);let o=this.getRandomElement(ie),b=this.getRandomElement(ie),g=this.getRandomElement(ie);r.primaryMaterial=o,r.secondaryMaterial=b,r.additiveMaterial=g,r.durability=o.durability+Math.floor(b.durability/2),r.efficiency=o.efficiency+Math.floor(b.efficiency/2);let _=10+this.rollD20();return r.craftingPointsUsed=0,r.requirements=this.calculateRequirements(r.durability,r.efficiency),r.generatedName=this.generateName(n,o),r.name=r.generatedName,r.description=this.generateDescription(r),r}generateArmor(t,e){let r=new re,i=e||this.getRandomElement(Object.values(me));r.armorType=i,r.weight=this.getWeightFromType(i);let n=this.getRandomElement(ne),o=this.getRandomElement(ne),b=this.getRandomElement(ne);r.primaryMaterial=n,r.secondaryMaterial=o,r.additiveMaterial=b,r.durability=n.durability+Math.floor(o.durability/2),r.stability=(n.stability||0)+Math.floor((o.stability||0)/2);let g=10+this.rollD20();return r.craftingPointsUsed=0,r.requirements={},r.generatedName=`${n.name}-${i}`,r.name=r.generatedName,r.description=this.generateArmorDescription(r),r}generateArmorDescription(t){let e=`Eine R\xFCstung vom Typ ${t.armorType}.`;return e+=` Hergestellt aus ${t.primaryMaterial.name}, ${t.secondaryMaterial.name} und ${t.additiveMaterial.name}.`,t.primaryMaterial.specialEffect&&(e+=`
Prim\xE4r-Effekt: ${t.primaryMaterial.specialEffect}`),t.secondaryMaterial.specialEffect&&(e+=`
Sekund\xE4r-Effekt: ${t.secondaryMaterial.specialEffect}`),t.additiveMaterial.specialEffect&&(e+=`
Zusatz-Effekt: ${t.additiveMaterial.specialEffect}`),e}generateName(t,e){let r=this.getRandomElement(this.namePrefixes),i=this.getRandomElement(this.nameSuffixes),n=e.name;switch(["a","e","i","o","u"].includes(n.slice(-1).toLowerCase())||(n+="s"),this.rollDie(4)){case 1:return`${e.name}-${t.name}`;case 2:return`${r} ${t.name}`;case 3:return`${t.name} ${i}`;case 4:return`${r} ${e.name}-${t.name} ${i}`;default:return`${e.name}-${t.name}`}}generateDescription(t){let e=`Eine Waffe vom Typ ${t.weaponType}.`;return e+=` Hergestellt aus ${t.primaryMaterial.name}, ${t.secondaryMaterial.name} und ${t.additiveMaterial.name}.`,t.primaryMaterial.specialEffect&&(e+=`
Prim\xE4r-Effekt: ${t.primaryMaterial.specialEffect}`),t.secondaryMaterial.specialEffect&&(e+=`
Sekund\xE4r-Effekt: ${t.secondaryMaterial.specialEffect}`),t.additiveMaterial.specialEffect&&(e+=`
Zusatz-Effekt: ${t.additiveMaterial.specialEffect}`),e}calculateRequirements(t,e){return{strength:Math.floor(5+t/20+e/2)}}getWeightFromType(t){switch(t){case"Leicht":return this.rollDie(5)+2;case"Schwer":return this.rollDie(10)+10;case"Fernkampf":return this.rollDie(6)+4;case"Helm":return this.rollDie(4)+1;case"Brustpanzer":return this.rollDie(10)+8;case"Beinschutz":return this.rollDie(6)+6;case"Stiefel":return this.rollDie(3)+1;case"Handschuhe":return this.rollDie(2)+1}}getRandomElement(t){return t[Math.floor(Math.random()*t.length)]}rollD20(){return Math.floor(Math.random()*20)+1}rollDie(t){return Math.floor(Math.random()*t)+1}static \u0275fac=function(e){return new(e||a)};static \u0275prov=B({token:a,factory:a.\u0275fac,providedIn:"root"})};var oe=class a{store=w(R);trashService=w(G);weaponGenerator=w(ae);createItem(t){let e=this.store.worldValue;e&&this.store.applyPatch({path:"itemLibrary",value:[...e.itemLibrary,t]})}generateRandomWeapon(t=5){let e=this.store.worldValue;if(!e)return;let r=this.weaponGenerator.generateWeapon(t);this.store.applyPatch({path:"itemLibrary",value:[...e.itemLibrary,r]})}generateRandomArmor(t=5){let e=this.store.worldValue;if(!e)return;let r=this.weaponGenerator.generateArmor(t);this.store.applyPatch({path:"itemLibrary",value:[...e.itemLibrary,r]})}updateItem(t,e){let r=e.path.replace(/\//g,".");r.startsWith(".")&&(r=r.substring(1)),this.store.applyPatch({path:`itemLibrary.${t}.${r}`,value:e.value})}removeItem(t){let e=this.store.worldValue;if(!e)return new Set;let r=e.itemLibrary[t],i=[...e.itemLibrary];return i.splice(t,1),this.trashService.addToTrash("item",r),this.store.applyPatch({path:"itemLibrary",value:i}),this.shiftIndices(t)}addRune(){let t=this.store.worldValue;if(t){let e={name:"New Rune",description:"",drawing:"",tags:[]};this.store.applyPatch({path:"runeLibrary",value:[...t.runeLibrary,e]})}}updateRune(t,e){let r=e.path.replace(/\//g,".");r.startsWith(".")&&(r=r.substring(1)),this.store.applyPatch({path:`runeLibrary.${t}.${r}`,value:e.value})}removeRune(t){let e=this.store.worldValue;if(!e)return new Set;let r=e.runeLibrary[t],i=[...e.runeLibrary];return i.splice(t,1),this.trashService.addToTrash("rune",r),this.store.applyPatch({path:"runeLibrary",value:i}),this.shiftIndices(t)}addSpell(){let t=this.store.worldValue;if(t){let e={name:"New Spell",description:"",drawing:"",tags:[],binding:{type:"learned"}};this.store.applyPatch({path:"spellLibrary",value:[...t.spellLibrary,e]})}}updateSpell(t,e){let r=e.path.replace(/\//g,".");r.startsWith(".")&&(r=r.substring(1)),this.store.applyPatch({path:`spellLibrary.${t}.${r}`,value:e.value})}removeSpell(t){let e=this.store.worldValue;if(!e)return new Set;let r=e.spellLibrary[t],i=[...e.spellLibrary];return i.splice(t,1),this.trashService.addToTrash("spell",r),this.store.applyPatch({path:"spellLibrary",value:i}),this.shiftIndices(t)}addSkill(){let t=this.store.worldValue;if(t){let e=new ee;e.name="New Skill",e.description="",e.type="passive",e.class="",e.enlightened=!1,this.store.applyPatch({path:"skillLibrary",value:[...t.skillLibrary,e]})}}updateSkill(t,e){let r=e.path.replace(/\//g,".");r.startsWith(".")&&(r=r.substring(1)),this.store.applyPatch({path:`skillLibrary.${t}.${r}`,value:e.value})}removeSkill(t){let e=this.store.worldValue;if(!e)return new Set;let r=e.skillLibrary[t],i=[...e.skillLibrary];return i.splice(t,1),this.trashService.addToTrash("skill",r),this.store.applyPatch({path:"skillLibrary",value:i}),this.shiftIndices(t)}shiftIndices(t){return new Set}getItemLibrary(){return this.store.worldValue?.itemLibrary||[]}getRuneLibrary(){return this.store.worldValue?.runeLibrary||[]}getSpellLibrary(){return this.store.worldValue?.spellLibrary||[]}getSkillLibrary(){return this.store.worldValue?.skillLibrary||[]}static \u0275fac=function(e){return new(e||a)};static \u0275prov=B({token:a,factory:a.\u0275fac,providedIn:"root"})};function Ke(a,t){return this.getOriginalIndex(t,"runes")}function Je(a,t){return this.getOriginalIndex(t,"spells")}function qe(a,t){return this.getOriginalIndex(t,"skills")}function Ze(a,t){if(a&1){let e=v();l(0,"div",9),h("dragstart",function(i){let n=m(e).$implicit,o=c(2);return u(o.onDragStart(i,"item",o.getOriginalIndex(n,"items")))}),l(1,"app-item",10),h("patch",function(i){let n=m(e).$implicit,o=c(2);return u(o.onItemUpdate(o.getOriginalIndex(n,"items"),i))})("delete",function(){let i=m(e).$implicit,n=c(2);return u(n.removeItem.emit(n.getOriginalIndex(i,"items")))})("editingChange",function(i){let n=m(e).$implicit,o=c(2);return u(o.onItemEditingChange(o.getOriginalIndex(n,"items"),i))}),s()()}if(a&2){let e=t.$implicit,r=c(2);W("draggable",!r.isItemEditing(r.getOriginalIndex(e,"items"))),K("draggable",!r.isItemEditing(r.getOriginalIndex(e,"items"))),d(),k("item",e)("sheet",r.dummySheet)("index",r.getOriginalIndex(e,"items"))("isEditing",r.isItemEditing(r.getOriginalIndex(e,"items")))}}function Qe(a,t){if(a&1){let e=v();l(0,"div",6),T(1,Ze,2,7,"div",7,J),l(3,"button",8),h("click",function(){m(e);let i=c();return u(i.addItem.emit())}),p(4,"+ Add Item"),s()()}if(a&2){let e=c();d(),M(e.filteredItems)}}function Ye(a,t){if(a&1){let e=v();l(0,"div",9),h("dragstart",function(i){let n=m(e).$implicit,o=c(2);return u(o.onDragStart(i,"rune",o.getOriginalIndex(n,"runes")))}),l(1,"app-rune",11),h("patch",function(i){let n=m(e).$implicit,o=c(2);return u(o.onRuneUpdate(o.getOriginalIndex(n,"runes"),i))})("delete",function(){let i=m(e).$implicit,n=c(2);return u(n.removeRune.emit(n.getOriginalIndex(i,"runes")))})("editingChange",function(i){let n=m(e).$implicit,o=c(2);return u(o.onRuneEditingChange(o.getOriginalIndex(n,"runes"),i))}),s()()}if(a&2){let e=t.$implicit,r=c(2);W("draggable",!r.isRuneEditing(r.getOriginalIndex(e,"runes"))),K("draggable",!r.isRuneEditing(r.getOriginalIndex(e,"runes"))),d(),k("rune",e)("index",r.getOriginalIndex(e,"runes"))("isEditing",r.isRuneEditing(r.getOriginalIndex(e,"runes")))}}function Xe(a,t){if(a&1){let e=v();l(0,"div",6),T(1,Ye,2,6,"div",7,Ke,!0),l(3,"button",8),h("click",function(){m(e);let i=c();return u(i.addRune.emit())}),p(4,"+ Add Rune"),s()()}if(a&2){let e=c();d(),M(e.filteredRunes)}}function et(a,t){if(a&1){let e=v();l(0,"div",9),h("dragstart",function(i){let n=m(e).$implicit,o=c(2);return u(o.onDragStart(i,"spell",o.getOriginalIndex(n,"spells")))}),l(1,"app-spell",12),h("patch",function(i){let n=m(e).$implicit,o=c(2);return u(o.onSpellUpdate(o.getOriginalIndex(n,"spells"),i))})("delete",function(){let i=m(e).$implicit,n=c(2);return u(n.removeSpell.emit(n.getOriginalIndex(i,"spells")))})("editingChange",function(i){let n=m(e).$implicit,o=c(2);return u(o.onSpellEditingChange(o.getOriginalIndex(n,"spells"),i))}),s()()}if(a&2){let e=t.$implicit,r=c(2);W("draggable",!r.isSpellEditing(r.getOriginalIndex(e,"spells"))),K("draggable",!r.isSpellEditing(r.getOriginalIndex(e,"spells"))),d(),k("spell",e)("sheet",r.dummySheet)("index",r.getOriginalIndex(e,"spells"))("isEditing",r.isSpellEditing(r.getOriginalIndex(e,"spells")))}}function tt(a,t){if(a&1){let e=v();l(0,"div",6),T(1,et,2,7,"div",7,Je,!0),l(3,"button",8),h("click",function(){m(e);let i=c();return u(i.addSpell.emit())}),p(4,"+ Add Spell"),s()()}if(a&2){let e=c();d(),M(e.filteredSpells)}}function rt(a,t){if(a&1){let e=v();l(0,"div",9),h("dragstart",function(i){let n=m(e).$implicit,o=c(2);return u(o.onDragStart(i,"skill",o.getOriginalIndex(n,"skills")))}),l(1,"app-skill",13),h("patch",function(i){let n=m(e).$implicit,o=c(2);return u(o.onSkillUpdate(o.getOriginalIndex(n,"skills"),i))})("delete",function(){let i=m(e).$implicit,n=c(2);return u(n.removeSkill.emit(n.getOriginalIndex(i,"skills")))})("editingChange",function(i){let n=m(e).$implicit,o=c(2);return u(o.onSkillEditingChange(o.getOriginalIndex(n,"skills"),i))}),s()()}if(a&2){let e=t.$implicit,r=c(2);W("draggable",!r.isSkillEditing(r.getOriginalIndex(e,"skills"))),K("draggable",!r.isSkillEditing(r.getOriginalIndex(e,"skills"))),d(),k("skill",e)("sheet",r.dummySheet)("index",r.getOriginalIndex(e,"skills"))("isEditing",r.isSkillEditing(r.getOriginalIndex(e,"skills")))}}function it(a,t){if(a&1){let e=v();l(0,"div",6),T(1,rt,2,7,"div",7,qe,!0),l(3,"button",8),h("click",function(){m(e);let i=c();return u(i.addSkill.emit())}),p(4,"+ Add Skill"),s()()}if(a&2){let e=c();d(),M(e.filteredSkills)}}var le=class a{items=[];runes=[];spells=[];skills=[];dummySheet;editingItems;editingRunes;editingSpells;editingSkills;addItem=new y;addRune=new y;addSpell=new y;addSkill=new y;updateItem=new y;updateRune=new y;updateSpell=new y;updateSkill=new y;removeItem=new y;removeRune=new y;removeSpell=new y;removeSkill=new y;itemEditingChange=new y;runeEditingChange=new y;spellEditingChange=new y;skillEditingChange=new y;dragStart=new y;activeTab="items";_searchTerm="";filteredItems=[];filteredRunes=[];filteredSpells=[];filteredSkills=[];prevItemsLength=0;prevRunesLength=0;prevSpellsLength=0;prevSkillsLength=0;get searchTerm(){return this._searchTerm}set searchTerm(t){this._searchTerm=t,this.updateFilteredArrays()}ngOnChanges(t){let e=!1;t.items&&this.items.length!==this.prevItemsLength&&(this.prevItemsLength=this.items.length,e=!0),t.runes&&this.runes.length!==this.prevRunesLength&&(this.prevRunesLength=this.runes.length,e=!0),t.spells&&this.spells.length!==this.prevSpellsLength&&(this.prevSpellsLength=this.spells.length,e=!0),t.skills&&this.skills.length!==this.prevSkillsLength&&(this.prevSkillsLength=this.skills.length,e=!0),(t.items?.firstChange||t.runes?.firstChange||t.spells?.firstChange||t.skills?.firstChange)&&(e=!0),e&&this.updateFilteredArrays()}updateFilteredArrays(){this.filteredItems=this.filterAndSort(this.items,this._searchTerm),this.filteredRunes=this.filterAndSort(this.runes,this._searchTerm),this.filteredSpells=this.filterAndSort(this.spells,this._searchTerm),this.filteredSkills=this.filterAndSort(this.skills,this._searchTerm)}filterAndSort(t,e){let r=t;if(e){let i=e.toLowerCase();r=t.filter(n=>n.name?.toLowerCase().includes(i)||n.description?.toLowerCase().includes(i))}return[...r].sort((i,n)=>{if(i.type&&n.type){let g={dice_bonus:0,active:1,passive:2,stat_bonus:3},_=g[i.type]??4,P=g[n.type]??4;if(_!==P)return _-P}let o=(i.name||"").toLowerCase(),b=(n.name||"").toLowerCase();return o.localeCompare(b)})}getOriginalIndex(t,e){return(e==="items"?this.items:e==="runes"?this.runes:e==="spells"?this.spells:this.skills).indexOf(t)}setActiveTab(t){this.activeTab=t}onDragStart(t,e,r){this.dragStart.emit({event:t,type:e,index:r})}isItemEditing(t){return this.editingItems.has(t)}isRuneEditing(t){return this.editingRunes.has(t)}isSpellEditing(t){return this.editingSpells.has(t)}isSkillEditing(t){return this.editingSkills.has(t)}onItemUpdate(t,e){this.updateItem.emit({index:t,patch:e})}onRuneUpdate(t,e){this.updateRune.emit({index:t,patch:e})}onSpellUpdate(t,e){this.updateSpell.emit({index:t,patch:e})}onSkillUpdate(t,e){this.updateSkill.emit({index:t,patch:e})}onItemEditingChange(t,e){this.itemEditingChange.emit({index:t,isEditing:e})}onRuneEditingChange(t,e){this.runeEditingChange.emit({index:t,isEditing:e})}onSpellEditingChange(t,e){this.spellEditingChange.emit({index:t,isEditing:e})}onSkillEditingChange(t,e){this.skillEditingChange.emit({index:t,isEditing:e})}static \u0275fac=function(e){return new(e||a)};static \u0275cmp=A({type:a,selectors:[["app-library-tabs"]],inputs:{items:"items",runes:"runes",spells:"spells",skills:"skills",dummySheet:"dummySheet",editingItems:"editingItems",editingRunes:"editingRunes",editingSpells:"editingSpells",editingSkills:"editingSkills"},outputs:{addItem:"addItem",addRune:"addRune",addSpell:"addSpell",addSkill:"addSkill",updateItem:"updateItem",updateRune:"updateRune",updateSpell:"updateSpell",updateSkill:"updateSkill",removeItem:"removeItem",removeRune:"removeRune",removeSpell:"removeSpell",removeSkill:"removeSkill",itemEditingChange:"itemEditingChange",runeEditingChange:"runeEditingChange",spellEditingChange:"spellEditingChange",skillEditingChange:"skillEditingChange",dragStart:"dragStart"},features:[ue],decls:17,vars:17,consts:[[1,"library-tabs-container"],[1,"tabs-header"],[1,"tab-button",3,"click"],[1,"search-container"],["type","text","placeholder","Search by name or description...",1,"search-input",3,"ngModelChange","ngModel"],[1,"tab-content"],[1,"library-list"],[1,"library-item-wrapper",3,"draggable"],[1,"add-button",3,"click"],[1,"library-item-wrapper",3,"dragstart"],[3,"patch","delete","editingChange","item","sheet","index","isEditing"],[3,"patch","delete","editingChange","rune","index","isEditing"],[3,"patch","delete","editingChange","spell","sheet","index","isEditing"],[3,"patch","delete","editingChange","skill","sheet","index","isEditing"]],template:function(e,r){e&1&&(l(0,"div",0)(1,"div",1)(2,"button",2),h("click",function(){return r.setActiveTab("items")}),p(3),s(),l(4,"button",2),h("click",function(){return r.setActiveTab("runes")}),p(5),s(),l(6,"button",2),h("click",function(){return r.setActiveTab("spells")}),p(7),s(),l(8,"button",2),h("click",function(){return r.setActiveTab("skills")}),p(9),s()(),l(10,"div",3)(11,"input",4),V("ngModelChange",function(n){return O(r.searchTerm,n)||(r.searchTerm=n),n}),s()(),l(12,"div",5),C(13,Qe,5,0,"div",6),C(14,Xe,5,0,"div",6),C(15,tt,5,0,"div",6),C(16,it,5,0,"div",6),s()()),e&2&&(d(2),W("active",r.activeTab==="items"),d(),f(" Items (",r.items.length,") "),d(),W("active",r.activeTab==="runes"),d(),f(" Runes (",r.runes.length,") "),d(),W("active",r.activeTab==="spells"),d(),f(" Spells (",r.spells.length,") "),d(),W("active",r.activeTab==="skills"),d(),f(" Skills (",r.skills.length,") "),d(2),L("ngModel",r.searchTerm),d(2),x(r.activeTab==="items"?13:-1),d(),x(r.activeTab==="runes"?14:-1),d(),x(r.activeTab==="spells"?15:-1),d(),x(r.activeTab==="skills"?16:-1))},dependencies:[F,z,$,H,N,Ve,Be,We,Ae],styles:[".library-tabs-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:100%;background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden}.tabs-header[_ngcontent-%COMP%]{display:flex;background:var(--bg);border-bottom:2px solid var(--border)}.tab-button[_ngcontent-%COMP%]{flex:1;padding:1rem;background:transparent;border:none;border-bottom:3px solid transparent;cursor:pointer;font-weight:600;font-size:14px;color:var(--muted);transition:all .2s}.tab-button[_ngcontent-%COMP%]:hover{background:#6b46c10d;color:var(--accent)}.tab-button.active[_ngcontent-%COMP%]{color:var(--accent);border-bottom-color:var(--accent);background:var(--card)}.search-container[_ngcontent-%COMP%]{padding:1rem;background:var(--card);border-bottom:1px solid var(--border)}.search-input[_ngcontent-%COMP%]{width:100%;padding:.75rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px;transition:border-color .2s}.search-input[_ngcontent-%COMP%]:focus{outline:none;border-color:var(--accent)}.search-input[_ngcontent-%COMP%]::placeholder{color:var(--muted)}.tab-content[_ngcontent-%COMP%]{flex:1;overflow-y:auto;padding:1rem}.library-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.75rem}.library-item-wrapper[_ngcontent-%COMP%]{cursor:grab;transition:opacity .2s}.library-item-wrapper[draggable=true][_ngcontent-%COMP%]:active{cursor:grabbing}.library-item-wrapper[draggable=false][_ngcontent-%COMP%]{cursor:default}.add-button[_ngcontent-%COMP%]{padding:.75rem;background:var(--accent);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;transition:background .2s;margin-top:.5rem}.add-button[_ngcontent-%COMP%]:hover{background:var(--accentdark)}.tab-content[_ngcontent-%COMP%]::-webkit-scrollbar{width:8px}.tab-content[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:var(--bg)}.tab-content[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}.tab-content[_ngcontent-%COMP%]::-webkit-scrollbar-thumb:hover{background:var(--muted)}"]})};var nt=(a,t)=>t.name,ze=(a,t)=>t.id;function at(a,t){if(a&1){let e=v();l(0,"div",16),h("dragstart",function(i){let n=m(e).$index,o=c();return u(o.onDragStartBundle(i,n))}),l(1,"button",17),h("click",function(i){let n=m(e).$index,o=c();return u(o.deleteBundle(n,i))}),p(2,"\xD7"),s(),l(3,"span",18),p(4),s(),l(5,"span",19),p(6),s()()}if(a&2){let e=t.$implicit;d(4),I(e.name),d(2),f("",e.items.length+e.runes.length+e.spells.length," items")}}function ot(a,t){a&1&&(l(0,"div",14),p(1," Drag items or bundles here to add loot "),s())}function lt(a,t){if(a&1&&(l(0,"span"),p(1),s()),a&2){let e=c(2).$implicit;d(),f("",e.data.platinum," pp ")}}function st(a,t){if(a&1&&(l(0,"span"),p(1),s()),a&2){let e=c(2).$implicit;d(),f("",e.data.gold," gp ")}}function ct(a,t){if(a&1&&(l(0,"span"),p(1),s()),a&2){let e=c(2).$implicit;d(),f("",e.data.silver," sp ")}}function dt(a,t){if(a&1&&(l(0,"span"),p(1),s()),a&2){let e=c(2).$implicit;d(),f("",e.data.copper," cp")}}function pt(a,t){if(a&1&&(l(0,"div",22),C(1,lt,2,1,"span"),C(2,st,2,1,"span"),C(3,ct,2,1,"span"),C(4,dt,2,1,"span"),s()),a&2){let e=c().$implicit;d(),x(e.data.platinum?1:-1),d(),x(e.data.gold?2:-1),d(),x(e.data.silver?3:-1),d(),x(e.data.copper?4:-1)}}function mt(a,t){if(a&1){let e=v();l(0,"label",26)(1,"input",27),h("change",function(){let i=m(e).$implicit,n=c().$index,o=c();return u(o.toggleRecipient(n,i.id))}),s(),p(2),s()}if(a&2){let e=t.$implicit,r=c().$implicit,i=c();d(),k("checked",i.isRecipient(r,e.id)),d(),f(" ",e.name," ")}}function ut(a,t){if(a&1){let e=v();l(0,"div",15)(1,"div",20)(2,"div")(3,"span",21),p(4),s(),l(5,"strong"),p(6),s()(),l(7,"button",12),h("click",function(){let i=m(e).$index,n=c();return u(n.removeLoot(i))}),p(8,"\xD7"),s()(),C(9,pt,5,4,"div",22),l(10,"div",23)(11,"span",24),p(12,"Send to:"),s(),l(13,"div",25),T(14,mt,3,2,"label",26,ze),s()()()}if(a&2){let e=t.$implicit,r=c();d(4),I(e.type),d(2),I(e.data.name||"Currency"),d(3),x(e.type==="currency"?9:-1),d(5),M(r.partyMembers)}}var se=class a{store=w(R);bundles=[];partyMembers=[];bundleCreated=new y;bundleDeleted=new y;newCurrency={copper:0,silver:0,gold:0,platinum:0};addCurrency(){let t=this.store.worldValue;if(t&&(this.newCurrency.copper||this.newCurrency.silver||this.newCurrency.gold||this.newCurrency.platinum)){let e={id:`currency_${Date.now()}_${Math.random()}`,type:"currency",data:S({},this.newCurrency),claimedBy:[],recipientIds:t.partyIds};this.store.applyPatch({path:"battleLoot",value:[...t.battleLoot,e]}),this.newCurrency={copper:0,silver:0,gold:0,platinum:0}}}removeLoot(t){let e=this.store.worldValue;if(!e)return;let r=[...e.battleLoot];r.splice(t,1),this.store.applyPatch({path:"battleLoot",value:r})}clearLoot(){this.store.applyPatch({path:"battleLoot",value:[]})}revealLoot(){this.store.revealBattleLoot()}isRecipient(t,e){return!t.recipientIds||t.recipientIds.length===0?!0:t.recipientIds.includes(e)}toggleRecipient(t,e){let r=this.store.worldValue;if(!r)return;let n=r.battleLoot[t].recipientIds||[];n.length===0&&(n=[...r.partyIds]),n.includes(e)?n=n.filter(o=>o!==e):n=[...n,e],this.store.applyPatch({path:`battleLoot.${t}.recipientIds`,value:n})}createBundleFromLoot(){let t=this.store.worldValue;if(!t||t.battleLoot.length===0)return;let e=prompt("Enter bundle name:");if(!e||this.bundles.some(i=>i.name===e)&&!confirm(`A bundle named "${e}" already exists. Overwrite it?`))return;let r={name:e,description:"Created from battle loot",items:[],runes:[],spells:[],skills:[],currency:{copper:0,silver:0,gold:0,platinum:0}};t.battleLoot.forEach(i=>{i.type==="item"?r.items.push(i.data):i.type==="rune"?r.runes.push(i.data):i.type==="spell"?r.spells.push(i.data):i.type==="skill"?r.skills.push(i.data):i.type==="currency"&&(r.currency.copper+=i.data.copper||0,r.currency.silver+=i.data.silver||0,r.currency.gold+=i.data.gold||0,r.currency.platinum+=i.data.platinum||0)}),this.bundleCreated.emit(r)}deleteBundle(t,e){e.stopPropagation(),confirm("Are you sure you want to delete this bundle?")&&this.bundleDeleted.emit(t)}onDragStartBundle(t,e){t.dataTransfer.effectAllowed="copy",t.dataTransfer.setData("lootType","bundle"),t.dataTransfer.setData("lootIndex",e.toString())}onDragOver(t){t.preventDefault(),t.dataTransfer.dropEffect="copy"}onDrop(t){t.preventDefault();let e=t.dataTransfer.getData("lootType"),r=parseInt(t.dataTransfer.getData("lootIndex")),i=this.store.worldValue;if(i)if(e==="bundle"){let n=this.bundles[r];if(!n)return;let o=[],b=(g,_)=>({id:`${g}_${Date.now()}_${Math.random()}`,type:g,data:_,claimedBy:[],recipientIds:i.partyIds});n.items.forEach(g=>o.push(b("item",g))),n.runes.forEach(g=>o.push(b("rune",g))),n.spells.forEach(g=>o.push(b("spell",g))),n.skills.forEach(g=>o.push(b("skill",g))),(n.currency.copper||n.currency.silver||n.currency.gold||n.currency.platinum)&&o.push({id:`curr_${Date.now()}`,type:"currency",data:S({},n.currency),claimedBy:[],recipientIds:i.partyIds}),this.store.applyPatch({path:"battleLoot",value:[...i.battleLoot,...o]})}else{let n;switch(e){case"item":n=i.itemLibrary[r];break;case"rune":n=i.runeLibrary[r];break;case"spell":n=i.spellLibrary[r];break;case"skill":n=i.skillLibrary[r];break}if(n){let o={id:`${e}_${Date.now()}_${Math.random()}`,type:e,data:n,claimedBy:[],recipientIds:i.partyIds};this.store.applyPatch({path:"battleLoot",value:[...i.battleLoot,o]})}}}static \u0275fac=function(e){return new(e||a)};static \u0275cmp=A({type:a,selectors:[["app-loot-manager"]],inputs:{bundles:"bundles",partyMembers:"partyMembers"},outputs:{bundleCreated:"bundleCreated",bundleDeleted:"bundleDeleted"},decls:42,vars:5,consts:[[1,"loot-manager-container"],[1,"currency-form"],[1,"currency-input"],["type","number",3,"ngModelChange","ngModel"],[3,"click"],[1,"bundles-section"],[1,"section-header"],[1,"secondary",3,"click"],[1,"bundle-list"],["draggable","true",1,"bundle-card"],[1,"loot-section"],[2,"display","flex","gap","0.5rem"],[1,"danger",3,"click"],[1,"loot-list",3,"dragover","drop"],[1,"empty-loot"],[1,"loot-item"],["draggable","true",1,"bundle-card",3,"dragstart"],["title","Delete Bundle",1,"bundle-delete",3,"click"],[1,"bundle-name"],[1,"bundle-desc"],[1,"loot-item-header"],[1,"loot-type"],[1,"currency-display"],[1,"loot-recipients"],[1,"recipients-label"],[1,"recipient-checkboxes"],[1,"recipient-checkbox"],["type","checkbox",3,"change","checked"]],template:function(e,r){e&1&&(l(0,"div",0)(1,"div",1)(2,"div",2)(3,"label"),p(4,"CP"),s(),l(5,"input",3),V("ngModelChange",function(n){return O(r.newCurrency.copper,n)||(r.newCurrency.copper=n),n}),s()(),l(6,"div",2)(7,"label"),p(8,"SP"),s(),l(9,"input",3),V("ngModelChange",function(n){return O(r.newCurrency.silver,n)||(r.newCurrency.silver=n),n}),s()(),l(10,"div",2)(11,"label"),p(12,"GP"),s(),l(13,"input",3),V("ngModelChange",function(n){return O(r.newCurrency.gold,n)||(r.newCurrency.gold=n),n}),s()(),l(14,"div",2)(15,"label"),p(16,"PP"),s(),l(17,"input",3),V("ngModelChange",function(n){return O(r.newCurrency.platinum,n)||(r.newCurrency.platinum=n),n}),s()(),l(18,"button",4),h("click",function(){return r.addCurrency()}),p(19,"Add"),s()(),l(20,"div",5)(21,"div",6)(22,"h3"),p(23,"Loot Bundles"),s(),l(24,"button",7),h("click",function(){return r.createBundleFromLoot()}),p(25,"Save Current as Bundle"),s()(),l(26,"div",8),T(27,at,7,2,"div",9,nt),s()(),l(29,"div",10)(30,"div",6)(31,"h3"),p(32,"Battle Loot"),s(),l(33,"div",11)(34,"button",4),h("click",function(){return r.revealLoot()}),p(35,"Reveal All"),s(),l(36,"button",12),h("click",function(){return r.clearLoot()}),p(37,"Clear"),s()()(),l(38,"div",13),h("dragover",function(n){return r.onDragOver(n)})("drop",function(n){return r.onDrop(n)}),C(39,ot,2,0,"div",14),T(40,ut,16,3,"div",15,ze),s()()()),e&2&&(d(5),L("ngModel",r.newCurrency.copper),d(4),L("ngModel",r.newCurrency.silver),d(4),L("ngModel",r.newCurrency.gold),d(4),L("ngModel",r.newCurrency.platinum),d(10),M(r.bundles),d(12),x((r.store.worldValue==null||r.store.worldValue.battleLoot==null?null:r.store.worldValue.battleLoot.length)===0?39:-1),d(),M(r.store.worldValue==null?null:r.store.worldValue.battleLoot))},dependencies:[F,z,$,Se,H,N],styles:[".loot-manager-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1rem;height:100%}.section-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}.section-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;color:var(--accent);font-size:1.1rem}.loot-list[_ngcontent-%COMP%]{flex:1;overflow-y:auto;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:.5rem;min-height:200px}.loot-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;background:var(--card);border:1px solid var(--border);border-radius:4px;padding:.5rem;margin-bottom:.5rem}.loot-item-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.loot-type[_ngcontent-%COMP%]{font-size:.7rem;text-transform:uppercase;background:#0000001a;padding:2px 4px;border-radius:3px;margin-right:.5rem}.loot-controls[_ngcontent-%COMP%]{display:flex;gap:.5rem;margin-top:.5rem}.currency-form[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(4,1fr) auto;gap:.5rem;align-items:end;background:var(--bg-secondary);padding:.5rem;border-radius:6px}.currency-input[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;font-size:.7rem;color:var(--text-muted)}.currency-input[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:100%;padding:4px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text)}.bundle-list[_ngcontent-%COMP%]{display:flex;gap:.5rem;overflow-x:auto;padding-bottom:.5rem}.bundle-card[_ngcontent-%COMP%]{min-width:120px;padding:.5rem;background:var(--card-bg);border:1px solid var(--border);border-radius:6px;cursor:grab;text-align:center;position:relative}.bundle-card[_ngcontent-%COMP%]:active{cursor:grabbing}.bundle-name[_ngcontent-%COMP%]{font-weight:700;font-size:.9rem;display:block;margin-bottom:4px}.bundle-desc[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-muted)}.bundle-delete[_ngcontent-%COMP%]{position:absolute;top:-5px;right:-5px;width:18px;height:18px;border-radius:50%;background:#ef4444;color:#fff;border:none;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer;opacity:0;transition:opacity .2s}.bundle-card[_ngcontent-%COMP%]:hover   .bundle-delete[_ngcontent-%COMP%]{opacity:1}button[_ngcontent-%COMP%]{padding:4px 8px;background:var(--accent);color:#fff;border:none;border-radius:4px;cursor:pointer}button[_ngcontent-%COMP%]:hover{background:var(--accent-hover)}button.secondary[_ngcontent-%COMP%]{background:transparent;border:1px solid var(--border);color:var(--text)}button.secondary[_ngcontent-%COMP%]:hover{border-color:var(--accent);color:var(--accent)}button.danger[_ngcontent-%COMP%]{background:#ef4444}.loot-recipients[_ngcontent-%COMP%]{margin-top:.5rem;padding-top:.5rem;border-top:1px solid var(--border)}.recipients-label[_ngcontent-%COMP%]{font-size:.7rem;color:var(--text-muted);display:block;margin-bottom:4px}.recipient-checkboxes[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:.5rem}.recipient-checkbox[_ngcontent-%COMP%]{font-size:.8rem;display:flex;align-items:center;gap:4px;cursor:pointer}.loot-section[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column}.empty-loot[_ngcontent-%COMP%]{text-align:center;padding:2rem;color:gray;font-style:italic}.currency-display[_ngcontent-%COMP%]{font-size:.8rem;margin-top:4px}"]})};var gt=()=>[],ht=(a,t)=>t.id;function _t(a,t){if(a&1){let e=v();l(0,"div",4)(1,"span"),p(2),s(),l(3,"button",7),h("click",function(){let i=m(e).$index,n=c(2);return u(n.removeCharacter(i))}),p(4,"Remove"),s()()}if(a&2){let e=t.$implicit;d(2),I(e)}}function bt(a,t){if(a&1){let e=v();l(0,"div",9)(1,"span"),p(2),s(),l(3,"button",7),h("click",function(){let i=m(e).$index,n=c(2);return u(n.removeFromParty(i))}),p(4,"Remove"),s()()}if(a&2){let e=t.$implicit;d(2),I(e)}}function ft(a,t){if(a&1&&(l(0,"option",27),p(1),s()),a&2){let e=c().$implicit;k("value",e),d(),I(e)}}function yt(a,t){if(a&1&&C(0,ft,2,2,"option",27),a&2){let e=t.$implicit,r=c();x(r.partyIds.includes(e)?-1:0)}}function Ct(a,t){a&1&&(l(0,"p"),p(1,"No characters in party. Add characters to see their stats."),s())}function xt(a,t){if(a&1&&(l(0,"div",31),D(1,"img",47),Y(2,"imageUrl"),s()),a&2){let e=c().$implicit;d(),k("alt",_e(e.sheet.name||e.id))("src",pe(2,3,e.sheet.portrait),ge)}}function vt(a,t){if(a&1){let e=v();l(0,"div",29),h("dragover",function(i){m(e);let n=c(3);return u(n.onDragOver(i))})("drop",function(i){let n=m(e).$implicit,o=c(3);return u(o.onDropOnCharacter(i,n.id))})("dblclick",function(){let i=m(e).$implicit,n=c(3);return u(n.openCharacterSheet(i.id))}),l(1,"div",30),C(2,xt,3,5,"div",31),l(3,"div",32)(4,"h3"),p(5),s()()(),l(6,"div",33)(7,"div",34)(8,"span",35),p(9,"Health"),s(),l(10,"div",36),D(11,"div",37),l(12,"span",38),p(13),s()()(),l(14,"div",34)(15,"span",35),p(16,"Energy"),s(),l(17,"div",36),D(18,"div",39),l(19,"span",38),p(20),s()()(),l(21,"div",34)(22,"span",35),p(23,"Mana"),s(),l(24,"div",36),D(25,"div",40),l(26,"span",38),p(27),s()()(),l(28,"div",41)(29,"span",35),p(30,"Money:"),s(),l(31,"div",42)(32,"span",43),p(33),s(),l(34,"span",44),p(35),s(),l(36,"span",45),p(37),s(),l(38,"span",46),p(39),s()()()()()}if(a&2){let e=t.$implicit;d(2),x(e.sheet.portrait?2:-1),d(3),I(e.sheet.name||e.id),d(6),Z("width",((e.sheet.statuses[0]==null?null:e.sheet.statuses[0].statusCurrent)||0)/((e.sheet.statuses[0]==null?null:e.sheet.statuses[0].statusBase)||1)*100,"%"),d(2),Q("",(e.sheet.statuses[0]==null?null:e.sheet.statuses[0].statusCurrent)||0," / ",(e.sheet.statuses[0]==null?null:e.sheet.statuses[0].statusBase)||0),d(5),Z("width",((e.sheet.statuses[1]==null?null:e.sheet.statuses[1].statusCurrent)||0)/((e.sheet.statuses[1]==null?null:e.sheet.statuses[1].statusBase)||1)*100,"%"),d(2),Q("",(e.sheet.statuses[1]==null?null:e.sheet.statuses[1].statusCurrent)||0," / ",(e.sheet.statuses[1]==null?null:e.sheet.statuses[1].statusBase)||0),d(5),Z("width",((e.sheet.statuses[2]==null?null:e.sheet.statuses[2].statusCurrent)||0)/((e.sheet.statuses[2]==null?null:e.sheet.statuses[2].statusBase)||1)*100,"%"),d(2),Q("",(e.sheet.statuses[2]==null?null:e.sheet.statuses[2].statusCurrent)||0," / ",(e.sheet.statuses[2]==null?null:e.sheet.statuses[2].statusBase)||0),d(6),f("",(e.sheet.currency==null?null:e.sheet.currency.copper)||0,"c"),d(2),f("",(e.sheet.currency==null?null:e.sheet.currency.silver)||0,"s"),d(2),f("",(e.sheet.currency==null?null:e.sheet.currency.gold)||0,"g"),d(2),f("",(e.sheet.currency==null?null:e.sheet.currency.platinum)||0,"p")}}function wt(a,t){if(a&1&&(l(0,"div",13),T(1,vt,40,18,"div",28,ht),s()),a&2){let e=c(2);d(),M(e.getPartyCharacterArray())}}function St(a,t){if(a&1){let e=v();l(0,"div",48),h("mousedown",function(){m(e);let i=c(2);return u(i.closeItemCreator())}),l(1,"div",49),h("click",function(i){return m(e),u(i.stopPropagation())})("mousedown",function(i){return m(e),u(i.stopPropagation())}),l(2,"app-item-creator",50),h("create",function(i){m(e);let n=c(2);return u(n.createItem(i))})("cancel",function(){m(e);let i=c(2);return u(i.closeItemCreator())}),s()()()}}function Tt(a,t){a&1&&(l(0,"p",57),p(1,"Trash is empty"),s())}function Mt(a,t){if(a&1&&(l(0,"div",64),p(1),s()),a&2){let e=c().$implicit;d(),f(" ",e.data.description," ")}}function kt(a,t){if(a&1){let e=v();l(0,"div",59)(1,"div",60)(2,"div",61)(3,"span",62),p(4),s(),l(5,"strong"),p(6),s()(),l(7,"div",63),p(8),Y(9,"date"),s(),C(10,Mt,2,1,"div",64),s(),l(11,"div",54)(12,"button",65),h("click",function(){let i=m(e).$index,n=c(4);return u(n.restoreFromTrash(i))}),p(13," Restore "),s(),l(14,"button",66),h("click",function(){let i=m(e).$index,n=c(4);return u(n.permanentlyDelete(i))}),p(15," Delete Forever "),s()()()}if(a&2){let e=t.$implicit;d(4),f(" ",e.type," "),d(2),I(e.data.name||"Unnamed"),d(2),f(" Deleted: ",fe(9,4,e.deletedAt,"short")," "),d(2),x(e.data.description?10:-1)}}function Pt(a,t){if(a&1&&(l(0,"div",58),T(1,kt,16,7,"div",59,J),s()),a&2){let e=c(2);d(),M(e.trash)}}function Et(a,t){if(a&1){let e=v();l(0,"div",51),h("click",function(){m(e);let i=c(2);return u(i.closeTrash())}),l(1,"div",52),h("click",function(i){return m(e),u(i.stopPropagation())}),l(2,"div",53)(3,"h2"),p(4,"\u{1F5D1}\uFE0F Trash"),s(),l(5,"div",54)(6,"button",55),h("click",function(){m(e);let i=c(2);return u(i.emptyTrash())}),p(7," Empty Trash "),s(),l(8,"button",56),h("click",function(){m(e);let i=c(2);return u(i.closeTrash())}),p(9," Close "),s()()(),C(10,Tt,2,0,"p",57)(11,Pt,3,0,"div",58),s()()}if(a&2){let e=c();d(6),k("disabled",!e.trash||e.trash.length===0),d(4),x(!e.trash||e.trash.length===0?10:11)}}function It(a,t){if(a&1){let e=v();l(0,"div",0)(1,"div",1)(2,"h1"),p(3),s()(),l(4,"div",2)(5,"app-card")(6,"h2"),p(7,"All Characters"),s(),l(8,"div",3),T(9,_t,5,1,"div",4,q),s(),l(11,"div",5)(12,"input",6),V("ngModelChange",function(i){m(e);let n=c();return O(n.newCharacterId,i)||(n.newCharacterId=i),u(i)}),s(),l(13,"button",7),h("click",function(){m(e);let i=c();return u(i.addCharacter())}),p(14,"Add Character"),s()()(),l(15,"app-card")(16,"h2"),p(17,"Active Party"),s(),l(18,"div",8),T(19,bt,5,1,"div",9,q),s(),l(21,"div",5)(22,"select",10),V("ngModelChange",function(i){m(e);let n=c();return O(n.selectedCharacterForParty,i)||(n.selectedCharacterForParty=i),u(i)}),l(23,"option",11),p(24,"Select a character..."),s(),T(25,yt,1,1,null,null,q),s(),l(27,"button",7),h("click",function(){m(e);let i=c();return u(i.addToParty())}),p(28,"Add to Party"),s()()(),l(29,"app-card",12)(30,"h2"),p(31,"Party Dashboard"),s(),C(32,Ct,2,0,"p")(33,wt,3,0,"div",13),s()(),l(34,"div",14),D(35,"app-battle-tracker",15),s(),l(36,"div",16)(37,"app-card",17)(38,"h2"),p(39,"Battle Loot"),s(),l(40,"app-loot-manager",18),h("bundleCreated",function(i){m(e);let n=c();return u(n.onBundleCreated(i))})("bundleDeleted",function(i){m(e);let n=c();return u(n.onBundleDeleted(i))}),s()(),l(41,"app-card",19)(42,"div",20)(43,"h2"),p(44,"Library"),s(),l(45,"button",21),h("click",function(){m(e);let i=c();return u(i.openTrash())}),p(46),s()(),l(47,"div",22)(48,"button",23),h("click",function(){m(e);let i=c();return u(i.generateRandomWeapon())}),p(49,"Zuf\xE4llige Waffe schmieden"),s(),l(50,"button",23),h("click",function(){m(e);let i=c();return u(i.generateRandomArmor())}),p(51,"Zuf\xE4llige R\xFCstung schmieden"),s()(),l(52,"p",24),p(53,"Drag items onto characters or battle loot. Double-click to edit."),s(),l(54,"app-library-tabs",25),h("addItem",function(){m(e);let i=c();return u(i.openItemCreator())})("addRune",function(){m(e);let i=c();return u(i.addRune())})("addSpell",function(){m(e);let i=c();return u(i.addSpell())})("addSkill",function(){m(e);let i=c();return u(i.addSkill())})("updateItem",function(i){m(e);let n=c();return u(n.updateItem(i.index,i.patch))})("updateRune",function(i){m(e);let n=c();return u(n.updateRune(i.index,i.patch))})("updateSpell",function(i){m(e);let n=c();return u(n.updateSpell(i.index,i.patch))})("updateSkill",function(i){m(e);let n=c();return u(n.updateSkill(i.index,i.patch))})("removeItem",function(i){m(e);let n=c();return u(n.removeItem(i))})("removeRune",function(i){m(e);let n=c();return u(n.removeRune(i))})("removeSpell",function(i){m(e);let n=c();return u(n.removeSpell(i))})("removeSkill",function(i){m(e);let n=c();return u(n.removeSkill(i))})("itemEditingChange",function(i){m(e);let n=c();return u(n.onItemEditingChange(i))})("runeEditingChange",function(i){m(e);let n=c();return u(n.onRuneEditingChange(i))})("spellEditingChange",function(i){m(e);let n=c();return u(n.onSpellEditingChange(i))})("skillEditingChange",function(i){m(e);let n=c();return u(n.onSkillEditingChange(i))})("dragStart",function(i){m(e);let n=c();return u(n.onDragStart(i.event,i.type,i.index))}),s()()()(),C(55,St,3,0,"div",26),C(56,Et,12,2,"div",26)}if(a&2){let e=t,r=c();d(3),f("",r.worldName," - GM View"),d(6),M(e.characterIds),d(3),L("ngModel",r.newCharacterId),d(7),M(e.partyIds),d(3),L("ngModel",r.selectedCharacterForParty),d(3),M(e.characterIds),d(7),x(r.getPartyCharacterArray().length===0?32:33),d(3),k("engine",r.battleEngine),d(5),k("bundles",r.lootBundleLibrary)("partyMembers",r.partyMembersForLoot),d(6),f(" \u{1F5D1}\uFE0F Trash (",(e.trash||be(19,gt)).length,") "),d(8),k("items",e.itemLibrary)("runes",e.runeLibrary)("spells",e.spellLibrary)("skills",e.skillLibrary)("dummySheet",r.dummySheet)("editingItems",r.editingItems)("editingRunes",r.editingRunes)("editingSpells",r.editingSpells)("editingSkills",r.editingSkills),d(),x(r.showItemCreator?55:-1),d(),x(r.showTrash?56:-1)}}var Ue=class a{constructor(t){this.route=t}worldName="";store=w(R);worldSocket=w(Oe);characterApi=w(Ee);characterSocket=w(Le);battleService=w(X);libraryService=w(oe);trashService=w(G);cdr=w(ye);newCharacterId="";selectedCharacterForParty="";partyCharacters=new Map;characterPortraitsMap=new Map;characterPatchSubscription;battleEngine=new Fe;dummySheet=Ie();showItemCreator=!1;showTrash=!1;editingItems=new Set;editingRunes=new Set;editingSpells=new Set;editingSkills=new Set;dragScrollInterval;isDragging=!1;get lootBundleLibrary(){return this.store.worldValue?.lootBundleLibrary||[]}get battleQueue(){return this.battleService.getBattleQueue()}get availableCharactersForBattle(){return this.battleService.getAvailableCharactersForBattle(this.getPartyCharacterArray())}ngOnInit(){this.battleEngine.setWorldStore(this.store),this.route.params.subscribe(t=>{this.worldName=t.worldName,this.store.load(this.worldName)}),this.characterSocket.connect(),this.characterPatchSubscription=this.characterSocket.patches$.subscribe(t=>{let e=this.partyCharacters.get(t.characterId);e&&(this.applyJsonPatch(e,t.patch),(t.patch.path.includes("speed")||t.patch.path==="level")&&this.battleService.refreshBattleSpeeds(),t.patch.path.includes("portrait")&&this.updateCharacterPortraits(),this.cdr.markForCheck())}),this.store.world$.subscribe(t=>{t&&this.loadPartyCharacters(t.partyIds)})}ngOnDestroy(){this.characterPatchSubscription?.unsubscribe()}async loadPartyCharacters(t){for(let r of t)if(!this.partyCharacters.has(r))try{let i=await this.characterApi.loadCharacter(r);if(i&&(i.currency||(i.currency={copper:0,silver:0,gold:0,platinum:0}),this.partyCharacters.set(r,i),this.characterSocket.joinCharacter(r),i.worldName!==this.worldName))try{await this.characterApi.patchCharacter(r,{path:"worldName",value:this.worldName})}catch(n){console.error(`Failed to auto-assign world to character ${r}:`,n)}}catch(i){console.error(`Failed to load character ${r}:`,i)}let e=new Set(t);for(let r of this.partyCharacters.keys())e.has(r)||this.partyCharacters.delete(r);this.battleService.setPartyCharacters(this.partyCharacters),this.updateCharacterPortraits(),this.battleEngine.setAvailableCharacters(Array.from(this.partyCharacters.entries()).map(([r,i])=>({id:r,name:i.name||r,portrait:i.portrait,speed:this.battleService.calculateSpeed(i)}))),this.battleEngine.loadFromWorldStore(),this.cdr.detectChanges()}updateCharacterPortraits(){let t=new Map;this.partyCharacters.forEach((e,r)=>{e.portrait&&t.set(r,e.portrait)}),this.characterPortraitsMap=t}getPartyCharacterArray(){return Array.from(this.partyCharacters.entries()).map(([t,e])=>({id:t,sheet:e}))}get partyMembersForLoot(){return this.getPartyCharacterArray().map(t=>({id:t.id,name:t.sheet.name||t.id}))}addCharacter(){if(!this.newCharacterId.trim())return;let t=this.store.worldValue;t&&!t.characterIds.includes(this.newCharacterId)&&(this.store.applyPatch({path:"characterIds",value:[...t.characterIds,this.newCharacterId]}),this.newCharacterId="")}removeCharacter(t){let e=this.store.worldValue;if(e){let r=[...e.characterIds],i=r[t];r.splice(t,1);let n=e.partyIds.filter(o=>o!==i);this.store.applyPatch({path:"characterIds",value:r}),n.length!==e.partyIds.length&&this.store.applyPatch({path:"partyIds",value:n})}}async addToParty(){if(!this.selectedCharacterForParty)return;let t=this.store.worldValue;if(t&&!t.partyIds.includes(this.selectedCharacterForParty)){this.store.applyPatch({path:"partyIds",value:[...t.partyIds,this.selectedCharacterForParty]});try{await this.characterApi.patchCharacter(this.selectedCharacterForParty,{path:"worldName",value:t.name})}catch(e){console.error("Failed to update character worldName:",e)}this.selectedCharacterForParty=""}}removeFromParty(t){let e=this.store.worldValue;if(e){let r=[...e.partyIds];r.splice(t,1),this.store.applyPatch({path:"partyIds",value:r})}}openItemCreator(){this.showItemCreator=!0}closeItemCreator(){this.showItemCreator=!1}createItem(t){this.libraryService.createItem(t),this.closeItemCreator()}generateRandomWeapon(){this.libraryService.generateRandomWeapon(5)}generateRandomArmor(){this.libraryService.generateRandomArmor(5)}updateItem(t,e){this.libraryService.updateItem(t,e)}removeItem(t){this.libraryService.removeItem(t),this.editingItems=this.shiftEditingSet(this.editingItems,t)}addRune(){this.libraryService.addRune()}updateRune(t,e){this.libraryService.updateRune(t,e)}removeRune(t){this.libraryService.removeRune(t),this.editingRunes=this.shiftEditingSet(this.editingRunes,t)}addSpell(){this.libraryService.addSpell()}updateSpell(t,e){this.libraryService.updateSpell(t,e)}removeSpell(t){this.libraryService.removeSpell(t)}addSkill(){this.libraryService.addSkill()}updateSkill(t,e){this.libraryService.updateSkill(t,e)}removeSkill(t){this.libraryService.removeSkill(t)}onItemEditingChange({index:t,isEditing:e}){this.editingItems=this.updateEditingSet(this.editingItems,t,e)}onRuneEditingChange({index:t,isEditing:e}){this.editingRunes=this.updateEditingSet(this.editingRunes,t,e)}onSpellEditingChange({index:t,isEditing:e}){this.editingSpells=this.updateEditingSet(this.editingSpells,t,e)}onSkillEditingChange({index:t,isEditing:e}){this.editingSkills=this.updateEditingSet(this.editingSkills,t,e)}isItemEditing(t){return this.editingItems.has(t)}isRuneEditing(t){return this.editingRunes.has(t)}isSpellEditing(t){return this.editingSpells.has(t)}updateEditingSet(t,e,r){let i=new Set(t);return r?i.add(e):i.delete(e),i}shiftEditingSet(t,e){let r=new Set;return t.forEach(i=>{i<e?r.add(i):i>e&&r.add(i-1)}),r}trackByIndex(t){return t}addToBattle(t){this.battleService.addToBattle(t)}removeFromBattle(t){this.battleService.removeFromBattle(t)}advanceTurn(){this.battleService.advanceTurn()}resetBattle(){this.battleService.resetBattle()}changeParticipantTeam(t,e){this.battleService.changeParticipantTeam(t,e)}reorderParticipants(t,e){this.battleService.reorderParticipants(t,e)}openTrash(){this.showTrash=!0}closeTrash(){this.showTrash=!1}restoreFromTrash(t){this.trashService.restoreFromTrash(t)}permanentlyDelete(t){this.trashService.permanentlyDelete(t)}emptyTrash(){this.trashService.emptyTrash()}onDragStart(t,e,r){t.dataTransfer.effectAllowed="copy",t.dataTransfer.setData("lootType",e),t.dataTransfer.setData("lootIndex",r.toString()),this.isDragging=!0,this.startAutoScroll()}onDragOver(t){t.preventDefault(),t.dataTransfer.dropEffect="copy",this.updateAutoScroll(t.clientY)}startAutoScroll(){this.dragScrollInterval&&clearInterval(this.dragScrollInterval),this.dragScrollInterval=window.setInterval(()=>{this.isDragging||this.stopAutoScroll()},16)}updateAutoScroll(t){let i=window.innerHeight;t<100?window.scrollBy(0,-10):t>i-100&&window.scrollBy(0,10)}stopAutoScroll(){this.dragScrollInterval&&(clearInterval(this.dragScrollInterval),this.dragScrollInterval=void 0),this.isDragging=!1}onDropOnCharacter(t,e){t.preventDefault(),this.stopAutoScroll();let r=t.dataTransfer.getData("lootType"),i=parseInt(t.dataTransfer.getData("lootIndex")),n=this.store.worldValue;if(!n)return;if(r==="bundle"){let b=this.lootBundleLibrary[i];b&&this.characterApi.loadCharacter(e).then(g=>{g&&(b.items.forEach(_=>this.giveItemToCharacter(e,"item",_,g)),b.runes.forEach(_=>this.giveItemToCharacter(e,"rune",_,g)),b.spells.forEach(_=>this.giveItemToCharacter(e,"spell",_,g)),b.skills.forEach(_=>this.giveItemToCharacter(e,"skill",_,g)))});return}let o;switch(r){case"item":o=n.itemLibrary[i];break;case"rune":o=n.runeLibrary[i];break;case"spell":o=n.spellLibrary[i];break;case"skill":o=n.skillLibrary[i];break}o&&this.characterApi.loadCharacter(e).then(b=>{b&&this.giveItemToCharacter(e,r,o,b)})}giveItemToCharacter(t,e,r,i){let n,o;switch(e){case"item":n="inventory",o=i.inventory||[];break;case"rune":n="runes",o=i.runes||[];break;case"spell":n="spells",o=i.spells||[];break;case"skill":n="skills",o=i.skills||[];break}o.push(S({},r)),this.characterSocket.sendPatch(t,{path:n,value:o}),this.sendDirectLootNotification(t,e,r)}sendDirectLootNotification(t,e,r){let i={id:`direct_${e}_${Date.now()}_${Math.random()}`,type:e,data:r,claimedBy:[]};this.worldSocket.sendDirectLoot(t,i)}onBundleCreated(t){let e=this.store.worldValue;if(e){let r=e.lootBundleLibrary||[],i=r.findIndex(o=>o.name===t.name),n=i>=0?r.map((o,b)=>b===i?t:o):[...r,t];this.store.applyPatch({path:"lootBundleLibrary",value:n})}}onBundleDeleted(t){let e=this.store.worldValue;if(e){let i=[...e.lootBundleLibrary||[]];i.splice(t,1),this.store.applyPatch({path:"lootBundleLibrary",value:i})}}openCharacterSheet(t){let e=`/characters/${t}`;window.open(e,"_blank")}applyJsonPatch(t,e){let r=e.path.startsWith("/")?e.path.substring(1).split("/"):e.path.split("."),i=t;for(let b=0;b<r.length-1;b++){let g=r[b],_=parseInt(g,10);!isNaN(_)&&Array.isArray(i)?i=i[_]:i=i[g]??={}}let n=r[r.length-1],o=parseInt(n,10);!isNaN(o)&&Array.isArray(i)?i[o]=e.value:i[n]=e.value}static \u0275fac=function(e){return new(e||a)(he(ve))};static \u0275cmp=A({type:a,selectors:[["app-world"]],decls:2,vars:3,consts:[[1,"world-container"],[1,"world-header"],[1,"management-grid"],[1,"character-list"],[1,"character-item"],[1,"add-section"],["type","text","placeholder","Character ID",3,"ngModelChange","ngModel"],[3,"click"],[1,"party-list"],[1,"party-item"],[3,"ngModelChange","ngModel"],["value",""],[1,"party-dashboard-card"],[1,"dashboard-grid"],[1,"battle-tracker-section"],[3,"engine"],[1,"content-grid"],[1,"battle-loot-card"],[3,"bundleCreated","bundleDeleted","bundles","partyMembers"],[1,"library-card"],[2,"display","flex","justify-content","space-between","align-items","center"],["title","Open Trash",2,"background","#666","color","white","padding","6px 12px","border-radius","4px","cursor","pointer","border","none",3,"click"],[2,"margin-bottom","1rem","display","flex","gap","0.5rem"],[2,"width","100%","background","var(--accent)","color","white","padding","8px",3,"click"],[1,"drag-hint"],[3,"addItem","addRune","addSpell","addSkill","updateItem","updateRune","updateSpell","updateSkill","removeItem","removeRune","removeSpell","removeSkill","itemEditingChange","runeEditingChange","spellEditingChange","skillEditingChange","dragStart","items","runes","spells","skills","dummySheet","editingItems","editingRunes","editingSpells","editingSkills"],[1,"dialog-overlay"],[3,"value"],[1,"character-card","drop-zone"],[1,"character-card","drop-zone",3,"dragover","drop","dblclick"],[1,"character-header"],[1,"character-portrait"],[1,"character-info"],[1,"character-stats"],[1,"stat-row"],[1,"stat-label"],[1,"stat-bar-wrapper"],[1,"stat-bar-fill","health"],[1,"stat-value"],[1,"stat-bar-fill","energy"],[1,"stat-bar-fill","mana"],[1,"stat-row","money"],[1,"currency"],[1,"copper"],[1,"silver"],[1,"gold"],[1,"platinum"],[3,"src","alt"],[1,"dialog-overlay",3,"mousedown"],[1,"dialog-content",3,"click","mousedown"],[3,"create","cancel"],[1,"dialog-overlay",3,"click"],[1,"dialog-content","trash-dialog",2,"max-width","800px","max-height","80vh","overflow-y","auto",3,"click"],[2,"display","flex","justify-content","space-between","align-items","center","margin-bottom","1rem"],[2,"display","flex","gap","0.5rem"],[2,"background","#d32f2f","color","white","padding","6px 12px","border-radius","4px","cursor","pointer","border","none",3,"click","disabled"],[2,"background","#666","color","white","padding","6px 12px","border-radius","4px","cursor","pointer","border","none",3,"click"],[2,"text-align","center","color","#999","padding","2rem"],[2,"display","flex","flex-direction","column","gap","0.5rem"],[2,"background","var(--card-bg)","border","1px solid var(--border-color)","border-radius","4px","padding","1rem","display","flex","justify-content","space-between","align-items","center"],[2,"flex","1"],[2,"display","flex","align-items","center","gap","0.5rem"],[2,"background","var(--accent)","color","white","padding","2px 8px","border-radius","3px","font-size","0.75rem","text-transform","uppercase"],[2,"color","#999","font-size","0.85rem","margin-top","0.25rem"],[2,"color","#ccc","font-size","0.9rem","margin-top","0.5rem","max-width","500px","overflow","hidden","text-overflow","ellipsis","white-space","nowrap"],[2,"background","#4caf50","color","white","padding","6px 12px","border-radius","4px","cursor","pointer","border","none",3,"click"],[2,"background","#d32f2f","color","white","padding","6px 12px","border-radius","4px","cursor","pointer","border","none",3,"click"]],template:function(e,r){if(e&1&&(C(0,It,57,20),Y(1,"async")),e&2){let i;x((i=pe(1,1,r.store.world$))?0:-1,i)}},dependencies:[F,we,z,Me,ke,$,Te,H,N,Re,le,De,se,Ce,xe,Pe],styles:[".world-container[_ngcontent-%COMP%]{padding:1rem;max-width:1800px;margin:0 auto}.world-header[_ngcontent-%COMP%]{margin-bottom:2rem}.world-header[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0;color:var(--accent);font-size:28px;font-weight:600}.management-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr 2fr;gap:1rem;margin-bottom:1rem}.content-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 2fr;gap:1rem;height:calc(100vh - 400px);min-height:600px}.battle-loot-card[_ngcontent-%COMP%], .library-card[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:100%}.party-dashboard-card[_ngcontent-%COMP%]{grid-column:span 3}.character-list[_ngcontent-%COMP%], .party-list[_ngcontent-%COMP%], .library-list[_ngcontent-%COMP%], .loot-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem;margin-bottom:1rem;max-height:300px;overflow-y:auto}.character-item[_ngcontent-%COMP%], .party-item[_ngcontent-%COMP%], .loot-item[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:.5rem;background:var(--bg);border-radius:6px;border:1px solid var(--border)}.library-list[_ngcontent-%COMP%] > *[_ngcontent-%COMP%]{margin-bottom:.5rem}.character-item[_ngcontent-%COMP%]   span[_ngcontent-%COMP%], .party-item[_ngcontent-%COMP%]   span[_ngcontent-%COMP%], .loot-item[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{flex:1;color:var(--text)}.character-item[_ngcontent-%COMP%]   button[_ngcontent-%COMP%], .party-item[_ngcontent-%COMP%]   button[_ngcontent-%COMP%], .loot-item[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:.25rem .75rem;background:#ef4444;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;transition:background .2s}.character-item[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover, .party-item[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover, .loot-item[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{background:#dc2626}.add-section[_ngcontent-%COMP%]{display:flex;gap:.5rem;margin-top:.5rem}.add-section[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], .add-section[_ngcontent-%COMP%]   select[_ngcontent-%COMP%]{flex:1;padding:.5rem;border:1px solid var(--border);border-radius:6px;font-size:14px}.add-section[_ngcontent-%COMP%]   button[_ngcontent-%COMP%], app-card[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{padding:.5rem 1rem;background:var(--accent);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:background .2s}.add-section[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover, app-card[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{background:var(--accentdark)}.dashboard-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem}.character-card[_ngcontent-%COMP%]{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;box-shadow:0 1px 2px #0000000d}.character-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 12px;color:var(--accent);font-size:18px;font-weight:600;border-bottom:none;padding-bottom:0}.stat-row[_ngcontent-%COMP%]{margin-bottom:12px}.stat-label[_ngcontent-%COMP%]{display:block;font-size:12px;font-weight:500;color:var(--muted);margin-bottom:6px}.stat-bar-wrapper[_ngcontent-%COMP%]{height:14px;background:#0009;border-radius:6px;overflow:hidden;position:relative}.stat-bar-fill[_ngcontent-%COMP%]{height:100%;background:var(--accent);border-radius:6px;transition:width .3s ease}.stat-bar-fill.health[_ngcontent-%COMP%]{background:var(--health-color);box-shadow:inset 0 0 30px #ef444499,inset 0 0 60px #ef444466,inset 0 0 90px #ef444433;filter:brightness(1.3)}.stat-bar-fill.energy[_ngcontent-%COMP%]{background:var(--energy-color);box-shadow:inset 0 0 30px #22c55e99,inset 0 0 60px #22c55e66,inset 0 0 90px #22c55e33;filter:brightness(1.3)}.stat-bar-fill.mana[_ngcontent-%COMP%]{background:var(--mana-color);box-shadow:inset 0 0 30px #3b82f699,inset 0 0 60px #3b82f666,inset 0 0 90px #3b82f633;filter:brightness(1.3)}.stat-value[_ngcontent-%COMP%]{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;color:var(--text)}.stat-row.money[_ngcontent-%COMP%]{margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}.currency[_ngcontent-%COMP%]{display:flex;gap:8px;flex-wrap:wrap}.currency[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-weight:600;padding:4px 8px;border-radius:6px;font-size:12px}.currency[_ngcontent-%COMP%]   .copper[_ngcontent-%COMP%]{background:#cd7f32;color:#000}.currency[_ngcontent-%COMP%]   .silver[_ngcontent-%COMP%]{background:silver;color:#000}.currency[_ngcontent-%COMP%]   .gold[_ngcontent-%COMP%]{background:gold;color:#000}.currency[_ngcontent-%COMP%]   .platinum[_ngcontent-%COMP%]{background:#e5e4e2;color:#000;border:1px solid #9ca3af}.draggable[_ngcontent-%COMP%]{cursor:move;transition:transform .2s,box-shadow .2s}.draggable[_ngcontent-%COMP%]:hover{transform:translateY(-2px);box-shadow:0 2px 4px #0000001a}.draggable[_ngcontent-%COMP%]:active{cursor:grabbing}.drop-zone[_ngcontent-%COMP%]{position:relative;transition:background .2s,border .2s}.drop-zone.drag-over[_ngcontent-%COMP%]{background:#f3f4f6;border:2px dashed var(--accent)}.character-card.drop-zone[_ngcontent-%COMP%]{border:1px solid var(--border)}.character-card.drop-zone[_ngcontent-%COMP%]:hover{border-color:var(--accent)}.drop-hint[_ngcontent-%COMP%]{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#6b46c1f2;color:#fff;padding:8px 16px;border-radius:6px;font-weight:600;font-size:14px;z-index:10;pointer-events:none;box-shadow:0 4px 6px #0000001a}.drop-zone[_ngcontent-%COMP%]:hover   .drop-hint[_ngcontent-%COMP%]{display:block}.drag-hint[_ngcontent-%COMP%]{font-size:12px;color:var(--muted);font-style:italic;margin:8px 0}.empty-loot[_ngcontent-%COMP%]{text-align:center;color:var(--muted);font-style:italic;padding:2rem;min-height:100px;display:flex;align-items:center;justify-content:center;border:2px dashed var(--border);border-radius:6px;margin:0;background:var(--bg)}.claimed-count[_ngcontent-%COMP%]{font-size:11px;color:var(--muted);background:var(--bg);padding:4px 8px;border-radius:6px;margin-left:8px;font-weight:500}.reveal-loot-btn[_ngcontent-%COMP%]{width:100%;margin-top:1rem;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;transition:background .2s}.reveal-loot-btn[_ngcontent-%COMP%]:hover{background:var(--accent-hover)}.dialog-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background-color:#00000080;display:flex;justify-content:center;align-items:center;z-index:1000}.dialog-content[_ngcontent-%COMP%]{background:var(--card);padding:2rem;border-radius:8px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto}.dialog-content[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin-top:0;color:var(--accent)}.empty-message[_ngcontent-%COMP%]{text-align:center;color:var(--text-muted);padding:2rem;font-style:italic}.character-header[_ngcontent-%COMP%]{display:flex;gap:1rem;margin-bottom:1rem;align-items:flex-start}.character-portrait[_ngcontent-%COMP%]{width:120px;height:120px;flex-shrink:0;border-radius:10px;overflow:hidden;border:3px solid var(--accent);box-shadow:0 3px 6px #00000026}.character-portrait[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.character-info[_ngcontent-%COMP%]{flex:1;min-width:0}.character-info[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 .5rem;font-size:18px;font-weight:600;color:var(--accent)}.character-stats[_ngcontent-%COMP%]{flex:1}.battle-tracker-section[_ngcontent-%COMP%]{margin-bottom:1rem}.cdk-drag-animating[_ngcontent-%COMP%]{transition:transform .3s cubic-bezier(0,0,.2,1)}.cdk-drop-list-dragging[_ngcontent-%COMP%]   .cdk-drag[_ngcontent-%COMP%]{transition:transform .25s cubic-bezier(0,0,.2,1)}"],changeDetection:0})};export{Ue as WorldComponent};
