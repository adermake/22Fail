import{a as at,d as ot,e as st}from"./chunk-RFXIYJE6.js";import{c as Z,f as tt,j as et,k as it,l as nt,p as rt}from"./chunk-CRXYTJXZ.js";import{e as X,k as K}from"./chunk-QU66LBKX.js";import{$b as Q,Bb as Y,Cb as J,Db as U,Fa as D,Gb as y,Ia as l,Ib as u,Jb as k,Kb as L,O as j,S as R,T as H,Ua as z,Ub as A,Vb as W,Y as f,Z as b,a as P,b as $,db as N,eb as B,fb as v,gb as _,h as V,ia as E,ib as q,jb as S,kb as I,lb as x,mb as c,nb as d,ob as T,sb as O,wb as C,yb as m}from"./chunk-EGMLUSXW.js";function lt(o){return{name:o,characterIds:[],partyIds:[],itemLibrary:[],runeLibrary:[],spellLibrary:[],skillLibrary:[],lootBundles:[],battleLoot:[],battleParticipants:[],currentTurnIndex:0,trash:[],battleMaps:[]}}var ct=class o{constructor(e,t){this.api=e;this.socket=t;this.socket.patches$.subscribe(i=>{let n=this.worldSubject.value;if(n){if(this.pendingPatchPaths.has(i.path)){console.log("[WORLD STORE] Skipping echo of own patch:",i.path),this.pendingPatchPaths.delete(i.path);return}this.applyJsonPatch(n,i),this.worldSubject.next(P({},n))}})}worldSubject=new V(null);world$=this.worldSubject.asObservable();worldName;pendingPatchPaths=new Set;get worldValue(){return this.worldSubject.value}async save(){let e=this.worldSubject.value;if(!e){console.warn("[WORLD STORE] No world loaded, cannot save.");return}if(!this.worldName){console.error("[WORLD STORE] No worldName set, cannot save.");return}try{await this.api.saveWorld(this.worldName,e),console.log("[WORLD STORE] World saved successfully")}catch(t){console.error("[WORLD STORE] Failed to save world:",t)}}async load(e){this.worldName=e,console.log("[WORLD STORE] Loading world:",e);let t=await this.api.loadWorld(e);if(console.log("[WORLD STORE] Loaded world from API:",t),!t)console.log("[WORLD STORE] No world found, creating new"),t=lt(e),this.worldSubject.next(t),this.save();else{let i=!1;t.characters&&!t.characterIds&&(console.log("[WORLD STORE] Migrating: characters -> characterIds"),t.characterIds=t.characters,delete t.characters,i=!0),t.party&&!t.partyIds&&(console.log("[WORLD STORE] Migrating: party -> partyIds"),t.partyIds=t.party,delete t.party,i=!0),t.library&&(console.log("[WORLD STORE] Migrating: library object -> separate libraries"),t.itemLibrary=t.library.items||[],t.runeLibrary=t.library.runes||[],t.spellLibrary=t.library.spells||[],t.skillLibrary=t.library.skills||[],delete t.library,i=!0),t.name||(t.name=e,i=!0),t.battleParticipants||(console.log("[WORLD STORE] Migrating: adding battleParticipants"),t.battleParticipants=[],i=!0),t.currentTurnIndex===void 0&&(console.log("[WORLD STORE] Migrating: adding currentTurnIndex"),t.currentTurnIndex=0,i=!0),t.lootBundles||(console.log("[WORLD STORE] Migrating: adding lootBundles"),t.lootBundles=[],i=!0),t.skillLibrary||(console.log("[WORLD STORE] Migrating: adding skillLibrary"),t.skillLibrary=[],i=!0),t.trash||(console.log("[WORLD STORE] Migrating: adding trash"),t.trash=[],i=!0),console.log("[WORLD STORE] Setting loaded world with",t.battleParticipants?.length||0,"battle participants"),this.worldSubject.next(t),i&&(console.log("[WORLD STORE] Saving migrated world to backend"),await this.save())}this.socket.connect(),this.socket.joinWorld(e)}applyPatch(e){let t=this.worldSubject.value;t&&(this.applyJsonPatch(t,e),this.worldSubject.next(P({},t))),this.pendingPatchPaths.add(e.path),setTimeout(()=>this.pendingPatchPaths.delete(e.path),5e3),this.socket.sendPatch(this.worldName,e)}revealBattleLoot(){this.socket.revealBattleLoot(this.worldName)}applyJsonPatch(e,t){let i=t.path.split("."),n=e;for(let s=0;s<i.length-1;s++){let p=i[s],g=parseInt(p,10);!isNaN(g)&&Array.isArray(n)?n=n[g]:n=n[p]??={}}let r=i[i.length-1],a=parseInt(r,10);!isNaN(a)&&Array.isArray(n)?n[a]=t.value:n[r]=t.value}static \u0275fac=function(t){return new(t||o)(R(st),R(ot))};static \u0275prov=j({token:o,factory:o.\u0275fac,providedIn:"root"})};var ut=["timelineContainer"];function mt(o,e){if(o&1&&(c(0,"div",4)(1,"span",13),u(2,"Current Turn:"),d(),c(3,"span",14),u(4),d()()),o&2){let t=m();l(4),k(t.currentTurnDisplay())}}function ht(o,e){if(o&1&&(c(0,"option",25),u(1),d()),o&2){let t=e.$implicit;x("value",t),l(),k(t)}}function ft(o,e){if(o&1){let t=O();c(0,"select",24),C("ngModelChange",function(n){f(t);let r=m().$implicit,a=m(2);return b(a.onTeamChange(r.id,n))}),S(1,ht,2,2,"option",25,q),d()}if(o&2){let t=m().$implicit,i=m(2);x("ngModel",t.team),l(),I(i.teams)}}function bt(o,e){if(o&1){let t=O();c(0,"div",16)(1,"div",17),T(2,"img",18),A(3,"imageUrl"),c(4,"div",19)(5,"span",20),u(6),d(),c(7,"span",21),u(8),d(),v(9,ft,3,1,"select",22),d()(),c(10,"button",23),C("click",function(){let n=f(t).$implicit,r=m(2);return b(n.isInBattle?r.onRemoveCharacter(n.id):r.onAddCharacter(n.id))}),u(11),d()()}if(o&2){let t=e.$implicit;y("in-battle",t.isInBattle),l(2),x("src",W(3,9,t.portrait),D),l(4),k(t.name),l(2),L("Speed: ",t.speed),l(),_(t.isInBattle?9:-1),l(),y("remove",t.isInBattle),l(),L(" ",t.isInBattle?"Remove":"Add"," ")}}function vt(o,e){if(o&1&&(c(0,"div",6),S(1,bt,12,11,"div",15,B().trackChar,!0),d()),o&2){let t=m();l(),I(t.characters())}}function _t(o,e){o&1&&(c(0,"p",7),u(1,"No characters available"),d())}function xt(o,e){o&1&&(c(0,"div",10)(1,"span"),u(2,"Add characters to start battle"),d()())}function Ct(o,e){o&1&&T(0,"div",28)}function Tt(o,e){if(o&1){let t=O();c(0,"div",32),C("dragstart",function(n){let r=f(t).$implicit,a=m(3);return b(a.onDragStart(n,r))})("dragend",function(){f(t);let n=m(3);return b(n.onDragEnd())}),T(1,"img",33),A(2,"imageUrl"),c(3,"span",34),u(4),d(),c(5,"span",35),u(6),d()()}if(o&2){let t=e.$implicit,i=m(3);y("dragged",i.isDragged(t.id))("animating",i.isAnimating(t.id))("scripted",t.isScripted)("calculated",!t.isScripted),x("ngClass","team-"+t.team),N("data-tile-id",t.id),l(),x("src",W(2,14,t.portrait),D)("alt",t.name),l(3),k(t.name),l(2),L("T",t.turnNumber)}}function yt(o,e){o&1&&T(0,"div",30)}function Mt(o,e){o&1&&T(0,"div",31)}function Pt(o,e){if(o&1&&(c(0,"div",27),v(1,Ct,1,0,"div",28),S(2,Tt,7,16,"div",29,B().trackTile,!0),v(4,yt,1,0,"div",30),v(5,Mt,1,0,"div",31),d()),o&2){let t=e.$implicit,i=e.$index,n=m(2);y("scripted",t.isScripted)("calculated",!t.isScripted),x("ngClass","team-"+t.team),N("data-group-id",t.id),l(),_(n.dragOverGroupIndex===i&&n.dropPosition==="before"?1:-1),l(),I(t.tiles),l(2),_(t.tiles.length>1?4:-1),l(),_(n.dragOverGroupIndex===i&&n.dropPosition==="after"?5:-1)}}function St(o,e){if(o&1&&S(0,Pt,6,9,"div",26,B().trackGroup,!0),o&2){let t=m();I(t.timeline())}}var dt=class o{engine;timelineRef;cdr=H(Q);timeline=E([]);characters=E([]);currentTurnDisplay=E(null);teams=["blue","red","green","yellow","purple","orange"];draggedTileId=null;dragOverGroupIndex=null;dropPosition=null;animState={previousPositions:new Map,animatingIds:new Set,removedTiles:new Map,isAnimating:!1};pendingAnimation=!1;ngOnInit(){this.engine&&(this.engine.setChangeCallback(()=>this.onEngineChange()),this.refresh())}ngOnDestroy(){this.engine&&this.engine.setChangeCallback(()=>{})}onEngineChange(){console.log("[ANIM] onEngineChange called, isAnimating:",this.animState.isAnimating),this.animState.isAnimating=!0,this.refresh(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.animateTransitions(),setTimeout(()=>{this.animState.isAnimating=!1},350)})})}refresh(){this.timeline.set(this.engine.getTimeline()),this.characters.set(this.engine.getCharacters()),this.currentTurnDisplay.set(this.engine.getCurrentTurnDisplay()),this.cdr.detectChanges()}recordPositions(){if(!this.timelineRef?.nativeElement)return;let e=this.timelineRef.nativeElement;this.animState.previousPositions.clear(),e.querySelectorAll("[data-tile-id]").forEach(n=>{let r=n.dataset.tileId;if(r){let a=n.getBoundingClientRect();this.animState.previousPositions.set(r,{x:a.left,y:a.top})}}),e.querySelectorAll("[data-group-id]").forEach(n=>{let r=n.dataset.groupId;if(r){let a=n.getBoundingClientRect();this.animState.previousPositions.set(`group_${r}`,{x:a.left,y:a.top})}})}animateTransitions(){if(!this.timelineRef?.nativeElement)return;let e=this.timelineRef.nativeElement;console.log("[ANIM] Starting animation cycle"),console.log("[ANIM] Recorded positions:",Array.from(this.animState.previousPositions.keys()));let t=e.querySelectorAll("[data-tile-id]");console.log("[ANIM] Current tiles in DOM:",t.length),t.forEach(i=>{let n=i.dataset.tileId;if(!n)return;let r=this.animState.previousPositions.get(n),a=i.getBoundingClientRect();console.log(`[ANIM] Tile ${n}: prevPos=${r?`(${r.x.toFixed(1)}, ${r.y.toFixed(1)})`:"NEW"}, currentPos=(${a.left.toFixed(1)}, ${a.top.toFixed(1)})`),r?this.animateMove(i,n,r):this.animateIn(i,n)})}animateIn(e,t){this.animState.animatingIds.has(t)||(this.animState.animatingIds.add(t),e.style.transition="none",e.style.transform="translateY(-40px)",e.style.opacity="0",e.offsetHeight,e.style.transition="transform 0.3s ease-out, opacity 0.3s ease-out",e.style.transform="translateY(0)",e.style.opacity="1",this.cleanupAfterAnimation(e,t,350))}animateMove(e,t,i){let n=e.getBoundingClientRect(),r=i.x-n.left,a=i.y-n.top;console.log(`[ANIM] Tile ${t}: deltaX=${r.toFixed(1)}, deltaY=${a.toFixed(1)}`),!(Math.abs(r)<2&&Math.abs(a)<2)&&(this.animState.animatingIds.has(t)||(this.animState.animatingIds.add(t),e.style.transition="none",e.style.transform=`translate(${r}px, ${a}px)`,e.offsetHeight,e.style.transition="transform 0.3s ease-out",e.style.transform="translate(0, 0)",this.cleanupAfterAnimation(e,t,350)))}cleanupAfterAnimation(e,t,i){let n=!1;setTimeout(()=>{n||(n=!0,e.style.transition="",e.style.transform="",e.style.opacity="",this.animState.animatingIds.delete(t))},i)}onAddCharacter(e){this.recordPositions(),this.engine.addCharacter(e)}onRemoveCharacter(e){this.recordPositions(),this.engine.removeCharacter(e)}onTeamChange(e,t){this.recordPositions(),this.engine.setTeam(e,t)}onNextTurn(){this.animState.isAnimating||(this.recordPositions(),this.engine.nextTurn())}onResetBattle(){this.recordPositions(),this.engine.resetBattle()}onDragStart(e,t){this.draggedTileId=t.id,e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",t.id))}onDragOver(e){if(e.preventDefault(),!this.draggedTileId)return;let t=e.currentTarget,i=Array.from(t.querySelectorAll("[data-group-id]"));if(i.length===0){this.dragOverGroupIndex=0,this.dropPosition="before";return}let n=e.clientX,r=i[0].getBoundingClientRect();if(n<r.left){this.dragOverGroupIndex=0,this.dropPosition="before";return}let a=i[i.length-1].getBoundingClientRect();if(n>a.right){this.dragOverGroupIndex=i.length-1,this.dropPosition="after";return}let s=0,p=1/0,g="before";i.forEach((h,w)=>{let M=h.getBoundingClientRect(),F=M.left+M.width/2,G=Math.abs(n-F);G<p&&(p=G,s=w,g=n<F?"before":"after")}),this.dragOverGroupIndex=s,this.dropPosition=g}onDragLeave(e){let t=e.currentTarget,i=e.relatedTarget;i&&t.contains(i)||(this.dragOverGroupIndex=null,this.dropPosition=null)}onDrop(e){if(e.preventDefault(),!this.draggedTileId||this.dragOverGroupIndex===null||!this.dropPosition){this.clearDragState();return}this.recordPositions(),this.engine.dropTile(this.draggedTileId,this.dragOverGroupIndex,this.dropPosition),this.clearDragState()}onDragEnd(){this.clearDragState()}clearDragState(){this.draggedTileId=null,this.dragOverGroupIndex=null,this.dropPosition=null}isAnimating(e){return this.animState.animatingIds.has(e)}isDragged(e){return this.draggedTileId===e}trackGroup(e,t){return t.id}trackTile(e,t){return t.id}trackChar(e,t){return t.id}static \u0275fac=function(t){return new(t||o)};static \u0275cmp=z({type:o,selectors:[["app-battle-tracker"]],viewQuery:function(t,i){if(t&1&&Y(ut,5),t&2){let n;J(n=U())&&(i.timelineRef=n.first)}},inputs:{engine:"engine"},decls:20,vars:6,consts:[["timelineContainer",""],[1,"battle-tracker-container"],[1,"battle-header"],["title","Reset battle",1,"reset-button",3,"click"],[1,"current-turn-display"],[1,"characters-section"],[1,"character-list"],[1,"no-chars"],[1,"timeline-section"],[1,"timeline",3,"dragover","dragleave","drop"],[1,"empty-timeline"],[1,"controls"],[1,"next-turn-btn",3,"click","disabled"],[1,"label"],[1,"names"],[1,"character-option",3,"in-battle"],[1,"character-option"],[1,"character-info"],["alt","",1,"portrait-small",3,"src"],[1,"details"],[1,"name"],[1,"speed"],[1,"team-selector",3,"ngModel"],[1,"toggle-btn",3,"click"],[1,"team-selector",3,"ngModelChange","ngModel"],[3,"value"],[1,"turn-group",3,"scripted","calculated","ngClass"],[1,"turn-group",3,"ngClass"],[1,"drop-indicator","before"],["draggable","true",1,"tile",3,"dragged","animating","scripted","calculated","ngClass"],[1,"group-line"],[1,"drop-indicator","after"],["draggable","true",1,"tile",3,"dragstart","dragend","ngClass"],[1,"tile-portrait",3,"src","alt"],[1,"tile-name"],[1,"turn-number"]],template:function(t,i){if(t&1){let n=O();c(0,"div",1)(1,"div",2)(2,"h2"),u(3,"Battle Tracker"),d(),c(4,"button",3),C("click",function(){return f(n),b(i.onResetBattle())}),u(5," Reset "),d()(),v(6,mt,5,1,"div",4),c(7,"div",5)(8,"h3"),u(9,"Characters"),d(),v(10,vt,3,0,"div",6)(11,_t,2,0,"p",7),d(),c(12,"div",8)(13,"div",9,0),C("dragover",function(a){return f(n),b(i.onDragOver(a))})("dragleave",function(a){return f(n),b(i.onDragLeave(a))})("drop",function(a){return f(n),b(i.onDrop(a))}),v(15,xt,3,0,"div",10)(16,St,2,0),d()(),c(17,"div",11)(18,"button",12),C("click",function(){return f(n),b(i.onNextTurn())}),u(19," Next Turn "),d()()()}t&2&&(l(6),_(i.currentTurnDisplay()?6:-1),l(4),_(i.characters().length>0?10:11),l(3),y("dragging",!!i.draggedTileId),l(2),_(i.timeline().length===0?15:16),l(3),x("disabled",i.timeline().length===0))},dependencies:[K,X,rt,it,nt,et,Z,tt,at],styles:[".battle-tracker-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1rem;padding:1rem;background:var(--bg-secondary);border-radius:8px}.battle-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding-bottom:.5rem;border-bottom:1px solid var(--border)}.battle-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;color:var(--accent);font-size:1.2rem}.reset-button[_ngcontent-%COMP%]{padding:4px 12px;background:transparent;border:1px solid var(--border);color:var(--text-muted);border-radius:4px;cursor:pointer;transition:all .2s}.reset-button[_ngcontent-%COMP%]:hover{border-color:var(--accent);color:var(--accent)}.current-turn-display[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;padding:.5rem .75rem;background:rgba(var(--accent-rgb),.1);border-left:3px solid var(--accent);border-radius:0 4px 4px 0}.current-turn-display[_ngcontent-%COMP%]   .label[_ngcontent-%COMP%]{color:var(--text-muted);font-size:.85rem}.current-turn-display[_ngcontent-%COMP%]   .names[_ngcontent-%COMP%]{color:var(--accent);font-weight:500}.characters-section[_ngcontent-%COMP%]{margin-bottom:.5rem}.characters-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 .5rem;font-size:1rem;color:var(--text)}.character-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem;max-height:250px;overflow-y:auto;padding-right:4px}.character-list[_ngcontent-%COMP%]::-webkit-scrollbar{width:6px}.character-list[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:#0000000d}.character-list[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}.character-option[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;padding:.5rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;transition:border-color .2s}.character-option.in-battle[_ngcontent-%COMP%]{border-color:var(--accent);background:rgba(var(--accent-rgb),.05)}.character-info[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem}.portrait-small[_ngcontent-%COMP%]{width:32px;height:32px;border-radius:50%;object-fit:cover}.details[_ngcontent-%COMP%]{display:flex;flex-direction:column}.details[_ngcontent-%COMP%]   .name[_ngcontent-%COMP%]{font-weight:500;font-size:.9rem}.details[_ngcontent-%COMP%]   .speed[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-muted)}.team-selector[_ngcontent-%COMP%]{margin-top:2px;padding:2px 4px;font-size:.75rem;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:4px}.toggle-btn[_ngcontent-%COMP%]{padding:4px 12px;border:none;border-radius:4px;cursor:pointer;font-size:.8rem;background:var(--accent);color:#fff;transition:opacity .2s}.toggle-btn[_ngcontent-%COMP%]:hover{opacity:.9}.toggle-btn.remove[_ngcontent-%COMP%]{background:var(--bg-secondary);color:var(--text);border:1px solid var(--border)}.no-chars[_ngcontent-%COMP%]{color:var(--text-muted);font-style:italic;margin:0}.timeline-section[_ngcontent-%COMP%]{overflow-x:auto;padding-bottom:.5rem}.timeline-section[_ngcontent-%COMP%]::-webkit-scrollbar{height:6px}.timeline-section[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:#0000000d;border-radius:3px}.timeline-section[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:var(--accent);border-radius:3px}.timeline[_ngcontent-%COMP%]{display:flex;gap:6px;min-height:100px;align-items:center;padding:8px 4px}.empty-timeline[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;min-height:80px;width:100%;color:var(--text-muted);font-style:italic}.turn-group[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:3px;padding:6px 6px 10px;border-radius:8px;background:#0000001a;position:relative}.turn-group.scripted[_ngcontent-%COMP%]{background:rgba(var(--accent-rgb),.15)}.turn-group.calculated[_ngcontent-%COMP%]{background:#0000000d}.group-line[_ngcontent-%COMP%]{position:absolute;bottom:2px;left:6px;right:6px;height:3px;border-radius:2px;background:currentColor}.turn-group.team-blue[_ngcontent-%COMP%]   .group-line[_ngcontent-%COMP%]{background:#3b82f6}.turn-group.team-red[_ngcontent-%COMP%]   .group-line[_ngcontent-%COMP%]{background:#ef4444}.turn-group.team-green[_ngcontent-%COMP%]   .group-line[_ngcontent-%COMP%]{background:#10b981}.turn-group.team-yellow[_ngcontent-%COMP%]   .group-line[_ngcontent-%COMP%]{background:#eab308}.turn-group.team-purple[_ngcontent-%COMP%]   .group-line[_ngcontent-%COMP%]{background:#a855f7}.turn-group.team-orange[_ngcontent-%COMP%]   .group-line[_ngcontent-%COMP%]{background:#f97316}.tile[_ngcontent-%COMP%]{position:relative;width:60px;height:85px;background:var(--card-bg, #2a2a2a);border:2px solid transparent;border-radius:6px;display:flex;flex-direction:column;align-items:center;overflow:hidden;cursor:grab;-webkit-user-select:none;user-select:none;transition:transform .15s ease,box-shadow .15s ease}.tile[_ngcontent-%COMP%]:active{cursor:grabbing}.tile-portrait[_ngcontent-%COMP%]{width:100%;height:55px;object-fit:cover;opacity:.9}.tile-name[_ngcontent-%COMP%]{position:absolute;bottom:12px;left:0;right:0;background:#000000bf;color:#fff;text-align:center;padding:2px 4px;font-size:9px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.turn-number[_ngcontent-%COMP%]{position:absolute;bottom:0;left:0;right:0;background:#00000080;color:var(--text-muted);text-align:center;font-size:8px;padding:1px}.tile.scripted[_ngcontent-%COMP%]{border-top:3px solid var(--accent)}.tile.calculated[_ngcontent-%COMP%]{border-top:3px dashed rgba(255,255,255,.3);opacity:.85}.tile.team-blue[_ngcontent-%COMP%]{border-bottom:3px solid #3b82f6}.tile.team-red[_ngcontent-%COMP%]{border-bottom:3px solid #ef4444}.tile.team-green[_ngcontent-%COMP%]{border-bottom:3px solid #10b981}.tile.team-yellow[_ngcontent-%COMP%]{border-bottom:3px solid #eab308}.tile.team-purple[_ngcontent-%COMP%]{border-bottom:3px solid #a855f7}.tile.team-orange[_ngcontent-%COMP%]{border-bottom:3px solid #f97316}.timeline[_ngcontent-%COMP%]:not(.dragging)   .tile[_ngcontent-%COMP%]:hover{transform:scale(1.1) translateY(-4px);z-index:10;box-shadow:0 6px 16px #0000004d}.timeline.dragging[_ngcontent-%COMP%]   .tile[_ngcontent-%COMP%]{pointer-events:none}.tile.dragged[_ngcontent-%COMP%]{opacity:.4}.tile.animating[_ngcontent-%COMP%]{pointer-events:none}.drop-indicator[_ngcontent-%COMP%]{position:absolute;top:4px;bottom:4px;width:4px;background:var(--accent);border-radius:2px;z-index:20;box-shadow:0 0 8px var(--accent),0 0 16px var(--accent);pointer-events:none;animation:_ngcontent-%COMP%_pulse .8s ease-in-out infinite}.drop-indicator.before[_ngcontent-%COMP%]{left:-4px}.drop-indicator.after[_ngcontent-%COMP%]{right:-4px}@keyframes _ngcontent-%COMP%_pulse{0%,to{opacity:1}50%{opacity:.6}}.controls[_ngcontent-%COMP%]{display:flex;gap:.5rem;margin-top:.5rem}.next-turn-btn[_ngcontent-%COMP%]{flex:1;padding:.75rem 1rem;background:var(--accent);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:500;transition:opacity .2s,transform .1s}.next-turn-btn[_ngcontent-%COMP%]:hover:not(:disabled){opacity:.9}.next-turn-btn[_ngcontent-%COMP%]:active:not(:disabled){transform:scale(.98)}.next-turn-btn[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}@keyframes _ngcontent-%COMP%_slideInFromTop{0%{opacity:0;transform:translateY(-40px)}to{opacity:1;transform:translateY(0)}}@keyframes _ngcontent-%COMP%_slideOutToBottom{0%{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(40px)}}"]})};var pt=class{onChange=null;worldStore=null;isSaving=!1;isInitialized=!1;allCharacters=new Map;participants=new Map;tiles=[];scriptedCount=0;TIMELINE_LENGTH=12;TEAMS=["blue","red","green","yellow","purple","orange"];setChangeCallback(e){this.onChange=e}setWorldStore(e){this.worldStore=e}setAvailableCharacters(e){this.allCharacters.clear();for(let t of e)this.allCharacters.set(t.id,{id:t.id,name:t.name,portrait:t.portrait,speed:t.speed??10});for(let[t,i]of this.participants){let n=this.allCharacters.get(t);n&&(i.name=n.name,i.portrait=n.portrait,i.speed=n.speed)}for(let t of this.tiles){let i=this.allCharacters.get(t.characterId);i&&(t.name=i.name,t.portrait=i.portrait,t.speed=i.speed)}this.notifyChange()}loadFromWorldStore(){if(this.isInitialized||this.isSaving||!this.worldStore)return;let e=this.worldStore.worldValue;if(!e)return;this.isInitialized=!0;let t=e.battleParticipants||[];if(t.length===0){this.participants.clear(),this.tiles=[],this.scriptedCount=0,this.notifyChange();return}let i=t[0];this.scriptedCount=i.turnFrequency>=1e4?i.turnFrequency-1e4:0,this.participants.clear();for(let r of t){let a=this.allCharacters.get(r.characterId);this.participants.set(r.characterId,{characterId:r.characterId,name:a?.name||r.name,portrait:a?.portrait,speed:a?.speed||r.speed,team:r.team||"blue",currentTurn:r.currentTurn||1})}let n=[...t].sort((r,a)=>r.nextTurnAt-a.nextTurnAt);this.tiles=[];for(let r of n){let a=this.participants.get(r.characterId);a&&(this.tiles.push(this.createTile(a,1,this.tiles.length)),a.currentTurn=2)}this.fillCalculatedTiles(),this.scriptedCount=Math.min(this.scriptedCount,this.tiles.length),this.notifyChange()}saveToWorldStore(){if(!this.worldStore)return;this.isSaving=!0;let e=[],t=new Set;for(let i of this.tiles){if(t.has(i.characterId))continue;t.add(i.characterId);let n=this.participants.get(i.characterId);if(!n)continue;let r=e.length;e.push({characterId:n.characterId,name:n.name,team:n.team,speed:n.speed,currentTurn:n.currentTurn,turnFrequency:r===0?1e4+this.scriptedCount:n.speed,nextTurnAt:r})}this.worldStore.applyPatch({path:"battleParticipants",value:e}),setTimeout(()=>{this.isSaving=!1},100)}calculateTiming(e,t){return e*1e3/Math.max(t,1)}createTile(e,t,i){return{id:`${e.characterId}_t${t}`,characterId:e.characterId,name:e.name,portrait:e.portrait,team:e.team,speed:e.speed,turnNumber:t,timing:this.calculateTiming(t,e.speed)}}fillCalculatedTiles(){if(this.participants.size===0)return;this.tiles.length>this.TIMELINE_LENGTH&&(this.tiles=this.tiles.slice(0,this.TIMELINE_LENGTH));let e=new Map;for(let s of this.tiles)e.has(s.characterId)||e.set(s.characterId,new Set),e.get(s.characterId).add(s.turnNumber);let t=new Map;for(let[s,p]of this.participants){let g=p.currentTurn,h=e.get(s)||new Set;for(;h.has(g);)g++;t.set(s,g)}let i=this.TIMELINE_LENGTH*2,n=0;for(;this.tiles.length<this.TIMELINE_LENGTH&&n<i;){n++;let s=null;for(let[g,h]of this.participants){let w=t.get(g)||1,M=this.calculateTiming(w,h.speed);(!s||M<s.timing)&&(s={characterId:g,turn:w,timing:M})}if(!s)break;let p=this.participants.get(s.characterId);this.tiles.push(this.createTile(p,s.turn,this.tiles.length)),t.set(s.characterId,s.turn+1)}let r=this.tiles.slice(0,this.scriptedCount),a=this.tiles.slice(this.scriptedCount);a.sort((s,p)=>s.timing-p.timing),this.tiles=[...r,...a]}rebuildTimeline(){this.tiles=[],this.scriptedCount=0;for(let e of this.participants.values())e.currentTurn=1;this.fillCalculatedTiles()}getTimeline(){if(this.tiles.length===0)return[];let e=[],t=[],i=null,n=new Set,r=0;for(let a of this.tiles){let s=r<this.scriptedCount,p=i===null||a.team!==i||n.has(a.characterId);if(p&&t.length>0){let g=r-t.length;e.push({id:`group_${e.length}`,tiles:t,team:i,isScripted:g<this.scriptedCount}),t=[],n.clear()}p&&(i=a.team),t.push($(P({},a),{isScripted:s})),n.add(a.characterId),r++}if(t.length>0){let a=this.tiles.length-t.length;e.push({id:`group_${e.length}`,tiles:t,team:i,isScripted:a<this.scriptedCount})}return e}getCharacters(){let e=[];for(let[t,i]of this.allCharacters){let n=this.participants.get(t);e.push({id:t,name:i.name,portrait:i.portrait,speed:i.speed,team:n?.team||"blue",isInBattle:!!n})}return e}getCurrentTurnDisplay(){let e=this.getTimeline();return e.length===0?null:e[0].tiles.map(i=>i.name).join(" & ")}hasTiles(){return this.tiles.length>0}addCharacter(e){let t=this.allCharacters.get(e);!t||this.participants.has(e)||(this.participants.set(e,{characterId:e,name:t.name,portrait:t.portrait,speed:t.speed,team:"blue",currentTurn:1}),this.rebuildTimeline(),this.notifyChange(),this.saveToWorldStore())}removeCharacter(e){this.participants.delete(e);let t=this.tiles;this.tiles=this.tiles.filter(r=>r.characterId!==e);let i=t.length-this.tiles.length,n=t.slice(0,this.scriptedCount).filter(r=>r.characterId===e).length;this.scriptedCount=Math.max(0,this.scriptedCount-n),this.fillCalculatedTiles(),this.notifyChange(),this.saveToWorldStore()}setTeam(e,t){let i=this.participants.get(e);if(i){i.team=t;for(let n of this.tiles)n.characterId===e&&(n.team=t);this.notifyChange(),this.saveToWorldStore()}}nextTurn(){if(this.tiles.length===0)return;let e=this.getTimeline();if(e.length===0)return;let t=e[0],i=t.tiles.length;for(let n of t.tiles){let r=this.participants.get(n.characterId);r&&(r.currentTurn=n.turnNumber+1)}this.tiles=this.tiles.slice(i),this.scriptedCount=Math.max(0,this.scriptedCount-i),this.tiles.length>this.TIMELINE_LENGTH&&(this.tiles=this.tiles.slice(0,this.TIMELINE_LENGTH)),this.fillCalculatedTiles(),this.notifyChange(),this.saveToWorldStore()}resetBattle(){this.participants.clear(),this.tiles=[],this.scriptedCount=0,this.isInitialized=!1,this.notifyChange(),this.saveToWorldStore()}dropTile(e,t,i){let n=this.tiles.findIndex(h=>h.id===e);if(n===-1)return;let r=this.tiles[n],a=this.getTimeline(),s=0;for(let h=0;h<t;h++)s+=a[h]?.tiles.length||0;if(i==="after"&&(s+=a[t]?.tiles.length||0),s<=n)return;let p=[...this.tiles];p.splice(n,1);let g=s-1;p.splice(g,0,r),this.tiles=p,this.scriptedCount=g+1,this.notifyChange(),this.saveToWorldStore()}notifyChange(){this.onChange&&this.onChange()}};export{ct as a,dt as b,pt as c};
