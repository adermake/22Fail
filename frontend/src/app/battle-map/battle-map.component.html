<div class="toolbar">
    <button (click)="toggleGmMode()" [class.active]="isGmMode">GM Mode</button>
    <ng-container *ngIf="isGmMode">
        <button (click)="toggleDrawingMode()" [class.active]="isDrawingMode">Draw</button>
        <button (click)="toggleDragMode()" [class.active]="isDragMode">Drag</button>
        <button (click)="toggleMeasureMode()" [class.active]="isMeasuring">Measure</button>
    </ng-container>
</div>

<div cdkDropListGroup>
    <div class="battle-map-container">
        <svg 
            class="battle-map-svg"
            [attr.viewBox]="viewBox"
            (wheel)="onWheel($event)"
            (mousedown)="onMouseDown($event)"
            (mousemove)="onMouseMove($event)"
            (mouseup)="onMouseUp()"
            cdkDropList id="grid-drop-list" (cdkDropListDropped)="onDrop($event)"
        >
            <defs>
                <clipPath *ngFor="let token of (store.battleMap$ | async)?.tokens" [attr.id]="'clip-' + token.characterId">
                    <polygon [attr.points]="getHexClipPoints(token)"></polygon>
                </clipPath>
            </defs>
            <g class="grid">
                <polygon *ngFor="let hex of hexagons" [attr.points]="hex.points" class="hexagon" [attr.data-hex-id]="hex.id"></polygon>
            </g>
            <g class="tokens">
                <image *ngFor="let token of (store.battleMap$ | async)?.tokens"
                    [attr.x]="hexToPixel(token.position).x - layout.size.x"
                    [attr.y]="hexToPixel(token.position).y - layout.size.y"
                    [attr.href]="token.image || 'assets/default-token.png'"
                    [attr.width]="layout.size.x * 2"
                    [attr.height]="layout.size.y * 2"
                    [attr.clip-path]="'url(#clip-' + token.characterId + ')'"
                    cdkDrag
                    [cdkDragData]="token"
                />
            </g>
            <g class="drawings">
                <path *ngFor="let drawing of (store.battleMap$ | async)?.drawings" 
                      [attr.d]="drawing.path" 
                      [attr.stroke]="drawing.color" 
                      [attr.stroke-width]="drawing.lineWidth"
                      fill="none"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                ></path>
                <path
                    *ngIf="isDrawing"
                    [attr.d]="currentDrawingPath"
                    stroke="#FF0000"
                    stroke-width="5"
                    fill="none"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                ></path>
                
                <line *ngIf="isMeasuring && measurementStart"
                    [attr.x1]="measurementStart.x"
                    [attr.y1]="measurementStart.y"
                    [attr.x2]="measurementEnd.x"
                    [attr.y2]="measurementEnd.y"
                    stroke="cyan"
                    stroke-width="3"
                    stroke-dasharray="10,5"
                ></line>
                <text *ngIf="isMeasuring && measurementStart"
                    [attr.x]="measurementEnd.x + 10"
                    [attr.y]="measurementEnd.y + 10"
                    fill="cyan"
                    font-size="24"
                >{{ measurementDistance }}</text>
            </g>
        </svg>
    </div>

    <div class="token-panel" cdkDropList id="token-list-drop-list" [cdkDropListData]="worldCharacters" *ngIf="isGmMode">
        <h3>{{ currentWorldName || 'No world selected' }}</h3>
        <ul>
            <li *ngFor="let char of worldCharacters" cdkDrag [cdkDragData]="char">
                <img [src]="char.portrait || 'assets/default-token.png'" width="30" height="30">
                {{ char.name }}
            </li>
        </ul>
    </div>
</div>
