<div 
  #container 
  class="grid-container"
  [class.tool-cursor]="currentTool === 'cursor'"
  [class.tool-draw]="currentTool === 'draw'"
  [class.tool-erase]="currentTool === 'erase'"
  [class.tool-walls]="currentTool === 'walls'"
  [class.tool-measure]="currentTool === 'measure'"
  [class.tool-ai-draw]="currentTool === 'ai-draw'"
  [class.external-drag-active]="isExternalDragActive"
  (pointerdown)="onPointerDown($event)"
  (pointermove)="onPointerMove($event)"
  (pointerup)="onPointerUp($event)"
  (pointerleave)="onPointerLeave($event)"
  (pointercancel)="onPointerLeave($event)"
  (wheel)="onWheel($event)"
  (contextmenu)="onContextMenu($event)"
  (dragenter)="onDragEnter($event)"
  (dragover)="onDragOver($event)"
  (dragleave)="onDragLeave($event)"
  (drop)="onDrop($event)"
>
  <!-- Grid canvas (hexagons) -->
  <canvas #gridCanvas class="grid-canvas"></canvas>
  
  <!-- Drawing canvas (strokes) -->
  <canvas #drawCanvas class="draw-canvas"></canvas>

  <!-- AI Layer canvas (ComfyUI generated images) -->
  <canvas #aiCanvas class="ai-canvas" [class.visible]="aiLayerVisible"></canvas>

  <!-- Tokens layer - uses world coordinates with CSS transform -->
  <div class="tokens-layer" [style.transform]="'translate(' + panX + 'px, ' + panY + 'px) scale(' + scale + ')'">
    @if (battleMap) {
      @for (token of battleMap.tokens; track token.id) {
        <app-battlemap-token
          [token]="token"
          [isCurrentTurn]="isTokenCurrentTurn(token)"
          [position]="getTokenScreenPosition(token)"
          [scale]="scale"
          [currentTool]="currentTool"
          [syncedTeam]="getSyncedTeam(token)"
          (dragStart)="onTokenDragStart(token, $event.event)"
          (dragEnd)="onTokenDragEnd($event.event, token.id)"
          (remove)="tokenRemove.emit(token.id)"
        />
      }
    }
  </div>

  <!-- Overlay canvas (ruler, movement path) - on top of tokens -->
  <canvas #overlayCanvas class="overlay-canvas"></canvas>

  <!-- Drag ghost - follows mouse exactly during token drag -->
  @if (draggingToken && dragGhostPosition()) {
    <div 
      class="drag-ghost"
      [style.left.px]="dragGhostPosition()!.x"
      [style.top.px]="dragGhostPosition()!.y"
      [style.width.px]="ghostWidth"
      [style.height.px]="ghostHeight"
      [style.--team-color]="getTeamColor(draggingToken.team)"
    >
      <div class="ghost-hexagon">
        @if (draggingToken.portrait) {
          <img [src]="draggingToken.portrait" [alt]="draggingToken.characterName" class="ghost-portrait" draggable="false" />
        } @else {
          <div class="ghost-initials">{{ getInitials(draggingToken.characterName) }}</div>
        }
      </div>
    </div>
  }

  <!-- Context menu for creating quick tokens -->
  @if (showContextMenu()) {
    <div 
      class="grid-context-menu"
      [style.left.px]="contextMenuPosition().x"
      [style.top.px]="contextMenuPosition().y"
      (click)="$event.stopPropagation()"
    >
      <button class="context-menu-item" (click)="onCreateQuickToken()">
        <span>âž•</span> Create Token
      </button>
    </div>
  }

  <!-- Brush resize preview (shown when shift+dragging) -->
  @if (brushResizePreview()) {
    <div 
      class="brush-resize-preview"
      [style.left.px]="brushResizePreview()!.x"
      [style.top.px]="brushResizePreview()!.y"
      [style.width.px]="brushResizePreview()!.size"
      [style.height.px]="brushResizePreview()!.size"
    >
      <span class="brush-size-label">{{ brushResizePreview()!.size | number:'1.0-0' }}</span>
    </div>
  }
</div>
