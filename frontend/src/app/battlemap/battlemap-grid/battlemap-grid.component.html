<div 
  #container 
  class="grid-container"
  [class.tool-cursor]="currentTool === 'cursor'"
  [class.tool-draw]="currentTool === 'draw'"
  [class.tool-erase]="currentTool === 'erase'"
  [class.tool-measure]="currentTool === 'measure'"
  [class.external-drag-active]="isExternalDragActive"
  (mousedown)="onMouseDown($event)"
  (mousemove)="onMouseMove($event)"
  (mouseup)="onMouseUp($event)"
  (mouseleave)="onMouseLeave()"
  (wheel)="onWheel($event)"
  (dragenter)="onDragEnter($event)"
  (dragover)="onDragOver($event)"
  (dragleave)="onDragLeave($event)"
  (drop)="onDrop($event)"
>
  <!-- Grid canvas (hexagons, measurement) -->
  <canvas #gridCanvas class="grid-canvas"></canvas>
  
  <!-- Drawing canvas (strokes) -->
  <canvas #drawCanvas class="draw-canvas"></canvas>

  <!-- Tokens layer - uses world coordinates with CSS transform -->
  <div class="tokens-layer" [style.transform]="'translate(' + panX + 'px, ' + panY + 'px) scale(' + scale + ')'">
    @if (battleMap) {
      @for (token of battleMap.tokens; track token.id) {
        <app-battlemap-token
          [token]="token"
          [isCurrentTurn]="isTokenCurrentTurn(token)"
          [position]="getTokenScreenPosition(token)"
          [scale]="scale"
          [currentTool]="currentTool"
          (dragStart)="onTokenDragStart(token, $event.event)"
          (dragEnd)="onTokenDragEnd($event.event, token.id)"
          (remove)="tokenRemove.emit(token.id)"
        />
      }
    }
  </div>

  <!-- Drag ghost - follows mouse exactly during token drag -->
  @if (draggingToken && dragGhostPosition()) {
    <div 
      class="drag-ghost"
      [style.left.px]="dragGhostPosition()!.x"
      [style.top.px]="dragGhostPosition()!.y"
      [style.width.px]="ghostSize"
      [style.height.px]="ghostSize"
      [style.--team-color]="getTeamColor(draggingToken.team)"
    >
      <div class="ghost-hexagon">
        @if (draggingToken.portrait) {
          <img [src]="draggingToken.portrait" [alt]="draggingToken.characterName" class="ghost-portrait" draggable="false" />
        } @else {
          <div class="ghost-initials">{{ getInitials(draggingToken.characterName) }}</div>
        }
      </div>
    </div>
  }

  <!-- Measurement display -->
  @if (measureDistance() > 0) {
    <div class="measure-info">
      <span class="measure-icon">ğŸ“</span>
      <span class="measure-value">{{ measureDistance().toFixed(1) }} m</span>
    </div>
  }
</div>
