<div class="toolbar">
  <!-- Left: Panel toggles -->
  <div class="toolbar-section">
    <button 
      class="toolbar-btn"
      title="Toggle Character List"
      (click)="toggleCharacterList.emit()"
    >
      <span class="btn-icon">üë•</span>
    </button>
    <button 
      class="toolbar-btn"
      title="Quick Token"
      (click)="openQuickTokenModal()"
    >
      <span class="btn-icon">‚ûï</span>
    </button>
  </div>

  <!-- Center: Tools -->
  <div class="toolbar-section tools">
    @for (tool of tools; track tool.id) {
      <button 
        class="toolbar-btn"
        [class.active]="currentTool === tool.id"
        [title]="tool.label"
        (click)="selectTool(tool.id)"
      >
        <span class="btn-icon">{{ tool.icon }}</span>
      </button>
    }
  </div>

  <!-- Draw tool settings -->
  @if (currentTool === 'draw') {
    <div class="toolbar-section brush-settings">
      <!-- Draw with walls toggle -->
      <label class="wall-mode-toggle" title="Also place walls while drawing">
        <input 
          type="checkbox" 
          [checked]="drawWithWalls"
          (change)="toggleDrawWithWalls()"
        />
        <span class="toggle-label">+üß±</span>
      </label>

      <!-- Color picker -->
      <div class="color-picker">
        @for (color of presetColors; track color) {
          <button 
            class="color-swatch"
            [class.active]="brushColor === color"
            [style.background]="color"
            [style.border-color]="color === '#ffffff' ? '#666' : color"
            (click)="selectColor(color)"
          ></button>
        }
        <label class="custom-color">
          <input 
            type="color" 
            [value]="brushColor"
            (input)="onColorInput($event)"
          />
          <span class="custom-color-preview" [style.background]="brushColor"></span>
        </label>
      </div>

      <!-- Pen brush size -->
      <div class="size-picker">
        <span class="size-label">Size:</span>
        @for (size of penBrushSizes; track size) {
          <button 
            class="size-btn"
            [class.active]="penBrushSize === size"
            [title]="size + 'px'"
            (click)="selectPenSize(size)"
          >
            <span class="size-dot" [style.width.px]="size" [style.height.px]="size"></span>
          </button>
        }
      </div>
    </div>
  }

  <!-- Erase tool settings -->
  @if (currentTool === 'erase') {
    <div class="toolbar-section brush-settings">
      <!-- Erase walls toggle -->
      <label class="wall-mode-toggle" title="Also remove walls while erasing">
        <input 
          type="checkbox" 
          [checked]="drawWithWalls"
          (change)="toggleDrawWithWalls()"
        />
        <span class="toggle-label">-üß±</span>
      </label>

      <div class="size-picker">
        <span class="size-label">Size:</span>
        @for (size of eraserBrushSizes; track size) {
          <button 
            class="size-btn"
            [class.active]="eraserBrushSize === size"
            [title]="size + 'px'"
            (click)="selectEraserSize(size)"
          >
            <span class="size-dot" [style.width.px]="clampSize(size)" [style.height.px]="clampSize(size)"></span>
          </button>
        }
      </div>
    </div>
  }
  
  <!-- Walls tool settings -->
  @if (currentTool === 'walls') {
    <div class="toolbar-section brush-settings">
      <button 
        class="action-btn danger"
        title="Clear all walls"
        (click)="clearWalls.emit()"
      >
        üóëÔ∏è Clear Walls
      </button>
    </div>
  }

  <!-- Cursor tool settings (drag mode) -->
  @if (currentTool === 'cursor') {
    <div class="toolbar-section drag-mode-settings">
      <span class="mode-label">Mode:</span>
      <button 
        class="mode-btn"
        [class.active]="dragMode === 'free'"
        title="Free movement - no restrictions"
        (click)="setDragMode('free')"
      >
        Free
      </button>
      <button 
        class="mode-btn"
        [class.active]="dragMode === 'enforced'"
        title="Enforced - respects movement speed and walls"
        (click)="setDragMode('enforced')"
      >
        Enforced
      </button>
    </div>
  }

  <!-- AI Draw tool settings -->
  @if (currentTool === 'ai-draw') {
    <div class="toolbar-section ai-draw-settings">
      <!-- AI Color palette -->
      <div class="ai-color-picker">
        @for (colorPrompt of aiColorPrompts; track colorPrompt.id) {
          <button 
            class="ai-color-swatch"
            [class.active]="selectedAiColor === colorPrompt.color"
            [style.background]="colorPrompt.color"
            [title]="colorPrompt.name + ': ' + colorPrompt.prompt"
            (click)="selectAiColor(colorPrompt.color)"
          >
            <span class="ai-color-label">{{ colorPrompt.name }}</span>
          </button>
        }
      </div>
      
      <!-- Edit color prompts button -->
      <button 
        class="action-btn"
        title="Edit color-to-prompt mappings"
        (click)="openAiColorPromptsModal()"
      >
        ‚öôÔ∏è Edit Colors
      </button>

      <!-- Generate from AI strokes -->
      <button 
        class="action-btn generate"
        [class.disabled]="comfyUIGenerating || !comfyUIAvailable"
        [disabled]="comfyUIGenerating || !comfyUIAvailable"
        title="Generate map from AI colored regions (builds incrementally)"
        (click)="generateFromAiStrokes.emit()"
      >
        @if (comfyUIGenerating) {
          ‚è≥ Generating...
        } @else {
          ü™Ñ Generate Map
        }
      </button>

      <!-- Clear AI strokes (keeps generated image) -->
      <button 
        class="action-btn"
        title="Clear AI strokes (keeps generated image for incremental building)"
        (click)="clearAiStrokes.emit()"
      >
        üóëÔ∏è Clear Strokes
      </button>
      
      <!-- Start fresh (clear everything) -->
      <button 
        class="action-btn danger"
        title="Clear everything and start fresh"
        (click)="startFreshAi.emit()"
      >
        üÜï Start Fresh
      </button>
    </div>
  }

  <!-- Right: Panel toggles -->
  <div class="toolbar-section">
    <!-- Layer visibility toggles -->
    <div class="layer-toggles">
      <button 
        class="layer-toggle-btn"
        [class.active]="drawLayerVisible"
        title="Toggle Drawing Layer visibility"
        (click)="drawLayerVisibleChange.emit(!drawLayerVisible)"
      >
        <span class="btn-icon">‚úèÔ∏è</span>
      </button>
      <button 
        class="layer-toggle-btn"
        [class.active]="aiLayerVisible"
        title="Toggle AI Layer visibility"
        (click)="aiLayerVisibleChange.emit(!aiLayerVisible)"
      >
        <span class="btn-icon">üé®</span>
      </button>
    </div>

    <!-- AI Settings Button (only visible when AI is available) -->
    @if (comfyUIAvailable) {
      <button 
        class="toolbar-btn"
        title="AI Settings & Prompt"
        (click)="openAiSettingsModal()"
      >
        <span class="btn-icon">‚öôÔ∏è</span>
      </button>
    }

    <button 
      class="toolbar-btn"
      title="Toggle Battle Tracker"
      (click)="toggleBattleTracker.emit()"
    >
      <span class="btn-icon">‚öîÔ∏è</span>
    </button>
  </div>
</div>

<!-- AI Settings Modal -->
@if (showAiSettingsModal()) {
  <div class="modal-overlay" (click)="closeAiSettingsModal()">
    <div class="modal-content modal-wide" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>ü§ñ AI Generation Settings</h3>
        <button class="modal-close" (click)="closeAiSettingsModal()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label>Base Prompt:</label>
          <textarea 
            rows="3"
            [value]="editingAiPrompt()"
            (input)="editingAiPrompt.set($any($event.target).value)"
            placeholder="e.g., A detailed fantasy dungeon map, dark stone walls, torches on the walls..."
          ></textarea>
          <p class="form-hint">Base description for your map. Leave empty for default D&D style.</p>
        </div>

        <div class="form-group">
          <label>General Region Prompt:</label>
          <input 
            type="text"
            [value]="editingGeneralRegionPrompt()"
            (input)="editingGeneralRegionPrompt.set($any($event.target).value)"
            placeholder="e.g., detailed, high quality, clear"
          />
          <p class="form-hint">Added to every region (quality tags, style modifiers).</p>
        </div>

        <div class="form-group">
          <label>Negative Prompt:</label>
          <input 
            type="text"
            [value]="editingNegativePrompt()"
            (input)="editingNegativePrompt.set($any($event.target).value)"
            placeholder="e.g., blurry, low quality, distorted, text, watermark"
          />
          <p class="form-hint">What to avoid in generation.</p>
        </div>

        <div class="form-group">
          <label>Grid Scale (feet per square):</label>
          <input 
            type="number"
            min="1"
            [value]="editingGridScale()"
            (input)="editingGridScale.set(+$any($event.target).value)"
            placeholder="5"
          />
          <p class="form-hint">Standard D&D: 5 feet. Helps AI understand building sizes.</p>
        </div>

        <div class="settings-grid">
          <div class="form-group">
            <label>Seed:</label>
            <div class="input-with-button">
              <input 
                type="number" 
                [value]="editingSeed()"
                (input)="editingSeed.set(+$any($event.target).value)"
                placeholder="-1 for random"
              />
              <button class="btn-small" (click)="randomizeSeed()" title="Random seed each time">üé≤</button>
            </div>
            <p class="form-hint">-1 = random each generation</p>
          </div>

          <div class="form-group">
            <label>Steps: {{ editingSteps() }}</label>
            <input 
              type="range" 
              min="15" max="50" step="1"
              [value]="editingSteps()"
              (input)="editingSteps.set(+$any($event.target).value)"
            />
            <p class="form-hint">20-30 recommended for FLUX</p>
          </div>

          <div class="form-group">
            <label>Sketch Strength: {{ editingDenoise() }}</label>
            <input 
              type="range" 
              min="0.3" max="1" step="0.05"
              [value]="editingDenoise()"
              (input)="editingDenoise.set(+$any($event.target).value)"
            />
            <p class="form-hint">How closely to follow your sketch lines</p>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeAiSettingsModal()">Cancel</button>
        <button class="btn-primary" (click)="saveAiSettings()">Save Settings</button>
      </div>
    </div>
  </div>
}

<!-- AI Color Prompts Modal -->
@if (showAiColorPromptsModal()) {
  <div class="modal-overlay" (click)="closeAiColorPromptsModal()">
    <div class="modal-content modal-wide" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Edit AI Color Prompts</h3>
        <button class="modal-close" (click)="closeAiColorPromptsModal()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <p class="modal-description">Configure which colors map to which AI prompts. When you paint a color, the AI will generate that element in that region.</p>
        
        <div class="color-prompts-list">
          @for (colorPrompt of editingColorPrompts(); track colorPrompt.id) {
            <div class="color-prompt-row">
              <div class="color-preview" [style.background]="colorPrompt.color"></div>
              
              <div class="color-input">
                <label>Color</label>
                <input 
                  type="color" 
                  [value]="colorPrompt.color"
                  (input)="updateEditingColorPrompt(colorPrompt.id, 'color', $any($event.target).value)"
                />
              </div>
              
              <div class="name-input">
                <label>Name</label>
                <input 
                  type="text" 
                  [value]="colorPrompt.name"
                  (input)="updateEditingColorPrompt(colorPrompt.id, 'name', $any($event.target).value)"
                  placeholder="e.g., Forest"
                />
              </div>
              
              <div class="prompt-input">
                <label>Prompt</label>
                <input 
                  type="text" 
                  [value]="colorPrompt.prompt"
                  (input)="updateEditingColorPrompt(colorPrompt.id, 'prompt', $any($event.target).value)"
                  placeholder="e.g., dense forest, tall trees"
                />
              </div>
              
              <button 
                class="btn-danger-small" 
                (click)="deleteEditingColorPrompt(colorPrompt.id)"
                title="Delete this color"
              >
                üóëÔ∏è
              </button>
            </div>
          }
        </div>
        
        <button class="btn-secondary" (click)="addNewColorPrompt()">‚ûï Add Color</button>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeAiColorPromptsModal()">Cancel</button>
        <button class="btn-primary" (click)="saveColorPrompts()">Save Changes</button>
      </div>
    </div>
  </div>
}

<!-- Quick Token Modal -->
@if (showQuickTokenModal()) {
  <div class="modal-overlay" (click)="closeQuickTokenModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Create Quick Token</h3>
        <button class="modal-close" (click)="closeQuickTokenModal()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label>Token Name</label>
          <input 
            type="text" 
            [value]="quickTokenName()"
            (input)="quickTokenName.set($any($event.target).value)"
            placeholder="e.g., Goblin, Dragon..."
          />
        </div>

        <div class="form-group">
          <label>Image URL (optional)</label>
          <input 
            type="text" 
            [value]="quickTokenImageUrl()"
            (input)="quickTokenImageUrl.set($any($event.target).value)"
            placeholder="https://example.com/image.png"
          />
          <p class="form-hint">Paste a direct link to a token image, or leave empty for initials only.</p>
        </div>

        @if (quickTokenImageUrl()) {
          <div class="selected-preview">
            <label>Preview:</label>
            <img [src]="getProxiedUrl(quickTokenImageUrl()!)" alt="Token preview" (error)="onImageError($event)" />
          </div>
        }
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeQuickTokenModal()">Cancel</button>
        <button class="btn-primary" (click)="createQuickToken()">Create Token</button>
      </div>
    </div>
  </div>
}
