<div class="toolbar">
  <!-- Left: Panel toggles -->
  <div class="toolbar-section">
    <button 
      class="toolbar-btn"
      title="Toggle Character List"
      (click)="toggleCharacterList.emit()"
    >
      <span class="btn-icon">üë•</span>
    </button>
    <button 
      class="toolbar-btn"
      title="Quick Token"
      (click)="openQuickTokenModal()"
    >
      <span class="btn-icon">‚ûï</span>
    </button>
  </div>

  <!-- Center: Tools -->
  <div class="toolbar-section tools">
    @for (tool of tools; track tool.id) {
      <button 
        class="toolbar-btn"
        [class.active]="currentTool === tool.id"
        [title]="tool.label"
        (click)="selectTool(tool.id)"
      >
        <span class="btn-icon">{{ tool.icon }}</span>
      </button>
    }
  </div>

  <!-- Draw tool settings -->
  @if (currentTool === 'draw') {
    <div class="toolbar-section brush-settings">
      <!-- Draw with walls toggle -->
      <label class="wall-mode-toggle" title="Also place walls while drawing">
        <input 
          type="checkbox" 
          [checked]="drawWithWalls"
          (change)="toggleDrawWithWalls()"
        />
        <span class="toggle-label">+üß±</span>
      </label>

      <!-- Color picker -->
      <div class="color-picker">
        @for (color of presetColors; track color) {
          <button 
            class="color-swatch"
            [class.active]="brushColor === color"
            [style.background]="color"
            [style.border-color]="color === '#ffffff' ? '#666' : color"
            (click)="selectColor(color)"
          ></button>
        }
        <label class="custom-color">
          <input 
            type="color" 
            [value]="brushColor"
            (input)="onColorInput($event)"
          />
          <span class="custom-color-preview" [style.background]="brushColor"></span>
        </label>
      </div>

      <!-- Pen brush size -->
      <div class="size-picker">
        <span class="size-label">Size:</span>
        @for (size of penBrushSizes; track size) {
          <button 
            class="size-btn"
            [class.active]="penBrushSize === size"
            [title]="size + 'px'"
            (click)="selectPenSize(size)"
          >
            <span class="size-dot" [style.width.px]="size" [style.height.px]="size"></span>
          </button>
        }
      </div>
    </div>
  }

  <!-- Erase tool settings -->
  @if (currentTool === 'erase') {
    <div class="toolbar-section brush-settings">
      <!-- Erase walls toggle -->
      <label class="wall-mode-toggle" title="Also remove walls while erasing">
        <input 
          type="checkbox" 
          [checked]="drawWithWalls"
          (change)="toggleDrawWithWalls()"
        />
        <span class="toggle-label">-üß±</span>
      </label>

      <div class="size-picker">
        <span class="size-label">Size:</span>
        @for (size of eraserBrushSizes; track size) {
          <button 
            class="size-btn"
            [class.active]="eraserBrushSize === size"
            [title]="size + 'px'"
            (click)="selectEraserSize(size)"
          >
            <span class="size-dot" [style.width.px]="clampSize(size)" [style.height.px]="clampSize(size)"></span>
          </button>
        }
      </div>
    </div>
  }
  
  <!-- Walls tool settings -->
  @if (currentTool === 'walls') {
    <div class="toolbar-section brush-settings">
      <button 
        class="action-btn danger"
        title="Clear all walls"
        (click)="clearWalls.emit()"
      >
        üóëÔ∏è Clear Walls
      </button>
    </div>
  }

  <!-- Cursor tool settings (drag mode) -->
  @if (currentTool === 'cursor') {
    <div class="toolbar-section drag-mode-settings">
      <span class="mode-label">Mode:</span>
      <button 
        class="mode-btn"
        [class.active]="dragMode === 'free'"
        title="Free movement - no restrictions"
        (click)="setDragMode('free')"
      >
        Free
      </button>
      <button 
        class="mode-btn"
        [class.active]="dragMode === 'enforced'"
        title="Enforced - respects movement speed and walls"
        (click)="setDragMode('enforced')"
      >
        Enforced
      </button>
    </div>
  }

  <!-- Right: Panel toggles -->
  <div class="toolbar-section">
    <!-- Layer visibility toggles -->
    <div class="layer-toggles">
      <button 
        class="layer-toggle-btn"
        [class.active]="drawLayerVisible"
        title="Toggle Drawing Layer visibility"
        (click)="drawLayerVisibleChange.emit(!drawLayerVisible)"
      >
        <span class="btn-icon">‚úèÔ∏è</span>
      </button>
      <button 
        class="layer-toggle-btn"
        [class.active]="aiLayerVisible"
        title="Toggle AI Layer visibility"
        (click)="aiLayerVisibleChange.emit(!aiLayerVisible)"
      >
        <span class="btn-icon">üé®</span>
      </button>
    </div>

    <!-- AI Settings Button (only visible when AI is available) -->
    @if (comfyUIAvailable) {
      <button 
        class="toolbar-btn"
        title="AI Settings & Prompt"
        (click)="openAiSettingsModal()"
      >
        <span class="btn-icon">‚öôÔ∏è</span>
      </button>
    }

    <!-- AI Layer Toggle -->
    <button 
      class="toolbar-btn ai-toggle"
      [class.active]="aiLayerEnabled"
      [class.available]="comfyUIAvailable"
      [class.generating]="comfyUIGenerating"
      [title]="comfyUIAvailable ? (aiLayerEnabled ? 'AI Generation ON (click to disable)' : 'AI Generation OFF (click to enable)') : 'ComfyUI not available (start ComfyUI with --enable-cors-header)'"
      [disabled]="!comfyUIAvailable"
      (click)="aiLayerToggle.emit()"
    >
      <span class="btn-icon">ü§ñ</span>
      @if (comfyUIGenerating) {
        <span class="generating-indicator"></span>
      }
    </button>

    <button 
      class="toolbar-btn"
      title="Toggle Battle Tracker"
      (click)="toggleBattleTracker.emit()"
    >
      <span class="btn-icon">‚öîÔ∏è</span>
    </button>
  </div>
</div>

<!-- AI Settings Modal -->
@if (showAiSettingsModal()) {
  <div class="modal-overlay" (click)="closeAiSettingsModal()">
    <div class="modal-content modal-wide" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>ü§ñ AI Generation Settings</h3>
        <button class="modal-close" (click)="closeAiSettingsModal()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label>Prompt:</label>
          <textarea 
            rows="4"
            [value]="editingAiPrompt()"
            (input)="editingAiPrompt.set($any($event.target).value)"
            placeholder="e.g., A detailed fantasy dungeon map, dark stone walls, torches on the walls..."
          ></textarea>
          <p class="form-hint">Leave empty for default D&D map style.</p>
        </div>

        <div class="settings-grid">
          <div class="form-group">
            <label>Seed:</label>
            <div class="input-with-button">
              <input 
                type="number" 
                [value]="editingSeed()"
                (input)="editingSeed.set(+$any($event.target).value)"
                placeholder="-1 for random"
              />
              <button class="btn-small" (click)="randomizeSeed()" title="Random seed each time">üé≤</button>
            </div>
            <p class="form-hint">-1 = random each generation</p>
          </div>

          <div class="form-group">
            <label>Steps: {{ editingSteps() }}</label>
            <input 
              type="range" 
              min="4" max="30" step="1"
              [value]="editingSteps()"
              (input)="editingSteps.set(+$any($event.target).value)"
            />
            <p class="form-hint">More steps = more detail, slower</p>
          </div>

          <div class="form-group">
            <label>CFG: {{ editingCfg() }}</label>
            <input 
              type="range" 
              min="1" max="10" step="0.1"
              [value]="editingCfg()"
              (input)="editingCfg.set(+$any($event.target).value)"
            />
            <p class="form-hint">How closely to follow prompt</p>
          </div>

          <div class="form-group">
            <label>Denoise: {{ editingDenoise() }}</label>
            <input 
              type="range" 
              min="0.1" max="1" step="0.05"
              [value]="editingDenoise()"
              (input)="editingDenoise.set(+$any($event.target).value)"
            />
            <p class="form-hint">Lower = more of your drawing preserved</p>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeAiSettingsModal()">Cancel</button>
        <button class="btn-primary" (click)="saveAiSettings()">Save Settings</button>
      </div>
    </div>
  </div>
}

<!-- Quick Token Modal -->
@if (showQuickTokenModal()) {
  <div class="modal-overlay" (click)="closeQuickTokenModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Create Quick Token</h3>
        <button class="modal-close" (click)="closeQuickTokenModal()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label>Token Name</label>
          <input 
            type="text" 
            [value]="quickTokenName()"
            (input)="quickTokenName.set($any($event.target).value)"
            placeholder="e.g., Goblin, Dragon..."
          />
        </div>

        <div class="form-group">
          <label>Image URL (optional)</label>
          <input 
            type="text" 
            [value]="quickTokenImageUrl()"
            (input)="quickTokenImageUrl.set($any($event.target).value)"
            placeholder="https://example.com/image.png"
          />
          <p class="form-hint">Paste a direct link to a token image, or leave empty for initials only.</p>
        </div>

        @if (quickTokenImageUrl()) {
          <div class="selected-preview">
            <label>Preview:</label>
            <img [src]="getProxiedUrl(quickTokenImageUrl()!)" alt="Token preview" (error)="onImageError($event)" />
          </div>
        }
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeQuickTokenModal()">Cancel</button>
        <button class="btn-primary" (click)="createQuickToken()">Create Token</button>
      </div>
    </div>
  </div>
}
