<div class="toolbar">
  <!-- Left: Panel toggles -->
  <div class="toolbar-section">
    <button 
      class="toolbar-btn"
      title="Toggle Character List"
      (click)="toggleCharacterList.emit()"
    >
      <span class="btn-icon">üë•</span>
    </button>
    <button 
      class="toolbar-btn"
      title="Quick Token"
      (click)="openQuickTokenModal()"
    >
      <span class="btn-icon">‚ûï</span>
    </button>
  </div>

  <!-- Center: Tools -->
  <div class="toolbar-section tools">
    @for (tool of tools; track tool.id) {
      <button 
        class="toolbar-btn"
        [class.active]="currentTool === tool.id"
        [title]="tool.label"
        (click)="selectTool(tool.id)"
      >
        <span class="btn-icon">{{ tool.icon }}</span>
      </button>
    }
  </div>

  <!-- Draw tool settings -->
  @if (currentTool === 'draw') {
    <div class="toolbar-section brush-settings">
      <!-- Draw with walls toggle -->
      <label class="wall-mode-toggle" title="Also place walls while drawing">
        <input 
          type="checkbox" 
          [checked]="drawWithWalls"
          (change)="toggleDrawWithWalls()"
        />
        <span class="toggle-label">+üß±</span>
      </label>

      <!-- Color picker -->
      <div class="color-picker">
        @for (color of presetColors; track color) {
          <button 
            class="color-swatch"
            [class.active]="brushColor === color"
            [style.background]="color"
            [style.border-color]="color === '#ffffff' ? '#666' : color"
            (click)="selectColor(color)"
          ></button>
        }
        <label class="custom-color">
          <input 
            type="color" 
            [value]="brushColor"
            (input)="onColorInput($event)"
          />
          <span class="custom-color-preview" [style.background]="brushColor"></span>
        </label>
      </div>

      <!-- Pen brush size -->
      <div class="size-picker">
        <span class="size-label">Size:</span>
        @for (size of penBrushSizes; track size) {
          <button 
            class="size-btn"
            [class.active]="penBrushSize === size"
            [title]="size + 'px'"
            (click)="selectPenSize(size)"
          >
            <span class="size-dot" [style.width.px]="size" [style.height.px]="size"></span>
          </button>
        }
      </div>
    </div>
  }

  <!-- Erase tool settings -->
  @if (currentTool === 'erase') {
    <div class="toolbar-section brush-settings">
      <!-- Erase walls toggle -->
      <label class="wall-mode-toggle" title="Also remove walls while erasing">
        <input 
          type="checkbox" 
          [checked]="drawWithWalls"
          (change)="toggleDrawWithWalls()"
        />
        <span class="toggle-label">-üß±</span>
      </label>

      <div class="size-picker">
        <span class="size-label">Size:</span>
        @for (size of eraserBrushSizes; track size) {
          <button 
            class="size-btn"
            [class.active]="eraserBrushSize === size"
            [title]="size + 'px'"
            (click)="selectEraserSize(size)"
          >
            <span class="size-dot" [style.width.px]="clampSize(size)" [style.height.px]="clampSize(size)"></span>
          </button>
        }
      </div>
    </div>
  }
  
  <!-- Walls tool settings -->
  @if (currentTool === 'walls') {
    <div class="toolbar-section brush-settings">
      <button 
        class="action-btn danger"
        title="Clear all walls"
        (click)="clearWalls.emit()"
      >
        üóëÔ∏è Clear Walls
      </button>
    </div>
  }

  <!-- Image tool settings -->
  @if (currentTool === 'image') {
    <div class="toolbar-section brush-settings">
      <span class="mode-label">Paste image or click map to add</span>
      <button 
        class="action-btn"
        title="Delete selected image"
        (click)="deleteSelectedImage.emit()"
      >
        üóëÔ∏è Delete Selected
      </button>
    </div>
  }

  <!-- Cursor tool settings (drag mode) -->
  @if (currentTool === 'cursor') {
    <div class="toolbar-section drag-mode-settings">
      <span class="mode-label">Mode:</span>
      <button 
        class="mode-btn"
        [class.active]="dragMode === 'free'"
        title="Free movement - no restrictions"
        (click)="setDragMode('free')"
      >
        Free
      </button>
      <button 
        class="mode-btn"
        [class.active]="dragMode === 'enforced'"
        title="Enforced - respects movement speed and walls"
        (click)="setDragMode('enforced')"
      >
        Enforced
      </button>
    </div>
  }

  <!-- Right: Panel toggles -->
  <div class="toolbar-section">
    <!-- Layer visibility toggles -->
    <div class="layer-toggles">
      <button 
        class="layer-toggle-btn"
        [class.active]="drawLayerVisible"
        title="Toggle Drawing Layer visibility"
        (click)="drawLayerVisibleChange.emit(!drawLayerVisible)"
      >
        <span class="btn-icon">‚úèÔ∏è</span>
      </button>
    </div>

    <button 
      class="toolbar-btn"
      title="Toggle Battle Tracker"
      (click)="toggleBattleTracker.emit()"
    >
      <span class="btn-icon">‚öîÔ∏è</span>
    </button>
  </div>
</div>

<!-- Quick Token Modal -->
@if (showQuickTokenModal()) {
  <div class="modal-overlay" (click)="closeQuickTokenModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Create Quick Token</h3>
        <button class="modal-close" (click)="closeQuickTokenModal()">‚úï</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label>Token Name</label>
          <input 
            type="text" 
            [value]="quickTokenName()"
            (input)="quickTokenName.set($any($event.target).value)"
            placeholder="e.g., Goblin, Dragon..."
          />
        </div>

        <div class="form-group">
          <label>Image URL (optional)</label>
          <input 
            type="text" 
            [value]="quickTokenImageUrl()"
            (input)="quickTokenImageUrl.set($any($event.target).value)"
            placeholder="https://example.com/image.png"
          />
          <p class="form-hint">Paste a direct link to a token image, or leave empty for initials only.</p>
        </div>

        @if (quickTokenImageUrl()) {
          <div class="selected-preview">
            <label>Preview:</label>
            <img [src]="getProxiedUrl(quickTokenImageUrl()!)" alt="Token preview" (error)="onImageError($event)" />
          </div>
        }
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeQuickTokenModal()">Cancel</button>
        <button class="btn-primary" (click)="createQuickToken()">Create Token</button>
      </div>
    </div>
  </div>
}
