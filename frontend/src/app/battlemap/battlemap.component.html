<div class="battlemap-container">
  <!-- Top Toolbar -->
  <app-battlemap-toolbar
    [currentTool]="currentTool()"
    [brushColor]="brushColor()"
    [penBrushSize]="penBrushSize()"
    [eraserBrushSize]="eraserBrushSize()"
    [drawWithWalls]="drawWithWalls()"
    [dragMode]="dragMode()"
    [drawLayerVisible]="drawLayerVisible()"
    (toolChange)="onToolChange($event)"
    (brushColorChange)="onBrushColorChange($event)"
    (penBrushSizeChange)="onPenBrushSizeChange($event)"
    (eraserBrushSizeChange)="onEraserBrushSizeChange($event)"
    (drawWithWallsChange)="onDrawWithWallsChange($event)"
    (dragModeChange)="onDragModeChange($event)"
    (drawLayerVisibleChange)="onDrawLayerVisibleChange($event)"
    (toggleCharacterList)="toggleCharacterList()"
    (toggleBattleTracker)="toggleBattleTracker()"
    (clearWalls)="onClearWalls()"
    (quickTokenCreate)="onQuickTokenDrop($event)"
    (deleteSelectedImage)="onDeleteSelectedImage()"
  />

  <!-- GM Controls (only visible if isGM) -->
  @if (isGM()) {
    <div class="gm-controls">
      <button (click)="onShowMapManager()">Manage Lobby</button>
      <button (click)="onImageLayerVisibleChange(!imageLayerVisible())">
        {{ imageLayerVisible() ? 'Hide' : 'Show' }} Images
      </button>
      <span class="current-map-indicator">Current Map: {{ battleMap()?.name || 'Loading...' }}</span>
    </div>
  }

  <!-- Lobby Manager Modal -->
  @if (showMapManager()) {
    <div class="map-manager-overlay" (click)="onHideMapManager()">
      <div class="map-manager-modal" (click)="$event.stopPropagation()">
        <h2>Lobby Manager</h2>
        <div class="map-manager-controls">
          <input 
            type="text" 
            placeholder="Search maps..." 
            [value]="mapSearchQuery()"
            (input)="onMapSearchChange($any($event.target).value)"
          />
          <input 
            #newMapName
            type="text" 
            placeholder="New map name..."
          />
          <button (click)="onCreateMap(newMapName.value || 'New Map'); newMapName.value = ''">
            Create Map
          </button>
        </div>
        <div class="map-list">
          @for (map of getFilteredMaps(); track map.id) {
            <div class="map-item" [class.active]="map.id === currentMapId()">
              <span class="map-name">{{ map.name }}</span>
              <button (click)="onSwitchMap(map.id)">Load</button>
              @if (map.id !== currentMapId()) {
                <button (click)="onDeleteMap(map.id)" class="delete-btn">Delete</button>
              }
            </div>
          }
        </div>
        <button (click)="onHideMapManager()" class="close-btn">Close</button>
      </div>
    </div>
  }

  <div class="battlemap-main">
    <div class="battlemap-content">
      <!-- Left Panel: Character List -->
      @if (showCharacterList()) {
        <app-battlemap-character-list
          [characters]="worldCharacters()"
          [tokensOnMap]="battleMap()?.tokens || []"
        />
      }

      <!-- Main Grid Area -->
      <app-battlemap-grid
        [battleMap]="enrichedBattleMap()"
        [currentTool]="currentTool()"
        [brushColor]="brushColor()"
        [penBrushSize]="penBrushSize()"
        [eraserBrushSize]="eraserBrushSize()"
        [drawWithWalls]="drawWithWalls()"
        [dragMode]="dragMode()"
        [currentTurnCharacterId]="currentTurnCharacterId()"
        [battleParticipants]="battleParticipants()"
        [drawLayerVisible]="drawLayerVisible()"
        [imageLayerVisible]="imageLayerVisible()"
        [selectedImageId]="selectedImageId()"
        (tokenDrop)="onTokenDrop($event)"
        (tokenMove)="onTokenMove($event)"
        (tokenRemove)="onTokenRemove($event)"
        (quickTokenDrop)="onQuickTokenDrop($event)"
        (brushSizeChange)="onBrushSizeChange($event)"
        (imageAdd)="onAddImage($event)"
        (imageSelect)="onSelectImage($event)"
        (imageTransform)="onTransformImage($event.id, $event.transform)"
        (imageDelete)="onDeleteImage($event)"
      />
    </div>

    <!-- Bottom Panel: Battle Tracker -->
    @if (showBattleTracker()) {
      <app-battlemap-battle-tracker />
    }
  </div>
</div>
