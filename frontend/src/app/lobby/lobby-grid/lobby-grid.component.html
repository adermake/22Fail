<div 
  class="grid-container" 
  #container
  (mousedown)="onMouseDown($event)"
  (mousemove)="onMouseMove($event)"
  (mouseup)="onMouseUp($event)"
  (mouseleave)="onMouseLeave($event)"
  (wheel)="onWheel($event)"
  (contextmenu)="onContextMenu($event)"
  (dragover)="onDragOver($event)"
  (dragleave)="onDragLeave($event)"
  (drop)="onDrop($event)"
>
  <!-- Texture Palette Bar (top, below toolbar) - Only show when texture tool is active -->
  @if (currentTool === 'texture') {
    <div class="texture-palette-bar">
      @for (entry of texturePalette(); track $index) {
        <div 
          class="palette-slot"
          [class.filled]="entry !== null"
          (mousedown)="onPaletteSlotMouseDown($event)"
          (click)="onPaletteSlotClick($index)"
          (contextmenu)="onPaletteSlotRightClick($event, $index)"
          (drop)="onPaletteSlotDrop($event, $index)"
          (dragover)="onPaletteSlotDragOver($event)"
          [title]="entry ? entry.name : 'Empty slot (drag texture here)'"
        >
          @if (entry) {
            <img 
              [src]="entry.previewUrl || getTextureUrl(entry.textureId)" 
              alt="" 
              class="palette-preview"
            />
            <div class="palette-number">{{ $index + 1 }}</div>
          } @else {
            <div class="palette-empty">{{ $index + 1 }}</div>
          }
        </div>
      }
    </div>
  }

  <!-- Canvas layers (bottom to top: images ‚Üí textures ‚Üí foreground images ‚Üí grid ‚Üí overlays ‚Üí drawing) -->
  <canvas #imageCanvas class="canvas-layer image-layer"></canvas>
  <canvas #textureCanvas class="canvas-layer texture-layer"></canvas>
  <canvas #foregroundCanvas class="canvas-layer foreground-layer"></canvas>
  <canvas #gridCanvas class="canvas-layer grid-layer"></canvas>
  <canvas #overlayCanvas class="canvas-layer overlay-layer"></canvas>
  <canvas #drawCanvas class="canvas-layer draw-layer"></canvas>

  <!-- Token layer -->
  <div class="token-layer">
    @for (token of tokens; track token.id) {
      <app-lobby-token
        [token]="token"
        [position]="getTokenScreenPosition(token)"
        [scale]="scale"
        [isCurrentTurn]="false"
        [isInteractive]="currentTool === 'cursor'"
        [isDragging]="draggingToken?.id === token.id"
        (dragStart)="onTokenDragStart(token, $event)"
        (contextMenu)="onTokenContextMenu(token, $event)"
      />
    }
    
    <!-- Ghost token at start position -->
    @if (draggingToken && dragGhostPosition()) {
      <div 
        class="drag-ghost-token"
        [style.left.px]="worldToScreen(dragGhostPosition()!.x, dragGhostPosition()!.y).x"
        [style.top.px]="worldToScreen(dragGhostPosition()!.x, dragGhostPosition()!.y).y"
        [style.transform]="'scale(' + scale + ')'"
      >
        @if (draggingToken.portrait) {
          <img 
            class="token-portrait" 
            [src]="getGhostPortraitUrl()"
            alt=""
          />
        } @else {
          <div class="token-placeholder">
            {{ draggingToken.name.charAt(0).toUpperCase() }}
          </div>
        }
      </div>
    }

    <!-- Distance indicator when dragging -->
    @if (draggingToken && getDragDistance() > 0) {
      <div 
        class="drag-distance-label"
        [style.left.px]="getTokenScreenPosition(draggingToken).x"
        [style.top.px]="getTokenScreenPosition(draggingToken).y + 35"
        [class.exceeds-speed]="dragPathExceedsSpeed()"
      >
        {{ getDragDistance() }}
      </div>
    }
  </div>

  <!-- Texture preview (bottom right) -->
  @if (selectedTextureId && currentTool === 'texture') {
    <div class="texture-preview">
      <canvas #texturePreviewCanvas class="texture-preview-canvas"></canvas>
    </div>
  }

  <!-- Context menu for images and quick token -->
  @if (showContextMenu()) {
    <div 
      class="context-menu"
      [style.left.px]="contextMenuPosition().x"
      [style.top.px]="contextMenuPosition().y"
      (click)="$event.stopPropagation()"
    >
      @if (contextMenuImageId()) {
        <!-- Image context menu -->
        <button (click)="onToggleImageLayer()">{{ getImageLayerLabel() }}</button>
        <div class="menu-divider"></div>
        <button (click)="onMoveImageToFront()">Bring to Front</button>
        <button (click)="onMoveImageForward()">Bring Forward</button>
        <button (click)="onMoveImageBackward()">Send Backward</button>
        <button (click)="onMoveImageToBack()">Send to Back</button>
        <div class="menu-divider"></div>
        <button class="danger" (click)="onDeleteSelectedImage()">Delete Image</button>
      } @else if (contextMenuTokenId()) {
        <!-- Token context menu -->
        <button class="danger" (click)="onRemoveToken()">üóëÔ∏è Remove Token</button>
      } @else if (contextMenuHex()) {
        <!-- Quick token creation menu -->
        <button (click)="onCreateQuickToken()">‚ûï Create Quick Token</button>
      }
    </div>
  }
</div>
