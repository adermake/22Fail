<div class="lobby-container">
  <!-- Toolbar at the top -->
  <app-lobby-toolbar
    [currentTool]="currentTool()"
    [brushColor]="brushColor()"
    [penBrushSize]="penBrushSize()"
    [eraserBrushSize]="eraserBrushSize()"
    [textureBrushSize]="textureBrushSize()"
    [textureBrushStrength]="textureBrushStrength()"
    [textureScale]="textureScale()"
    [textureBrushType]="textureBrushType()"
    [textureColorBlend]="textureColorBlend()"
    [textureBlendColor]="textureBlendColor()"
    [textureHue]="textureHue()"
    [isEraserMode]="isEraserMode()"
    [drawWithWalls]="drawWithWalls()"
    [dragMode]="dragMode()"
    [drawLayerVisible]="drawLayerVisible()"
    [isGM]="isGM()"
    (toolChange)="onToolChange($event)"
    (brushColorChange)="onBrushColorChange($event)"
    (penBrushSizeChange)="onPenBrushSizeChange($event)"
    (eraserBrushSizeChange)="onEraserBrushSizeChange($event)"
    (textureBrushSizeChange)="onTextureBrushSizeChange($event)"
    (textureBrushStrengthChange)="onTextureBrushStrengthChange($event)"
    (textureScaleChange)="onTextureScaleChange($event)"
    (textureBrushTypeChange)="onTextureBrushTypeChange($event)"
    (textureColorBlendChange)="onTextureColorBlendChange($event)"
    (textureBlendColorChange)="onTextureBlendColorChange($event)"
    (textureHueChange)="onTextureHueChange($event)"
    (drawWithWallsChange)="onDrawWithWallsChange($event)"
    (dragModeChange)="onDragModeChange($event)"
    (drawLayerVisibleChange)="onDrawLayerVisibleChange($event)"
    (clearDrawings)="store.clearStrokes()"
    (clearWalls)="store.clearWalls()"
    (clearTextures)="onClearAllTextures()"
    (toggleSidebar)="toggleSidebar()"
    (mapSettingsClicked)="showMapSettings()"
  />

  <!-- Main content area -->
  <div class="lobby-main">
    <!-- Sidebar -->
    @if (showSidebar()) {
      <app-lobby-sidebar
        class="lobby-sidebar"
        [characters]="worldCharacters()"
        [tokensOnMap]="enrichedTokens()"
        [images]="imageLibrary()"
        [textures]="textureLibrary()"
        [selectedTextureId]="selectedTextureId()"
        [isGM]="isGM()"
        (loadImages)="onLoadImages($event)"
        (deleteImage)="onDeleteLibraryImage($event)"
        (renameImage)="onRenameLibraryImage($event)"
        (loadTextures)="onLoadTextures($event)"
        (selectTexture)="onSelectTexture($event)"
        (dragStart)="onImageDragStart($event)"
      />
    }

    <!-- Grid and side panel container -->
    <div class="lobby-content-wrapper">
      <!-- Grid canvas area -->
      <div class="lobby-grid-wrapper">
        <app-lobby-grid
          [map]="currentMap()"
          [tokens]="enrichedTokens()"
          [worldCharacters]="worldCharacters()"
        [currentTool]="currentTool()"
        [brushColor]="brushColor()"
        [penBrushSize]="penBrushSize()"
        [eraserBrushSize]="eraserBrushSize()"
        [textureBrushSize]="textureBrushSize()"
        [textureBrushStrength]="textureBrushStrength()"
        [textureScale]="textureScale()"
        [textureBrushType]="textureBrushType()"
        [textureColorBlend]="textureColorBlend()"
        [textureBlendColor]="textureBlendColor()"
        [textureHue]="textureHue()"
        [textureLayer]="textureLayer()"
        [isEraserMode]="isEraserMode()"
        [selectedTextureId]="selectedTextureId()"
        [drawWithWalls]="drawWithWalls()"
        [dragMode]="dragMode()"
        [drawLayerVisible]="drawLayerVisible()"
        [imageLayerVisible]="imageLayerVisible()"
        [selectedImageId]="selectedImageId()"
        [isGM]="isGM()"
        (tokenDrop)="onTokenDrop($event)"
        (tokenMove)="onTokenMove($event)"
        (tokenRemove)="onTokenRemove($event)"
        (quickTokenDrop)="onQuickTokenDrop($event)"
        (imageSelect)="onSelectImage($event)"
        (imageTransform)="onTransformImage($event)"
        (imageDelete)="onDeleteImage($event)"
        (placeImage)="onPlaceImage($event)"
        (toolAutoSelect)="onToolAutoSelect($event)"
        (textureBrushSizeChange)="onTextureBrushSizeChange($event)"
        (textureBrushStrengthChange)="onTextureBrushStrengthChange($event)"
        (textureBrushTypeChange)="onTextureBrushTypeChange($event)"
        (textureScaleChange)="onTextureScaleChange($event)"
        (textureHueChange)="onTextureHueChange($event)"
        (textureColorBlendChange)="onTextureColorBlendChange($event)"
        (textureBlendColorChange)="onTextureBlendColorChange($event)"
        (textureLayerChange)="textureLayer.set($event)"
        (selectedTextureIdChange)="onSelectTexture($event)"
        />
      </div>

      <!-- Side Panel (right side) - Layers for GM, Roll History for all -->
      <app-lobby-side-panel
        class="lobby-side-panel"
        [isGM]="isGM()"
        [rolls]="rollHistory()"
        [layers]="layers()"
        [activeLayerId]="activeLayerId()"
        (layerSelect)="onLayerSelect($event)"
        (layerToggleVisible)="onLayerToggleVisible($event)"
        (layerToggleLock)="onLayerToggleLock($event)"
        (layerDelete)="onLayerDelete($event)"
        (layerRename)="onLayerRename($event)"
        (layerReorder)="onLayerReorder($event)"
        (layerAdd)="onLayerAdd($event)"
      />
    </div>

    <!-- Battle Tracker Section (always show in lobby for coordination) -->
    <div class="battle-tracker-section">
      <app-battle-tracker [engine]="battleEngine" [readOnly]="true"></app-battle-tracker>
    </div>
  </div>
</div>

<!-- Map Settings Modal -->
@if (showMapSettingsModal()) {
  <div class="modal-backdrop" (click)="showMapSettingsModal.set(false)">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Map Settings</h3>
        <button class="modal-close" (click)="showMapSettingsModal.set(false)">&times;</button>
      </div>
      <div class="modal-content">
        <!-- Create New Map -->
        <div class="create-map-section">
          <h4>Create New Map</h4>
          <input 
            type="text" 
            [(ngModel)]="newMapName" 
            placeholder="Map Name" 
            class="map-name-input"
            (keydown.enter)="onCreateMap()"
          />
          <button class="btn-primary" (click)="onCreateMap()">Create Map</button>
        </div>

        <hr class="modal-divider" />

        <!-- Existing Maps -->
        <div class="maps-section">
          <h4>Maps ({{ mapList().length }})</h4>
          <div class="map-list">
            @for (map of mapList(); track map.id) {
              <div class="map-item" [class.active]="currentMapId() === map.id">
                <div class="map-item-header">
                  <span class="map-name">{{ map.name }}</span>
                  @if (currentMapId() === map.id) {
                    <span class="current-badge">âœ“ Active</span>
                  }
                </div>
                
                <!-- Background Color -->
                <div class="map-settings-row">
                  <label>Background:</label>
                  <input 
                    type="color" 
                    [value]="getMapBackground(map.id)" 
                    (change)="onMapBackgroundChange(map.id, $event)"
                    class="color-picker"
                  />
                  <span class="color-value">{{ getMapBackground(map.id) }}</span>
                </div>

                <!-- Actions -->
                <div class="map-actions">
                  @if (currentMapId() !== map.id) {
                    <button class="btn-switch" (click)="onSwitchMap(map.id)">Switch To</button>
                  }
                  @if (mapList().length > 1) {
                    <button class="btn-delete" (click)="onDeleteMap(map.id)">Delete</button>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
}
