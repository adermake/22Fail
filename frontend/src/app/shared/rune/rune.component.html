<div class="rune-card" 
     [class.editing]="isEditing"
     (dblclick)="!isEditing && toggleEdit()">
  
  <!-- Fullscreen Drawing Modal -->
  @if (isEditing && hasDrawing && isFullscreenDrawing()) {
    <div class="fullscreen-overlay">
      <div class="fullscreen-header">
        <h3>‚ú® {{ rune.drawing ? 'Edit' : 'Create' }} Rune Drawing</h3>
        <button type="button" class="close-fullscreen-btn" (click)="closeFullscreenDrawing()">‚úï Close</button>
      </div>
      <div class="fullscreen-content">
        <!-- Drawing Toolbar -->
        <div class="drawing-toolbar">
          <!-- Tool Selector -->
          <div class="toolbar-section tools">
            <button 
              type="button"
              class="toolbar-btn"
              [class.active]="!isErasing()"
              title="Draw Mode"
              (click)="setDrawMode()"
            >
              <span class="btn-icon">‚úèÔ∏è</span>
            </button>
            <button 
              type="button"
              class="toolbar-btn"
              [class.active]="isErasing()"
              title="Eraser Mode"
              (click)="toggleEraser()"
            >
              <span class="btn-icon">üßπ</span>
            </button>
          </div>

          <!-- Draw Tool Settings -->
          @if (!isErasing()) {
            <div class="toolbar-section brush-settings">
              <!-- Color picker -->
              <div class="color-picker">
                @for (color of presetColors; track color) {
                  <button 
                    type="button"
                    class="color-swatch"
                    [class.active]="strokeColor === color"
                    [style.background]="color"
                    [style.border-color]="color === '#ffffff' ? '#666' : color"
                    [title]="color"
                    (click)="selectColor(color)"
                  ></button>
                }
                <label class="custom-color" title="Custom Color">
                  <input 
                    type="color" 
                    [value]="strokeColor"
                    (input)="onColorInput($event)"
                  />
                  <span class="custom-color-preview" [style.background]="strokeColor"></span>
                </label>
              </div>
            </div>
          }

          <!-- Eraser Settings -->
          @if (isErasing()) {
            <div class="toolbar-section brush-settings">
              <span class="setting-label">Eraser Size:</span>
              <div class="size-picker">
                @for (size of eraserSizes; track size) {
                  <button 
                    type="button"
                    class="size-btn"
                    [class.active]="eraserSize === size"
                    [title]="size + 'px'"
                    (click)="selectEraserSize(size)"
                  >
                    <span class="size-dot" [style.width.px]="Math.min(size, 24)" [style.height.px]="Math.min(size, 24)"></span>
                  </button>
                }
              </div>
            </div>
          }

          <!-- Actions -->
          <div class="toolbar-section actions">
            <button type="button" class="action-btn" (click)="undo()" title="Undo (Ctrl+Z)">
              <span class="btn-icon">‚Ü∂</span> Undo
            </button>
            <button type="button" class="action-btn clear" (click)="clearCanvas()" title="Clear Drawing">
              <span class="btn-icon">üóëÔ∏è</span> Clear
            </button>
          </div>
        </div>

        <!-- Canvas with border expansion buttons -->
        <div class="canvas-area">
          <button type="button" class="expand-btn expand-top" (click)="expandTop()" title="Expand Top">‚ñ≤</button>
          <button type="button" class="expand-btn expand-left" (click)="expandLeft()" title="Expand Left">‚óÑ</button>
          <button type="button" class="expand-btn expand-right" (click)="expandRight()" title="Expand Right">‚ñ∫</button>
          <button type="button" class="expand-btn expand-bottom" (click)="expandBottom()" title="Expand Bottom">‚ñº</button>
          
          <div class="fullscreen-canvas-wrapper" [class.panning]="isPanning()">
            <canvas 
              #canvas
              [attr.width]="canvasWidth()"
              [attr.height]="canvasHeight()"
              (pointerdown)="startDrawing($event)"
              (pointermove)="draw($event)"
              (pointerup)="stopDrawing()"
              (pointerleave)="stopDrawing()"
              (pointercancel)="stopDrawing()"
            ></canvas>
          </div>
        </div>
      </div>
    </div>
  }
  
  @if (!isEditing) {
    <div class="rune-view">
      <div class="rune-header">
        <div class="rune-drawing">
          <img [src]="rune.drawing | imageUrl" alt="Rune drawing" />
        </div>
        <div class="rune-info">
          <div class="rune-title-row">
            <h4>{{ rune.name }}</h4>
            <button class="delete-btn-compact" (click)="deleteRune(); $event.stopPropagation()" title="Delete">üóëÔ∏è</button>
          </div>
          <div class="rune-tags">
            @for (tag of rune.tags; track tag) {
              <span class="tag">{{ tag }}</span>
            }
          </div>
        </div>
      </div>
      <p class="rune-description" [innerHTML]="enhancedDescription"></p>
    </div>
  } @else {
    <div class="rune-edit" (click)="$event.stopPropagation()">
      <div class="field">
        <label>Name</label>
        <input
          type="text"
          [ngModel]="rune.name"
          (ngModelChange)="updateField('name', $event)"
        />
      </div>

      <div class="field">
        <label>Description</label>
        <textarea
          [ngModel]="rune.description"
          (ngModelChange)="updateField('description', $event)"
          rows="3"
        ></textarea>
      </div>

      <div class="field checkbox-field">
        <label class="checkbox-label">
          <input type="checkbox" [checked]="hasDrawing" (change)="toggleDrawing()" />
          <span>Draw Rune Symbol</span>
        </label>
      </div>

      @if (hasDrawing) {
        <div class="field">
          <label>Draw Rune Symbol</label>
          @if (rune.drawing) {
            <div class="drawing-preview">
              <img [src]="rune.drawing | imageUrl" alt="Rune drawing" />
            </div>
          }
          <button type="button" class="edit-drawing-btn" (click)="openFullscreenDrawing()">
            üìù Edit Drawing in Fullscreen
          </button>
        </div>
      }

      <div class="field">
        <label>Tags</label>
        <div class="tag-selector">
          @for (tag of tagOptions; track tag) {
            <button
              type="button"
              class="tag-option"
              [class.selected]="hasTag(tag)"
              (click)="toggleTag(tag)">
              {{ tag }}
            </button>
          }
        </div>
      </div>

      <div class="rune-actions">
        <button class="save-btn" (click)="toggleEdit()">Done</button>
      </div>
    </div>
  }
</div>