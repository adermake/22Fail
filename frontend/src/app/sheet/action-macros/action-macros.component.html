<div class="action-macros-overlay">
  <div class="action-macros-fullscreen">
    <!-- Header -->
    <div class="dialog-header">
      <h2>‚ö° Aktionen</h2>
      <div class="header-controls">
        <button class="add-btn" (click)="createNewMacro()">+ Neue Aktion</button>
        <button class="close-btn" (click)="onClose()">&times;</button>
      </div>
    </div>

    <div class="dialog-body">
      <!-- Left Panel: Resource Bars -->
      <div class="panel resource-panel">
        <div class="panel-header">
          <h3>Ressourcen</h3>
        </div>
        
        <div class="resource-bars">
          @for (status of getStatuses(); track status.formulaType) {
            <div class="resource-bar-container">
              <div class="resource-label">
                <span class="resource-icon">{{ getResourceIcon(status.formulaType) }}</span>
                <span>{{ status.statusName }}</span>
              </div>
              <div class="resource-bar">
                <div class="resource-fill" 
                     [class.health]="status.formulaType === formulaTypeLife"
                     [class.energy]="status.formulaType === formulaTypeEnergy"
                     [class.mana]="status.formulaType === formulaTypeMana"
                     [style.width.%]="getResourcePercent(status)"></div>
                <span class="resource-text">{{ status.statusCurrent }} / {{ getStatusMax(status) }}</span>
              </div>
            </div>
          }
        </div>

        <!-- Roll Results Display -->
        @if (lastRollResults().length > 0 || resourceChanges().length > 0) {
          <div class="combined-results-section">
            <h4>üé≤ Aktionsergebnisse</h4>
            
            <!-- Group results by action execution -->
            <div class="results-list">
              <!-- Dice Roll Results -->
              @for (result of lastRollResults(); track result.id) {
                <div class="result-item roll-result" 
                     [class.animate]="result.isNew"
                     [style.border-left]="result.color ? '4px solid ' + result.color : '4px solid #f59e0b'">
                  <div class="result-header">
                    <span class="result-icon">üé≤</span>
                    @if (result.name) {
                      <span class="result-name" [style.color]="result.color || '#f59e0b'">{{ result.name }}</span>
                    }
                    <span class="result-formula">{{ result.formula }}</span>
                  </div>
                  <div class="result-value">{{ result.total }}</div>
                  @if (result.rolls.length > 0) {
                    <div class="result-detail">[{{ result.rolls.join(' + ') }}]</div>
                  }
                </div>
              }
              
              <!-- Resource Changes -->
              @for (change of resourceChanges(); track change.resource) {
                <div class="result-item resource-result" 
                     [class.animate]="change.isNew"
                     [class.negative]="change.amount < 0"
                     [class.positive]="change.amount > 0">
                  <div class="result-header">
                    <span class="result-icon">{{ change.amount > 0 ? 'üìà' : 'üìâ' }}</span>
                    <span class="result-name">{{ change.resource }}</span>
                  </div>
                  <div class="result-value" [class.negative]="change.amount < 0" [class.positive]="change.amount > 0">
                    {{ change.amount > 0 ? '+' : '' }}{{ change.amount }}
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>

      <!-- Center Panel: Action List or Editor -->
      <div class="panel main-panel">
        @if (!showEditor()) {
          <div class="panel-header">
            <h3>Verf√ºgbare Aktionen</h3>
          </div>

          @if (macros().length === 0) {
            <div class="empty-state">
              <span class="empty-icon">‚ö°</span>
              <p>Keine Aktionen konfiguriert</p>
              <p class="empty-hint">Erstelle eine Aktion, um komplexe W√ºrfe zu automatisieren</p>
              <button class="create-first-btn" (click)="createNewMacro()">Erste Aktion erstellen</button>
            </div>
          } @else {
            <div class="macro-grid" cdkDropList (cdkDropListDropped)="dropMacro($event)">
              @for (macro of macros(); track macro.id) {
                <div class="macro-card" 
                     cdkDrag
                     [class.invalid]="!macro.isValid"
                     [class.disabled]="!areConditionsMet(macro)"
                     [style.border-left-color]="macro.color">
                  
                  <div class="macro-header">
                    <span class="macro-icon">{{ macro.icon || '‚ö°' }}</span>
                    <span class="macro-name">{{ macro.name }}</span>
                    @if (!macro.isValid) {
                      <span class="invalid-badge" [title]="'Fehlende Skills: ' + getMissingSkills(macro).join(', ')">‚ö†Ô∏è</span>
                    }
                    <span class="drag-handle" cdkDragHandle>‚ãÆ‚ãÆ</span>
                  </div>

                  @if (macro.description) {
                    <p class="macro-description">{{ macro.description }}</p>
                  }

                  <div class="macro-summary">
                    @for (cons of macro.consequences; track cons.id) {
                      <span class="consequence-tag" [class]="cons.type">{{ getConsequenceLabel(cons) }}</span>
                    }
                  </div>

                  <div class="macro-actions">
                    <button class="run-btn" 
                            [disabled]="!areConditionsMet(macro)"
                            (click)="runMacroWithResults(macro)">
                      ‚ñ∂ Ausf√ºhren
                    </button>
                    <button class="edit-btn" (click)="editMacro(macro)">‚úèÔ∏è</button>
                    <button class="delete-btn" (click)="deleteMacro(macro.id)">üóëÔ∏è</button>
                  </div>
                </div>
              }
            </div>
          }
        } @else {
          <!-- Macro Editor -->
          @if (editingMacro(); as macro) {
            <div class="panel-header">
              <h3>{{ isNewMacro() ? 'Neue Aktion' : 'Aktion bearbeiten' }}</h3>
            </div>

            <div class="macro-editor">
              <!-- Basic Settings -->
              <div class="editor-section">
                <h3>‚öôÔ∏è Grundeinstellungen</h3>
                <div class="form-row">
                  <div class="form-group flex-1">
                    <label>
                      <span class="label-icon">‚úèÔ∏è</span>
                      Name
                    </label>
                    <input type="text" [(ngModel)]="macro.name" placeholder="z.B. Feuerball, Heilzauber" />
                  </div>
                  <div class="form-group color-group">
                    <label>
                      <span class="label-icon">üé®</span>
                      Farbe
                    </label>
                    <input type="color" [(ngModel)]="macro.color" />
                  </div>
                </div>
                <div class="form-group">
                  <label>
                    <span class="label-icon">üìù</span>
                    Beschreibung
                    <span class="label-hint">Optional: Was macht diese Aktion?</span>
                  </label>
                  <input type="text" [(ngModel)]="macro.description" placeholder="z.B. Wirft einen m√§chtigen Feuerball" />
                </div>
                <div class="form-group">
                  <label>
                    <span class="label-icon">üé≠</span>
                    Icon
                  </label>
                  <div class="icon-selector">
                    @for (icon of availableIcons; track icon) {
                      <button class="icon-btn" [class.selected]="macro.icon === icon" 
                              (click)="macro.icon = icon">
                        {{ icon }}
                      </button>
                    }
                  </div>
                </div>
              </div>

              <!-- Conditions -->
              <div class="editor-section">
                <div class="section-header">
                  <h4>‚ùì Bedingungen (Wenn...)</h4>
                  <button class="add-small-btn" (click)="addCondition()">+ Bedingung</button>
                </div>
                @if (macro.conditions.length === 0) {
                  <p class="section-empty">Keine Bedingungen - Aktion ist immer verf√ºgbar</p>
                } @else {
                  @for (condition of macro.conditions; track condition.id; let i = $index) {
                    <div class="condition-row">
                      <select [(ngModel)]="condition.type">
                        <option value="resource">Ressource</option>
                        <option value="stat">Attribut</option>
                        <option value="skill">Skill</option>
                      </select>

                      @if (condition.type === 'resource') {
                        <select [(ngModel)]="condition.resource">
                          @for (res of resourceTypes; track res) {
                            <option [value]="res">{{ res }}</option>
                          }
                        </select>
                      } @else if (condition.type === 'stat') {
                        <select [(ngModel)]="condition.stat">
                          @for (stat of statTypes; track stat) {
                            <option [value]="stat">{{ stat }}</option>
                          }
                        </select>
                      } @else {
                        <input type="text" [(ngModel)]="condition.skillName" placeholder="Skill-Name" />
                      }

                      @if (condition.type !== 'skill') {
                        <select [(ngModel)]="condition.operator">
                          @for (op of operators; track op) {
                            <option [value]="op">{{ op }}</option>
                          }
                        </select>
                        
                        <!-- Comparison type selector -->
                        <select [(ngModel)]="condition.valueType" class="value-type-select">
                          <option value="fixed">Fester Wert</option>
                          <option value="currentResource">Aktuelle Ressource</option>
                          <option value="maxResource">Max Ressource</option>
                          <option value="stat">Attribut</option>
                        </select>
                        
                        <!-- Show appropriate input based on valueType -->
                        @if (condition.valueType === 'fixed') {
                          <input type="number" [(ngModel)]="condition.value" placeholder="Wert" />
                        } @else if (condition.valueType === 'currentResource' || condition.valueType === 'maxResource') {
                          <select [(ngModel)]="condition.compareToResource">
                            @for (res of resourceTypes; track res) {
                              <option [value]="res">{{ res }}</option>
                            }
                          </select>
                        } @else if (condition.valueType === 'stat') {
                          <select [(ngModel)]="condition.compareToStat">
                            @for (stat of statTypes; track stat) {
                              <option [value]="stat">{{ stat }}</option>
                            }
                          </select>
                        }
                      }

                      <button class="remove-btn" (click)="removeCondition(i)">√ó</button>
                    </div>
                  }
                }
              </div>

              <!-- Consequences -->
              <div class="editor-section">
                <div class="section-header">
                  <h4>‚ö° Aktionen (Dann...)</h4>
                  <button class="add-small-btn" (click)="addConsequence()">+ Aktion</button>
                </div>
                @if (macro.consequences.length === 0) {
                  <p class="section-empty">Keine Aktionen definiert</p>
                } @else {
                  @for (consequence of macro.consequences; track consequence.id; let i = $index) {
                    <div class="consequence-card">
                      <!-- Action Type Selector -->
                      <div class="consequence-header">
                        <div class="form-group flex-1">
                          <label>Aktionstyp</label>
                          <select [(ngModel)]="consequence.type" class="action-type-select">
                            <option value="dice_roll">üé≤ W√ºrfeln</option>
                            <option value="spend_resource">üìâ Ressource ausgeben</option>
                            <option value="gain_resource">üìà Ressource erhalten</option>
                          </select>
                        </div>
                        <button class="remove-card-btn" (click)="removeConsequence(i)" title="Aktion entfernen">
                          <span>√ó</span>
                        </button>
                      </div>

                      <!-- Resource Selection (for spend/gain) -->
                      @if (consequence.type === 'spend_resource' || consequence.type === 'gain_resource') {
                        <div class="form-group">
                          <label>Ressource</label>
                          <select [(ngModel)]="consequence.resource" class="resource-select">
                            @for (res of resourceTypes; track res) {
                              <option [value]="res">{{ res }}</option>
                            }
                          </select>
                        </div>
                      }

                      <!-- Unified Dice Configuration Section -->
                      <div class="dice-config-section">
                        <!-- Roll Name and Color -->
                        <div class="form-row">
                          <div class="form-group flex-1">
                            <label>
                              <span class="label-icon">üè∑Ô∏è</span>
                              Anzeigename (optional)
                            </label>
                            <input 
                              type="text" 
                              [(ngModel)]="consequence.rollName" 
                              placeholder="z.B. Angriff, Schaden, Heilung"
                              class="roll-name-input" />
                          </div>
                          <div class="form-group color-picker-group">
                            <label>
                              <span class="label-icon">üé®</span>
                              Farbe
                            </label>
                            <input 
                              type="color" 
                              [(ngModel)]="consequence.rollColor" 
                              class="color-picker"
                              title="Farbe f√ºr die Anzeige" />
                          </div>
                        </div>

                        <!-- Formula Input with Validation -->
                        <div class="form-group">
                          <label>
                            <span class="label-icon">üé≤</span>
                            W√ºrfelformel oder fester Wert
                            <span class="label-hint">Beispiele: 1d20+3, 2d6*2, 3d10+5-2, oder einfach 10</span>
                          </label>
                          <div class="formula-input-wrapper">
                            <input 
                              type="text" 
                              [(ngModel)]="consequence.diceFormula" 
                              (ngModelChange)="onFormulaChange(consequence)"
                              placeholder="z.B. 2d6+3"
                              class="formula-input"
                              [class.valid]="isFormulaValid(consequence.diceFormula)"
                              [class.invalid]="consequence.diceFormula && !isFormulaValid(consequence.diceFormula)" />
                            @if (consequence.diceFormula && isFormulaValid(consequence.diceFormula)) {
                              <span class="validation-icon valid" title="Formel ist g√ºltig">‚úì</span>
                            }
                            @if (consequence.diceFormula && !isFormulaValid(consequence.diceFormula)) {
                              <span class="validation-icon invalid" title="{{ getFormulaError(consequence.diceFormula) }}">‚úó</span>
                            }
                          </div>
                          @if (consequence.diceFormula && !isFormulaValid(consequence.diceFormula)) {
                            <div class="error-message">
                              {{ getFormulaError(consequence.diceFormula) }}
                            </div>
                          }
                        </div>

                        <!-- OR Divider -->
                        @if (savedDiceConfigs().length > 0) {
                          <div class="or-divider">
                            <span>ODER</span>
                          </div>

                          <!-- Saved Dice Config Dropdown -->
                          <div class="form-group">
                            <label>
                              <span class="label-icon">üíæ</span>
                              Gespeicherte W√ºrfelkonfiguration
                              <span class="label-hint">W√§hle eine vorher gespeicherte Konfiguration</span>
                            </label>
                            <select 
                              [(ngModel)]="consequence.savedDiceConfigId" 
                              (change)="onSavedConfigSelected(consequence)"
                              class="saved-config-select">
                              <option value="">-- Keine gespeicherte Konfiguration --</option>
                              @for (config of savedDiceConfigs(); track config.id) {
                                <option [value]="config.id">
                                  {{ config.name }} ({{ config.diceCount }}d{{ config.diceType }})
                                </option>
                              }
                            </select>
                          </div>
                        }
                      </div>
                    </div>
                  }
                }
              </div>

              <div class="editor-actions">
                <button class="cancel-btn" (click)="closeEditor()">Abbrechen</button>
                <button class="save-btn" (click)="saveMacro()">Speichern</button>
              </div>
            </div>
          }
        }
      </div>
    </div>
  </div>
</div>
