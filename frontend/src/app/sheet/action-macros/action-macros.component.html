<div class="action-macros-overlay">
  <div class="action-macros-fullscreen">
    <!-- Header -->
    <div class="dialog-header">
      <h2>‚ö° Aktionen</h2>
      <div class="header-controls">
        <button class="add-btn" (click)="createNewMacro()">+ Neue Aktion</button>
        <button class="close-btn" (click)="onClose()">&times;</button>
      </div>
    </div>

    <div class="dialog-body">
      <!-- Left Panel: Resource Bars -->
      <div class="panel resource-panel">
        <div class="panel-header">
          <h3>Ressourcen</h3>
        </div>
        
        <div class="resource-bars">
          @for (status of getStatuses(); track status.formulaType) {
            <div class="resource-bar-container">
              <div class="resource-label">
                <span class="resource-icon">{{ getResourceIcon(status.formulaType) }}</span>
                <span>{{ status.statusName }}</span>
              </div>
              <div class="resource-bar">
                <div class="resource-fill" 
                     [class.health]="status.formulaType === formulaTypeLife"
                     [class.energy]="status.formulaType === formulaTypeEnergy"
                     [class.mana]="status.formulaType === formulaTypeMana"
                     [style.width.%]="getResourcePercent(status)"></div>
                <span class="resource-text">{{ status.statusCurrent }} / {{ getStatusMax(status) }}</span>
              </div>
            </div>
          }
        </div>

        <!-- Roll Results Display -->
        @if (lastRollResults().length > 0) {
          <div class="roll-results-section">
            <h4>üé≤ W√ºrfelergebnisse</h4>
            <div class="roll-results-list">
              @for (result of lastRollResults(); track result.id) {
                <div class="roll-result-item" 
                     [class.animate]="result.isNew"
                     [style.border-left]="result.color ? '3px solid ' + result.color : ''">
                  @if (result.name) {
                    <span class="roll-name" [style.color]="result.color || '#f59e0b'">{{ result.name }}</span>
                  }
                  <span class="roll-formula">{{ result.formula }}</span>
                  <span class="roll-value">{{ result.total }}</span>
                  <span class="roll-detail">[{{ result.rolls.join('+') }}]</span>
                </div>
              }
            </div>
          </div>
        }

        <!-- Resource Changes Display -->
        @if (resourceChanges().length > 0) {
          <div class="resource-changes-section">
            <h4>üìä Ressourcen-√Ñnderungen</h4>
            <div class="resource-changes-list">
              @for (change of resourceChanges(); track change.resource) {
                <div class="resource-change-item" 
                     [class.animate]="change.isNew"
                     [class.negative]="change.amount < 0"
                     [class.positive]="change.amount > 0">
                  <span class="change-resource">{{ change.resource }}</span>
                  <span class="change-amount">{{ change.amount > 0 ? '+' : '' }}{{ change.amount }}</span>
                </div>
              }
            </div>
          </div>
        }
      </div>

      <!-- Center Panel: Action List or Editor -->
      <div class="panel main-panel">
        @if (!showEditor()) {
          <div class="panel-header">
            <h3>Verf√ºgbare Aktionen</h3>
          </div>

          @if (macros().length === 0) {
            <div class="empty-state">
              <span class="empty-icon">‚ö°</span>
              <p>Keine Aktionen konfiguriert</p>
              <p class="empty-hint">Erstelle eine Aktion, um komplexe W√ºrfe zu automatisieren</p>
              <button class="create-first-btn" (click)="createNewMacro()">Erste Aktion erstellen</button>
            </div>
          } @else {
            <div class="macro-grid" cdkDropList (cdkDropListDropped)="dropMacro($event)">
              @for (macro of macros(); track macro.id) {
                <div class="macro-card" 
                     cdkDrag
                     [class.invalid]="!macro.isValid"
                     [class.disabled]="!areConditionsMet(macro)"
                     [style.border-left-color]="macro.color">
                  
                  <div class="macro-header">
                    <span class="macro-icon">{{ macro.icon || '‚ö°' }}</span>
                    <span class="macro-name">{{ macro.name }}</span>
                    @if (!macro.isValid) {
                      <span class="invalid-badge" [title]="'Fehlende Skills: ' + getMissingSkills(macro).join(', ')">‚ö†Ô∏è</span>
                    }
                    <span class="drag-handle" cdkDragHandle>‚ãÆ‚ãÆ</span>
                  </div>

                  @if (macro.description) {
                    <p class="macro-description">{{ macro.description }}</p>
                  }

                  <div class="macro-summary">
                    @for (cons of macro.consequences; track cons.id) {
                      <span class="consequence-tag" [class]="cons.type">{{ getConsequenceLabel(cons) }}</span>
                    }
                  </div>

                  <div class="macro-actions">
                    <button class="run-btn" 
                            [disabled]="!areConditionsMet(macro)"
                            (click)="runMacroWithResults(macro)">
                      ‚ñ∂ Ausf√ºhren
                    </button>
                    <button class="edit-btn" (click)="editMacro(macro)">‚úèÔ∏è</button>
                    <button class="delete-btn" (click)="deleteMacro(macro.id)">üóëÔ∏è</button>
                  </div>
                </div>
              }
            </div>
          }
        } @else {
          <!-- Macro Editor -->
          @if (editingMacro(); as macro) {
            <div class="panel-header">
              <h3>{{ isNewMacro() ? 'Neue Aktion' : 'Aktion bearbeiten' }}</h3>
            </div>

            <div class="macro-editor">
              <!-- Basic Settings -->
              <div class="editor-section">
                <div class="form-row">
                  <div class="form-group flex-1">
                    <label>Name</label>
                    <input type="text" [(ngModel)]="macro.name" placeholder="Aktionsname" />
                  </div>
                  <div class="form-group icon-group">
                    <label>Icon</label>
                    <div class="icon-selector">
                      @for (icon of availableIcons; track icon) {
                        <button class="icon-btn" [class.selected]="macro.icon === icon" 
                                (click)="macro.icon = icon">
                          {{ icon }}
                        </button>
                      }
                    </div>
                  </div>
                  <div class="form-group color-group">
                    <label>Farbe</label>
                    <input type="color" [(ngModel)]="macro.color" />
                  </div>
                </div>
                <div class="form-group">
                  <label>Beschreibung</label>
                  <input type="text" [(ngModel)]="macro.description" placeholder="Optionale Beschreibung" />
                </div>
              </div>

              <!-- Conditions -->
              <div class="editor-section">
                <div class="section-header">
                  <h4>Bedingungen (Wenn...)</h4>
                  <button class="add-small-btn" (click)="addCondition()">+ Bedingung</button>
                </div>
                @if (macro.conditions.length === 0) {
                  <p class="section-empty">Keine Bedingungen - Aktion ist immer verf√ºgbar</p>
                } @else {
                  @for (condition of macro.conditions; track condition.id; let i = $index) {
                    <div class="condition-row">
                      <select [(ngModel)]="condition.type">
                        <option value="resource">Ressource</option>
                        <option value="stat">Attribut</option>
                        <option value="skill">Skill</option>
                      </select>

                      @if (condition.type === 'resource') {
                        <select [(ngModel)]="condition.resource">
                          @for (res of resourceTypes; track res) {
                            <option [value]="res">{{ res }}</option>
                          }
                        </select>
                      } @else if (condition.type === 'stat') {
                        <select [(ngModel)]="condition.stat">
                          @for (stat of statTypes; track stat) {
                            <option [value]="stat">{{ stat }}</option>
                          }
                        </select>
                      } @else {
                        <input type="text" [(ngModel)]="condition.skillName" placeholder="Skill-Name" />
                      }

                      @if (condition.type !== 'skill') {
                        <select [(ngModel)]="condition.operator">
                          @for (op of operators; track op) {
                            <option [value]="op">{{ op }}</option>
                          }
                        </select>
                        
                        <!-- Comparison type selector -->
                        <select [(ngModel)]="condition.valueType" class="value-type-select">
                          <option value="fixed">Fester Wert</option>
                          <option value="currentResource">Aktuelle Ressource</option>
                          <option value="maxResource">Max Ressource</option>
                          <option value="stat">Attribut</option>
                        </select>
                        
                        <!-- Show appropriate input based on valueType -->
                        @if (condition.valueType === 'fixed') {
                          <input type="number" [(ngModel)]="condition.value" placeholder="Wert" />
                        } @else if (condition.valueType === 'currentResource' || condition.valueType === 'maxResource') {
                          <select [(ngModel)]="condition.compareToResource">
                            @for (res of resourceTypes; track res) {
                              <option [value]="res">{{ res }}</option>
                            }
                          </select>
                        } @else if (condition.valueType === 'stat') {
                          <select [(ngModel)]="condition.compareToStat">
                            @for (stat of statTypes; track stat) {
                              <option [value]="stat">{{ stat }}</option>
                            }
                          </select>
                        }
                      }

                      <button class="remove-btn" (click)="removeCondition(i)">√ó</button>
                    </div>
                  }
                }
              </div>

              <!-- Consequences -->
              <div class="editor-section">
                <div class="section-header">
                  <h4>Aktionen (Dann...)</h4>
                  <button class="add-small-btn" (click)="addConsequence()">+ Aktion</button>
                </div>
                @if (macro.consequences.length === 0) {
                  <p class="section-empty">Keine Aktionen definiert</p>
                } @else {
                  @for (consequence of macro.consequences; track consequence.id; let i = $index) {
                    <div class="consequence-row">
                      <select [(ngModel)]="consequence.type">
                        <option value="dice_roll">W√ºrfeln</option>
                        <option value="spend_resource">Ressource ausgeben</option>
                        <option value="gain_resource">Ressource erhalten</option>
                      </select>

                      @if (consequence.type === 'dice_roll') {
                        <!-- Dice roll name and color -->
                        <input type="text" [(ngModel)]="consequence.rollName" placeholder="Name (optional)" class="roll-name-input" />
                        <input type="color" [(ngModel)]="consequence.rollColor" class="color-input" title="W√ºrfelfarbe" />
                        
                        <!-- Option to use saved dice config or manual -->
                        @if (savedDiceConfigs().length > 0) {
                          <select [(ngModel)]="consequence.savedDiceConfigId" class="config-select">
                            <option value="">Manuelle W√ºrfel</option>
                            @for (config of savedDiceConfigs(); track config.id) {
                              <option [value]="config.id">{{ config.name }} ({{ config.diceCount }}d{{ config.diceType }})</option>
                            }
                          </select>
                        }
                        @if (!consequence.savedDiceConfigId) {
                          <input type="number" [(ngModel)]="consequence.diceCount" min="1" max="20" class="small-input" />
                          <span class="d-label">d</span>
                          <select [(ngModel)]="consequence.diceType">
                            @for (dice of diceTypes; track dice) {
                              <option [value]="dice">{{ dice }}</option>
                            }
                          </select>
                        }
                      } @else if (consequence.type === 'spend_resource') {
                        <!-- Option to use dice for amount or fixed -->
                        <select [(ngModel)]="consequence.resource">
                          @for (res of resourceTypes; track res) {
                            <option [value]="res">{{ res }}</option>
                          }
                        </select>
                        <span class="d-label">Kosten:</span>
                        @if (savedDiceConfigs().length > 0) {
                          <select [(ngModel)]="consequence.savedDiceConfigId" class="config-select">
                            <option value="">Fester Wert</option>
                            @for (config of savedDiceConfigs(); track config.id) {
                              <option [value]="config.id">{{ config.name }} ({{ config.diceCount }}d{{ config.diceType }})</option>
                            }
                          </select>
                        }
                        @if (!consequence.savedDiceConfigId) {
                          <input type="number" [(ngModel)]="consequence.amount" class="small-input" />
                        }
                      } @else {
                        <input type="number" [(ngModel)]="consequence.amount" class="small-input" />
                        <select [(ngModel)]="consequence.resource">
                          @for (res of resourceTypes; track res) {
                            <option [value]="res">{{ res }}</option>
                          }
                        </select>
                      }

                      <button class="remove-btn" (click)="removeConsequence(i)">√ó</button>
                    </div>
                  }
                }
              </div>

              <div class="editor-actions">
                <button class="cancel-btn" (click)="closeEditor()">Abbrechen</button>
                <button class="save-btn" (click)="saveMacro()">Speichern</button>
              </div>
            </div>
          }
        }
      </div>
    </div>
  </div>
</div>
