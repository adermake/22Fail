<div class="dice-roller-overlay" (click)="onClose()">
  <div class="dice-roller-dialog" [class.secret-mode]="isSecretRoll()" (click)="$event.stopPropagation()">
    <div class="dialog-header">
      <h2>ðŸŽ² WÃ¼rfel Werfen</h2>
      <div class="header-controls">
        <label class="secret-toggle" [class.active]="isSecretRoll()">
          <input type="checkbox" [checked]="isSecretRoll()" (change)="isSecretRoll.set($any($event.target).checked)" />
          <span class="secret-label">ðŸ¤« Geheim</span>
        </label>
        <button class="close-btn" (click)="onClose()">&times;</button>
      </div>
    </div>

    <div class="dialog-content horizontal-layout">
      <!-- Left Column: Dice Selection & Roll -->
      <div class="column dice-column">
        <!-- Dice Type Selection -->
        <div class="dice-type-row">
          @for (type of diceTypes; track type) {
            <button 
              class="dice-btn"
              [class.selected]="selectedDiceType() === type"
              (click)="selectedDiceType.set(type)">
              d{{type}}
            </button>
          }
        </div>
        
        <!-- Dice Count & Manual Bonus Row -->
        <div class="dice-controls-row">
          <div class="control-group">
            <label>Anzahl</label>
            <input 
              type="number" 
              min="1" 
              max="20" 
              [value]="diceCount()"
              (input)="diceCount.set(+$any($event.target).value)" />
          </div>
          <div class="control-group">
            <label>Â±Bonus</label>
            <input 
              type="number" 
              [value]="manualBonus()"
              (input)="manualBonus.set(+$any($event.target).value)"
              placeholder="0" />
          </div>
        </div>

        <!-- Roll Summary & Button -->
        <div class="roll-area">
          <div class="roll-summary">
            <span class="formula">
              {{diceCount()}}d{{selectedDiceType()}}
              @if (totalBonus() !== 0) {
                <span [class.negative]="totalBonus() < 0">
                  {{totalBonus() > 0 ? '+' : ''}}{{totalBonus()}}
                </span>
              }
            </span>
          </div>
          <button 
            class="roll-btn"
            [class.rolling]="isRolling()"
            [class.secret]="isSecretRoll()"
            [disabled]="isRolling()"
            (click)="roll()">
            <span class="roll-text">{{isRolling() ? 'ðŸŽ²...' : 'ðŸŽ² WÃ¼rfeln'}}</span>
          </button>
        </div>

        <!-- Last Roll Result -->
        @if (lastRoll(); as roll) {
          <div class="last-roll" [class.secret]="roll.isSecret">
            <div class="roll-result-big">{{roll.result}}</div>
            <div class="roll-breakdown">
              <span class="dice-sum">[{{roll.rolls.join('+')}}]</span>
              @if (roll.bonuses.length > 0) {
                @for (bonus of roll.bonuses; track bonus.name) {
                  <span class="bonus-tag" [class.negative]="bonus.value < 0">
                    {{bonus.value > 0 ? '+' : ''}}{{bonus.value}}
                  </span>
                }
              }
            </div>
          </div>
        }
      </div>

      <!-- Right Column: Bonuses -->
      <div class="column bonus-column">
        <!-- Stat Bonuses -->
        <div class="bonus-section">
          <h4>Attribute</h4>
          <div class="bonus-chips">
            @for (stat of statBonuses(); track stat.name) {
              <button 
                class="bonus-chip stat"
                [class.selected]="isBonusSelected(stat.name)"
                (click)="toggleBonus(stat.name)">
                <span class="chip-name">{{stat.name}}</span>
                <span class="chip-value" [class.negative]="stat.value < 0">
                  {{stat.value > 0 ? '+' : ''}}{{stat.value}}
                </span>
              </button>
            }
          </div>
        </div>

        <!-- Skill Dice Bonuses -->
        @if (availableDiceBonuses().length > 0) {
          <div class="bonus-section">
            <h4>WÃ¼rfelboni</h4>
            <div class="bonus-chips scrollable">
              @for (bonus of availableDiceBonuses(); track bonus.name) {
                <button 
                  class="bonus-chip skill"
                  [class.selected]="isBonusSelected(bonus.name)"
                  (click)="toggleBonus(bonus.name)">
                  <span class="chip-name">{{bonus.name}}</span>
                  <span class="chip-value">+{{bonus.value}}</span>
                </button>
              }
            </div>
          </div>
        }

        <!-- Roll History -->
        @if (rollHistory().rolls.length > 0) {
          <div class="bonus-section history-section">
            <h4>Letzte WÃ¼rfe</h4>
            <div class="history-chips">
              @for (roll of rollHistory().rolls.slice(0, 5); track roll.id) {
                <button class="history-chip" (click)="repeatRoll(roll)" [title]="getRollLabel(roll)">
                  <span class="history-formula">{{roll.diceCount}}d{{roll.diceType}}</span>
                  <span class="history-result">= {{roll.result}}</span>
                </button>
              }
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Received Rolls from Other Players -->
    @if (receivedRolls().length > 0) {
      <div class="received-rolls">
        <h4>ðŸŽ² Andere WÃ¼rfe</h4>
        <div class="received-list">
          @for (roll of receivedRolls(); track roll.id) {
            <div class="received-roll">
              <span class="player-name">{{roll.characterName}}</span>
              <span class="roll-info">{{roll.diceCount}}d{{roll.diceType}} = </span>
              <span class="roll-total">{{roll.result}}</span>
            </div>
          }
        </div>
      </div>
    }
  </div>
</div>
