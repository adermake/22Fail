<div class="dice-roller-overlay">
  <div class="dice-roller-fullscreen" [class.secret-mode]="isSecretRoll()">
    <!-- Header -->
    <div class="dialog-header">
      <h2>ðŸŽ² WÃ¼rfel Werfen</h2>
      <div class="header-controls">
        <label class="secret-toggle" [class.active]="isSecretRoll()">
          <input type="checkbox" [checked]="isSecretRoll()" (change)="isSecretRoll.set($any($event.target).checked)" />
          <span class="secret-label">ðŸ¤« Geheim</span>
        </label>
        <button class="close-btn" (click)="onClose()">&times;</button>
      </div>
    </div>

    <div class="dialog-body">
      <!-- Left Panel: Rolling Area -->
      <div class="panel roll-panel">
        <div class="panel-header">
          <h3>WÃ¼rfeln</h3>
        </div>

        <!-- Custom Dice Input -->
        <div class="dice-input-section">
          <input 
            type="text" 
            class="dice-formula-input"
            [value]="diceFormula()"
            (input)="parseDiceFormula($any($event.target).value)"
            placeholder="z.B. 2d6+3 oder 1d20"
          />
        </div>

        <!-- Dice Type Buttons -->
        <div class="dice-type-grid">
          @for (type of diceTypes; track type) {
            <button 
              class="dice-type-btn"
              [class.selected]="selectedDiceType() === type"
              (click)="selectDice(type)">
              d{{type}}
            </button>
          }
        </div>
        
        <!-- Dice Count & Bonus -->
        <div class="dice-controls">
          <div class="control-group">
            <label>Anzahl</label>
            <div class="number-control">
              <button (click)="diceCount.set(Math.max(1, diceCount() - 1))">-</button>
              <input type="number" min="1" max="20" [value]="diceCount()" (input)="diceCount.set(+$any($event.target).value)" />
              <button (click)="diceCount.set(Math.min(20, diceCount() + 1))">+</button>
            </div>
          </div>
          <div class="control-group">
            <label>Â±Bonus</label>
            <input type="number" class="bonus-input" [value]="manualBonus()" (input)="manualBonus.set(+$any($event.target).value)" />
          </div>
        </div>

        <!-- Roll Summary -->
        <div class="roll-summary">
          <span class="formula-display">
            {{diceCount()}}d{{selectedDiceType()}}
            @if (totalBonus() !== 0) {
              <span [class.negative]="totalBonus() < 0">
                {{totalBonus() > 0 ? '+' : ''}}{{totalBonus()}}
              </span>
            }
          </span>
        </div>

        <!-- Roll Button -->
        <button 
          class="roll-btn"
          [class.rolling]="isRolling()"
          [class.secret]="isSecretRoll()"
          [disabled]="isRolling()"
          (click)="roll()">
          <span class="roll-text">{{isRolling() ? 'ðŸŽ²...' : 'ðŸŽ² WÃ¼rfeln'}}</span>
        </button>

        <!-- Result Display -->
        @if (lastRoll(); as rollResult) {
          <div class="result-display" [class.secret]="rollResult.isSecret" [class.animate]="isAnimating()">
            <div class="result-number">{{rollResult.result}}</div>
            <div class="result-breakdown">
              <span class="dice-rolls">[{{rollResult.rolls.join('+')}}]</span>
              @for (bonus of rollResult.bonuses; track bonus.name) {
                <span class="bonus-pill" [class.negative]="bonus.value < 0">
                  {{bonus.name}}: {{bonus.value > 0 ? '+' : ''}}{{bonus.value}}
                </span>
              }
            </div>
          </div>
        }

        <!-- Save Configuration -->
        <div class="save-config-section">
          <input 
            type="text" 
            class="config-name-input"
            [(ngModel)]="newConfigName"
            placeholder="Konfiguration speichern..." 
          />
          <button class="save-config-btn" (click)="saveConfiguration()" [disabled]="!newConfigName">ðŸ’¾</button>
        </div>
      </div>

      <!-- Middle Panel: Bonuses -->
      <div class="panel bonus-panel">
        <div class="panel-header">
          <h3>Boni</h3>
        </div>

        <!-- Stat Bonuses -->
        <div class="bonus-section">
          <h4>Attribute</h4>
          <div class="bonus-grid">
            @for (stat of statBonuses(); track stat.name) {
              <button 
                class="bonus-chip stat"
                [class.selected]="isBonusSelected(stat.name)"
                (click)="toggleBonus(stat.name)">
                <span class="chip-name">{{stat.name}}</span>
                <span class="chip-value" [class.negative]="stat.value < 0">
                  {{stat.value > 0 ? '+' : ''}}{{stat.value}}
                </span>
              </button>
            }
          </div>
        </div>

        <!-- Dice Skill Bonuses -->
        @if (availableDiceBonuses().length > 0) {
          <div class="bonus-section">
            <div class="section-header-row">
              <h4>WÃ¼rfelboni (Skills)</h4>
              @if (availableDiceBonuses().length > 4) {
                <input type="text" 
                       class="skill-filter-input"
                       placeholder="Filter..."
                       [value]="skillFilter()"
                       (input)="skillFilter.set($any($event.target).value)" />
              }
            </div>
            <div class="bonus-grid scrollable">
              @for (bonus of filteredDiceBonuses(); track bonus.name) {
                <button 
                  class="bonus-chip skill"
                  [class.selected]="isBonusSelected(bonus.name)"
                  (click)="toggleBonus(bonus.name)"
                  [title]="bonus.context || ''">
                  <span class="chip-name">{{bonus.name}}</span>
                  <span class="chip-value">+{{bonus.value}}</span>
                  @if (bonus.context) {
                    <span class="chip-context">{{bonus.context}}</span>
                  }
                </button>
              }
            </div>
          </div>
        }

        <!-- Selected Bonuses Summary -->
        @if (selectedBonuses().size > 0) {
          <div class="selected-summary">
            <span class="summary-label">AusgewÃ¤hlt:</span>
            <span class="summary-value">{{totalBonus() > 0 ? '+' : ''}}{{totalBonus()}}</span>
          </div>
        }
      </div>

      <!-- Right Panel: Saved Configs & History -->
      <div class="panel config-panel">
        <div class="panel-header">
          <h3>Gespeichert</h3>
          <button class="toggle-list-btn" (click)="showSavedList.set(!showSavedList())">
            {{showSavedList() ? 'â–¼' : 'â–¶'}}
          </button>
        </div>

        @if (showSavedList()) {
          <div class="saved-configs">
            @if (savedConfigs().length === 0) {
              <p class="empty-hint">Keine gespeicherten Konfigurationen</p>
            } @else {
              @for (config of savedConfigs(); track config.id) {
                <div class="config-item">
                  <button class="config-btn" (click)="loadConfiguration(config)">
                    <span class="config-name">{{config.name}}</span>
                    <span class="config-formula">{{config.diceCount}}d{{config.diceType}}</span>
                  </button>
                  <button class="config-delete" (click)="deleteConfiguration(config.id)">Ã—</button>
                </div>
              }
            }
          </div>
        }

        <!-- Roll History -->
        <div class="history-section">
          <h4>Verlauf</h4>
          <div class="history-list">
            @for (roll of rollHistory().rolls.slice(0, 8); track roll.id) {
              <button class="history-item" (click)="repeatRoll(roll)">
                <span class="history-formula">{{roll.diceCount}}d{{roll.diceType}}</span>
                <span class="history-result">= {{roll.result}}</span>
                <span class="history-time">{{getTimeAgo(roll.timestamp)}}</span>
              </button>
            }
          </div>
        </div>

        <!-- Received Rolls -->
        @if (receivedRolls().length > 0) {
          <div class="received-section">
            <h4>ðŸŽ² Andere WÃ¼rfe</h4>
            <div class="received-list">
              @for (roll of receivedRolls(); track roll.id) {
                <div class="received-item">
                  <span class="player-name">{{roll.characterName}}</span>
                  <span class="roll-info">{{roll.diceCount}}d{{roll.diceType}} = </span>
                  <span class="roll-result">{{roll.result}}</span>
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>
  </div>
</div>
