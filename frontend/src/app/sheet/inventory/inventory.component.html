<app-card>
  <div class="inventory-header">
    <div>
      <h2>Inventory</h2>
      <div class="weight-info">
        <div class="weight-row">
          <span class="weight-display" [class]="encumbranceClass" [style.color]="encumbranceColor">
            {{ totalWeight }} / {{ maxCapacity }} kg
          </span>
          @if (speedPenaltyText) {
            <span class="speed-penalty" [class]="encumbranceClass">{{ speedPenaltyText }}</span>
          }
        </div>
        <span class="currency-weight-label"
          >Currency: {{ getCurrencyWeight() | number : '1.2-2' }} kg</span
        >
        <div class="weight-bar" [class]="encumbranceClass">
          <div
            class="weight-fill"
            [class]="encumbranceClass"
            [style.width.%]="Math.min(encumbrancePercentage, 100)"
            [style.background-color]="encumbranceColor"
          ></div>
        </div>
      </div>
    </div>
    <div class="header-buttons">
      <button class="settings-btn" (click)="openSettingsDialog()" title="Carry Capacity Settings">
        ⚙️
      </button>
      <button class="add-btn" (click)="openCreateDialog()">+ Add Item</button>
    </div>
  </div>

  <div
    class="inventory-list"
    cdkDropList
    id="inventoryList"
    [cdkDropListData]="sheet.inventory"
    [cdkDropListConnectedTo]="['equipmentList']"
    (cdkDropListDropped)="onDrop($event)"
  >
    @for (item of (sheet.inventory || []); track i; let i = $index) {
    <div cdkDrag [cdkDragDisabled]="isItemEditing(i)" (cdkDragStarted)="onDragStarted($event)">
      <app-item
        [item]="item"
        [sheet]="sheet"
        [index]="i"
        [isEditing]="isItemEditing(i)"
        (patch)="updateItem(i, $event)"
        (delete)="deleteItem(i)"
        (editingChange)="onEditingChange(i, $event)"
      ></app-item>
      <div
        class="drag-placeholder-wrapper"
        *cdkDragPlaceholder
        [style.height]="placeholderHeight"
        [style.width]="placeholderWidth"
      ></div>
    </div>
    } @if ((sheet.inventory || []).length === 0) {
    <p class="empty-message">No items yet. Click + to add one.</p>
    }
  </div>
  <!-- Currency Section at Bottom -->
  <div class="currency-section">
    <h3>Currency</h3>
    <div class="currency-grid">
      <div class="coin-input copper">
        <label for="copper">Copper</label>
        <input
          id="copper"
          type="number"
          min="0"
          step="1"
          [ngModel]="sheet.currency?.copper || 0"
          (ngModelChange)="updateCurrency('copper', $event)"
        />
      </div>
      <div class="coin-input silver">
        <label for="silver">Silver</label>
        <input
          id="silver"
          type="number"
          min="0"
          step="1"
          [ngModel]="sheet.currency?.silver || 0"
          (ngModelChange)="updateCurrency('silver', $event)"
        />
      </div>
      <div class="coin-input gold">
        <label for="gold">Gold</label>
        <input
          id="gold"
          type="number"
          min="0"
          step="1"
          [ngModel]="sheet.currency?.gold || 0"
          (ngModelChange)="updateCurrency('gold', $event)"
        />
      </div>
      <div class="coin-input platinum">
        <label for="platinum">Platinum</label>
        <input
          id="platinum"
          type="number"
          min="0"
          step="1"
          [ngModel]="sheet.currency?.platinum || 0"
          (ngModelChange)="updateCurrency('platinum', $event)"
        />
      </div>
    </div>
    <div class="currency-total">
      Total: {{ getCurrencyTotalValue() | number:'1.2-2' }} gp
    </div>
  </div>
  <!-- Create Dialog -->
  @if (showCreateDialog) {
  <div class="dialog-overlay" (click)="closeCreateDialog()">
    <div class="dialog-content" (click)="$event.stopPropagation()">
      <h3>Add New Item</h3>
      <app-item-creator
        (create)="createItem($event)"
        (cancel)="closeCreateDialog()"
      ></app-item-creator>
    </div>
  </div>
  }

  <!-- Settings Dialog -->
  @if (showSettingsDialog) {
  <div class="dialog-overlay">
    <div class="dialog-content" (click)="$event.stopPropagation()">
      <h3>Carry Capacity Settings</h3>
      <div class="settings-form">
        <div class="field">
          <label>Formula: (Strength × Multiplier) + Bonus</label>
        </div>
        <div class="field">
          <label for="multiplier">Multiplier</label>
          <input
            id="multiplier"
            type="number"
            step="0.5"
            min="0"
            [ngModel]="sheet.carryCapacityMultiplier"
            (ngModelChange)="updateCapacitySetting('carryCapacityMultiplier', $event)"
          />
        </div>
        <div class="field">
          <label for="bonus">Bonus (kg)</label>
          <input
            id="bonus"
            type="number"
            step="1"
            [ngModel]="sheet.carryCapacityBonus"
            (ngModelChange)="updateCapacitySetting('carryCapacityBonus', $event)"
          />
        </div>
        <div class="field preview">
          <label>Current Capacity:</label>
          <span class="capacity-preview">{{ maxCapacity }} kg</span>
        </div>
        <button class="close-btn" (click)="closeSettingsDialog()">Close</button>
      </div>
    </div>
  </div>
  }
</app-card>
