@if (store.sheet$ | async; as sheet) {
<div class="character-grid" [class.current-turn]="isCurrentTurn" [class.group-turn]="isGroupTurn">
  <div class="grid-character">
    <app-character
      [sheet]="sheet"
      [characterId]="store.characterId"
      (patch)="store.applyPatch($any($event))"
    ></app-character>
  </div>
  
  <div class="grid-stats">
    <app-stats [sheet]="sheet" (patch)="store.applyPatch($any($event))"></app-stats>
  </div>
  
  <div class="grid-levelclass">
    <app-levelclass [sheet]="sheet" (patch)="store.applyPatch($any($event))" (openSkillTree)="showSkillTree = true"></app-levelclass>
  </div>
  
  <div class="grid-currentstats">
    <app-currentstats [sheet]="sheet" (patch)="store.applyPatch($any($event))"></app-currentstats>
  </div>

  <!-- Equipment - Separate so you can drag items from inventory -->
  <div class="grid-equipment">
    <app-equipment [sheet]="sheet" (patch)="store.applyPatch($any($event))"></app-equipment>
  </div>

  <!-- Tabbed Component for Inventory, Spells, Runes, Skills -->
  <div class="grid-tabs">
    <app-character-tabs
      [sheet]="sheet"
      [editingRunes]="editingRunes"
      [editingSpells]="editingSpells"
      [editingSkills]="editingSkills"
      (patch)="store.applyPatch($any($event))"
      (runeEditingChange)="onRuneEditingChange($any($event).index, $any($event).isEditing)"
      (spellEditingChange)="onSpellEditingChange($any($event).index, $any($event).isEditing)"
      (skillEditingChange)="onSkillEditingChange($any($event).index, $any($event).isEditing)"
      (openTrash)="openTrash()">
    </app-character-tabs>
  </div>

  <!-- Backstory - Standalone Section -->
  <div class="grid-backstory">
    <app-backstory
      [sheet]="sheet"
      (patch)="store.applyPatch($any($event))">
    </app-backstory>
  </div>
</div>

@if (showLootPopup) {
  <app-loot-popup
    [loot]="receivedLoot"
    [isBattleLoot]="isBattleLoot"
    (claimItem)="onClaimLoot($event)"
    (close)="onCloseLootPopup()">
  </app-loot-popup>
}

<!-- Skill Tree Modal -->
@if (showSkillTree) {
  <app-skill-tree
    [sheet]="sheet"
    (patch)="store.applyPatch($any($event))"
    (close)="closeSkillTree()">
  </app-skill-tree>
}

<!-- Sticky Action Buttons - Horizontal Layout -->
<div class="sticky-actions horizontal">
  <button class="action-btn dice-btn" [class.active]="showDiceRoller" (click)="toggleDiceRoller()" title="W√ºrfeln (D)">
    üé≤
  </button>
  <button class="action-btn resource-btn" [class.active]="showResourcePanel" (click)="toggleResourcePanel()" title="Ressourcen (R)">
    üíé
  </button>
  <button class="action-btn action-macro-btn" [class.active]="showActionMacros" (click)="toggleActionMacros()" title="Aktionen (A)">
    ‚ö°
  </button>
  <button class="action-btn info-btn" [class.active]="showGameInfo" (click)="toggleGameInfo()" title="Game Guide (H)">
    üìö
  </button>
</div>

<!-- Game Info Dialog -->
@if (showGameInfo) {
  <app-game-info
    (close)="closeGameInfo()">
  </app-game-info>
}

<!-- Dice Roller Dialog -->
@if (showDiceRoller) {
  <app-dice-roller
    [sheet]="sheet"
    (close)="closeDiceRoller()">
  </app-dice-roller>
}

<!-- Resource Panel -->
@if (showResourcePanel) {
  <div class="dialog-overlay" (click)="closeResourcePanel()">
    <div class="dialog-content use-resource-dialog" (click)="$event.stopPropagation()">
      <h2>Manage Resource</h2>

      <div class="resource-selector">
        <button
          class="resource-option health"
          [class.selected]="resourceType === 'health'"
          (click)="resourceType = 'health'">
          <span class="resource-icon">‚ù§Ô∏è</span>
          <span>Health</span>
          <span class="resource-value">{{ getResourceCurrent('health') }}</span>
        </button>
        <button
          class="resource-option energy"
          [class.selected]="resourceType === 'energy'"
          (click)="resourceType = 'energy'">
          <span class="resource-icon">‚ö°</span>
          <span style="color: #22c55e;">Energy</span>
          <span class="resource-value" style="color: #22c55e;">{{ getResourceCurrent('energy') }}</span>
        </button>
        <button
          class="resource-option mana"
          [class.selected]="resourceType === 'mana'"
          (click)="resourceType = 'mana'">
          <span class="resource-icon">üíß</span>
          <span style="color: #3b82f6;">Mana</span>
          <span class="resource-value" style="color: #3b82f6;">{{ getResourceCurrent('mana') }}</span>
        </button>
      </div>

      @if (recentSpendings.length > 0) {
        <div class="recent-spendings">
          <h3>Recent Changes</h3>
          <div class="spending-buttons">
            @for (spending of recentSpendings; track $index) {
              <button 
                class="spending-btn" 
                [class.health-spending]="spending.type === 'health'"
                [class.energy-spending]="spending.type === 'energy'"
                [class.mana-spending]="spending.type === 'mana'"
                (click)="useRecentSpending(spending)"
                title="Change {{ spending.amount }} {{ spending.type }}">
                @if (spending.type === 'health') {<span>‚ù§Ô∏è</span>}
                @if (spending.type === 'energy') {<span>‚ö°</span>}
                @if (spending.type === 'mana') {<span>üíß</span>}
                <span class="spending-amount">{{ spending.amount >= 0 ? '+' : '' }}{{ spending.amount }}</span>
              </button>
            }
          </div>
        </div>
      }

      <div class="amount-input">
        <label>Amount to change:</label>
        <input
          type="number"
          [(ngModel)]="resourceAmount"
          placeholder="0 (positive to gain, negative to spend)"
        />
        <span class="max-hint">Current: {{ getResourceCurrent(resourceType) }}</span>
      </div>

      <div class="dialog-actions">
        <button
          class="use-btn"
          [class.gain-btn]="resourceAmount > 0"
          [class.loss-btn]="resourceAmount < 0"
          [class.disabled]="resourceAmount === 0"
          [disabled]="resourceAmount === 0"
          (click)="changeResource()">
          @if (resourceAmount > 0) {
            <span>Gain {{ resourceAmount }} {{ resourceType | titlecase }}</span>
          } @else if (resourceAmount < 0) {
            <span>Spend {{ Math.abs(resourceAmount) }} {{ resourceType | titlecase }}</span>
          } @else {
            <span>Change {{ resourceType | titlecase }}</span>
          }
        </button>
        <button class="cancel-btn" (click)="closeResourcePanel()">Cancel</button>
      </div>
    </div>
  </div>
}

<!-- Action Macros Dialog -->
@if (showActionMacros) {
  <app-action-macros 
    [sheet]="sheet" 
    (close)="closeActionMacros()"
    (executeMacro)="handleMacroExecution($event)"
    (resourceChanged)="handleResourceChange($event)"
    (rollPerformed)="handleActionRoll($event)"
    (actionExecuted)="handleActionExecution($any($event))">
  </app-action-macros>
}

<!-- Trash Dialog -->
@if (showTrash) {
  <div class="dialog-overlay" (click)="closeTrash()">
    <div class="dialog-content trash-dialog" (click)="$event.stopPropagation()" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>üóëÔ∏è Trash</h2>
        <div style="display: flex; gap: 0.5rem;">
          <button (click)="emptyTrash()" [disabled]="!sheet.trash || sheet.trash.length === 0" style="background: #d32f2f; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none;">
            Empty Trash
          </button>
          <button (click)="closeTrash()" style="background: #666; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none;">
            Close
          </button>
        </div>
      </div>

      @if (!sheet.trash || sheet.trash.length === 0) {
        <p style="text-align: center; color: #999; padding: 2rem;">Trash is empty</p>
      } @else {
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          @for (trashItem of sheet.trash; track $index; let i = $index) {
            <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="background: var(--accent); color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; text-transform: uppercase;">
                    {{ trashItem.type }}
                  </span>
                  <strong>{{ trashItem.data.name || 'Unnamed' }}</strong>
                </div>
                <div style="color: #999; font-size: 0.85rem; margin-top: 0.25rem;">
                  Deleted: {{ trashItem.deletedAt | date:'short' }}
                </div>
                @if (trashItem.data.description) {
                  <div style="color: #ccc; font-size: 0.9rem; margin-top: 0.5rem; max-width: 500px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    {{ trashItem.data.description }}
                  </div>
                }
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button (click)="restoreFromTrash(i)" style="background: #4caf50; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none;">
                  Restore
                </button>
                <button (click)="permanentlyDelete(i)" style="background: #d32f2f; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none;">
                  Delete Forever
                </button>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>
}
}
