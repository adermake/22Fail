@if (store.sheet$ | async; as sheet) {
<div class="character-grid" [class.current-turn]="isCurrentTurn" [class.group-turn]="isGroupTurn">
  <app-character
    [sheet]="sheet"
    [characterId]="store.characterId"
    (patch)="store.applyPatch($any($event))"
  ></app-character>
  <app-stats [sheet]="sheet" (patch)="store.applyPatch($any($event))"></app-stats>
  <app-levelclass [sheet]="sheet" (patch)="store.applyPatch($any($event))" (openSkillTree)="showSkillTree = true"></app-levelclass>
  <app-currentstats [sheet]="sheet" (patch)="store.applyPatch($any($event))"></app-currentstats>
  <app-currency [sheet]="sheet" (patch)="store.applyPatch($any($event))"> </app-currency>

  <!-- Equipment - Separate so you can drag items from inventory -->
  <app-equipment [sheet]="sheet" (patch)="store.applyPatch($any($event))"></app-equipment>

  <!-- Tabbed Component for Inventory, Spells, Runes, Skills -->
  <app-character-tabs
    [sheet]="sheet"
    [editingRunes]="editingRunes"
    [editingSpells]="editingSpells"
    [editingSkills]="editingSkills"
    (patch)="store.applyPatch($any($event))"
    (runeEditingChange)="onRuneEditingChange($any($event).index, $any($event).isEditing)"
    (spellEditingChange)="onSpellEditingChange($any($event).index, $any($event).isEditing)"
    (skillEditingChange)="onSkillEditingChange($any($event).index, $any($event).isEditing)"
    (openTrash)="openTrash()">
  </app-character-tabs>
</div>

@if (showLootPopup) {
  <app-loot-popup
    [loot]="receivedLoot"
    [isBattleLoot]="isBattleLoot"
    (claimItem)="onClaimLoot($event)"
    (close)="onCloseLootPopup()">
  </app-loot-popup>
}

<!-- Skill Tree Modal -->
@if (showSkillTree) {
  <app-skill-tree
    [sheet]="sheet"
    (patch)="store.applyPatch($any($event))"
    (close)="closeSkillTree()">
  </app-skill-tree>
}

<!-- Sticky Use Resource Button -->
<button class="use-resource-btn" (click)="openUseResource()">
  Use Resource
</button>

<!-- Use Resource Dialog -->
@if (showUseResource) {
  <div class="dialog-overlay" (click)="closeUseResource()">
    <div class="dialog-content use-resource-dialog" (click)="$event.stopPropagation()">
      <h2>Use Resource</h2>

      <div class="resource-selector">
        <button
          class="resource-option health"
          [class.selected]="resourceType === 'health'"
          (click)="resourceType = 'health'">
          <span class="resource-icon">‚ù§Ô∏è</span>
          <span>Health</span>
          <span class="resource-value">{{ getResourceCurrent('health') }}</span>
        </button>
        <button
          class="resource-option energy"
          [class.selected]="resourceType === 'energy'"
          (click)="resourceType = 'energy'">
          <span class="resource-icon">‚ö°</span>
          <span>Energy</span>
          <span class="resource-value">{{ getResourceCurrent('energy') }}</span>
        </button>
        <button
          class="resource-option mana"
          [class.selected]="resourceType === 'mana'"
          (click)="resourceType = 'mana'">
          <span class="resource-icon">üíß</span>
          <span>Mana</span>
          <span class="resource-value">{{ getResourceCurrent('mana') }}</span>
        </button>
      </div>

      <div class="amount-input">
        <label>Amount to use:</label>
        <input
          type="number"
          [(ngModel)]="resourceAmount"
          min="0"
          [max]="getResourceCurrent(resourceType)"
          placeholder="0"
        />
        <span class="max-hint">Max: {{ getResourceCurrent(resourceType) }}</span>
      </div>

      <div class="dialog-actions">
        <button
          class="use-btn"
          [class.disabled]="!canUseResource()"
          [disabled]="!canUseResource()"
          (click)="useResource()">
          Use {{ resourceAmount }} {{ resourceType | titlecase }}
        </button>
        <button class="cancel-btn" (click)="closeUseResource()">Cancel</button>
      </div>
    </div>
  </div>
}

<!-- Trash Dialog -->
@if (showTrash) {
  <div class="dialog-overlay" (click)="closeTrash()">
    <div class="dialog-content trash-dialog" (click)="$event.stopPropagation()" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>üóëÔ∏è Trash</h2>
        <div style="display: flex; gap: 0.5rem;">
          <button (click)="emptyTrash()" [disabled]="!sheet.trash || sheet.trash.length === 0" style="background: #d32f2f; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none;">
            Empty Trash
          </button>
          <button (click)="closeTrash()" style="background: #666; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none;">
            Close
          </button>
        </div>
      </div>

      @if (!sheet.trash || sheet.trash.length === 0) {
        <p style="text-align: center; color: #999; padding: 2rem;">Trash is empty</p>
      } @else {
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          @for (trashItem of sheet.trash; track $index; let i = $index) {
            <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="background: var(--accent); color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; text-transform: uppercase;">
                    {{ trashItem.type }}
                  </span>
                  <strong>{{ trashItem.data.name || 'Unnamed' }}</strong>
                </div>
                <div style="color: #999; font-size: 0.85rem; margin-top: 0.25rem;">
                  Deleted: {{ trashItem.deletedAt | date:'short' }}
                </div>
                @if (trashItem.data.description) {
                  <div style="color: #ccc; font-size: 0.9rem; margin-top: 0.5rem; max-width: 500px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    {{ trashItem.data.description }}
                  </div>
                }
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button (click)="restoreFromTrash(i)" style="background: #4caf50; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none;">
                  Restore
                </button>
                <button (click)="permanentlyDelete(i)" style="background: #d32f2f; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none;">
                  Delete Forever
                </button>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>
}
}
