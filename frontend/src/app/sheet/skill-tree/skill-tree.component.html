<div class="skill-tree-fullscreen">
  <div class="modal-header">
    <h2>Talentbaum</h2>
    <div class="header-controls">
      <div class="talent-points">
        <span class="points-label">Talentpunkte:</span>
        <span class="points-value">{{ getAvailableTalentPoints() }}</span>
      </div>
      <div class="zoom-controls">
        <button class="zoom-btn" (click)="zoomOut()" title="Verkleinern">-</button>
        <button class="zoom-btn" (click)="resetView()" title="Zurücksetzen">⟲</button>
        <button class="zoom-btn" (click)="zoomIn()" title="Vergrößern">+</button>
      </div>
      <div class="edit-controls">
        <button
          class="edit-btn"
          [class.active]="editMode"
          (click)="toggleEditMode()"
          title="Layout bearbeiten"
        >
          {{ editMode ? 'Fertig' : 'Layout' }}
        </button>
        @if (editMode) {
          <button class="reset-btn" (click)="resetLayout()" title="Layout zurücksetzen">
            Reset
          </button>
          <button class="export-btn" (click)="exportLayout()" title="Layout exportieren">
            Export
          </button>
        }
      </div>
      <button class="close-btn" (click)="onClose()">&times;</button>
    </div>
  </div>

  <div class="modal-content">
    <!-- Tree View with pan/zoom -->
    <div
      #treeContainer
      class="tree-container"
      (wheel)="onWheel($event)"
      (mousedown)="onMouseDown($event)"
      (mousemove)="onMouseMove($event)"
      (mouseup)="onMouseUp()"
      (mouseleave)="onMouseLeave()"
    >
      <div class="tree-inner" [style.transform]="transformStyle">
        <svg class="tree-svg" [attr.viewBox]="'0 0 1200 1200'">
          <!-- Connection lines (curved bezier paths) -->
          @for (conn of connections; track conn.from + '-' + conn.to) {
            @if (getConnectionPath(conn); as pathData) {
              <path
                class="connection-line"
                [class.accessible]="isClassAccessible(conn.from) || isClassAccessible(conn.to)"
                [attr.d]="pathData"
                fill="none"
              />
            }
          }

          <!-- Tier rings (decorative) with tier-based colors -->
          @for (radius of tierRadii; track radius; let i = $index) {
            @if (i > 0) {
              <circle
                class="tier-ring"
                [class]="'tier-ring tier-' + i"
                [attr.cx]="centerX"
                [attr.cy]="centerY"
                [attr.r]="radius"
                fill="none"
              />
            }
          }
        </svg>

        <!-- Class nodes -->
        @for (classPos of classPositions; track classPos.name) {
          <app-class-node
            [className]="classPos.name"
            [x]="classPos.x"
            [y]="classPos.y"
            [tier]="classPos.tier"
            [learnedCount]="getLearnedCountForClass(classPos.name)"
            [totalCount]="getTotalSkillsForClass(classPos.name)"
            [isSelected]="selectedClass === classPos.name"
            [isAccessible]="isClassAccessible(classPos.name)"
            [canLearn]="canLearnFromClass(classPos.name)"
            [editMode]="editMode"
            (select)="selectClass(classPos.name)"
            (dragStart)="startNodeDrag(classPos.name, $event)"
          />
        }
      </div>
    </div>

    <!-- Skill Detail Panel -->
    @if (selectedClass) {
      <div class="skill-panel">
        <app-skill-detail
          [className]="selectedClass"
          [skills]="getSkillsForSelectedClass()"
          [learnedSkillIds]="sheet.learnedSkillIds || []"
          [availablePoints]="getAvailableTalentPoints()"
          [canLearnFromClass]="canLearnFromClass(selectedClass)"
          (learnSkill)="learnSkill($event)"
          (unlearnSkill)="unlearnSkill($event)"
          (close)="selectedClass = null"
        />
      </div>
    }
  </div>
</div>
