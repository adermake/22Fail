<div class="battle-tracker-container" [class.read-only]="readOnly">
  <!-- Header -->
  <div class="battle-header">
    <h2>Battle Tracker</h2>
    @if (!readOnly) {
      <div class="header-buttons">
        <button class="reset-meters-btn" (click)="onResetTurnMeters()" title="Reset all turn meters to 0">
          Reset Meters
        </button>
        <button class="reset-button" (click)="onResetBattle()" title="Clear all participants">
          Reset Battle
        </button>
      </div>
    }
  </div>

  <!-- Current Turn Display -->
  @if (currentTurnDisplay()) {
    <div class="current-turn-display">
      <span class="label">Current Turn:</span>
      <span class="names">{{ currentTurnDisplay() }}</span>
    </div>
  }

  <!-- Character List with Turn Meters (World View Only) -->
  @if (!readOnly) {
    <div class="characters-section">
      <h3>Characters</h3>
      @if (allCharacters().length > 0) {
        <div class="character-list">
          @for (char of allCharacters(); track trackChar($index, char)) {
            <div class="character-option" [class.in-battle]="char.isInBattle">
              <div class="character-info">
                <img 
                  [src]="char.portrait | imageUrl" 
                  class="portrait-small" 
                  alt=""
                >
                <div class="details">
                  <span class="name">{{ char.name }}</span>
                  <span class="speed">Speed: {{ char.speed }}</span>
                </div>
                
                <!-- Team Selector (only when in battle) -->
                @if (char.isInBattle) {
                  <select 
                    class="team-selector"
                    [ngModel]="char.team"
                    (ngModelChange)="onTeamChange(char.id, $event)"
                  >
                    @for (team of teams; track team) {
                      <option [value]="team">{{ team }}</option>
                    }
                  </select>
                }
              </div>

              <!-- Turn Meter Slider (only when in battle) -->
              @if (char.isInBattle) {
                <div class="turn-meter-section">
                  <div class="turn-meter-bar">
                    <div 
                      class="turn-meter-fill" 
                      [style.width.%]="getTurnMeterPercent(char)"
                      [ngClass]="'team-' + char.team"
                    ></div>
                  </div>
                  <input 
                    type="range" 
                    class="turn-meter-slider"
                    [min]="0" 
                    [max]="TURN_METER_MAX - 1" 
                    [value]="char.turnMeter"
                    (input)="onTurnMeterChange(char.id, $event)"
                  >
                  <span class="turn-meter-value">{{ char.turnMeter }}</span>
                </div>
              }

              <!-- Add/Remove Button -->
              <button 
                class="toggle-btn" 
                [class.remove]="char.isInBattle"
                (click)="char.isInBattle ? onRemoveCharacter(char.id) : onAddCharacter(char.id)"
              >
                {{ char.isInBattle ? 'Remove' : 'Add' }}
              </button>
            </div>
          }
        </div>
      } @else {
        <p class="no-chars">No characters available</p>
      }
    </div>
  }

  <!-- Timeline -->
  <div class="timeline-section">
    <div 
      class="timeline" 
      #timelineContainer
    >
      @if (timeline().length === 0) {
        <div class="empty-timeline">
          <span>Add characters to start battle</span>
        </div>
      } @else {
        @for (group of timeline(); track trackGroup($index, group); let gIdx = $index) {
          <div 
            class="turn-group"
            [attr.data-group-id]="group.id"
            [ngClass]="'team-' + group.team"
            [class.first-group]="gIdx === 0"
          >
            <!-- Tiles -->
            @for (tile of group.tiles; track trackTile($index, tile)) {
              <div 
                class="tile"
                [attr.data-tile-id]="tile.id"
                [class.animating]="isAnimating(tile.id)"
                [ngClass]="'team-' + tile.team"
              >
                <img 
                  [src]="tile.portrait | imageUrl" 
                  [alt]="tile.name"
                  class="tile-portrait"
                >
                <span class="tile-name">{{ tile.name }}</span>
                <span class="turn-number">T{{ tile.turnNumber }}</span>
              </div>
            }

            <!-- Group indicator line (when multiple tiles in group) -->
            @if (group.tiles.length > 1) {
              <div class="group-line"></div>
            }
          </div>
        }
      }
    </div>
  </div>

  <!-- Controls -->
  @if (!readOnly) {
    <div class="controls">
      <button 
        class="next-turn-btn"
        (click)="onNextTurn()" 
        [disabled]="timeline().length === 0"
        title="Advance to next turn"
      >
        Next Turn
      </button>
    </div>
  }
</div>
