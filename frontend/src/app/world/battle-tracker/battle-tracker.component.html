<div class="battle-tracker-container" [class.read-only]="readOnly">
  <!-- Header -->
  <div class="battle-header">
    <h2>Battle Tracker</h2>
    @if (!readOnly) {
      <div class="header-buttons">
        <button class="reset-meters-btn" (click)="onResetTurnMeters()" title="Reset all turn meters to 0">
          Reset Meters
        </button>
        <button class="reset-button" (click)="onResetBattle()" title="Clear all participants">
          Reset Battle
        </button>
      </div>
    }
  </div>

  <!-- Current Turn Display -->
  @if (currentTurnDisplay()) {
    <div class="current-turn-display">
      <span class="label">Current Turn:</span>
      <span class="names">{{ currentTurnDisplay() }}</span>
    </div>
  }

  <!-- Character Grid (World View Only) - Two columns: Available | In Battle -->
  @if (!readOnly) {
    <div class="characters-grid-section">
      <!-- Available Characters (Left) -->
      <div 
        class="character-column available-column"
        (dragover)="onAvailableColumnDragOver($event)"
        (drop)="onAvailableColumnDrop($event)"
      >
        <div class="column-header">Available</div>
        <div class="character-tiles">
          @for (char of availableCharacters(); track trackChar($index, char)) {
            <div 
              class="character-tile"
              draggable="true"
              (dragstart)="onCharDragStart($event, char)"
              title="Drag to add to battle"
            >
              @if (char.portrait) {
                <img [src]="char.portrait | imageUrl" class="tile-portrait-small" alt="">
              } @else {
                <span class="tile-portrait-small tile-initial">{{ char.name?.charAt(0) || '?' }}</span>
              }
              <span class="tile-char-name">{{ char.name }}</span>
            </div>
          }
          @if (availableCharacters().length === 0) {
            <div class="empty-column">All in battle</div>
          }
        </div>
      </div>

      <!-- In Battle Characters (Right) -->
      <div 
        class="character-column battle-column"
        (dragover)="onBattleColumnDragOver($event)"
        (drop)="onBattleColumnDrop($event)"
      >
        <div class="column-header">In Battle</div>
        <div class="character-tiles">
          @for (char of inBattleCharacters(); track trackChar($index, char)) {
            <div 
              class="character-tile in-battle"
              [ngClass]="'team-' + char.team"
              draggable="true"
              (dragstart)="onCharDragStart($event, char)"
              title="Drag to remove from battle"
            >
              @if (char.portrait) {
                <img [src]="char.portrait | imageUrl" class="tile-portrait-small" alt="">
              } @else {
                <span class="tile-portrait-small tile-initial">{{ char.name?.charAt(0) || '?' }}</span>
              }
              <span class="tile-char-name">{{ char.name }}</span>
            </div>
          }
          @if (inBattleCharacters().length === 0) {
            <div class="empty-column drop-zone">Drag characters here</div>
          }
        </div>
      </div>
    </div>

    <!-- Turn Meters for In-Battle Characters -->
    @if (inBattleCharacters().length > 0) {
      <div class="turn-meters-section">
        <div class="meters-header">Turn Meters</div>
        <div class="meters-list">
          @for (char of inBattleCharacters(); track trackChar($index, char)) {
            <div class="meter-row" [ngClass]="'team-' + char.team">
                <span class="meter-name">{{ char.name }}</span>
                <div class="meter-slider-wrapper" [class.dragging]="isDraggingMeter()">
                  <div class="meter-track">
                    <div 
                      class="meter-fill"
                      [style.width.%]="getTurnMeterPercent(char)"
                    ></div>
                    <div 
                      class="meter-thumb"
                      [style.left.%]="getTurnMeterPercent(char)"
                    ></div>
                  </div>
                  <input 
                    type="range" 
                    class="meter-input"
                    [min]="0" 
                    [max]="TURN_METER_MAX - 1" 
                    [value]="char.turnMeter"
                    (mousedown)="onMeterDragStart()"
                    (mouseup)="onMeterDragEnd()"
                    (input)="onTurnMeterInput(char.id, $event)"
                  >
                </div>
                <span class="meter-value">{{ char.turnMeter }}</span>
              </div>
          }
        </div>
      </div>
    }
  }

  <!-- Timeline -->
  <div class="timeline-section">
    <div 
      class="timeline" 
      #timelineContainer
    >
      @if (timeline().length === 0) {
        <div class="empty-timeline">
          <span>Add characters to start battle</span>
        </div>
      } @else {
        @for (group of timeline(); track trackGroup($index, group); let gIdx = $index) {
          <div 
            class="turn-group"
            [attr.data-group-id]="group.id"
            [ngClass]="'team-' + group.team"
            [class.first-group]="gIdx === 0"
          >
            <!-- Tiles -->
            @for (tile of group.tiles; track trackTile($index, tile)) {
              <div 
                class="tile"
                [attr.data-tile-id]="tile.id"
                [class.animating]="isAnimating(tile.id)"
                [ngClass]="'team-' + tile.team"
                (click)="onTileClick($event, tile)"
            >
                @if (tile.portrait) {
                  <img 
                    [src]="tile.portrait | imageUrl" 
                    [alt]="tile.name"
                    class="tile-portrait"
                  >
                } @else {
                  <span class="tile-portrait tile-initial">{{ tile.name?.charAt(0) || '?' }}</span>
                }
                <span class="tile-name">{{ tile.name }}</span>
                <span class="tile-speed">{{ tile.speed - 10 }}</span>
              </div>
            }

            <!-- Group indicator line (when multiple tiles in group) -->
            @if (group.tiles.length > 1) {
              <div class="group-line"></div>
            }
          </div>
        }
      }
    </div>
  </div>

  <!-- Radial Team Menu -->
  @if (radialMenuOpen()) {
    <div class="radial-menu-backdrop" (click)="closeRadialMenu()"></div>
    <div class="radial-menu" [style.left.px]="radialMenuPosition().x" [style.top.px]="radialMenuPosition().y">
      @for (team of teams; track team; let i = $index) {
        <button 
          class="radial-team-btn" 
          [ngClass]="'team-' + team"
          [class.selected]="getRadialMenuChar()?.team === team"
          (click)="onRadialTeamSelect(team)"
          [title]="team"
          [style.--angle]="(i * 60 - 90) + 'deg'"
        >
          <span class="radial-color-circle"></span>
        </button>
      }
    </div>
  }

  <!-- Controls -->
  @if (!readOnly) {
    <div class="controls">
      <button 
        class="next-turn-btn"
        (click)="onNextTurn()" 
        [disabled]="timeline().length === 0"
        title="Advance to next turn"
      >
        Next Turn
      </button>
    </div>
  }
</div>
