<div class="battle-tracker">
  <div class="battle-header">
    <h2>Battle Tracker</h2>
    <button class="reset-button" (click)="onResetBattle()">Reset Battle</button>
  </div>

  <div class="characters-section">
    <h3>Characters</h3>
    @if (availableCharacters.length > 0) {
      <div class="character-list">
        @for (char of availableCharacters; track char.id) {
          <div class="character-option" [class.in-battle]="isInBattle(char.id)">
            <div class="character-info">
              @if (getCharacterPortrait(char.id)) {
                <img [src]="getCharacterPortrait(char.id)" alt="{{ char.name }}" class="character-portrait-small">
              }
              <div class="character-details">
                <span class="character-name">{{ char.name }}</span>
                <span class="character-speed">Speed: {{ char.speed }}</span>
                @if (isInBattle(char.id)) {
                  <select class="team-selector" [ngModel]="getParticipant(char.id)?.team" (ngModelChange)="onTeamChange(char.id, $any($event))">
                    @for (team of availableTeams; track team) {
                      <option [value]="team">{{ team }}</option>
                    }
                  </select>
                }
              </div>
            </div>
            <button
              class="toggle-button"
              [class.in-battle]="isInBattle(char.id)"
              (click)="isInBattle(char.id) ? onRemoveCharacter(char.id) : onAddCharacter(char.id)">
              {{ isInBattle(char.id) ? 'Remove' : 'Add' }}
            </button>
          </div>
        }
      </div>
    } @else {
      <p class="empty-message">No characters available</p>
    }
  </div>

  @if (turnQueue.length > 0) {
    <div class="turn-queue-section">
      <h3>Turn Order Queue</h3>
      <p class="queue-hint">Drag portraits to reorder turns between positions</p>
      <div class="turn-queue">
        @for (group of turnQueue; track $index) {
          <!-- Drop zone before each group -->
          <div class="drop-zone"
               [class.drop-zone-active]="dragOverIndex === $index && dropPosition === 'before'"
               (dragover)="onDragOverDropZone($event, $index)"
               (dragleave)="onDragLeaveQueue()"
               (drop)="onDropBetween($event, $index)"></div>

          <div class="queue-group"
               [class.current-turn]="$index === 0"
               [class.is-group]="group.participants.length > 1"
               [class.completing]="$index === 0 && completingTurn"
               [class.drag-over-left]="dragOverIndex === $index && dropPosition === 'left'"
               [class.drag-over-right]="dragOverIndex === $index && dropPosition === 'right'"
               (dragover)="onDragOverGroup($event, $index)"
               (dragleave)="onDragLeaveQueue()"
               (drop)="onDropOnGroup($event, $index)">

            <div class="group-portraits">
              @for (participant of group.participants; track participant.characterId) {
                <div class="queue-item"
                     [attr.data-team]="participant.team"
                     draggable="true"
                     (dragstart)="onDragStartQueue($event, participant.characterId)"
                     (dragend)="onDragEnd()">
                  @if (participant.portrait) {
                    <img [src]="participant.portrait" alt="{{ participant.name }}" class="queue-portrait">
                  } @else {
                    <div class="queue-portrait-placeholder">
                      {{ participant.name.charAt(0).toUpperCase() }}
                    </div>
                  }
                </div>
              }
            </div>

            @if ($index === 0) {
              <span class="turn-label">Now</span>
            }
          </div>
        }
        <!-- Drop zone after the last group -->
        <div class="drop-zone"
             [class.drop-zone-active]="dragOverIndex === turnQueue.length && dropPosition === 'after'"
             (dragover)="onDragOverDropZone($event, turnQueue.length)"
             (dragleave)="onDragLeaveQueue()"
             (drop)="onDropBetween($event, turnQueue.length)"></div>
      </div>

      @if (currentTurnGroup.length > 0) {
        <div class="current-turn-display">
          <div class="current-turn-info">
            <div class="current-portraits">
              @for (participant of currentTurnGroup; track participant.characterId) {
                @if (participant.portrait) {
                  <img [src]="participant.portrait" alt="{{ participant.name }}" class="current-portrait">
                }
              }
            </div>
            <div>
              <p><strong>Current Turn:</strong></p>
              <p class="current-name">{{ currentTurnNames }}</p>
            </div>
          </div>
          <button class="complete-turn-button" (click)="onNextTurn()">Complete Turn</button>
        </div>
      }
    </div>
  }
</div>
