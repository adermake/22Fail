<div class="battle-tracker-container">
  <div class="battle-header">
    <h2>Battle Tracker</h2>
    <button class="reset-button" (click)="onResetBattle()">Reset Battle</button>
  </div>

  <!-- Current Turn Display -->
  @if (currentTurnDisplay) {
    <div class="current-turn-display">
      <span class="current-turn-label">Current Turn:</span>
      <span class="current-turn-names">{{ currentTurnDisplay }}</span>
    </div>
  }

  <!-- Character List -->
  <div class="characters-section">
    <h3>Characters</h3>
    @if (characters.length > 0) {
      <div class="character-list">
        @for (char of characters; track char.id) {
          <div class="character-option" [class.in-battle]="char.isInBattle">
            <div class="character-info">
              <img [src]="char.portrait || 'assets/default-portrait.png'" class="character-portrait-small" alt="">
              <div class="character-details">
                <span class="character-name">{{ char.name }}</span>
                @if (char.speed !== undefined) {
                  <span class="character-speed">Speed: {{ char.speed }}</span>
                }
                @if (char.isInBattle) {
                  <select class="team-selector"
                          [ngModel]="char.team"
                          (ngModelChange)="onTeamChange(char.id, $event)">
                    @for (team of availableTeams; track team) {
                      <option [value]="team">{{ team }}</option>
                    }
                  </select>
                }
              </div>
            </div>
            <button class="toggle-button"
                    [class.in-battle]="char.isInBattle"
                    (click)="char.isInBattle ? onRemoveCharacter(char.id) : onAddCharacter(char.id)">
              {{ char.isInBattle ? 'Remove' : 'Add' }}
            </button>
          </div>
        }
      </div>
    } @else {
      <p class="no-chars">No characters available</p>
    }
  </div>

  <!-- Timeline - All tiles are draggable -->
  <div class="turn-queue-container">
    <div class="turn-queue"
         [class.is-dragging]="!!draggedTileId"
         (dragover)="onDragOver($event)"
         (dragleave)="onDragLeave($event)"
         (drop)="onDrop($event)">

      @for (group of timeline; track group.id; let gIdx = $index) {
        <div class="battle-group" [ngClass]="'team-' + group.team">

          <!-- Drop indicator before this group -->
          @if (dragOverGroupIndex === gIdx && dropPosition === 'before') {
            <div class="drop-indicator drop-before"></div>
          }

          <!-- Tiles in this group -->
          @for (tile of group.tiles; track tile.id) {
            <div class="battle-card"
                 [class.fading]="shouldTileFade(tile.id)"
                 [class.is-dragged]="draggedTileId === tile.id"
                 [ngClass]="'team-' + tile.team"
                 draggable="true"
                 (dragstart)="onDragStart($event, tile)"
                 (dragend)="onDragEnd()">
              <img [src]="tile.portrait || 'assets/default-portrait.png'" [alt]="tile.name">
              <span>{{ tile.name }}</span>
            </div>
          }

          <!-- Drop indicator after this group -->
          @if (dragOverGroupIndex === gIdx && dropPosition === 'after') {
            <div class="drop-indicator drop-after"></div>
          }
        </div>
      }

      <!-- Empty state -->
      @if (timeline.length === 0) {
        <div class="empty-timeline">
          <span>Add characters to start battle</span>
        </div>
      }
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <button (click)="onNextTurn()" [disabled]="timeline.length === 0">Next Turn</button>
  </div>
</div>
