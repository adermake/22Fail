<div class="battle-tracker">
  <div class="battle-header">
    <h2>Battle Tracker</h2>
    <button class="reset-button" (click)="onResetBattle()">Reset Battle</button>
  </div>

  <div class="add-character-section">
    <h3>Add to Battle</h3>
    @if (availableToAdd.length > 0) {
      <div class="character-list">
        @for (char of availableToAdd; track char.id) {
          <div class="character-option">
            <span class="character-name">{{ char.name }}</span>
            <span class="character-speed">Speed: {{ char.speed }}</span>
            <button class="add-button" (click)="onAddCharacter(char.id)">+</button>
          </div>
        }
      </div>
    } @else {
      <p class="empty-message">All characters are in battle</p>
    }
  </div>

  <div class="participants-section">
    <h3>Battle Participants</h3>
    @if (battleParticipants.length > 0) {
      <div class="participants-list">
        @for (participant of battleParticipants; track participant.characterId) {
          <div class="participant-item"
               [attr.data-team]="participant.team">
            <div class="participant-info">
              @if (participant.portrait) {
                <img [src]="participant.portrait" alt="{{ participant.name }}" class="participant-portrait">
              }
              <div class="participant-details">
                <span class="participant-name">{{ participant.name }}</span>
                <span class="participant-speed">Speed: {{ participant.speed }}</span>
                <select class="team-selector" [ngModel]="participant.team" (ngModelChange)="onTeamChange(participant.characterId, $any($event))">
                  @for (team of availableTeams; track team) {
                    <option [value]="team">{{ team }}</option>
                  }
                </select>
              </div>
            </div>
            <button class="remove-button" (click)="onRemoveCharacter(participant.characterId)">Ã—</button>
          </div>
        }
      </div>
    } @else {
      <p class="empty-message">No participants in battle</p>
    }
  </div>

  @if (turnQueue.length > 0) {
    <div class="turn-queue-section">
      <h3>Turn Order Queue</h3>
      <p class="queue-hint">Drag portraits to reorder turns between positions</p>
      <div class="turn-queue">
        @for (group of turnQueue; track $index) {
          <!-- Drop zone before each group -->
          <div class="drop-zone"
               [class.drop-zone-active]="dragOverIndex === $index"
               (dragover)="onDragOverDropZone($event, $index)"
               (dragleave)="onDragLeaveQueue()"
               (drop)="onDropBetween($event, $index)"></div>

          <div class="queue-group"
               [class.current-turn]="$index === 0"
               [class.is-group]="group.participants.length > 1"
               [class.completing]="$index === 0 && completingTurn">

            <div class="group-portraits">
              @for (participant of group.participants; track participant.characterId) {
                <div class="queue-item"
                     [attr.data-team]="participant.team"
                     draggable="true"
                     (dragstart)="onDragStartQueue($event, participant.characterId)"
                     (dragend)="onDragEnd()">
                  @if (participant.portrait) {
                    <img [src]="participant.portrait" alt="{{ participant.name }}" class="queue-portrait">
                  } @else {
                    <div class="queue-portrait-placeholder">
                      {{ participant.name.charAt(0).toUpperCase() }}
                    </div>
                  }
                </div>
              }
            </div>

            @if ($index === 0) {
              <span class="turn-label">Now</span>
            }
            @if (group.participants.length > 1) {
              <span class="group-indicator">Group Turn ({{ group.participants.length }})</span>
            }
          </div>
        }
        <!-- Drop zone after the last group -->
        <div class="drop-zone"
             [class.drop-zone-active]="dragOverIndex === turnQueue.length"
             (dragover)="onDragOverDropZone($event, turnQueue.length)"
             (dragleave)="onDragLeaveQueue()"
             (drop)="onDropBetween($event, turnQueue.length)"></div>
      </div>

      @if (currentTurn) {
        <div class="current-turn-display">
          <div class="current-turn-info">
            @if (currentTurn.portrait) {
              <img [src]="currentTurn.portrait" alt="{{ currentTurn.name }}" class="current-portrait">
            }
            <div>
              <p><strong>Current Turn:</strong></p>
              <p class="current-name">{{ currentTurn.name }}</p>
            </div>
          </div>
          <button class="complete-turn-button" (click)="onNextTurn()">Complete Turn</button>
        </div>
      }
    </div>
  }
</div>
