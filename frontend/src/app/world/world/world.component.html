@if (store.world$ | async; as world) {
<div class="world-container">
  <div class="world-header">
    <h1>{{ worldName }} - GM View</h1>
  </div>

  <!-- Top Section: Character Management -->
  <div class="management-grid">
    <!-- All Characters -->
    <app-card>
      <h2>All Characters</h2>
      <div class="character-list">
        @for (characterId of world.characterIds; track characterId; let i = $index) {
          <div class="character-item">
            <span>{{ characterId }}</span>
            <button (click)="removeCharacter(i)">Remove</button>
          </div>
        }
      </div>
      <div class="add-section">
        <input
          type="text"
          [(ngModel)]="newCharacterId"
          placeholder="Character ID"
        />
        <button (click)="addCharacter()">Add Character</button>
      </div>
    </app-card>

    <!-- Active Party -->
    <app-card>
      <h2>Active Party</h2>
      <div class="party-list">
        @for (partyId of world.partyIds; track partyId; let i = $index) {
          <div class="party-item">
            <span>{{ partyId }}</span>
            <button (click)="removeFromParty(i)">Remove</button>
          </div>
        }
      </div>
      <div class="add-section">
        <select [(ngModel)]="selectedCharacterForParty">
          <option value="">Select a character...</option>
          @for (characterId of world.characterIds; track characterId) {
            @if (!world.partyIds.includes(characterId)) {
              <option [value]="characterId">{{ characterId }}</option>
            }
          }
        </select>
        <button (click)="addToParty()">Add to Party</button>
      </div>
    </app-card>

    <!-- Party Dashboard -->
    <app-card class="party-dashboard-card">
      <h2>Party Dashboard</h2>
      @if (getPartyCharacterArray().length === 0) {
        <p>No characters in party. Add characters to see their stats.</p>
      } @else {
        <div class="dashboard-grid">
          @for (member of getPartyCharacterArray(); track member.id) {
            <div class="character-card drop-zone"
                 (dragover)="onDragOver($event)"
                 (drop)="onDropOnCharacter($event, member.id)"
                 (dblclick)="openCharacterSheet(member.id)">
              <div class="character-header">
                @if (member.sheet.portrait) {
                  <div class="character-portrait">
                    <img [src]="member.sheet.portrait | imageUrl" alt="{{ member.sheet.name || member.id }}" />
                  </div>
                }
                <div class="character-info">
                  <h3>{{ member.sheet.name || member.id }}</h3>
                </div>
              </div>

              <div class="character-stats">
                <div class="stat-row">
                  <span class="stat-label">Health</span>
                  <div class="stat-bar-wrapper">
                    <div class="stat-bar-fill health"
                         [style.width.%]="getResourcePercentage(member.sheet, FormulaType.LIFE)">
                    </div>
                    <span class="stat-value">{{ getResourceCurrent(member.sheet, FormulaType.LIFE) }} / {{ getResourceMax(member.sheet, FormulaType.LIFE) }}</span>
                  </div>
                </div>
                <div class="stat-row">
                  <span class="stat-label">Energy</span>
                  <div class="stat-bar-wrapper">
                    <div class="stat-bar-fill energy"
                         [style.width.%]="getResourcePercentage(member.sheet, FormulaType.ENERGY)">
                    </div>
                    <span class="stat-value">{{ getResourceCurrent(member.sheet, FormulaType.ENERGY) }} / {{ getResourceMax(member.sheet, FormulaType.ENERGY) }}</span>
                  </div>
                </div>
                <div class="stat-row">
                  <span class="stat-label">Mana</span>
                  <div class="stat-bar-wrapper">
                    <div class="stat-bar-fill mana"
                         [style.width.%]="getResourcePercentage(member.sheet, FormulaType.MANA)">
                    </div>
                    <span class="stat-value">{{ getResourceCurrent(member.sheet, FormulaType.MANA) }} / {{ getResourceMax(member.sheet, FormulaType.MANA) }}</span>
                  </div>
                </div>
                <div class="stat-row money">
                  <span class="stat-label">Money:</span>
                  <div class="currency">
                    <span class="copper">{{ member.sheet.currency?.copper || 0 }}c</span>
                    <span class="silver">{{ member.sheet.currency?.silver || 0 }}s</span>
                    <span class="gold">{{ member.sheet.currency?.gold || 0 }}g</span>
                    <span class="platinum">{{ member.sheet.currency?.platinum || 0 }}p</span>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      }
    </app-card>
  </div>

  <!-- Battle Tracker Section -->
  <div class="battle-tracker-section">
    <app-battle-tracker [engine]="battleEngine"></app-battle-tracker>
  </div>

  <!-- Bottom Section: Battle Loot + Library -->
  <div class="content-grid">
    <!-- Battle Loot Section (Left) -->
    <app-card class="battle-loot-card">
      <h2>Battle Loot</h2>
      <app-loot-manager 
        [bundles]="lootBundleLibrary" 
        [partyMembers]="partyMembersForLoot"
        (bundleCreated)="onBundleCreated($event)"
        (bundleDeleted)="onBundleDeleted($event)">
      </app-loot-manager>
    </app-card>

    <!-- Library Tabs Section (Right) -->
    <app-card class="library-card">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Library</h2>
        <button (click)="openTrash()" style="background: #666; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none;" title="Open Trash">
          üóëÔ∏è Trash ({{ (world.trash || []).length }})
        </button>
      </div>
      <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem;">
        <button (click)="generateRandomWeapon()" style="width: 100%; background: var(--accent); color: white; padding: 8px;">Zuf√§llige Waffe schmieden</button>
        <button (click)="generateRandomArmor()" style="width: 100%; background: var(--accent); color: white; padding: 8px;">Zuf√§llige R√ºstung schmieden</button>
      </div>
      <p class="drag-hint">Drag items onto characters or battle loot. Double-click to edit.</p>
      <app-library-tabs
        [items]="world.itemLibrary"
        [runes]="world.runeLibrary"
        [spells]="world.spellLibrary"
        [skills]="world.skillLibrary"
        [dummySheet]="dummySheet"
        [editingItems]="editingItems"
        [editingRunes]="editingRunes"
        [editingSpells]="editingSpells"
        [editingSkills]="editingSkills"
        (addItem)="openItemCreator()"
        (addRune)="addRune()"
        (addSpell)="addSpell()"
        (addSkill)="addSkill()"
        (updateItem)="updateItem($event.index, $event.patch)"
        (updateRune)="updateRune($event.index, $event.patch)"
        (updateSpell)="updateSpell($event.index, $event.patch)"
        (updateSkill)="updateSkill($event.index, $event.patch)"
        (removeItem)="removeItem($event)"
        (removeRune)="removeRune($event)"
        (removeSpell)="removeSpell($event)"
        (removeSkill)="removeSkill($event)"
        (itemEditingChange)="onItemEditingChange($event)"
        (runeEditingChange)="onRuneEditingChange($event)"
        (spellEditingChange)="onSpellEditingChange($event)"
        (skillEditingChange)="onSkillEditingChange($event)"
        (dragStart)="onDragStart($event.event, $event.type, $event.index)">
      </app-library-tabs>
    </app-card>
  </div>
</div>

<!-- Item Creator Dialog -->
@if (showItemCreator) {
  <div class="dialog-overlay" (mousedown)="closeItemCreator()">
    <div class="dialog-content" (click)="$event.stopPropagation()" (mousedown)="$event.stopPropagation()">
      <app-item-creator
        (create)="createItem($event)"
        (cancel)="closeItemCreator()">
      </app-item-creator>
    </div>
  </div>
}

<!-- Trash Dialog -->
@if (showTrash) {
  <div class="dialog-overlay" (click)="closeTrash()">
    <div class="dialog-content trash-dialog" (click)="$event.stopPropagation()" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>üóëÔ∏è Trash</h2>
        <div style="display: flex; gap: 0.5rem;">
          <button (click)="emptyTrash()" [disabled]="!world.trash || world.trash.length === 0" style="background: #d32f2f; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none;">
            Empty Trash
          </button>
          <button (click)="closeTrash()" style="background: #666; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none;">
            Close
          </button>
        </div>
      </div>

      @if (!world.trash || world.trash.length === 0) {
        <p style="text-align: center; color: #999; padding: 2rem;">Trash is empty</p>
      } @else {
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          @for (trashItem of world.trash; track $index; let i = $index) {
            <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span style="background: var(--accent); color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.75rem; text-transform: uppercase;">
                    {{ trashItem.type }}
                  </span>
                  <strong>{{ trashItem.data.name || 'Unnamed' }}</strong>
                </div>
                <div style="color: #999; font-size: 0.85rem; margin-top: 0.25rem;">
                  Deleted: {{ trashItem.deletedAt | date:'short' }}
                </div>
                @if (trashItem.data.description) {
                  <div style="color: #ccc; font-size: 0.9rem; margin-top: 0.5rem; max-width: 500px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    {{ trashItem.data.description }}
                  </div>
                }
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button (click)="restoreFromTrash(i)" style="background: #4caf50; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none;">
                  Restore
                </button>
                <button (click)="permanentlyDelete(i)" style="background: #d32f2f; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; border: none;">
                  Delete Forever
                </button>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>
}
}
